<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sofia - Your Brain Health Story Companion</title>
    <link rel="icon" type="image/svg+xml" href="static/favicon.svg">
    <!-- Sofia Brain Health Story Companion
    
    This application can run in two modes:
    1. Standalone (localStorage only) - Works without any backend
    2. Full Backend (API + PostgreSQL) - Load js/api-client.js for full functionality
    
    For backend integration, ensure api-client.js is available and configure API_BASE_URL
    
    Optional Features:
    - PDF Document Upload: Uncomment the PDF.js script tag at bottom to enable PDF parsing
    - API Integration: Loads from js/api-client.js for database persistence
    -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .container {
            display: flex;
            min-height: calc(100vh - 40px);
            max-width: 1600px;
            margin: 0 auto;
            gap: 20px;
            padding: 20px;
        }

        .chat-section, .feedback-section, .memory-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 400px;
            max-height: calc(100vh - 60px);
        }

        .chat-section {
            flex: 2;
            position: relative;
        }

        .feedback-section {
            flex: 1;
        }

        .memory-section {
            flex: 1.2;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Visual Style Selector */
        .style-selector {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
        }

        .style-selector button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .style-selector button:hover {
            background: rgba(255, 255, 255, 0.9);
            color: #000;
        }

        .style-menu {
            position: absolute;
            top: 40px;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 10px;
            display: none;
            width: 200px;
        }

        .style-menu.active {
            display: block;
        }

        .style-option {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            color: #000;
            margin-bottom: 4px;
            transition: background 0.2s;
        }

        .style-option:hover {
            background: #f0f4f8;
        }

        .style-option.active {
            background: #667eea;
            color: #000;
        }

        /* About Me Profile Display */
        .about-me-summary {
            background: #e8f0fe;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .about-me-summary h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .about-me-item {
            background: white;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 6px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .about-me-item.best-life {
            border-left: 3px solid #51cf66;
        }

        .about-me-item.concern {
            border-left: 3px solid #ff6b6b;
        }

        .about-me-item.next-step {
            border-left: 3px solid #339af0;
        }

        .confidence-badge {
            background: #ffd43b;
            color: #000;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        /* Story Progress Visualization */
        .story-progress {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            display: none;
        }

        .story-progress.active {
            display: block;
        }

        .progress-journey {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .journey-node {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin: 0 5px;
            transition: all 0.3s;
        }

        .journey-node.completed {
            background: #51cf66;
            color: white;
        }

        .journey-node.current {
            background: #667eea;
            color: white;
            animation: pulse 2s infinite;
        }

        .journey-line {
            height: 2px;
            width: 40px;
            background: #e0e0e0;
        }

        .journey-line.completed {
            background: #51cf66;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Progress Garden Theme */
        .progress-garden {
            text-align: center;
            padding: 10px;
        }

        .garden-plant {
            font-size: 40px;
            transition: all 0.5s;
        }

        .garden-plant.seed { content: "🌱"; }
        .garden-plant.sprout { font-size: 50px; }
        .garden-plant.growing { font-size: 60px; }
        .garden-plant.blooming { font-size: 70px; }

        /* Progress Constellation Theme */
        .progress-constellation {
            position: relative;
            height: 100px;
            background: #1a1a2e;
            border-radius: 8px;
            overflow: hidden;
        }

        .star {
            position: absolute;
            color: #fff;
            font-size: 16px;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .chat-container, .feedback-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bot-message {
            background: #e8f0fe;
            padding: 15px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            max-width: 80%;
        }

        .bot-message.story-moment {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        .bot-message.about-me {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .user-message {
            background: #f0f4f8;
            padding: 15px;
            border-radius: 12px;
            border-left: 4px solid #764ba2;
            max-width: 80%;
            margin-left: auto;
            text-align: right;
        }

        .narrative-choice {
            background: #f8f9fa;
            border: 2px solid #667eea;
            padding: 12px 20px;
            margin: 8px 4px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            display: block;
            width: calc(100% - 8px);
            color: #000 !important;
        }

        .narrative-choice:hover {
            background: #667eea;
            color: #000 !important;
            transform: translateX(5px);
        }

        .narrative-choice::before {
            content: "→ ";
            font-weight: bold;
            margin-right: 8px;
        }

        .about-me-choice {
            background: #e8f0fe;
            border: 2px solid #667eea;
            padding: 10px 16px;
            margin: 6px 4px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            display: inline-block;
            color: #000 !important;
        }

        .about-me-choice:hover {
            background: #667eea;
            color: #000 !important;
        }

        .about-me-choice.selected {
            background: #667eea;
            color: #000 !important;
        }

        /* Story Moment Indicator */
        .story-moment-indicator {
            display: inline-flex;
            align-items: center;
            background: #ffc107;
            color: #856404;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-bottom: 8px;
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }

        .story-moment-indicator::before {
            content: "🌟 ";
            margin-right: 4px;
        }

        .about-me-indicator {
            display: inline-flex;
            align-items: center;
            background: #28a745;
            color: #000;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .about-me-indicator::before {
            content: "💚 ";
            margin-right: 4px;
        }

        /* Chapter Creation Modal */
        .chapter-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1050;
            overflow-y: auto;
        }

        .chapter-modal.active {
            display: flex;
        }

        .chapter-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .chapter-content h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .chapter-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .chapter-input:focus {
            border-color: #667eea;
            outline: none;
        }

        .about-me-connection {
            background: #e8f0fe;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .about-me-connection h4 {
            color: #667eea;
            margin-bottom: 8px;
        }

        .mood-arc {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .mood-node {
            font-size: 30px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .mood-node:hover {
            transform: scale(1.2);
        }

        .mood-node.selected {
            transform: scale(1.3);
            filter: brightness(1.2);
        }

        .input-section {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        input[type="text"], textarea {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Style for all buttons to ensure black text */
        button {
            padding: 12px 24px;
            background: #667eea;
            color: #000 !important;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        button:hover {
            background: #5a67d8;
            color: #000;
        }

        .feedback-header {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .feedback-header h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 5px;
        }

        .feedback-header p {
            font-size: 14px;
            color: #666;
        }

        .feedback-item {
            background: #f8f9fa;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
            font-size: 14px;
        }

        .feedback-timestamp {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .feedback-confirmation {
            background: #d4edda;
            border-left: 3px solid #28a745;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            font-size: 14px;
            animation: fadeIn 0.3s ease-in;
        }

        .goal-card {
            background: #fff3cd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }

        .goal-card h3 {
            color: #856404;
            margin-bottom: 5px;
        }

        .option-button {
            background: #e8f0fe;
            color: #000 !important;
            padding: 10px 20px;
            margin: 5px;
            border: 2px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option-button:hover {
            background: #667eea;
            color: #000 !important;
        }

        .typing-indicator {
            display: none;
            padding: 15px;
            background: #e8f0fe;
            border-radius: 12px;
            width: fit-content;
            margin-bottom: 15px;
        }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        .user-history {
            background: #e8f0fe;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            font-size: 12px;
            display: none;
        }

        .progress-indicator {
            background: #d4edda;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .safety-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #e8f0fe;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 999;
        }

        .safety-indicator::before {
            content: '🛡️';
            font-size: 16px;
        }

        .safety-alert {
            background: #fee;
            color: #c33;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .memory-header {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .memory-header h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 5px;
        }

        .memory-header p {
            font-size: 14px;
            color: #666;
        }

        .memory-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .memory-item {
            background: #f0f4f8;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
            position: relative;
            animation: fadeIn 0.3s ease-in;
        }

        .memory-item.concern {
            border-left-color: #ff6b6b;
        }

        .memory-item.goal {
            border-left-color: #51cf66;
        }

        .memory-item.value {
            border-left-color: #339af0;
        }

        .memory-item.education {
            border-left-color: #f59f00;
        }

        .memory-item.chapter {
            border-left-color: #9775fa;
            background: #f3f0ff;
        }

        .memory-item.about-me {
            border-left-color: #28a745;
            background: #e7f5e7;
        }

        .memory-type {
            font-size: 11px;
            text-transform: uppercase;
            color: #666;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .memory-content {
            font-size: 14px;
            color: #333;
            margin-bottom: 5px;
        }

        .memory-meta {
            font-size: 12px;
            color: #999;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .memory-actions {
            display: flex;
            gap: 10px;
        }

        .memory-action-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .memory-action-btn:hover {
            background: #e8f0fe;
            color: #000;
        }

        .memory-action-btn.delete {
            color: #ff6b6b;
        }

        .memory-action-btn.delete:hover {
            background: #fee;
        }

        .memory-edit-form {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            display: none;
        }

        .memory-edit-form.active {
            display: block;
        }

        .memory-edit-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .memory-edit-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .memory-edit-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            color: #000;
        }

        .memory-edit-btn.save {
            background: #667eea;
            color: #000;
        }

        .memory-edit-btn.cancel {
            background: #e0e0e0;
            color: #666;
        }

        .memory-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .memory-filter-btn {
            padding: 6px 12px;
            border: 1px solid #e0e0e0;
            background: white;
            color: #000;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .memory-filter-btn.active {
            background: #667eea;
            color: #000;
            border-color: #667eea;
        }

        .memory-filter-btn:hover {
            border-color: #667eea;
        }

        .memory-summary {
            background: #e8f0fe;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
            line-height: 1.6;
        }

        .memory-summary-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .memory-item.new-item {
            animation: highlight 2s ease-in-out;
        }

        @keyframes highlight {
            0% {
                background-color: #ffd43b;
                transform: scale(1.02);
            }
            50% {
                background-color: #ffe066;
            }
            100% {
                background-color: #f0f4f8;
                transform: scale(1);
            }
        }

        .memory-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #667eea;
            color: #000;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            animation: slideIn 0.3s ease-out;
            z-index: 1100;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Document Review Styles */
        .variable-review-item {
            background: #f0f4f8;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .variable-review-item.selected {
            border-color: #51cf66;
            background: #e7f5e7;
        }

        .variable-review-item.conflict {
            border-color: #ffc107;
            background: #fff3cd;
        }

        .variable-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .variable-name {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .variable-type {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
        }

        .variable-value {
            color: #555;
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            font-size: 13px;
        }

        .variable-existing {
            background: #fee;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            font-size: 12px;
        }

        .variable-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .extraction-status {
            background: #e8f0fe;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        /* Responsive design */
        @media (min-width: 1201px) {
            .chat-section, .feedback-section, .memory-section {
                max-height: calc(100vh - 60px);
            }
        }

        @media (max-width: 1400px) {
            .container {
                flex-wrap: wrap;
                min-height: auto;
            }
            
            .chat-section {
                width: 100%;
                max-height: 700px;
                order: 1;
            }
            
            .memory-section {
                width: calc(60% - 10px);
                max-height: 600px;
                order: 2;
            }
            
            .feedback-section {
                width: calc(40% - 10px);
                max-height: 600px;
                order: 3;
            }
        }

        @media (max-width: 1200px) {
            body {
                overflow-y: auto;
            }
            
            .container {
                flex-direction: column;
                min-height: auto;
                max-width: 100%;
            }
            
            .chat-section, .memory-section, .feedback-section {
                width: 100%;
                max-height: 600px;
                margin-bottom: 20px;
                order: unset;
            }
            
            .chat-section {
                max-height: 700px;
            }
        }

        @media (max-width: 768px) {
            body {
                overflow-y: auto;
            }
            
            .container {
                padding: 10px;
                gap: 10px;
            }
            
            .memory-filters {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .memory-filter-btn {
                padding: 4px 10px;
                font-size: 11px;
                margin: 2px;
            }
            
            .memory-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .safety-indicator {
                bottom: 10px;
                right: 10px;
                font-size: 11px;
                padding: 8px 12px;
            }
            
            .memory-notification {
                top: 10px;
                right: 10px;
                left: 10px;
                font-size: 13px;
                padding: 10px 16px;
            }
            
            .chat-section, .memory-section, .feedback-section {
                max-height: 500px;
                margin-bottom: 15px;
            }
            
            .chat-section {
                max-height: 600px;
            }
            
            /* Adjust upload button position on mobile */
            div[style*="position: fixed; bottom: 70px"] {
                bottom: 120px !important;
                right: 10px !important;
            }
            
            div[style*="position: fixed; bottom: 70px"] button {
                padding: 8px 16px !important;
                font-size: 14px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="chat-section">
            <div class="header">
                <h1>🧠 Sofia - Your Brain Health Story Companion</h1>
                <p>Creating your personal brain health adventure</p>
                <div class="style-selector">
                    <button onclick="toggleStyleMenu()">🎨 Story Style</button>
                    <div class="style-menu" id="styleMenu">
                        <div class="style-option active" onclick="setVisualStyle('journey')">🗺️ Journey Map</div>
                        <div class="style-option" onclick="setVisualStyle('garden')">🌱 Growing Garden</div>
                        <div class="style-option" onclick="setVisualStyle('constellation')">⭐ Star Builder</div>
                        <div class="style-option" onclick="setVisualStyle('simple')">📊 Simple Progress</div>
                    </div>
                </div>
            </div>
            <div class="story-progress" id="storyProgress">
                <!-- Progress visualization will be inserted here -->
            </div>
            <div class="chat-container" id="chatContainer">
                <div class="typing-indicator" id="typingIndicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            <div class="input-section">
                <div class="input-group">
                    <input type="text" id="userInput" placeholder="Type your message here..." />
                    <button onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>

        <div class="memory-section">
            <div class="memory-header">
                <h2>📖 Your Story Journal</h2>
                <p>Your brain health journey, captured in chapters</p>
                <p style="font-size: 11px; color: #888; margin-top: 5px;">✏️ Edit to refine your story | 🗑️ Delete unwanted memories | 📑 Create chapters</p>
            </div>
            <div class="memory-container">
                <!-- About Me Summary Section -->
                <div class="about-me-summary" id="aboutMeSummary" style="display: none;">
                    <h3>💚 What Matters Most to You</h3>
                    <div id="aboutMeContent"></div>
                </div>
                
        <div class="memory-summary" id="memorySummary">
            <div class="memory-summary-stat">
                <span>Active Goals:</span>
                <strong id="activeGoalsCount">0</strong>
        </div>
        <div class="memory-summary-stat">
                <span>Story Chapters:</span>
                <strong id="chaptersCount">0</strong>
        </div>
        <div class="memory-summary-stat">
                <span>Topics Explored:</span>
                <strong id="topicsCount">0</strong>
        </div>
        <div class="memory-summary-stat">
                <span>About Me - Living My Best Life:</span>
                <strong id="bestLifeCount">0</strong>
        </div>
        <div class="memory-summary-stat">
                <span>About Me - Key Concerns:</span>
                <strong id="concernsCount">0</strong>
        </div>
    </div>
                <div class="memory-filters">
                    <button class="memory-filter-btn active" onclick="filterMemory('all')">All</button>
                    <button class="memory-filter-btn" onclick="filterMemory('about-me')">About Me</button>
                    <button class="memory-filter-btn" onclick="filterMemory('chapter')">Chapters</button>
                    <button class="memory-filter-btn" onclick="filterMemory('goal')">Goals</button>
                    <button class="memory-filter-btn" onclick="filterMemory('concern')">Concerns</button>
                    <button class="memory-filter-btn" onclick="filterMemory('value')">Values</button>
                    <button class="memory-filter-btn" onclick="filterMemory('education')">Learning</button>
                </div>
                <div id="memoryList"></div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                    <button class="memory-action-btn" onclick="createStoryCompilation()" style="margin-right: 10px;">📚 Create Story</button>
                    <button class="memory-action-btn" onclick="downloadMemorySummary()" style="margin-right: 10px;">📄 Export Summary</button>
                    <button class="memory-action-btn" onclick="downloadUserHistory()" style="margin-right: 10px;">📥 Export All Data</button>
                    <button class="memory-action-btn delete" onclick="clearAllData()">🗑️ Clear All Data</button>
                </div>
            </div>
        </div>

        <div class="feedback-section">
            <div class="feedback-header">
                <h2>💭 Share Your Thoughts</h2>
                <p>Help us improve your story experience</p>
            </div>
            <div class="feedback-container" id="feedbackContainer"></div>
            <div class="input-section">
                <textarea id="feedbackInput" placeholder="How was this conversation? Any suggestions?" rows="3"></textarea>
                <button onclick="submitFeedback()" style="margin-top: 10px; width: 100%;">Submit Feedback</button>
            </div>
        </div>
    </div>
    
    <div class="safety-indicator" id="safetyIndicator">
        Your conversation is monitored for safety
    </div>

    <!-- Document Upload Button -->
    <div style="position: fixed; bottom: 70px; right: 20px; z-index: 999;">
        <button onclick="openDocumentUpload()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 25px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 18px;">📄</span>
            <span>Upload Document</span>
        </button>
        <input type="file" id="documentUpload" accept=".txt,.pdf,.doc,.docx,.json,.csv" style="display: none;" onchange="handleDocumentUpload(event)">
    </div>

    <!-- Document Review Modal -->
    <div class="chapter-modal" id="documentReviewModal">
        <div class="chapter-content" style="max-width: 800px; max-height: 90vh;">
            <h2>📄 Review Extracted Information</h2>
            <p style="font-size: 14px; color: #666; margin-bottom: 20px;">
                I've extracted the following information from your document. Please review and approve what you'd like to add to your profile.
            </p>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                <button onclick="selectAllExtracted()" style="background: #51cf66; padding: 8px 16px; font-size: 14px;">
                    ✅ Select All
                </button>
                <button onclick="deselectAllExtracted()" style="background: #ff6b6b; padding: 8px 16px; font-size: 14px;">
                    ❌ Deselect All
                </button>
            </div>
            
            <div id="extractedVariablesList" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                <!-- Extracted variables will be shown here -->
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="closeDocumentReview()">Cancel</button>
                <button onclick="applySelectedVariables()" style="background: #51cf66; color: #000;">
                    Apply Selected to Profile
                </button>
            </div>
        </div>
    </div>

    <!-- Chapter Creation Modal -->
    <div class="chapter-modal" id="chapterModal">
        <div class="chapter-content">
            <h2>Create Your Chapter</h2>
            
            <div class="about-me-connection" id="chapterAboutMeConnection" style="display: none;">
                <h4>This chapter connects to what matters most:</h4>
                <div id="chapterAboutMeLinks"></div>
            </div>
            
            <input type="text" class="chapter-input" id="chapterTitle" placeholder="Chapter Title...">
            <textarea class="chapter-input" id="chapterMoment" placeholder="Describe the key moment..." rows="3"></textarea>
            
            <p style="margin-top: 15px; font-size: 14px; color: #666;">Your emotional journey:</p>
            <div class="mood-arc">
                <div class="mood-node" onclick="selectMood(0, '😔')">😔</div>
                <div class="mood-node" onclick="selectMood(1, '😐')">😐</div>
                <div class="mood-node" onclick="selectMood(2, '😊')">😊</div>
                <div class="mood-node" onclick="selectMood(3, '😄')">😄</div>
                <div class="mood-node" onclick="selectMood(4, '🌟')">🌟</div>
            </div>
            
            <textarea class="chapter-input" id="chapterChoices" placeholder="What choices led to this moment?" rows="3"></textarea>
            <textarea class="chapter-input" id="chapterLearning" placeholder="What did you learn?" rows="3"></textarea>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="closeChapterModal()">Cancel</button>
                <button onclick="saveChapter()" style="background: #51cf66; color: #000;">Save Chapter</button>
            </div>
        </div>
    </div>

    <script>
        // Sofia - Cognitive Care Companion Configuration with About Me Care Model
        const companionConfig = {
            identity: {
                name: "Sofia",
                role: "Brain Health Story Companion",
                mission: "Guide you in creating your personal brain health transformation story centered on what matters most to you",
                approach: "Narrative-focused, empowering, using second-person perspective, About Me-centered"
            },
            targetAudience: "Adults aged 55 and older",
            aboutMeFramework: {
                bestLifeElements: [
                    "Spend time with people I care about",
                    "Live on my own / be independent",
                    "Take care of my daily needs",
                    "Exercise or play games regularly",
                    "Participate in favorite hobbies",
                    "Spend time outdoors or travel",
                    "Work, volunteer, or help others",
                    "Spend time with pets",
                    "Have mental stimulation everyday"
                ],
                concernCategories: [
                    "Getting help with daily tasks",
                    "My ability to live on my own",
                    "My safety",
                    "My finances",
                    "My anxiety",
                    "Losing interest in hobbies",
                    "My diet",
                    "Being lost or disoriented",
                    "My sleep",
                    "Alcohol or tobacco use",
                    "My balance, falling",
                    "My hearing or vision",
                    "Being alone",
                    "Being a burden",
                    "Quality of care I receive"
                ],
                confidenceLevels: ["Very confident", "Somewhat confident", "Not very confident"]
            },
            narrativeFramework: {
                core: "SAFEST BRAINS",
                topics: {
                    S: "Sleep optimization narratives",
                    A: "Activity and exercise stories",
                    F: "Food and nutrition choices",
                    E: "Education through interactive learning",
                    S2: "Social connection chapters",
                    T: "Tobacco/substance avoidance paths"
                }
            },
            storyElements: {
                momentRecognition: true,
                chapterCreation: true,
                visualJournal: true,
                progressMetaphors: ["journey", "garden", "constellation", "simple"]
            }
        };

        // Story Moment Recognition Patterns
        const storyMomentPatterns = {
            emotionalTransitions: [
                /i used to .* but now/i,
                /something changed when/i,
                /i realized that/i,
                /for the first time/i,
                /different than before/i,
                /surprising myself/i
            ],
            decisionPoints: [
                /i had to choose/i,
                /i decided to/i,
                /i'm considering/i,
                /instead of .* i/i,
                /i chose/i,
                /i picked/i
            ],
            breakthroughs: [
                /i never thought i could/i,
                /it finally clicked/i,
                /breakthrough/i,
                /aha moment/i,
                /everything changed/i,
                /i discovered/i
            ],
            victories: [
                /i actually did it/i,
                /i succeeded/i,
                /proud of myself/i,
                /i managed to/i,
                /accomplishment/i,
                /achieved/i
            ]
        };

        // Current visual style
        let currentVisualStyle = 'journey';
        let storyMoments = [];
        let userChapters = [];
        let currentMoodArc = [];

        // About Me tracking
        let selectedBestLifeElements = [];
        let selectedConcerns = [];
        let isAboutMeComplete = false;

        // Human-in-the-Loop Safety Monitoring Configuration (kept from original)
        const safetyMonitoring = {
            // Emergency keywords requiring immediate intervention
            emergencyKeywords: [
                "suicide", "kill myself", "end my life", "hurt myself", "harm myself",
                "emergency", "chest pain", "can't breathe", "cant breathe", "bleeding",
                "collapsed", "unconscious", "seizure", "stroke", "heart attack",
                "help me", "dying", "911", "999", "ambulance"
            ],
            
            // Emotional distress indicators
            distressKeywords: [
                "hopeless", "helpless", "overwhelmed", "desperate", "miserable",
                "unbearable", "terrible", "can't cope", "cant cope", "give up",
                "too much", "lost", "alone", "lonely", "abandoned", "scared",
                "frightened", "terrified", "worthless", "burden"
            ],
            
            // Frustration indicators
            frustrationKeywords: [
                "frustrated", "annoying", "useless", "stupid", "waste of time",
                "not helpful", "doesn't work", "doesnt work", "doesn't understand",
                "doesnt understand", "not understanding", "pointless", "going in circles",
                "talking to a wall", "not getting anywhere", "ridiculous", "tired of this",
                "fed up", "unhelpful", "confused", "this isn't working", "this isnt working",
                "can't help", "cant help", "stop", "quit", "end this"
            ],
            
            // Repetition indicators
            repetitionIndicators: [
                "i already said", "i told you", "as i said", "like i said",
                "i mentioned", "i just told you", "again", "repeating myself",
                "said earlier", "keep saying", "once more", "one more time"
            ],
            
            // Inclusion/bias concerns
            inclusionKeywords: [
                "racist", "sexist", "discrimination", "biased", "unfair",
                "prejudice", "stereotype", "offensive", "inappropriate",
                "disrespectful", "insensitive"
            ],
            
            // Clinician contact info (would be loaded from secure config in production)
            clinicianInfo: {
                name: "Dr. Sarah Thompson",
                id: "clinician_001",
                email: "sarah.thompson@healthsystem.org",
                phone: "555-0123",
                preferredContact: "dashboard"
            }
        };

        // Safety monitoring data structure
        let safetyData = {
            triggers: [],
            interventions: [],
            contentMisalignments: [],
            sessionRiskProfile: {
                overallRiskLevel: "low",
                dominantConcerns: [],
                escalationPattern: false,
                requiresFollowUp: false
            }
        };

        // Function to create default user history structure
        function createDefaultUserHistory() {
            return {
                // Basic Profile
                profile: {
                    name: "",
                    age: "",
                    registrationDate: new Date().toISOString(),
                    lastVisit: null,
                    totalSessions: 0
                },

                // About Me Profile (NEW)
                aboutMe: {
                    bestLifeElements: [],
                    concerns: [],
                    confidenceLevel: "",
                    confidenceTimestamp: null,
                    userDefinedNextSteps: [],
                    profileCompleteness: 0,
                    lastUpdated: null,
                    updateFrequency: "monthly"
                },

                // Story Elements
                storyChapters: [],
                storyMoments: [],
                visualStyle: "journey",

                // Original tracking elements
                concerns: [],  
                values: [],    
                whatMattersMost: [],  
                goals: [],     
                educationTopics: [],  
                actionPlans: [],  
                
                // Social Context
                socialContext: {
                    livingArrangement: "",
                    supportSystem: [],
                    socialActivities: []
                },
                
                // Health & Lifestyle
                healthFactors: {
                    physicalActivity: "",
                    sleepQuality: "",
                    dietQuality: "",
                    medicalConditions: [],
                    medications: []
                },
                
                // Cognitive Status
                cognitiveStatus: {
                    selfReportedChanges: [],
                    strengths: [],
                    challenges: []
                },
                
                // Emotional State Tracking
                emotionalStates: [],  
                
                // Session Summaries
                sessions: []  
            };
        }

        // Initialize with default structure
        let userHistory = createDefaultUserHistory();

        // Visual style functions
        function toggleStyleMenu() {
            const menu = document.getElementById('styleMenu');
            menu.classList.toggle('active');
        }

        function setVisualStyle(style) {
            currentVisualStyle = style;
            userHistory.visualStyle = style;
            saveUserHistory();
            
            // Update menu
            document.querySelectorAll('.style-option').forEach(option => {
                option.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Hide menu
            document.getElementById('styleMenu').classList.remove('active');
            
            // Update progress display
            updateProgressVisualization();
            
            showBotMessage(`You've chosen the ${getStyleName(style)} style for your journey. I love it!`);
        }

        function getStyleName(style) {
            const names = {
                'journey': 'Journey Map',
                'garden': 'Growing Garden',
                'constellation': 'Star Builder',
                'simple': 'Simple Progress'
            };
            return names[style] || style;
        }

        function updateProgressVisualization() {
            const progressDiv = document.getElementById('storyProgress');
            progressDiv.classList.add('active');
            
            switch(currentVisualStyle) {
                case 'journey':
                    progressDiv.innerHTML = createJourneyVisualization();
                    break;
                case 'garden':
                    progressDiv.innerHTML = createGardenVisualization();
                    break;
                case 'constellation':
                    progressDiv.innerHTML = createConstellationVisualization();
                    break;
                case 'simple':
                    progressDiv.innerHTML = createSimpleVisualization();
                    break;
            }
        }

        function createJourneyVisualization() {
            const totalGoals = userHistory.goals.length;
            const completedGoals = userHistory.goals.filter(g => g.status === 'completed').length;
            const chapters = userHistory.storyChapters.length;
            
            let html = '<div class="progress-journey">';
            html += '<div class="journey-node completed">🏠</div>';
            html += '<div class="journey-line completed"></div>';
            
            for (let i = 0; i < 3; i++) {
                if (i < chapters) {
                    html += '<div class="journey-node completed">📖</div>';
                } else if (i === chapters) {
                    html += '<div class="journey-node current">✨</div>';
                } else {
                    html += '<div class="journey-node">?</div>';
                }
                
                if (i < 2) {
                    html += `<div class="journey-line ${i < chapters ? 'completed' : ''}"></div>`;
                }
            }
            
            html += '<div class="journey-line"></div>';
            html += '<div class="journey-node">🏆</div>';
            html += '</div>';
            
            return html;
        }

        function createGardenVisualization() {
            const growth = Math.min(userHistory.goals.length + userHistory.storyChapters.length, 4);
            const stages = ['🌱', '🌿', '🌳', '🌸'];
            
            return `
                <div class="progress-garden">
                    <div class="garden-plant" style="font-size: ${40 + (growth * 10)}px;">
                        ${stages[growth] || stages[0]}
                    </div>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        Your story is ${growth === 0 ? 'just beginning' : growth === 4 ? 'blooming beautifully' : 'growing stronger'}
                    </p>
                </div>
            `;
        }

        function createConstellationVisualization() {
            let html = '<div class="progress-constellation">';
            const achievements = userHistory.goals.filter(g => g.status === 'completed').length + 
                              userHistory.storyChapters.length;
            
            for (let i = 0; i < achievements; i++) {
                const left = Math.random() * 80 + 10;
                const top = Math.random() * 80 + 10;
                html += `<div class="star" style="left: ${left}%; top: ${top}%;">⭐</div>`;
            }
            
            html += '</div>';
            return html;
        }

        function createSimpleVisualization() {
            const activeGoals = userHistory.goals.filter(g => g.status === 'active').length;
            const completedGoals = userHistory.goals.filter(g => g.status === 'completed').length;
            const chapters = userHistory.storyChapters.length;
            
            return `
                <div style="padding: 10px; text-align: center;">
                    <span style="margin: 0 10px;">📖 ${chapters} Chapters</span>
                    <span style="margin: 0 10px;">🎯 ${activeGoals} Active Goals</span>
                    <span style="margin: 0 10px;">✅ ${completedGoals} Completed</span>
                </div>
            `;
        }

        // About Me functions
        function updateAboutMeSummary() {
            const summary = document.getElementById('aboutMeSummary');
            const content = document.getElementById('aboutMeContent');
            
            if (!userHistory.aboutMe || 
                (userHistory.aboutMe.bestLifeElements.length === 0 && 
                 userHistory.aboutMe.concerns.length === 0)) {
                summary.style.display = 'none';
                return;
            }
            
            summary.style.display = 'block';
            content.innerHTML = '';
            
            // Best Life Elements
            if (userHistory.aboutMe.bestLifeElements.length > 0) {
                userHistory.aboutMe.bestLifeElements.forEach(element => {
                    const div = document.createElement('div');
                    div.className = 'about-me-item best-life';
                    div.innerHTML = `<span>🌟</span> ${element.element}`;
                    content.appendChild(div);
                });
            }
            
            // Concerns
            if (userHistory.aboutMe.concerns.length > 0) {
                userHistory.aboutMe.concerns.forEach(concern => {
                    const div = document.createElement('div');
                    div.className = 'about-me-item concern';
                    div.innerHTML = `<span>🤔</span> ${concern.concern}`;
                    content.appendChild(div);
                });
            }
            
            // Confidence Level
            if (userHistory.aboutMe.confidenceLevel) {
                const div = document.createElement('div');
                div.style.marginTop = '10px';
                div.innerHTML = `<span class="confidence-badge">${userHistory.aboutMe.confidenceLevel}</span>`;
                content.appendChild(div);
            }
        }

        // Story moment detection
        function detectStoryMoment(message) {
            const lowerMessage = message.toLowerCase();
            
            for (const [type, patterns] of Object.entries(storyMomentPatterns)) {
                for (const pattern of patterns) {
                    if (pattern.test(message)) {
                        return {
                            type: type,
                            content: message,
                            timestamp: new Date().toISOString(),
                            pattern: pattern.toString()
                        };
                    }
                }
            }
            return null;
        }

        // Chapter creation functions
        function openChapterModal(moment) {
            document.getElementById('chapterModal').classList.add('active');
            if (moment) {
                document.getElementById('chapterMoment').value = moment.content;
            }
            
            // Show About Me connections
            showChapterAboutMeConnections();
            
            currentMoodArc = [];
        }

        function showChapterAboutMeConnections() {
            const connectionDiv = document.getElementById('chapterAboutMeConnection');
            const linksDiv = document.getElementById('chapterAboutMeLinks');
            
            if (userHistory.aboutMe && userHistory.aboutMe.bestLifeElements.length > 0) {
                connectionDiv.style.display = 'block';
                linksDiv.innerHTML = '';
                
                userHistory.aboutMe.bestLifeElements.slice(0, 3).forEach(element => {
                    const span = document.createElement('span');
                    span.style.cssText = 'display: inline-block; background: #e8f0fe; padding: 4px 8px; margin: 2px; border-radius: 4px; font-size: 12px;';
                    span.textContent = element.element;
                    linksDiv.appendChild(span);
                });
            } else {
                connectionDiv.style.display = 'none';
            }
        }

        function closeChapterModal() {
            document.getElementById('chapterModal').classList.remove('active');
            document.getElementById('chapterTitle').value = '';
            document.getElementById('chapterMoment').value = '';
            document.getElementById('chapterChoices').value = '';
            document.getElementById('chapterLearning').value = '';
            currentMoodArc = [];
            document.querySelectorAll('.mood-node').forEach(node => node.classList.remove('selected'));
        }

        function selectMood(index, mood) {
            currentMoodArc[index] = mood;
            document.querySelectorAll('.mood-node').forEach((node, i) => {
                if (i === index) {
                    node.classList.add('selected');
                } else {
                    node.classList.remove('selected');
                }
            });
        }

        function saveChapter() {
            const title = document.getElementById('chapterTitle').value.trim();
            const moment = document.getElementById('chapterMoment').value.trim();
            const choices = document.getElementById('chapterChoices').value.trim();
            const learning = document.getElementById('chapterLearning').value.trim();
            
            if (!title || !moment) {
                alert('Please provide at least a title and key moment for your chapter.');
                return;
            }
            
            const chapter = {
                title: title,
                moment: moment,
                moodArc: currentMoodArc.length > 0 ? currentMoodArc : ['😐'],
                choices: choices,
                learning: learning,
                timestamp: new Date().toISOString(),
                linkedBestLifeElements: userHistory.aboutMe.bestLifeElements.map(e => e.element)
            };
            
            userHistory.storyChapters.push(chapter);
            saveUserHistory();
            updateMemoryDisplay(true);
            
            // About Me-aware response
            let response = `Beautiful! You've created a new chapter: "${title}". `;
            if (userHistory.aboutMe.bestLifeElements.length > 0) {
                response += `This moment connects to what matters most to you - ${userHistory.aboutMe.bestLifeElements[0].element}. `;
            }
            response += `Your story continues to unfold. 📖✨`;
            
            showBotMessage(response);
            
            closeChapterModal();
        }

        // Create story compilation
        function createStoryCompilation() {
            if (userHistory.storyChapters.length === 0) {
                showBotMessage("You haven't created any chapters yet. As we continue our conversations, I'll help you capture meaningful moments to build your story.");
                return;
            }
            
            let story = `📚 Your Brain Health Story\n\n`;
            story += `By ${userHistory.profile.name || 'A Brave Storyteller'}\n\n`;
            
            // Add About Me section
            if (userHistory.aboutMe && userHistory.aboutMe.bestLifeElements.length > 0) {
                story += `What Matters Most to Me:\n`;
                userHistory.aboutMe.bestLifeElements.forEach(element => {
                    story += `• ${element.element}\n`;
                });
                story += `\n`;
            }
            
            userHistory.storyChapters.forEach((chapter, index) => {
                story += `Chapter ${index + 1}: ${chapter.title}\n`;
                story += `━━━━━━━━━━━━━━━━━━━━\n\n`;
                story += `${chapter.moment}\n\n`;
                
                if (chapter.choices) {
                    story += `Choices Made: ${chapter.choices}\n\n`;
                }
                
                if (chapter.learning) {
                    story += `What I Learned: ${chapter.learning}\n\n`;
                }
                
                story += `Mood Journey: ${chapter.moodArc.join(' → ')}\n\n\n`;
            });
            
            // Create and download
            const blob = new Blob([story], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `my-brain-health-story-${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            
            showBotMessage("I've compiled your chapters into a complete story! Check your downloads folder to read your brain health journey. 📖");
        }

        // Enhanced load user history with migration
        function loadUserHistory() {
            const saved = localStorage.getItem('sofiaUserHistory');
            if (saved) {
                try {
                    const loadedHistory = JSON.parse(saved);
                    
                    // Create a new default structure
                    const defaultHistory = createDefaultUserHistory();
                    
                    // Merge loaded data with default structure to ensure all properties exist
                    userHistory = mergeDeep(defaultHistory, loadedHistory);
                    
                    // Ensure critical arrays exist
                    if (!Array.isArray(userHistory.storyChapters)) userHistory.storyChapters = [];
                    if (!Array.isArray(userHistory.storyMoments)) userHistory.storyMoments = [];
                    if (!Array.isArray(userHistory.concerns)) userHistory.concerns = [];
                    if (!Array.isArray(userHistory.goals)) userHistory.goals = [];
                    if (!Array.isArray(userHistory.values)) userHistory.values = [];
                    if (!Array.isArray(userHistory.educationTopics)) userHistory.educationTopics = [];
                    if (!Array.isArray(userHistory.actionPlans)) userHistory.actionPlans = [];
                    if (!Array.isArray(userHistory.emotionalStates)) userHistory.emotionalStates = [];
                    if (!Array.isArray(userHistory.sessions)) userHistory.sessions = [];
                    if (!Array.isArray(userHistory.whatMattersMost)) userHistory.whatMattersMost = [];
                    
                    // Ensure About Me structure exists
                    if (!userHistory.aboutMe) {
                        userHistory.aboutMe = defaultHistory.aboutMe;
                    } else {
                        if (!Array.isArray(userHistory.aboutMe.bestLifeElements)) userHistory.aboutMe.bestLifeElements = [];
                        if (!Array.isArray(userHistory.aboutMe.concerns)) userHistory.aboutMe.concerns = [];
                        if (!Array.isArray(userHistory.aboutMe.userDefinedNextSteps)) userHistory.aboutMe.userDefinedNextSteps = [];
                    }
                    
                    // Load safety data if it exists
                    if (loadedHistory.safetyData) {
                        safetyData = loadedHistory.safetyData;
                    }
                    
                    // Set visual style if saved
                    if (loadedHistory.visualStyle) {
                        currentVisualStyle = loadedHistory.visualStyle;
                    }
                    
                    // Check if About Me is complete
                    isAboutMeComplete = userHistory.aboutMe.profileCompleteness > 0;
                    
                    console.log('User history loaded and migrated successfully');
                    return true;
                } catch (error) {
                    console.error('Error loading user history:', error);
                    // If there's an error, start fresh
                    userHistory = createDefaultUserHistory();
                    return false;
                }
            }
            return false;
        }

        // Deep merge function to handle nested objects
        function mergeDeep(target, source) {
            const output = Object.assign({}, target);
            if (isObject(target) && isObject(source)) {
                Object.keys(source).forEach(key => {
                    if (isObject(source[key])) {
                        if (!(key in target))
                            Object.assign(output, { [key]: source[key] });
                        else
                            output[key] = mergeDeep(target[key], source[key]);
                    } else {
                        Object.assign(output, { [key]: source[key] });
                    }
                });
            }
            return output;
        }

        function isObject(item) {
            return item && typeof item === 'object' && !Array.isArray(item);
        }

        // Save user history to localStorage
        async function saveUserHistory() {
            // Save to localStorage as backup
            localStorage.setItem('sofiaUserHistory', JSON.stringify(userHistory));
            
            // If API is available, sync specific changes
            if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                try {
                    // Update session if in progress
                    if (currentSessionId && typeof SofiaAPI !== 'undefined') {
                        const currentSession = userHistory.sessions[userHistory.sessions.length - 1];
                        if (currentSession) {
                            await SofiaAPI.updateSession(
                                currentSession.duration,
                                currentSession.mainTopics,
                                conversationLog
                            );
                        }
                    }
                } catch (error) {
                    console.error('Failed to sync with API:', error);
                }
            }
        }

        // About Me logging functions
        async function logBestLifeElement(element, priority = 1) {
            const previousElements = userHistory.aboutMe.bestLifeElements.map(e => e.element).join(', ');
            
            userHistory.aboutMe.bestLifeElements.push({
                element: element,
                priority: priority,
                timestamp: new Date().toISOString(),
                notes: ""
            });
            userHistory.aboutMe.lastUpdated = new Date().toISOString();
            updateAboutMeCompleteness();
            saveUserHistory();
            
            // Track in backend if available
            if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                try {
                    await SofiaAPI.trackProfileChange({
                        variableName: 'bestLifeElements',
                        variableValue: element,
                        previousValue: previousElements || null,
                        source: documentProcessing ? 'document' : 'conversation',
                        sourceDetails: {
                            priority: priority,
                            timestamp: new Date().toISOString()
                        }
                    });
                    
                    // Also update About Me via API
                    await SofiaAPI.updateAboutMe({
                        bestLifeElements: userHistory.aboutMe.bestLifeElements,
                        concerns: userHistory.aboutMe.concerns,
                        confidenceLevel: userHistory.aboutMe.confidenceLevel,
                        userDefinedNextSteps: userHistory.aboutMe.userDefinedNextSteps
                    });
                } catch (error) {
                    console.error('Failed to track best life element in backend:', error);
                }
            }
        }

        async function logAboutMeConcern(concern, severity = 'moderate') {
            const previousConcerns = userHistory.aboutMe.concerns.map(c => c.concern).join(', ');
            
            userHistory.aboutMe.concerns.push({
                concern: concern,
                severity: severity,
                timestamp: new Date().toISOString(),
                linkedToBestLife: [],
                notes: ""
            });
            userHistory.aboutMe.lastUpdated = new Date().toISOString();
            updateAboutMeCompleteness();
            saveUserHistory();
            
            // Track in backend if available
            if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                try {
                    await SofiaAPI.trackProfileChange({
                        variableName: 'aboutMeConcerns',
                        variableValue: concern,
                        previousValue: previousConcerns || null,
                        source: documentProcessing ? 'document' : 'conversation',
                        sourceDetails: {
                            severity: severity,
                            timestamp: new Date().toISOString()
                        }
                    });
                    
                    // Also update About Me via API
                    await SofiaAPI.updateAboutMe({
                        bestLifeElements: userHistory.aboutMe.bestLifeElements,
                        concerns: userHistory.aboutMe.concerns,
                        confidenceLevel: userHistory.aboutMe.confidenceLevel,
                        userDefinedNextSteps: userHistory.aboutMe.userDefinedNextSteps
                    });
                } catch (error) {
                    console.error('Failed to track About Me concern in backend:', error);
                }
            }
        }

        function updateAboutMeCompleteness() {
            let completeness = 0;
            if (userHistory.aboutMe.bestLifeElements.length > 0) completeness += 40;
            if (userHistory.aboutMe.concerns.length > 0) completeness += 40;
            if (userHistory.aboutMe.confidenceLevel) completeness += 20;
            userHistory.aboutMe.profileCompleteness = completeness;
        }

        // Enhanced logging functions with story elements
        async function logConcern(concern, severity = 'moderate', context = '') {
            // Get previous concerns for history tracking
            const previousConcerns = userHistory.concerns.map(c => c.concern).join(', ');
            
            userHistory.concerns.push({
                concern: concern,
                timestamp: new Date().toISOString(),
                severity: severity,
                context: context
            });
            saveUserHistory();
            
            // Track in backend if available
            if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                try {
                    await SofiaAPI.trackProfileChange({
                        variableName: 'concerns',
                        variableValue: concern,
                        previousValue: previousConcerns || null,
                        source: context.includes('document') ? 'document' : 'conversation',
                        sourceDetails: {
                            severity: severity,
                            context: context,
                            timestamp: new Date().toISOString()
                        }
                    });
                } catch (error) {
                    console.error('Failed to track concern in backend:', error);
                }
            }
        }

        async function logValue(value, importance = 'high') {
            const previousValues = userHistory.values.map(v => v.value).join(', ');
            
            userHistory.values.push({
                value: value,
                timestamp: new Date().toISOString(),
                importance: importance
            });
            saveUserHistory();
            
            // Track in backend if available
            if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                try {
                    await SofiaAPI.trackProfileChange({
                        variableName: 'values',
                        variableValue: value,
                        previousValue: previousValues || null,
                        source: 'conversation',
                        sourceDetails: {
                            importance: importance,
                            timestamp: new Date().toISOString()
                        }
                    });
                } catch (error) {
                    console.error('Failed to track value in backend:', error);
                }
            }
        }

        function logWhatMattersMost(matter) {
            userHistory.whatMattersMost.push({
                matter: matter,
                timestamp: new Date().toISOString()
            });
            saveUserHistory();
        }

        async function logGoal(goal, confidence = 7, linkedBestLifeElements = []) {
            const previousGoals = userHistory.goals.filter(g => g.status === 'active').map(g => g.goal).join(', ');
            
            userHistory.goals.push({
                goal: goal,
                setDate: new Date().toISOString(),
                confidence: confidence,
                status: 'active',
                progress: [],
                linkedBestLifeElements: linkedBestLifeElements
            });
            saveUserHistory();
            
            // Track in backend if available
            if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                try {
                    // Create goal via API
                    await SofiaAPI.createGoal({
                        goal: goal,
                        confidence: confidence,
                        linkedBestLifeElements: linkedBestLifeElements
                    });
                    
                    // Track as profile change
                    await SofiaAPI.trackProfileChange({
                        variableName: 'goals',
                        variableValue: goal,
                        previousValue: previousGoals || null,
                        source: 'conversation',
                        sourceDetails: {
                            confidence: confidence,
                            linkedElements: linkedBestLifeElements,
                            timestamp: new Date().toISOString()
                        }
                    });
                } catch (error) {
                    console.error('Failed to track goal in backend:', error);
                }
            }
        }

        function updateGoalProgress(goalIndex, progress, notes = '') {
            if (userHistory.goals[goalIndex]) {
                userHistory.goals[goalIndex].progress.push({
                    date: new Date().toISOString(),
                    progress: progress,
                    notes: notes
                });
                saveUserHistory();
            }
        }

        async function logEducationTopic(topic, engagement = 'moderate') {
            const previousTopics = userHistory.educationTopics.map(t => t.topic).join(', ');
            
            userHistory.educationTopics.push({
                topic: topic,
                timestamp: new Date().toISOString(),
                engagement: engagement
            });
            saveUserHistory();
            
            // Track in backend if available
            if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                try {
                    await SofiaAPI.trackProfileChange({
                        variableName: 'educationTopics',
                        variableValue: topic,
                        previousValue: previousTopics || null,
                        source: 'conversation',
                        sourceDetails: {
                            engagement: engagement,
                            timestamp: new Date().toISOString()
                        }
                    });
                } catch (error) {
                    console.error('Failed to track education topic in backend:', error);
                }
            }
        }

        function logActionPlan(action) {
            userHistory.actionPlans.push({
                action: action,
                timestamp: new Date().toISOString(),
                completed: false
            });
            saveUserHistory();
        }

        function logEmotionalState(state, trigger = '') {
            userHistory.emotionalStates.push({
                state: state,
                timestamp: new Date().toISOString(),
                trigger: trigger
            });
            saveUserHistory();
        }

        function logStoryMoment(moment) {
            userHistory.storyMoments.push(moment);
            saveUserHistory();
        }

        function startNewSession() {
            userHistory.profile.totalSessions++;
            userHistory.profile.lastVisit = new Date().toISOString();
            const sessionIndex = userHistory.sessions.length;
            userHistory.sessions.push({
                date: new Date().toISOString(),
                duration: 0,
                mainTopics: [],
                goalsSet: [],
                mood: 'neutral',
                notes: []
            });
            saveUserHistory();
            return sessionIndex;
        }

        function updateCurrentSession(updates) {
            const currentSession = userHistory.sessions[userHistory.sessions.length - 1];
            if (currentSession) {
                Object.assign(currentSession, updates);
                saveUserHistory();
            }
        }

        // Safety monitoring functions (kept from original)
        function analyzeSafetyTriggers(message) {
            const lowerMessage = message.toLowerCase();
            const detectedTriggers = [];
            
            // Check for emergency keywords
            safetyMonitoring.emergencyKeywords.forEach(keyword => {
                if (lowerMessage.includes(keyword)) {
                    detectedTriggers.push({
                        type: 'emergency',
                        severity: 'critical',
                        keyword: keyword,
                        context: extractContext(message, keyword),
                        timestamp: new Date().toISOString()
                    });
                }
            });
            
            // Check for distress keywords
            safetyMonitoring.distressKeywords.forEach(keyword => {
                if (lowerMessage.includes(keyword)) {
                    detectedTriggers.push({
                        type: 'distress',
                        severity: 'high',
                        keyword: keyword,
                        context: extractContext(message, keyword),
                        timestamp: new Date().toISOString()
                    });
                }
            });
            
            // Check for frustration
            safetyMonitoring.frustrationKeywords.forEach(keyword => {
                if (lowerMessage.includes(keyword)) {
                    detectedTriggers.push({
                        type: 'frustration',
                        severity: 'moderate',
                        keyword: keyword,
                        context: extractContext(message, keyword),
                        timestamp: new Date().toISOString()
                    });
                }
            });
            
            // Check for repetition
            safetyMonitoring.repetitionIndicators.forEach(phrase => {
                if (lowerMessage.includes(phrase)) {
                    detectedTriggers.push({
                        type: 'repetition',
                        severity: 'moderate',
                        keyword: phrase,
                        context: message,
                        timestamp: new Date().toISOString()
                    });
                }
            });
            
            // Check for inclusion concerns
            safetyMonitoring.inclusionKeywords.forEach(keyword => {
                if (lowerMessage.includes(keyword)) {
                    detectedTriggers.push({
                        type: 'inclusion',
                        severity: 'high',
                        keyword: keyword,
                        context: extractContext(message, keyword),
                        timestamp: new Date().toISOString()
                    });
                }
            });
            
            return detectedTriggers;
        }

        function extractContext(text, keyword, windowSize = 50) {
            const lowerText = text.toLowerCase();
            const keywordIndex = lowerText.indexOf(keyword.toLowerCase());
            if (keywordIndex === -1) return text;
            
            const start = Math.max(0, keywordIndex - windowSize);
            const end = Math.min(text.length, keywordIndex + keyword.length + windowSize);
            
            return '...' + text.slice(start, end) + '...';
        }

        async function handleSafetyTrigger(triggers) {
            if (triggers.length === 0) return null;
            
            // Log all triggers
            safetyData.triggers.push(...triggers);
            
            // Determine highest severity
            const severityOrder = ['critical', 'high', 'moderate', 'low'];
            const highestSeverity = triggers.reduce((max, trigger) => {
                const maxIndex = severityOrder.indexOf(max);
                const triggerIndex = severityOrder.indexOf(trigger.severity);
                return triggerIndex < maxIndex ? trigger.severity : max;
            }, 'low');
            
            // Update session risk profile
            safetyData.sessionRiskProfile.overallRiskLevel = highestSeverity;
            safetyData.sessionRiskProfile.dominantConcerns = [...new Set(triggers.map(t => t.type))];
            
            // Create intervention record
            const intervention = {
                timestamp: new Date().toISOString(),
                triggers: triggers,
                urgency: highestSeverity === 'critical' ? 'immediate' : highestSeverity === 'high' ? 'urgent' : 'standard',
                clinicianNotified: highestSeverity === 'critical' || highestSeverity === 'high',
                sessionId: currentSessionIndex
            };
            
            safetyData.interventions.push(intervention);
            
            // Send to API if available and severity is high/critical
            if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated() && 
                (highestSeverity === 'critical' || highestSeverity === 'high')) {
                try {
                    // Get the most severe trigger
                    const mostSevereTrigger = triggers.find(t => t.severity === highestSeverity);
                    await SofiaAPI.createSafetyEvent({
                        triggerType: mostSevereTrigger.type,
                        severity: highestSeverity,
                        keywords: triggers.map(t => t.keyword),
                        context: triggers.map(t => t.context).join(' | ')
                    });
                } catch (error) {
                    console.error('Failed to create safety event in API:', error);
                    // Save to offline queue
                    const offlineQueue = JSON.parse(localStorage.getItem('sofia_offline_queue') || '[]');
                    offlineQueue.push({ 
                        type: 'safetyEvent', 
                        data: {
                            triggerType: triggers[0].type,
                            severity: highestSeverity,
                            keywords: triggers.map(t => t.keyword),
                            context: triggers.map(t => t.context).join(' | ')
                        }, 
                        timestamp: new Date().toISOString() 
                    });
                    localStorage.setItem('sofia_offline_queue', JSON.stringify(offlineQueue));
                }
            }
            
            // Log to user history
            logEmotionalState(highestSeverity + '_safety_trigger', triggers.map(t => t.keyword).join(', '));
            
            // Simulate clinician alert (in production, this would send actual notifications)
            if (intervention.clinicianNotified) {
                console.error(`CLINICIAN ALERT: ${highestSeverity.toUpperCase()} safety trigger detected for ${userHistory.profile.name || 'User'}`);
                console.error('Triggers:', triggers);
                console.error('Recent conversation:', conversationLog.slice(-5));
            }
            
            // Return appropriate response based on trigger type
            return generateSafetyResponse(triggers, highestSeverity);
        }

        function generateSafetyResponse(triggers, severity) {
            const triggerTypes = triggers.map(t => t.type);
            const userName = userHistory.profile.name || 'friend';
            
            if (severity === 'critical') {
                if (triggerTypes.includes('emergency')) {
                    return `${userName}, this sounds like a medical emergency. Please call 911 immediately or have someone take you to the nearest emergency room. 

I've alerted ${safetyMonitoring.clinicianInfo.name} who will follow up with you as soon as possible. 

Your safety is my top priority. If you're experiencing chest pain, difficulty breathing, or any other severe symptoms, please don't wait - get help right now.`;
                }
            }
            
            if (triggerTypes.includes('distress')) {
                return `${userName}, I can see you're going through a really difficult time right now. Your feelings are valid, and you don't have to face this alone.

I've asked ${safetyMonitoring.clinicianInfo.name} to reach out to you right away. They're trained to provide the kind of support that can really help.

In the meantime, please remember:
• You are valued and important
• These intense feelings will pass
• Help is available and it's okay to reach out

If you need immediate support, you can call the crisis helpline at 988. Would you like me to share some breathing exercises that might help you feel a bit calmer right now?`;
            }
            
            if (triggerTypes.includes('frustration') || triggerTypes.includes('repetition')) {
                return `${userName}, I understand this is frustrating, and I apologize if I haven't been as helpful as you need. 

Let me try a different approach. I've also made a note for ${safetyMonitoring.clinicianInfo.name} to follow up with you to ensure you get the support you deserve.

Could you tell me in your own words what would be most helpful for you right now? I'm here to listen and support you.`;
            }
            
            if (triggerTypes.includes('inclusion')) {
                return `${userName}, I sincerely apologize if anything I've said has come across as biased or insensitive. That's never my intention, and I take your concern very seriously.

I've immediately flagged this conversation for ${safetyMonitoring.clinicianInfo.name} to review. They will follow up with you to address your concerns properly and ensure you receive respectful, inclusive support.

Your feedback helps me improve. Thank you for speaking up about this.`;
            }
            
            // Default safety response
            return `${userName}, I want to make sure you're getting the support you need. I've asked ${safetyMonitoring.clinicianInfo.name} to follow up with you about our conversation. They'll be in touch soon to provide additional help.`;
        }

        function checkContentAlignment(message) {
            // In production, this would check against evidence-based content
            const concerningStatements = [
                /cure/i,
                /guarantee/i,
                /medical advice/i,
                /stop taking/i,
                /don't need.*doctor/i,
                /replace.*medication/i
            ];
            
            let misalignments = [];
            concerningStatements.forEach(pattern => {
                if (pattern.test(message)) {
                    misalignments.push({
                        pattern: pattern.toString(),
                        context: message,
                        timestamp: new Date().toISOString()
                    });
                }
            });
            
            if (misalignments.length > 0) {
                safetyData.contentMisalignments.push(...misalignments);
                console.warn('Content alignment concerns detected:', misalignments);
            }
            
            return misalignments.length === 0;
        }

        // Update safety indicator UI
        function updateSafetyIndicator(riskLevel) {
            const indicator = document.getElementById('safetyIndicator');
            if (!indicator) return;
            
            if (riskLevel === 'critical' || riskLevel === 'high') {
                indicator.classList.add('safety-alert');
                indicator.textContent = 'Clinician has been notified';
            } else {
                indicator.classList.remove('safety-alert');
                indicator.textContent = 'Your conversation is monitored for safety';
            }
        }

        // Update session risk assessment
        function updateSessionRiskAssessment() {
            const recentTriggers = safetyData.triggers.filter(t => {
                const triggerTime = new Date(t.timestamp);
                const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
                return triggerTime > fiveMinutesAgo;
            });
            
            // Check for escalation pattern
            if (recentTriggers.length >= 3) {
                safetyData.sessionRiskProfile.escalationPattern = true;
                safetyData.sessionRiskProfile.requiresFollowUp = true;
            }
            
            // Update UI indicator
            updateSafetyIndicator(safetyData.sessionRiskProfile.overallRiskLevel);
            
            // Save safety data with user history
            userHistory.safetyData = safetyData;
            saveUserHistory();
        }

        // Memory display variables
        let currentMemoryFilter = 'all';
        let memoryDisplayList = [];

        // Update memory display
        function updateMemoryDisplay(highlightLatest = false) {
            const memoryList = document.getElementById('memoryList');
            if (!memoryList) return;
            
            memoryList.innerHTML = '';
            
            // Update About Me summary
            updateAboutMeSummary();
            
            // Collect all memory items
            memoryDisplayList = [];
            
            // Add About Me items (NEW)
            if (userHistory.aboutMe) {
                // Add best life elements as a single item
                if (userHistory.aboutMe.bestLifeElements.length > 0) {
                    memoryDisplayList.push({
                        type: 'about-me',
                        subtype: 'best-life',
                        content: `My Best Life: ${userHistory.aboutMe.bestLifeElements.map(e => e.element).join(', ')}`,
                        metadata: `${userHistory.aboutMe.bestLifeElements.length} elements`,
                        timestamp: userHistory.aboutMe.lastUpdated || new Date().toISOString(),
                        index: 0
                    });
                }
                
                // Add concerns as a single item
                if (userHistory.aboutMe.concerns.length > 0) {
                    memoryDisplayList.push({
                        type: 'about-me',
                        subtype: 'concerns',
                        content: `My Concerns: ${userHistory.aboutMe.concerns.map(c => c.concern).join(', ')}`,
                        metadata: `Confidence: ${userHistory.aboutMe.confidenceLevel || 'Not set'}`,
                        timestamp: userHistory.aboutMe.lastUpdated || new Date().toISOString(),
                        index: 1
                    });
                }
            }
            
            // Add story chapters
            if (userHistory.storyChapters && userHistory.storyChapters.length > 0) {
                userHistory.storyChapters.forEach((chapter, index) => {
                    memoryDisplayList.push({
                        type: 'chapter',
                        content: chapter.title,
                        metadata: `Mood: ${chapter.moodArc.join(' → ')}`,
                        timestamp: chapter.timestamp,
                        index: index,
                        fullChapter: chapter
                    });
                });
            }
            
            // Add concerns
            if (userHistory.concerns && userHistory.concerns.length > 0) {
                userHistory.concerns.forEach((concern, index) => {
                    memoryDisplayList.push({
                        type: 'concern',
                        content: concern.concern,
                        metadata: `Severity: ${concern.severity}`,
                        timestamp: concern.timestamp,
                        index: index,
                        context: concern.context
                    });
                });
            }
            
            // Add goals
            if (userHistory.goals && userHistory.goals.length > 0) {
                userHistory.goals.forEach((goal, index) => {
                    let metadata = `Confidence: ${goal.confidence}/10 | Status: ${goal.status}`;
                    if (goal.linkedBestLifeElements && goal.linkedBestLifeElements.length > 0) {
                        metadata += ` | Supports: ${goal.linkedBestLifeElements[0]}`;
                    }
                    memoryDisplayList.push({
                        type: 'goal',
                        content: goal.goal,
                        metadata: metadata,
                        timestamp: goal.setDate,
                        index: index,
                        progress: goal.progress
                    });
                });
            }
            
            // Add values
            if (userHistory.values && userHistory.values.length > 0) {
                userHistory.values.forEach((value, index) => {
                    memoryDisplayList.push({
                        type: 'value',
                        content: value.value,
                        metadata: `Importance: ${value.importance}`,
                        timestamp: value.timestamp,
                        index: index
                    });
                });
            }
            
            // Add education topics
            if (userHistory.educationTopics && userHistory.educationTopics.length > 0) {
                userHistory.educationTopics.forEach((topic, index) => {
                    memoryDisplayList.push({
                        type: 'education',
                        content: topic.topic.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                        metadata: `Engagement: ${topic.engagement}`,
                        timestamp: topic.timestamp,
                        index: index
                    });
                });
            }
            
            // Sort by timestamp (most recent first)
            memoryDisplayList.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Filter based on current filter
            const filteredList = currentMemoryFilter === 'all' 
                ? memoryDisplayList 
                : memoryDisplayList.filter(item => item.type === currentMemoryFilter);
            
            // Display items or empty state
            if (filteredList.length === 0) {
                memoryList.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px;">📝</div>
                        <div style="font-size: 14px;">
                            ${currentMemoryFilter === 'all' 
                                ? "No memories recorded yet. Let's start our conversation!" 
                                : `No ${currentMemoryFilter}s recorded yet.`}
                        </div>
                    </div>
                `;
            } else {
                filteredList.forEach((item, index) => {
                    const memoryItem = createMemoryItemElement(item);
                    if (highlightLatest && index === 0) {
                        memoryItem.classList.add('new-item');
                    }
                    memoryList.appendChild(memoryItem);
                });
                
                // Scroll to top if highlighting latest
                if (highlightLatest) {
                    const memoryContainer = memoryList.parentElement;
                    memoryContainer.scrollTop = 0;
                }
            }
            
            // Update summary
            updateMemorySummary();
        }

        // Create memory item element
        function createMemoryItemElement(item) {
            const div = document.createElement('div');
            div.className = `memory-item ${item.type}`;
            div.id = `memory-${item.type}-${item.index}`;
            
            const typeLabel = item.type === 'about-me' ? 'About Me' : item.type.charAt(0).toUpperCase() + item.type.slice(1);
            const timeAgo = getTimeAgo(item.timestamp);
            
            // Check if item has a user note or was edited
            let userNote = '';
            let lastEdited = null;
            let itemArray = [];
            
            switch(item.type) {
                case 'chapter':
                    itemArray = userHistory.storyChapters;
                    break;
                case 'concern':
                    itemArray = userHistory.concerns;
                    break;
                case 'goal':
                    itemArray = userHistory.goals;
                    break;
                case 'value':
                    itemArray = userHistory.values;
                    break;
                case 'education':
                    itemArray = userHistory.educationTopics;
                    break;
            }
            
            if (itemArray[item.index]) {
                userNote = itemArray[item.index].userNote || '';
                lastEdited = itemArray[item.index].lastEdited;
            }
            
            // Special handling for About Me items
            if (item.type === 'about-me') {
                div.innerHTML = `
                    <div class="memory-type">💚 ${typeLabel}${lastEdited ? ' <span style="font-size: 10px; color: #999;">(edited)</span>' : ''}</div>
                    <div class="memory-content">${item.content}</div>
                    <div class="memory-meta">
                        <span>${item.metadata} • ${timeAgo}</span>
                        <div class="memory-actions">
                            <button class="memory-action-btn" onclick="openAboutMeEditor()">Edit</button>
                        </div>
                    </div>
                `;
            }
            // Special handling for chapters
            else if (item.type === 'chapter') {
                div.innerHTML = `
                    <div class="memory-type">📖 ${typeLabel}${lastEdited ? ' <span style="font-size: 10px; color: #999;">(edited)</span>' : ''}</div>
                    <div class="memory-content" style="font-weight: bold;">${item.content}</div>
                    <div style="font-size: 12px; color: #666; margin-top: 4px;">${item.fullChapter.moment.substring(0, 100)}...</div>
                    <div class="memory-meta">
                        <span>${item.metadata} • ${timeAgo}</span>
                        <div class="memory-actions">
                            <button class="memory-action-btn" onclick="viewChapter(${item.index})">View</button>
                            <button class="memory-action-btn delete" onclick="deleteMemoryItem('${item.type}', ${item.index})">Delete</button>
                        </div>
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <div class="memory-type">${typeLabel}${lastEdited ? ' <span style="font-size: 10px; color: #999;">(edited)</span>' : ''}</div>
                    <div class="memory-content">${item.content}</div>
                    ${userNote ? `<div style="font-size: 12px; color: #666; margin-top: 4px; font-style: italic;">Note: ${userNote}</div>` : ''}
                    <div class="memory-meta">
                        <span>${item.metadata} • ${timeAgo}${lastEdited ? ` • Edited ${getTimeAgo(lastEdited)}` : ''}</span>
                        <div class="memory-actions">
                            <button class="memory-action-btn" onclick="editMemoryItem('${item.type}', ${item.index})">Edit</button>
                            <button class="memory-action-btn delete" onclick="deleteMemoryItem('${item.type}', ${item.index})">Delete</button>
                        </div>
                    </div>
                    <div class="memory-edit-form" id="edit-${item.type}-${item.index}">
                        <input type="text" class="memory-edit-input" id="edit-input-${item.type}-${item.index}" value="${item.content}">
                        <textarea class="memory-edit-input" id="edit-note-${item.type}-${item.index}" placeholder="Add a note or correction (optional)" rows="2">${userNote}</textarea>
                        <div class="memory-edit-actions">
                            <button class="memory-edit-btn cancel" onclick="cancelEdit('${item.type}', ${item.index})">Cancel</button>
                            <button class="memory-edit-btn save" onclick="saveEdit('${item.type}', ${item.index})">Save</button>
                        </div>
                    </div>
                `;
            }
            
            return div;
        }

        // Open About Me editor
        function openAboutMeEditor() {
            currentPhase = "about_me_edit";
            showBotMessage(
                `Let's update what matters most to you. This helps me provide better support aligned with your values and concerns.

Would you like to:`,
                [
                    "→ Update what makes life meaningful",
                    "→ Review your concerns",
                    "→ Change your confidence level",
                    "→ Add new priorities"
                ]
            );
        }

        // View chapter function
        function viewChapter(index) {
            const chapter = userHistory.storyChapters[index];
            if (!chapter) return;
            
            let chapterView = `📖 <strong>${chapter.title}</strong>\n\n${chapter.moment}`;
            
            if (chapter.choices) {
                chapterView += `\n\n<em>Choices Made:</em> ${chapter.choices}`;
            }
            
            if (chapter.learning) {
                chapterView += `\n\n<em>What You Learned:</em> ${chapter.learning}`;
            }
            
            chapterView += `\n\n<em>Your Journey:</em> ${chapter.moodArc.join(' → ')}`;
            
            if (chapter.linkedBestLifeElements && chapter.linkedBestLifeElements.length > 0) {
                chapterView += `\n\n<em>Connected to:</em> ${chapter.linkedBestLifeElements.join(', ')}`;
            }
            
            showBotMessage(chapterView);
        }

        // Get time ago string
        function getTimeAgo(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const seconds = Math.floor((now - then) / 1000);
            
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} min ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
            return `${Math.floor(seconds / 86400)} days ago`;
        }

        // Edit memory item
        function editMemoryItem(type, index) {
            const editForm = document.getElementById(`edit-${type}-${index}`);
            if (editForm) {
                editForm.classList.add('active');
            }
        }

        // Cancel edit
        function cancelEdit(type, index) {
            const editForm = document.getElementById(`edit-${type}-${index}`);
            if (editForm) {
                editForm.classList.remove('active');
                updateMemoryDisplay();
            }
        }

        // Save edit
        async function saveEdit(type, index) {
            const input = document.getElementById(`edit-input-${type}-${index}`);
            const noteInput = document.getElementById(`edit-note-${type}-${index}`);
            if (!input) return;
            
            const newValue = input.value.trim();
            const note = noteInput ? noteInput.value.trim() : '';
            if (!newValue) return;
            
            const editTimestamp = new Date().toISOString();
            let previousValue = null;
            
            // Update the appropriate array and track in backend
            switch(type) {
                case 'concern':
                    if (userHistory.concerns[index]) {
                        previousValue = userHistory.concerns[index].concern;
                        userHistory.concerns[index].concern = newValue;
                        if (note) userHistory.concerns[index].userNote = note;
                        userHistory.concerns[index].lastEdited = editTimestamp;
                        
                        // Track in backend
                        if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                            try {
                                await SofiaAPI.trackProfileChange({
                                    variableName: 'concern_edit',
                                    variableValue: newValue,
                                    previousValue: previousValue,
                                    source: 'manual_edit',
                                    sourceDetails: {
                                        editNote: note,
                                        editTimestamp: editTimestamp,
                                        itemIndex: index
                                    }
                                });
                            } catch (error) {
                                console.error('Failed to track concern edit:', error);
                            }
                        }
                        
                        showBotMessage(`I've updated your concern to: "${newValue}". ${note ? 'I\'ve also noted: "' + note + '"' : ''} Thank you for refining your story!`);
                    }
                    break;
                case 'goal':
                    if (userHistory.goals[index]) {
                        previousValue = userHistory.goals[index].goal;
                        userHistory.goals[index].goal = newValue;
                        if (note) userHistory.goals[index].userNote = note;
                        userHistory.goals[index].lastEdited = editTimestamp;
                        
                        // Track in backend
                        if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                            try {
                                await SofiaAPI.trackProfileChange({
                                    variableName: 'goal_edit',
                                    variableValue: newValue,
                                    previousValue: previousValue,
                                    source: 'manual_edit',
                                    sourceDetails: {
                                        editNote: note,
                                        editTimestamp: editTimestamp,
                                        itemIndex: index
                                    }
                                });
                            } catch (error) {
                                console.error('Failed to track goal edit:', error);
                            }
                        }
                        
                        showBotMessage(`I've updated your goal to: "${newValue}". ${note ? 'I\'ve noted: "' + note + '"' : ''} Your story continues to evolve!`);
                    }
                    break;
                case 'value':
                    if (userHistory.values[index]) {
                        previousValue = userHistory.values[index].value;
                        userHistory.values[index].value = newValue;
                        if (note) userHistory.values[index].userNote = note;
                        userHistory.values[index].lastEdited = editTimestamp;
                        
                        // Track in backend
                        if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                            try {
                                await SofiaAPI.trackProfileChange({
                                    variableName: 'value_edit',
                                    variableValue: newValue,
                                    previousValue: previousValue,
                                    source: 'manual_edit',
                                    sourceDetails: {
                                        editNote: note,
                                        editTimestamp: editTimestamp,
                                        itemIndex: index
                                    }
                                });
                            } catch (error) {
                                console.error('Failed to track value edit:', error);
                            }
                        }
                        
                        showBotMessage(`I've updated what matters to you: "${newValue}". ${note ? 'I understand: "' + note + '"' : ''} These values guide your journey!`);
                    }
                    break;
                case 'education':
                    if (userHistory.educationTopics[index]) {
                        previousValue = userHistory.educationTopics[index].topic;
                        userHistory.educationTopics[index].topic = newValue.toLowerCase().replace(/ /g, '_');
                        if (note) userHistory.educationTopics[index].userNote = note;
                        userHistory.educationTopics[index].lastEdited = editTimestamp;
                        
                        // Track in backend
                        if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                            try {
                                await SofiaAPI.trackProfileChange({
                                    variableName: 'education_topic_edit',
                                    variableValue: newValue,
                                    previousValue: previousValue,
                                    source: 'manual_edit',
                                    sourceDetails: {
                                        editNote: note,
                                        editTimestamp: editTimestamp,
                                        itemIndex: index
                                    }
                                });
                            } catch (error) {
                                console.error('Failed to track education topic edit:', error);
                            }
                        }
                        
                        showBotMessage(`I've updated the topic we explored: "${newValue}". ${note ? 'Your note: "' + note + '"' : ''}`);
                    }
                    break;
            }
            
            logActionPlan(`User edited ${type}: "${newValue}"`);
            
            saveUserHistory();
            updateMemoryDisplay();
            cancelEdit(type, index);
        }

        // Delete memory item
        function deleteMemoryItem(type, index) {
            const confirmDelete = confirm(`Are you sure you want to delete this ${type}?`);
            if (!confirmDelete) return;
            
            // Remove from the appropriate array
            switch(type) {
                case 'chapter':
                    userHistory.storyChapters.splice(index, 1);
                    showBotMessage("I've removed that chapter from your story. You can always create new chapters as your journey continues.");
                    break;
                case 'concern':
                    userHistory.concerns.splice(index, 1);
                    showBotMessage("I've removed that concern from your story. Your narrative continues to evolve.");
                    break;
                case 'goal':
                    userHistory.goals.splice(index, 1);
                    showBotMessage("I've removed that goal. New paths await in your story!");
                    break;
                case 'value':
                    userHistory.values.splice(index, 1);
                    showBotMessage("I've removed that from what matters to you in your story.");
                    break;
                case 'education':
                    userHistory.educationTopics.splice(index, 1);
                    showBotMessage("I've removed that topic from your learning journey.");
                    break;
            }
            
            saveUserHistory();
            updateMemoryDisplay();
        }

        // Filter memory display
        function filterMemory(filter) {
            currentMemoryFilter = filter;
            
            // Update button states
            document.querySelectorAll('.memory-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateMemoryDisplay();
        }

        // Update memory summary
        function updateMemorySummary() {
            const activeGoals = userHistory.goals ? userHistory.goals.filter(g => g.status === 'active').length : 0;
            const chapters = userHistory.storyChapters ? userHistory.storyChapters.length : 0;
            const topics = userHistory.educationTopics ? userHistory.educationTopics.length : 0;
            
            // NEW: Count About Me elements
            const bestLifeCount = userHistory.aboutMe && userHistory.aboutMe.bestLifeElements ? 
                userHistory.aboutMe.bestLifeElements.length : 0;
            const concernsCount = userHistory.aboutMe && userHistory.aboutMe.concerns ? 
                userHistory.aboutMe.concerns.length : 0;
            
            document.getElementById('activeGoalsCount').textContent = activeGoals;
            document.getElementById('chaptersCount').textContent = chapters;
            document.getElementById('topicsCount').textContent = topics;
            
            // NEW: Update About Me counts
            document.getElementById('bestLifeCount').textContent = bestLifeCount;
            document.getElementById('concernsCount').textContent = concernsCount;
        }

        // Show memory notification
        function showMemoryNotification(type, content) {
            const notification = document.createElement('div');
            notification.className = 'memory-notification';
            
            const typeLabel = type.charAt(0).toUpperCase() + type.slice(1);
            notification.innerHTML = `📝 Remembered ${typeLabel}: "${content}"`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Enhanced logging functions with real-time display and notifications
        const originalLogConcern = logConcern;
        logConcern = function(concern, severity = 'moderate', context = '') {
            originalLogConcern(concern, severity, context);
            updateMemoryDisplay(true);
            showMemoryNotification('concern', concern);
        };

        const originalLogGoal = logGoal;
        logGoal = function(goal, confidence = 7, linkedBestLifeElements = []) {
            const index = originalLogGoal(goal, confidence, linkedBestLifeElements);
            updateMemoryDisplay(true);
            showMemoryNotification('goal', goal);
            return index;
        };

        const originalLogValue = logValue;
        logValue = function(value, importance = 'high') {
            originalLogValue(value, importance);
            updateMemoryDisplay(true);
            showMemoryNotification('value', value);
        };

        const originalLogEducationTopic = logEducationTopic;
        logEducationTopic = function(topic, engagement = 'moderate') {
            originalLogEducationTopic(topic, engagement);
            updateMemoryDisplay(true);
            const displayTopic = topic.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            showMemoryNotification('education', displayTopic);
        };

        let conversationLog = [];
        let feedbackLog = [];
        let currentPhase = "initialization";
        let currentSessionIndex = -1;
        let isReturningUser = false;
        let optionButtonCounter = 0; // Counter for unique button IDs

        // Document upload variables
        let extractedVariables = [];
        let documentProcessing = false;

        // Profile variable mappings for intelligent extraction
        const profileVariableMappings = {
            // Personal Information
            name: ['name', 'full name', 'patient name', 'client name', 'first name', 'last name'],
            age: ['age', 'date of birth', 'dob', 'birth date', 'years old'],
            
            // Health Conditions
            medicalConditions: ['diagnosis', 'medical conditions', 'health conditions', 'conditions', 'diagnosed with', 'medical history'],
            medications: ['medications', 'prescriptions', 'drugs', 'medicine', 'taking', 'prescribed'],
            
            // Cognitive Concerns
            memoryConcerns: ['memory', 'forgetfulness', 'forgetting', 'memory loss', 'cognitive concerns', 'memory problems'],
            cognitiveStrengths: ['strengths', 'abilities', 'good at', 'capable of', 'independent in'],
            
            // Daily Living
            livingArrangement: ['living', 'residence', 'home', 'lives with', 'living arrangement', 'housing'],
            dailyActivities: ['activities', 'daily routine', 'hobbies', 'interests', 'enjoys', 'participates in'],
            
            // Social
            familySupport: ['family', 'relatives', 'children', 'spouse', 'partner', 'support system'],
            socialActivities: ['social', 'friends', 'groups', 'clubs', 'community', 'social activities'],
            
            // Goals and Values
            personalGoals: ['goals', 'wants to', 'hopes to', 'wishes', 'objectives', 'aims'],
            values: ['values', 'important to', 'matters most', 'priorities', 'believes in'],
            
            // Physical Health
            physicalActivity: ['exercise', 'physical activity', 'walking', 'movement', 'fitness'],
            dietNutrition: ['diet', 'nutrition', 'eating', 'meals', 'food preferences'],
            sleepPatterns: ['sleep', 'sleeping', 'insomnia', 'rest', 'bedtime'],
            
            // Safety Concerns
            safetyConcerns: ['safety', 'falls', 'balance', 'risks', 'concerns about', 'worried about'],
            
            // About Me Specific
            bestLifeElements: ['best life', 'meaningful', 'joy', 'fulfillment', 'happiness', 'quality of life'],
            concerns: ['concerns', 'worries', 'anxious about', 'afraid of', 'challenges']
        };

        // Document upload functions
        function openDocumentUpload() {
            document.getElementById('documentUpload').click();
        }

        async function handleDocumentUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            documentProcessing = true;
            showBotMessage("📄 I'm reading your document and extracting relevant information. This may take a moment...");
            
            try {
                const content = await readFileContent(file);
                const extracted = await extractProfileVariables(content, file.type);
                
                // Track upload if API is available
                let uploadId = null;
                if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                    try {
                        const uploadResult = await SofiaAPI.trackDocumentUpload({
                            filename: file.name,
                            fileType: file.type,
                            fileSize: file.size,
                            extractedCount: extracted.length,
                            metadata: {
                                processedAt: new Date().toISOString(),
                                extractionMethod: 'client-side'
                            }
                        });
                        uploadId = uploadResult.id;
                    } catch (error) {
                        console.error('Failed to track document upload:', error);
                    }
                }
                
                if (extracted.length > 0) {
                    extractedVariables = extracted;
                    extractedVariables.uploadId = uploadId; // Store for later update
                    showDocumentReview();
                } else {
                    showBotMessage("I couldn't find any relevant profile information in this document. Could you try a different document or tell me what information you'd like to add to your profile?");
                }
            } catch (error) {
                console.error('Document processing error:', error);
                showBotMessage("I had trouble reading your document. Please try again with a different file format (text, PDF, or Word documents work best).");
            } finally {
                documentProcessing = false;
                // Reset file input
                event.target.value = '';
            }
        }

        async function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    const content = e.target.result;
                    
                    if (file.type === 'application/pdf') {
                        // For PDF files, check if PDF.js is available
                        if (typeof pdfjsLib !== 'undefined') {
                            try {
                                const pdf = await pdfjsLib.getDocument({ data: content }).promise;
                                let fullText = '';
                                
                                for (let i = 1; i <= pdf.numPages; i++) {
                                    const page = await pdf.getPage(i);
                                    const textContent = await page.getTextContent();
                                    const pageText = textContent.items.map(item => item.str).join(' ');
                                    fullText += pageText + '\n';
                                }
                                
                                resolve(fullText);
                            } catch (error) {
                                reject(new Error('Could not parse PDF. Please try a text file instead.'));
                            }
                        } else {
                            reject(new Error('PDF reading is not available. Please use a text file (.txt) or copy and paste the content.'));
                        }
                    } else if (file.type.includes('json')) {
                        try {
                            const jsonData = JSON.parse(content);
                            // Convert JSON to readable text format
                            let textContent = '';
                            
                            function extractText(obj, prefix = '') {
                                for (const [key, value] of Object.entries(obj)) {
                                    if (typeof value === 'object' && value !== null) {
                                        extractText(value, key + ': ');
                                    } else {
                                        textContent += `${prefix}${key}: ${value}\n`;
                                    }
                                }
                            }
                            
                            extractText(jsonData);
                            resolve(textContent);
                        } catch (e) {
                            reject(new Error('Invalid JSON file'));
                        }
                    } else if (file.type.includes('csv')) {
                        // Basic CSV parsing
                        const lines = content.split('\n');
                        let textContent = '';
                        
                        if (lines.length > 0) {
                            const headers = lines[0].split(',').map(h => h.trim());
                            
                            for (let i = 1; i < lines.length; i++) {
                                const values = lines[i].split(',').map(v => v.trim());
                                if (values.length === headers.length) {
                                    headers.forEach((header, index) => {
                                        if (values[index]) {
                                            textContent += `${header}: ${values[index]}\n`;
                                        }
                                    });
                                    textContent += '\n';
                                }
                            }
                        }
                        resolve(textContent);
                    } else {
                        // Text files and others
                        resolve(content);
                    }
                };
                
                reader.onerror = reject;
                
                if (file.type === 'application/pdf') {
                    reader.readAsArrayBuffer(file);
                } else {
                    reader.readAsText(file);
                }
            });
        }

        async function extractProfileVariables(content, fileType) {
            const extracted = [];
            const lines = content.split(/\n+/);
            const processedValues = new Set(); // Avoid duplicates
            
            // Smart extraction based on patterns
            for (const [variable, keywords] of Object.entries(profileVariableMappings)) {
                for (const keyword of keywords) {
                    const regex = new RegExp(`${keyword}[:\\s]*([^\\n\\r.;]+)`, 'gi');
                    const matches = content.matchAll(regex);
                    
                    for (const match of matches) {
                        const value = match[1].trim();
                        if (value && value.length > 2 && value.length < 500) {
                            const key = `${variable}_${value}`;
                            if (!processedValues.has(key)) {
                                processedValues.add(key);
                                
                                // Check for existing value
                                const existing = getExistingValue(variable);
                                
                                extracted.push({
                                    variable: variable,
                                    displayName: formatVariableName(variable),
                                    value: value,
                                    type: getVariableType(variable),
                                    source: keyword,
                                    existing: existing,
                                    hasConflict: existing && existing !== value,
                                    selected: true
                                });
                            }
                        }
                    }
                }
            }
            
            // Also look for structured data patterns
            // Look for "About Me" style lists
            const bulletPoints = content.match(/[•\-\*]\s*([^\n]+)/g);
            if (bulletPoints) {
                bulletPoints.forEach(point => {
                    const cleaned = point.replace(/[•\-\*]\s*/, '').trim();
                    // Check if this matches any About Me categories
                    if (cleaned.length > 5 && cleaned.length < 200) {
                        const category = categorizeAboutMeItem(cleaned);
                        if (category) {
                            extracted.push({
                                variable: category,
                                displayName: formatVariableName(category),
                                value: cleaned,
                                type: 'about_me',
                                source: 'bullet point',
                                existing: null,
                                hasConflict: false,
                                selected: true
                            });
                        }
                    }
                });
            }
            
            return extracted;
        }

        function categorizeAboutMeItem(text) {
            const lowerText = text.toLowerCase();
            
            // Check for best life elements
            const bestLifeKeywords = ['enjoy', 'love', 'important', 'meaningful', 'value', 'matter'];
            if (bestLifeKeywords.some(keyword => lowerText.includes(keyword))) {
                return 'bestLifeElements';
            }
            
            // Check for concerns
            const concernKeywords = ['worry', 'concern', 'anxious', 'afraid', 'challenge', 'difficult'];
            if (concernKeywords.some(keyword => lowerText.includes(keyword))) {
                return 'concerns';
            }
            
            // Check for goals
            const goalKeywords = ['want to', 'hope to', 'goal', 'plan to', 'would like'];
            if (goalKeywords.some(keyword => lowerText.includes(keyword))) {
                return 'personalGoals';
            }
            
            return null;
        }

        function getExistingValue(variable) {
            // Check various places in userHistory for existing values
            switch(variable) {
                case 'name':
                    return userHistory.profile.name;
                case 'age':
                    return userHistory.profile.age;
                case 'bestLifeElements':
                    return userHistory.aboutMe.bestLifeElements.map(e => e.element).join(', ');
                case 'concerns':
                    return userHistory.aboutMe.concerns.map(c => c.concern).join(', ');
                case 'personalGoals':
                    return userHistory.goals.filter(g => g.status === 'active').map(g => g.goal).join(', ');
                case 'values':
                    return userHistory.values.map(v => v.value).join(', ');
                case 'livingArrangement':
                    return userHistory.socialContext?.livingArrangement;
                case 'medicalConditions':
                    return userHistory.healthFactors?.medicalConditions?.join(', ');
                case 'medications':
                    return userHistory.healthFactors?.medications?.join(', ');
                default:
                    return null;
            }
        }

        function getVariableType(variable) {
            const types = {
                name: 'personal',
                age: 'personal',
                medicalConditions: 'health',
                medications: 'health',
                memoryConcerns: 'cognitive',
                cognitiveStrengths: 'cognitive',
                livingArrangement: 'social',
                dailyActivities: 'lifestyle',
                familySupport: 'social',
                socialActivities: 'social',
                personalGoals: 'goals',
                values: 'values',
                physicalActivity: 'health',
                dietNutrition: 'health',
                sleepPatterns: 'health',
                safetyConcerns: 'safety',
                bestLifeElements: 'about_me',
                concerns: 'about_me'
            };
            return types[variable] || 'other';
        }

        function formatVariableName(variable) {
            return variable
                .replace(/([A-Z])/g, ' $1')
                .replace(/^./, str => str.toUpperCase())
                .trim();
        }

        function showDocumentReview() {
            const modal = document.getElementById('documentReviewModal');
            const list = document.getElementById('extractedVariablesList');
            
            list.innerHTML = '';
            
            // Group by type
            const grouped = extractedVariables.reduce((acc, item) => {
                if (!acc[item.type]) acc[item.type] = [];
                acc[item.type].push(item);
                return acc;
            }, {});
            
            // Show extraction summary
            const summary = document.createElement('div');
            summary.className = 'extraction-status';
            summary.innerHTML = `Found ${extractedVariables.length} pieces of information across ${Object.keys(grouped).length} categories`;
            list.appendChild(summary);
            
            // Display each group
            Object.entries(grouped).forEach(([type, items]) => {
                const typeHeader = document.createElement('h4');
                typeHeader.style.cssText = 'margin: 15px 0 10px 0; color: #667eea; text-transform: capitalize;';
                typeHeader.textContent = type.replace('_', ' ') + ' Information';
                list.appendChild(typeHeader);
                
                items.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = `variable-review-item ${item.selected ? 'selected' : ''} ${item.hasConflict ? 'conflict' : ''}`;
                    div.id = `extracted-${index}`;
                    
                    div.innerHTML = `
                        <div class="variable-header">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" class="variable-checkbox" 
                                       id="check-${index}" 
                                       ${item.selected ? 'checked' : ''} 
                                       onchange="toggleExtractedVariable(${index})">
                                <label for="check-${index}" class="variable-name">${item.displayName}</label>
                            </div>
                            <span class="variable-type">${item.type}</span>
                        </div>
                        <div class="variable-value">${item.value}</div>
                        ${item.hasConflict ? `
                            <div class="variable-existing">
                                ⚠️ Current value: "${item.existing}"<br>
                                <small>Selecting this will update with a timestamp</small>
                            </div>
                        ` : ''}
                        <div style="font-size: 11px; color: #999; margin-top: 5px;">
                            Source: ${item.source}
                        </div>
                    `;
                    
                    list.appendChild(div);
                });
            });
            
            modal.classList.add('active');
        }

        function toggleExtractedVariable(index) {
            extractedVariables[index].selected = !extractedVariables[index].selected;
            const element = document.getElementById(`extracted-${index}`);
            if (extractedVariables[index].selected) {
                element.classList.add('selected');
            } else {
                element.classList.remove('selected');
            }
        }

        function selectAllExtracted() {
            extractedVariables.forEach((item, index) => {
                item.selected = true;
                document.getElementById(`check-${index}`).checked = true;
                document.getElementById(`extracted-${index}`).classList.add('selected');
            });
        }

        function deselectAllExtracted() {
            extractedVariables.forEach((item, index) => {
                item.selected = false;
                document.getElementById(`check-${index}`).checked = false;
                document.getElementById(`extracted-${index}`).classList.remove('selected');
            });
        }

        function closeDocumentReview() {
            document.getElementById('documentReviewModal').classList.remove('active');
            extractedVariables = [];
        }

        async function applySelectedVariables() {
            const selected = extractedVariables.filter(item => item.selected);
            if (selected.length === 0) {
                alert('Please select at least one item to add to your profile.');
                return;
            }
            
            let updatedCount = 0;
            let addedCount = 0;
            
            // Apply each selected variable
            for (const item of selected) {
                const timestamp = new Date().toISOString();
                
                // Track profile change if API is available
                if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                    try {
                        await SofiaAPI.trackProfileChange({
                            variableName: item.variable,
                            variableValue: item.value,
                            previousValue: item.existing || null,
                            source: 'document',
                            sourceDetails: {
                                extractionKeyword: item.source,
                                hasConflict: item.hasConflict,
                                uploadId: extractedVariables.uploadId
                            }
                        });
                    } catch (error) {
                        console.error('Failed to track profile change:', error);
                    }
                }
                
                switch(item.variable) {
                    case 'name':
                        if (!userHistory.profile.name || item.hasConflict) {
                            userHistory.profile.name = item.value;
                            userHistory.profile.nameHistory = userHistory.profile.nameHistory || [];
                            userHistory.profile.nameHistory.push({ value: item.value, timestamp });
                        }
                        break;
                        
                    case 'age':
                        if (!userHistory.profile.age || item.hasConflict) {
                            userHistory.profile.age = item.value;
                            userHistory.profile.ageHistory = userHistory.profile.ageHistory || [];
                            userHistory.profile.ageHistory.push({ value: item.value, timestamp });
                        }
                        break;
                        
                    case 'bestLifeElements':
                        logBestLifeElement(item.value);
                        break;
                        
                    case 'concerns':
                        logAboutMeConcern(item.value);
                        break;
                        
                    case 'personalGoals':
                        logGoal(item.value);
                        break;
                        
                    case 'values':
                        logValue(item.value);
                        break;
                        
                    case 'memoryConcerns':
                        logConcern(item.value, 'moderate', 'from uploaded document');
                        break;
                        
                    case 'medicalConditions':
                        if (!userHistory.healthFactors.medicalConditions) {
                            userHistory.healthFactors.medicalConditions = [];
                        }
                        userHistory.healthFactors.medicalConditions.push({
                            condition: item.value,
                            timestamp: timestamp,
                            source: 'document'
                        });
                        break;
                        
                    case 'medications':
                        if (!userHistory.healthFactors.medications) {
                            userHistory.healthFactors.medications = [];
                        }
                        userHistory.healthFactors.medications.push({
                            medication: item.value,
                            timestamp: timestamp,
                            source: 'document'
                        });
                        break;
                        
                    case 'livingArrangement':
                        userHistory.socialContext.livingArrangement = item.value;
                        userHistory.socialContext.livingArrangementHistory = userHistory.socialContext.livingArrangementHistory || [];
                        userHistory.socialContext.livingArrangementHistory.push({ value: item.value, timestamp });
                        break;
                        
                    case 'physicalActivity':
                        userHistory.healthFactors.physicalActivity = item.value;
                        logEducationTopic('physical_activity_mentioned');
                        break;
                        
                    case 'sleepPatterns':
                        userHistory.healthFactors.sleepQuality = item.value;
                        logEducationTopic('sleep_patterns_mentioned');
                        break;
                        
                    default:
                        // Store in a general extracted data section
                        if (!userHistory.extractedData) {
                            userHistory.extractedData = {};
                        }
                        if (!userHistory.extractedData[item.variable]) {
                            userHistory.extractedData[item.variable] = [];
                        }
                        userHistory.extractedData[item.variable].push({
                            value: item.value,
                            timestamp: timestamp,
                            source: 'document'
                        });
                }
                
                if (item.hasConflict) {
                    updatedCount++;
                } else {
                    addedCount++;
                }
            }
            
            // Save updates
            saveUserHistory();
            updateMemoryDisplay(true);
            
            // Update document upload status if API is available
            if (extractedVariables.uploadId && typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                try {
                    await SofiaAPI.updateDocumentUpload(extractedVariables.uploadId, selected.length);
                } catch (error) {
                    console.error('Failed to update document status:', error);
                }
            }
            
            closeDocumentReview();
            
            // Show summary to user
            let summaryMessage = `✨ I've successfully updated your profile!\n\n`;
            if (addedCount > 0) {
                summaryMessage += `📌 Added ${addedCount} new piece${addedCount > 1 ? 's' : ''} of information\n`;
            }
            if (updatedCount > 0) {
                summaryMessage += `🔄 Updated ${updatedCount} existing value${updatedCount > 1 ? 's' : ''} with timestamps\n`;
            }
            
            summaryMessage += `\nYour profile is now richer and more complete. `;
            
            // Add personalized follow-up based on what was extracted
            if (selected.some(item => item.type === 'about_me')) {
                summaryMessage += `I see what matters most to you. Would you like to explore how we can support these priorities?`;
                currentPhase = "document_followup";
            } else if (selected.some(item => item.type === 'health')) {
                summaryMessage += `I've noted your health information. Would you like to discuss strategies for brain health that work with your current situation?`;
                currentPhase = "health_followup";
            } else {
                summaryMessage += `This gives me a better understanding of your journey. What would you like to explore next?`;
            }
            
            showBotMessage(summaryMessage, [
                "→ Show me my updated profile",
                "→ Continue our conversation",
                "→ Set a new goal based on this",
                "→ Create a chapter about this"
            ]);
        }

        // Add handler for document-based follow-ups
        function handleDocumentFollowup(message) {
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('show') && lowerMessage.includes('profile')) {
                showProfileSummary();
            } else if (lowerMessage.includes('continue')) {
                showBotMessage(
                    "Let's continue your story. What aspect of your brain health journey would you like to explore?",
                    [
                        "→ The Path of Movement",
                        "→ The Garden of Rest",
                        "→ The Circle of Connection",
                        "→ The Temple of Learning"
                    ]
                );
                currentPhase = "chapter_creation";
            } else if (lowerMessage.includes('goal')) {
                currentPhase = "goal_setting_from_document";
                showBotMessage(
                    "Based on what I learned from your document, here are some meaningful goals we could work on together:",
                    generateGoalSuggestionsFromDocument()
                );
            } else if (lowerMessage.includes('chapter')) {
                openChapterModal();
            }
        }

        function generateGoalSuggestionsFromDocument() {
            const suggestions = [];
            
            // Look at what was extracted to suggest relevant goals
            if (userHistory.healthFactors.physicalActivity) {
                suggestions.push("→ Maintain or increase daily physical activity");
            }
            if (userHistory.healthFactors.sleepQuality) {
                suggestions.push("→ Improve sleep quality and consistency");
            }
            if (userHistory.aboutMe.bestLifeElements.length > 0) {
                suggestions.push(`→ Dedicate more time to ${userHistory.aboutMe.bestLifeElements[0].element.toLowerCase()}`);
            }
            if (userHistory.concerns.length > 0) {
                suggestions.push("→ Address my top concern with a specific action plan");
            }
            
            // Default suggestion
            if (suggestions.length === 0) {
                suggestions.push("→ Create a personalized brain health routine");
            }
            
            return suggestions;
        }

        function showProfileSummary() {
            let summary = `📊 Your Complete Profile Summary\n\n`;
            
            // Personal Information
            summary += `**Personal Information**\n`;
            summary += `Name: ${userHistory.profile.name || 'Not set'}\n`;
            summary += `Age: ${userHistory.profile.age || 'Not set'}\n\n`;
            
            // About Me
            if (userHistory.aboutMe.bestLifeElements.length > 0) {
                summary += `**What Makes Life Meaningful**\n`;
                userHistory.aboutMe.bestLifeElements.forEach(element => {
                    summary += `• ${element.element}\n`;
                });
                summary += '\n';
            }
            
            if (userHistory.aboutMe.concerns.length > 0) {
                summary += `**Current Concerns**\n`;
                userHistory.aboutMe.concerns.forEach(concern => {
                    summary += `• ${concern.concern}\n`;
                });
                summary += '\n';
            }
            
            // Health Information
            if (userHistory.healthFactors.medicalConditions && userHistory.healthFactors.medicalConditions.length > 0) {
                summary += `**Health Conditions**\n`;
                userHistory.healthFactors.medicalConditions.forEach(condition => {
                    summary += `• ${condition.condition || condition}\n`;
                });
                summary += '\n';
            }
            
            // Goals
            const activeGoals = userHistory.goals.filter(g => g.status === 'active');
            if (activeGoals.length > 0) {
                summary += `**Active Goals**\n`;
                activeGoals.forEach(goal => {
                    summary += `• ${goal.goal}\n`;
                });
                summary += '\n';
            }
            
            // Story Progress
            summary += `**Your Story Progress**\n`;
            summary += `Chapters Written: ${userHistory.storyChapters.length}\n`;
            summary += `Topics Explored: ${userHistory.educationTopics.length}\n`;
            summary += `Values Identified: ${userHistory.values.length}\n`;
            
            showBotMessage(summary);
        }

        // Initialize the chat with profile awareness
        window.onload = async function() {
            // Load API client if available
            if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                try {
                    // Load user data from API
                    const apiData = await loadUserHistoryFromAPI();
                    if (apiData) {
                        userHistory = apiData;
                        isReturningUser = true;
                        isAboutMeComplete = userHistory.aboutMe.profileCompleteness > 0;
                    }
                    
                    // Create new session in API
                    const session = await SofiaAPI.createSession();
                    currentSessionId = session.id;
                } catch (error) {
                    console.error('API initialization failed, falling back to localStorage:', error);
                    isReturningUser = loadUserHistory();
                    currentSessionIndex = startNewSession();
                }
            } else {
                // Fallback to localStorage if API not available
                isReturningUser = loadUserHistory();
                currentSessionIndex = startNewSession();
            }
            
            // Initialize memory display
            updateMemoryDisplay();
            
            // Update progress visualization if returning user
            if (isReturningUser && userHistory.storyChapters && userHistory.storyChapters.length > 0) {
                updateProgressVisualization();
            }

            setTimeout(async () => {
                if (isReturningUser && userHistory.profile.name) {
                    // Check if About Me profile is complete
                    if (!isAboutMeComplete || userHistory.aboutMe.profileCompleteness < 100) {
                        // Returning user but incomplete About Me
                        showBotMessage(
                            `Welcome back, ${userHistory.profile.name}! Before we continue your brain health story, I'd love to understand more about what matters most to you.

This helps me provide support that's truly aligned with your values and concerns. It will only take a few moments.

Shall we explore what makes life meaningful for you?`,
                            [
                                "→ Yes, let's explore what matters to me",
                                "→ Skip for now and continue my story"
                            ]
                        );
                        currentPhase = "about_me_prompt";
                    } else {
                        // Returning user with complete About Me - personalized greeting
                        const daysSinceLastVisit = Math.floor((new Date() - new Date(userHistory.profile.lastVisit)) / (1000 * 60 * 60 * 24));
                        let greeting = `Welcome back to your story, ${userHistory.profile.name}! `;

                        if (daysSinceLastVisit === 0) {
                            greeting += "You've returned to continue writing today's chapter. ";
                        } else if (daysSinceLastVisit === 1) {
                            greeting += "Yesterday's chapter has ended, and today brings new possibilities. ";
                        } else {
                            greeting += `${daysSinceLastVisit} days have passed, each one adding depth to your journey. `;
                        }

                        // Reference About Me priorities
                        if (userHistory.aboutMe.bestLifeElements.length > 0) {
                            greeting += `\n\nI remember that ${userHistory.aboutMe.bestLifeElements[0].element.toLowerCase()} is important to you. `;
                        }

                        // Reference story progress
                        if (userHistory.storyChapters.length > 0) {
                            const lastChapter = userHistory.storyChapters[userHistory.storyChapters.length - 1];
                            greeting += `Your last chapter, "${lastChapter.title}," showed remarkable growth. `;
                        }

                        if (userHistory.goals.length > 0) {
                            const activeGoals = userHistory.goals.filter(g => g.status === 'active');
                            if (activeGoals.length > 0) {
                                greeting += `You're currently working on "${activeGoals[0].goal}" - how has this quest been unfolding?`;
                                currentPhase = "goal_checkin";
                            }
                        }

                        showBotMessage(greeting, [
                            "→ Continue my current quest",
                            "→ Begin a new chapter",
                            "→ Reflect on my journey",
                            "→ Update what matters to me"
                        ]);
                    }
                } else {
                    // New user - narrative introduction with About Me focus
                    showBotMessage(
                        `Welcome, brave soul. I'm Sofia, your guide in the adventure of brain health.

You stand at the beginning of an extraordinary journey - one where you are both the author and the hero. But before we begin crafting your story, I'd love to understand what makes life meaningful for you.

To start, may I know your name?`
                    );
                    currentPhase = "introduction";
                }
            }, 1000);
        };

        function showTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = 'block';
            document.getElementById('chatContainer').appendChild(indicator);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = 'none';
        }

        function showBotMessage(message, options = [], isStoryMoment = false, isAboutMe = false) {
            showTypingIndicator();
            
            setTimeout(() => {
                hideTypingIndicator();
                const chatContainer = document.getElementById('chatContainer');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                
                let messageHTML = '';
                
                // Add special indicators
                if (isStoryMoment) {
                    messageHTML += '<div class="story-moment-indicator">Story Moment Detected</div>';
                }
                if (isAboutMe) {
                    messageHTML += '<div class="about-me-indicator">About Me Discovery</div>';
                }
                
                messageHTML += `<div class="bot-message ${isStoryMoment ? 'story-moment' : ''} ${isAboutMe ? 'about-me' : ''}">${message.replace(/\n/g, '<br>')}</div>`;
                
                if (options.length > 0) {
                    messageHTML += '<div style="margin-top: 10px;">';
                    const buttonIds = [];
                    options.forEach((option, index) => {
                        // Create a unique ID for each option
                        const optionId = `option-${optionButtonCounter++}-${index}`;
                        buttonIds.push({id: optionId, option: option});
                        if (option.startsWith('→')) {
                            messageHTML += `<button class="narrative-choice" id="${optionId}">${option}</button>`;
                        } else {
                            messageHTML += `<button class="option-button" id="${optionId}">${option}</button>`;
                        }
                    });
                    messageHTML += '</div>';
                    
                    messageDiv.innerHTML = messageHTML;
                    chatContainer.appendChild(messageDiv);
                    
                    // Add click handlers after elements are in DOM
                    buttonIds.forEach(({id, option}) => {
                        const button = document.getElementById(id);
                        if (button) {
                            button.addEventListener('click', function() {
                                const optionText = option.startsWith('→') ? option.substring(2).trim() : option;
                                handleOptionClick(optionText);
                            });
                        }
                    });
                } else {
                    messageDiv.innerHTML = messageHTML;
                    chatContainer.appendChild(messageDiv);
                }
                
                scrollToBottom();
                
                conversationLog.push({
                    type: 'bot',
                    message: message,
                    timestamp: new Date().toISOString()
                });
            }, 1500);
        }

        function showAboutMeOptions(optionsList, type) {
            const chatContainer = document.getElementById('chatContainer');
            const optionsDiv = document.createElement('div');
            optionsDiv.style.marginTop = '10px';
            optionsDiv.innerHTML = '<div style="margin-bottom: 10px; font-size: 14px; color: #666;">Select all that apply:</div>';
            
            const buttonIds = [];
            optionsList.forEach((option, index) => {
                const buttonId = `about-me-${optionButtonCounter++}-${index}`;
                buttonIds.push({id: buttonId, option: option});
                const button = document.createElement('button');
                button.id = buttonId;
                button.className = 'about-me-choice';
                button.textContent = option;
                optionsDiv.appendChild(button);
            });
            
            // Add continue button
            const continueBtn = document.createElement('button');
            continueBtn.style.marginTop = '15px';
            continueBtn.textContent = 'Continue →';
            continueBtn.id = `continue-${optionButtonCounter++}`;
            optionsDiv.appendChild(continueBtn);
            
            chatContainer.appendChild(optionsDiv);
            
            // Add event listeners after DOM insertion
            buttonIds.forEach(({id, option}) => {
                const button = document.getElementById(id);
                if (button) {
                    button.addEventListener('click', function() {
                        toggleAboutMeSelection(this, option, type);
                    });
                }
            });
            
            // Add continue button listener
            continueBtn.addEventListener('click', function() {
                processAboutMeSelections(type);
            });
            
            scrollToBottom();
        }

        function toggleAboutMeSelection(button, option, type) {
            try {
                button.classList.toggle('selected');
                
                if (type === 'best-life') {
                    if (button.classList.contains('selected')) {
                        selectedBestLifeElements.push(option);
                    } else {
                        selectedBestLifeElements = selectedBestLifeElements.filter(e => e !== option);
                    }
                } else if (type === 'concerns') {
                    if (button.classList.contains('selected')) {
                        selectedConcerns.push(option);
                    } else {
                        selectedConcerns = selectedConcerns.filter(c => c !== option);
                    }
                }
            } catch (error) {
                console.error('Error toggling selection:', error);
            }
        }

        function processAboutMeSelections(type) {
            try {
                if (type === 'best-life') {
                    // Save best life elements
                    selectedBestLifeElements.forEach((element, index) => {
                        logBestLifeElement(element, index + 1);
                    });
                    
                    // Move to concerns phase
                    currentPhase = "about_me_concerns";
                    showBotMessage(
                        `Thank you for sharing what brings meaning to your life. These are beautiful priorities.

Now, let's talk about what might get in the way. What concerns you most when you think about living your best life?`,
                        [],
                        false,
                        true
                    );
                    
                    setTimeout(() => {
                        showAboutMeOptions(companionConfig.aboutMeFramework.concernCategories, 'concerns');
                    }, 2000);
                } else if (type === 'concerns') {
                    // Save concerns
                    selectedConcerns.forEach(concern => {
                        logAboutMeConcern(concern);
                    });
                    
                    // Move to confidence assessment
                    currentPhase = "about_me_confidence";
                    showBotMessage(
                        `I understand these concerns. They're valid and shared by many others.

Given what we've discussed, how confident are you that you can address these concerns?`,
                        companionConfig.aboutMeFramework.confidenceLevels,
                        false,
                        true
                    );
                }
            } catch (error) {
                console.error('Error processing selections:', error);
                showBotMessage("I apologize, but I encountered an error. Let's try a different approach. Can you tell me in your own words what matters most to you?");
            }
        }

        function showUserMessage(message) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `<div class="user-message">${message}</div>`;
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
            
            conversationLog.push({
                type: 'user',
                message: message,
                timestamp: new Date().toISOString()
            });
        }

        function sendMessage() {
            try {
                const input = document.getElementById('userInput');
                const message = input.value.trim();
                
                if (message) {
                    showUserMessage(message);
                    input.value = '';
                    processUserMessage(message);
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('There was an error sending your message. Please try again.');
            }
        }

        function handleOptionClick(option) {
            try {
                showUserMessage(option);
                processUserMessage(option);
            } catch (error) {
                console.error('Error handling option click:', error);
                showBotMessage("I apologize, but I encountered an error. Please try typing your response instead.");
            }
        }

        function analyzeMessageForLogging(message) {
            const lowerMessage = message.toLowerCase();
            
            // Detect and log concerns
            const concernKeywords = ['worry', 'concern', 'afraid', 'scared', 'anxious', 'forget', 'memory', 'lost', 'confused'];
            concernKeywords.forEach(keyword => {
                if (lowerMessage.includes(keyword)) {
                    logEmotionalState('concerned', keyword);
                }
            });

            // Detect and log values
            const valueKeywords = {
                'family': 'family connections',
                'independent': 'independence',
                'active': 'staying active',
                'friend': 'friendships',
                'learn': 'lifelong learning'
            };
            
            Object.entries(valueKeywords).forEach(([keyword, value]) => {
                if (lowerMessage.includes(keyword)) {
                    logValue(value);
                }
            });
        }

        async function processUserMessage(message) {
            const lowerMessage = message.toLowerCase();
            
            // SAFETY CHECK FIRST
            const safetyTriggers = analyzeSafetyTriggers(message);
            if (safetyTriggers.length > 0) {
                const safetyResponse = handleSafetyTrigger(safetyTriggers);
                if (safetyResponse) {
                    showBotMessage(safetyResponse);
                    updateSessionRiskAssessment();
                    return;
                }
            }
            
            // STORY MOMENT DETECTION
            const storyMoment = detectStoryMoment(message);
            if (storyMoment) {
                logStoryMoment(storyMoment);
                
                // Connect story moment to About Me if profile is complete
                let aboutMeConnection = "";
                if (userHistory.aboutMe.bestLifeElements.length > 0) {
                    aboutMeConnection = `\n\nThis moment connects to what matters most to you - ${userHistory.aboutMe.bestLifeElements[0].element}.`;
                }
                
                showBotMessage(
                    `You've discovered something important about your journey - a moment worth capturing in your story.${aboutMeConnection}

This ${storyMoment.type === 'breakthroughs' ? 'breakthrough' : 
      storyMoment.type === 'victories' ? 'victory' : 
      storyMoment.type === 'emotionalTransitions' ? 'transformation' : 
      'decision'} could become a powerful chapter.

Would you like to:`,
                    [
                        "→ Explore what made this moment possible",
                        "→ Capture this as a new chapter",
                        "→ Continue building on this momentum"
                    ],
                    true
                );
                
                if (message.includes('capture') || message.includes('chapter')) {
                    openChapterModal(storyMoment);
                }
                return;
            }
            
            // Always analyze message for logging
            analyzeMessageForLogging(message);
            
            // Update session risk assessment periodically
            updateSessionRiskAssessment();
            
            // Document upload follow-up handling
            if (currentPhase === "document_followup" || currentPhase === "health_followup") {
                handleDocumentFollowup(message);
                return;
            }
            
            // About Me prompt responses
            if (currentPhase === "about_me_prompt") {
                if (lowerMessage.includes('yes') || lowerMessage.includes('explore')) {
                    currentPhase = "about_me_best_life";
                    showBotMessage(
                        `Wonderful! Let's explore what makes life meaningful for you.

When you think about living your best life, what brings you the most joy and fulfillment? I'll share some common themes, and you can select all that resonate with you.`,
                        [],
                        false,
                        true
                    );
                    
                    setTimeout(() => {
                        showAboutMeOptions(companionConfig.aboutMeFramework.bestLifeElements, 'best-life');
                    }, 2000);
                    return;
                } else if (lowerMessage.includes('skip')) {
                    currentPhase = "story_beginning";
                    showBotMessage(
                        `That's fine, we can explore this another time. Let's continue with your brain health journey.

What would you like to focus on today?`,
                        [
                            "→ Continue my current quest",
                            "→ Begin a new chapter",
                            "→ Reflect on my journey"
                        ]
                    );
                    return;
                }
            }
            
            // About Me confidence response
            if (currentPhase === "about_me_confidence") {
                userHistory.aboutMe.confidenceLevel = message;
                userHistory.aboutMe.confidenceTimestamp = new Date().toISOString();
                updateAboutMeCompleteness();
                saveUserHistory();
                
                isAboutMeComplete = true;
                currentPhase = "about_me_next_steps";
                
                let confidenceResponse = "";
                if (message.includes("Very confident")) {
                    confidenceResponse = "Your confidence is inspiring! With that strength, you're ready to tackle these challenges.";
                } else if (message.includes("Somewhat confident")) {
                    confidenceResponse = "That's a good starting point. We'll work together to build your confidence as we go.";
                } else {
                    confidenceResponse = "I understand. It's okay to feel uncertain. We'll take small steps together to build your confidence.";
                }
                
                showBotMessage(
                    `${confidenceResponse}

Now, thinking about everything we've discussed - what you value most and the concerns you face - what do you think would be a good first step toward living your best life?

This could be something small and manageable, or a bigger goal you're ready to pursue.`,
                    [],
                    false,
                    true
                );
                return;
            }
            
            // About Me next steps
            if (currentPhase === "about_me_next_steps") {
                userHistory.aboutMe.userDefinedNextSteps.push({
                    step: message,
                    timestamp: new Date().toISOString(),
                    status: "planned",
                    linkedConcerns: selectedConcerns
                });
                saveUserHistory();
                updateMemoryDisplay(true);
                
                currentPhase = "story_beginning";
                
                // Create first goal linked to About Me
                const linkedElements = userHistory.aboutMe.bestLifeElements.map(e => e.element);
                logGoal(message, 7, linkedElements);
                
                showBotMessage(
                    `Perfect! "${message}" is a wonderful first step that directly supports what matters most to you.

This goal connects to your desire to ${linkedElements[0].toLowerCase()}, which makes it even more meaningful.

Now that I understand what's important to you, let's begin crafting your brain health story. Every journey needs its first chapter.

What would you like to explore first?`,
                    [
                        "→ The Path of Movement (Physical activity)",
                        "→ The Garden of Rest (Sleep improvement)",
                        "→ The Circle of Connection (Social engagement)",
                        "→ The Temple of Learning (Mental stimulation)",
                        "→ The Valley of Calm (Stress management)"
                    ]
                );
                return;
            }
            
            // Update what matters to me
            if (lowerMessage.includes('update what matters')) {
                openAboutMeEditor();
                return;
            }
            
            // Continue my current quest
            if (lowerMessage.includes('continue my current quest') || lowerMessage.includes('current quest')) {
                const activeGoals = userHistory.goals.filter(g => g.status === 'active');
                if (activeGoals.length > 0) {
                    let questMessage = `Your current quest: "${activeGoals[0].goal}"`;
                    
                    // Add About Me connection
                    if (activeGoals[0].linkedBestLifeElements && activeGoals[0].linkedBestLifeElements.length > 0) {
                        questMessage += `\n\nThis quest supports your desire to ${activeGoals[0].linkedBestLifeElements[0].toLowerCase()}.`;
                    }
                    
                    questMessage += `\n\nYou stand at a crossroads in this journey. The path ahead branches in multiple directions.\n\nChoose your next step:`;
                    
                    showBotMessage(questMessage, [
                        "→ Report progress on my quest",
                        "→ Face a challenge that's emerged",
                        "→ Seek wisdom for the journey",
                        "→ Adjust my quest parameters"
                    ]);
                }
                return;
            }
            
            // Begin a new chapter
            if (lowerMessage.includes('begin a new chapter') || lowerMessage.includes('new chapter')) {
                currentPhase = "chapter_creation";
                
                let chapterPrompt = `A new chapter awaits. Every story needs its turning points - moments where the hero chooses a new direction.`;
                
                // Add About Me context
                if (userHistory.aboutMe.bestLifeElements.length > 0) {
                    chapterPrompt += `\n\nConsidering what matters most to you - ${userHistory.aboutMe.bestLifeElements.slice(0, 2).map(e => e.element).join(' and ')} - what calls to you in this moment?`;
                } else {
                    chapterPrompt += `\n\nWhat calls to you in this moment of your journey?`;
                }
                
                showBotMessage(chapterPrompt, [
                    "→ The Path of Movement (Physical activity)",
                    "→ The Garden of Rest (Sleep improvement)",
                    "→ The Circle of Connection (Social engagement)",
                    "→ The Temple of Learning (Mental stimulation)",
                    "→ The Valley of Calm (Stress management)"
                ]);
                return;
            }
            
            // Reflect on my journey
            if (lowerMessage.includes('reflect on my journey') || lowerMessage.includes('journey')) {
                showProgressSummary();
                return;
            }
            
            // Name collection phase
            if (!userHistory.profile.name && currentPhase === "introduction") {
                userHistory.profile.name = message;
                
                // Don't save yet - wait for age
                currentPhase = "age_inquiry";
                showBotMessage(
                    `${message} - a name that will echo through the chapters of your brain health saga.

Every hero's journey begins with understanding where they stand. To craft your personalized adventure, may I know your age? This helps me tailor your story's challenges and triumphs.`
                );
                return;
            }
            
            // Age collection phase
            if (!userHistory.profile.age && currentPhase === "age_inquiry") {
                userHistory.profile.age = message;
                
                // Authenticate with API if available
                if (typeof SofiaAPI !== 'undefined') {
                    try {
                        const authResult = await SofiaAPI.authenticate(userHistory.profile.name, userHistory.profile.age);
                        // API will return existing user data if returning user
                        if (authResult.user.total_sessions > 0) {
                            // Load full profile from API
                            const apiData = await loadUserHistoryFromAPI();
                            if (apiData) {
                                userHistory = apiData;
                                isReturningUser = true;
                                isAboutMeComplete = userHistory.aboutMe.profileCompleteness > 0;
                            }
                        }
                        // Create new session
                        const session = await SofiaAPI.createSession();
                        currentSessionId = session.id;
                    } catch (error) {
                        console.error('API authentication failed:', error);
                        // Continue with localStorage fallback
                    }
                }
                
                saveUserHistory();
                currentPhase = "about_me_prompt";
                updateCurrentSession({ mainTopics: ['introduction', 'about_me_setup'] });
                
                showBotMessage(
                    `At ${userHistory.profile.age}, you stand at a powerful point in your story - where wisdom meets opportunity, where experience guides new adventures.

Before we begin your brain health journey, I'd love to understand what makes life meaningful for you. This helps me provide support that's truly aligned with your values.

Shall we explore what matters most to you?`,
                    [
                        "→ Yes, let's explore what matters to me",
                        "→ Skip for now and start my journey"
                    ]
                );
                return;
            }
            
            // Path selections (narrative branches)
            if (currentPhase === "story_beginning" || currentPhase === "chapter_creation") {
                if (lowerMessage.includes('movement') || lowerMessage.includes('path of movement')) {
                    // Link to About Me
                    let connectionMessage = "";
                    if (userHistory.aboutMe.bestLifeElements.some(e => e.element.includes('Exercise'))) {
                        connectionMessage = "Perfect! This directly supports your goal of exercising regularly. ";
                    }
                    
                    currentPhase = "movement_quest";
                    showBotMessage(
                        `${connectionMessage}You choose the Path of Movement, where every step strengthens both body and mind.

Movement is medicine, ${userHistory.profile.name}. Each activity you do sends healing signals throughout your brain.

What aspect of movement speaks to you right now?`,
                        [
                            "→ Daily Walking Adventures",
                            "→ Gentle Strength Building",
                            "→ Balance and Flexibility",
                            "→ Joyful Movement (Dancing, Playing)"
                        ]
                    );
                    return;
                }
                
                if (lowerMessage.includes('rest') || lowerMessage.includes('garden of rest') || lowerMessage.includes('sleep improvement')) {
                    // Link to About Me
                    let connectionMessage = "";
                    if (userHistory.aboutMe.concerns.some(c => c.concern.includes('sleep'))) {
                        connectionMessage = "Wise choice! This addresses your concern about sleep. ";
                    }
                    
                    currentPhase = "sleep_quest";
                    logEducationTopic("sleep_improvement");
                    showBotMessage(
                        `${connectionMessage}You enter the Garden of Rest, where peaceful nights nurture your brain's renewal.

Sleep is when your brain heals and clears away the day's debris, ${userHistory.profile.name}. It's essential for memory and clear thinking.

What aspect of your sleep journey would you like to explore?`,
                        [
                            "→ Creating a bedtime ritual",
                            "→ Dealing with sleep disruptions",
                            "→ Making my bedroom a sanctuary",
                            "→ Managing worries at night"
                        ]
                    );
                    return;
                }
                
                if (lowerMessage.includes('connection') || lowerMessage.includes('circle of connection')) {
                    // Link to About Me
                    let connectionMessage = "";
                    if (userHistory.aboutMe.bestLifeElements.some(e => e.element.includes('people I care about'))) {
                        connectionMessage = "Wonderful choice! This aligns perfectly with your value of spending time with people you care about. ";
                    }
                    
                    currentPhase = "connection_quest";
                    showBotMessage(
                        `${connectionMessage}You enter the Circle of Connection, where relationships nurture your cognitive health.

Social bonds are powerful brain protectors, ${userHistory.profile.name}. Every meaningful conversation creates new neural pathways.

How would you like to strengthen your connections?`,
                        [
                            "→ Reconnect with old friends",
                            "→ Deepen family bonds",
                            "→ Join a community group",
                            "→ Share your wisdom with others"
                        ]
                    );
                    return;
                }
            }
            
            // Goal setting with About Me awareness
            if (lowerMessage.includes('accept') && lowerMessage.includes('quest')) {
                currentPhase = "quest_commitment";
                let questGoal = "";
                
                if (conversationLog.slice(-3).some(log => log.message && log.message.includes('Daily Walking'))) {
                    questGoal = "Take a 15-minute walk every day this week";
                }
                
                if (questGoal) {
                    // Link to About Me elements
                    const linkedElements = userHistory.aboutMe.bestLifeElements.map(e => e.element);
                    logGoal(questGoal, 7, linkedElements);
                    
                    showBotMessage(
                        `⚔️ Quest Accepted: "${questGoal}"

This quest beautifully supports your value of ${linkedElements[0] || 'living your best life'}. You feel a surge of determination.

On a scale of 1-10, how confident do you feel about completing this quest?
(1 = This seems impossible, 10 = I've got this!)`,
                    );
                    currentPhase = "confidence_check";
                    return;
                }
            }
            
            // Confidence assessment
            if (currentPhase === "confidence_check") {
                const confidence = parseInt(message);
                if (!isNaN(confidence)) {
                    const lastGoalIndex = userHistory.goals.length - 1;
                    userHistory.goals[lastGoalIndex].confidence = confidence;
                    saveUserHistory();
                    
                    if (confidence < 7) {
                        showBotMessage(
                            `A confidence level of ${confidence} shows wisdom - you recognize the challenge ahead.

Every hero faces doubt. What would increase your confidence on this quest?`,
                            [
                                "→ Start with a smaller challenge",
                                "→ Find a quest companion",
                                "→ Learn preparation rituals",
                                "→ Set magical reminders"
                            ]
                        );
                    } else {
                        logActionPlan(`Begin quest: ${userHistory.goals[lastGoalIndex].goal}`);
                        showBotMessage(
                            `Confidence level ${confidence} - the heart of a true hero!

Your quest begins now. What's the very first step you'll take TODAY to start this adventure?

Remember: Even the longest journey begins with a single step.`
                        );
                        currentPhase = "action_planning";
                    }
                }
                return;
            }
            
            // Report progress on quest
            if ((lowerMessage.includes('report progress') || lowerMessage.includes('progress on my quest')) && userHistory.goals.some(g => g.status === 'active')) {
                currentPhase = "progress_report";
                const activeGoal = userHistory.goals.find(g => g.status === 'active');
                
                showBotMessage(
                    `Tell me about your progress with "${activeGoal.goal}".

How has it been going? Every step forward, no matter how small, is part of your heroic journey.

Share your experience - the triumphs, the challenges, or even the days you didn't quite make it. It's all part of your story.`
                );
                return;
            }
            
            // Face a challenge
            if (lowerMessage.includes('face a challenge') || lowerMessage.includes('challenge that') || lowerMessage.includes('emerged')) {
                currentPhase = "challenge_support";
                const activeGoal = userHistory.goals.find(g => g.status === 'active');
                
                showBotMessage(
                    `Every hero faces obstacles. What challenge has emerged on your quest${activeGoal ? ' to "' + activeGoal.goal + '"' : ''}?

Sometimes the dragon we must slay is our own doubt, or the mountain we climb is made of daily habits.

Tell me what you're facing, and together we'll find a way forward.`,
                    [
                        "→ I'm losing motivation",
                        "→ It's harder than I expected",
                        "→ Life got in the way",
                        "→ I need to adjust my approach"
                    ]
                );
                return;
            }
            
            // Seek wisdom
            if (lowerMessage.includes('seek wisdom') || lowerMessage.includes('wisdom for')) {
                currentPhase = "wisdom_sharing";
                const activeGoal = userHistory.goals.find(g => g.status === 'active');
                
                let wisdomTopics = [
                    "→ Tips for staying consistent",
                    "→ How to track progress",
                    "→ Building supportive habits",
                    "→ Celebrating small wins"
                ];
                
                // Customize based on goal type
                if (activeGoal && activeGoal.goal.toLowerCase().includes('walk')) {
                    wisdomTopics = [
                        "→ Best times for walking",
                        "→ Making walks more enjoyable",
                        "→ Walking safely",
                        "→ Tracking your steps"
                    ];
                } else if (activeGoal && activeGoal.goal.toLowerCase().includes('sleep')) {
                    wisdomTopics = [
                        "→ Evening routines that work",
                        "→ Creating a sleep sanctuary",
                        "→ Dealing with sleep disruptions",
                        "→ Tracking sleep quality"
                    ];
                }
                
                showBotMessage(
                    `The ancient scrolls of brain health wisdom are open before you. 📜✨

What knowledge would serve you best on your quest${activeGoal ? ' to "' + activeGoal.goal + '"' : ''}?`,
                    wisdomTopics
                );
                return;
            }
            
            // Adjust quest parameters
            if (lowerMessage.includes('adjust') && (lowerMessage.includes('quest') || lowerMessage.includes('parameters'))) {
                currentPhase = "quest_adjustment";
                const activeGoal = userHistory.goals.find(g => g.status === 'active');
                
                if (activeGoal) {
                    showBotMessage(
                        `Sometimes a quest needs refinement. Your current quest is: "${activeGoal.goal}"

Your original confidence level was ${activeGoal.confidence}/10.

How would you like to adjust this quest?`,
                        [
                            "→ Make it easier to start",
                            "→ Change the frequency",
                            "→ Add a reward system",
                            "→ Find an accountability partner",
                            "→ Complete this quest and start anew"
                        ]
                    );
                } else {
                    showBotMessage("I don't see an active quest to adjust. Would you like to set a new quest?");
                    currentPhase = "chapter_creation";
                }
                return;
            }
            
            // Handle progress report responses
            if (currentPhase === "progress_report") {
                // Log the progress update
                const activeGoalIndex = userHistory.goals.findIndex(g => g.status === 'active');
                if (activeGoalIndex >= 0) {
                    updateGoalProgress(activeGoalIndex, message);
                    
                    // Check for success indicators
                    if (lowerMessage.includes('did it') || lowerMessage.includes('success') || lowerMessage.includes('achieved')) {
                        showBotMessage(
                            `🎉 This is wonderful! You're living your heroic story!

Your progress shows that ${userHistory.aboutMe.bestLifeElements.length > 0 ? userHistory.aboutMe.bestLifeElements[0].element + ' is truly possible' : 'transformation is happening'}.

Would you like to:`,
                            [
                                "→ Celebrate this victory",
                                "→ Set a new challenge",
                                "→ Share what you've learned",
                                "→ Continue with the same quest"
                            ]
                        );
                    } else if (lowerMessage.includes('struggle') || lowerMessage.includes('hard') || lowerMessage.includes('difficult')) {
                        showBotMessage(
                            `I hear you. This path isn't always easy, but your honesty shows strength.

Remember: Heroes aren't defined by never falling, but by always getting back up.

What would help you most right now?`,
                            [
                                "→ Adjust the quest to be more manageable",
                                "→ Find strategies that work better",
                                "→ Take a brief rest and restart",
                                "→ Connect with others on similar journeys"
                            ]
                        );
                    } else {
                        showBotMessage(
                            `Thank you for sharing your progress. Every step of this journey matters.

How do you feel about your progress so far?`,
                            [
                                "→ Proud of what I've done",
                                "→ Ready for more challenge",
                                "→ Need some adjustments",
                                "→ Want to try something different"
                            ]
                        );
                    }
                }
                currentPhase = "quest_reflection";
                return;
            }
            
            // Capture as chapter request
            if (lowerMessage.includes('capture') && lowerMessage.includes('chapter')) {
                openChapterModal();
                return;
            }
            
            // Default response for unhandled inputs during specific phases
            if (currentPhase === "movement_quest" || currentPhase === "sleep_quest" || currentPhase === "connection_quest") {
                // User typed something unexpected during a quest selection
                showBotMessage(
                    `I see you have something specific in mind. Tell me more about what you'd like to explore, or choose from the options above to continue on your chosen path.`
                );
                return;
            }
            
            // If no specific handler matched, provide a contextual response
            if (currentPhase && !['initialization', 'introduction', 'age_inquiry'].includes(currentPhase)) {
                // We're in the middle of something specific
                showBotMessage(
                    `I'm not sure how to respond to that in our current context. Would you like to continue with what we were discussing, or would you prefer to explore something else?`,
                    [
                        "→ Continue our current topic",
                        "→ Start something new",
                        "→ Show me my progress",
                        "→ Update what matters to me"
                    ]
                );
            }
        }

        function showProgressSummary() {
            const activeGoals = userHistory.goals.filter(g => g.status === 'active');
            const completedGoals = userHistory.goals.filter(g => g.status === 'completed');
            const chapters = userHistory.storyChapters.length;
            
            let summary = `📚 The Story So Far...\n\n`;
            summary += `**Protagonist:** ${userHistory.profile.name}\n`;
            summary += `**Chapters Written:** ${chapters}\n`;
            summary += `**Active Quests:** ${activeGoals.length}\n`;
            summary += `**Completed Quests:** ${completedGoals.length}\n\n`;
            
            // Add About Me summary
            if (userHistory.aboutMe.bestLifeElements.length > 0) {
                summary += `**What Matters Most:**\n`;
                userHistory.aboutMe.bestLifeElements.forEach(element => {
                    summary += `• ${element.element}\n`;
                });
                summary += '\n';
            }
            
            if (chapters > 0) {
                summary += `**Recent Chapter:** "${userHistory.storyChapters[chapters - 1].title}"\n\n`;
            }
            
            if (activeGoals.length > 0) {
                summary += `**Current Quest:**\n`;
                activeGoals.forEach(goal => {
                    summary += `⚔️ ${goal.goal} (Confidence: ${goal.confidence}/10)\n`;
                    if (goal.linkedBestLifeElements && goal.linkedBestLifeElements.length > 0) {
                        summary += `   Supporting: ${goal.linkedBestLifeElements[0]}\n`;
                    }
                });
            }
            
            summary += `\n**Your Journey Stats:**\n`;
            summary += `🗓️ Days on this adventure: ${Math.floor((new Date() - new Date(userHistory.profile.registrationDate)) / (1000 * 60 * 60 * 24))}\n`;
            summary += `💬 Conversations shared: ${userHistory.profile.totalSessions}\n`;
            summary += `📖 Wisdom topics explored: ${userHistory.educationTopics.length}`;
            
            if (userHistory.aboutMe.confidenceLevel) {
                summary += `\n💪 Confidence Level: ${userHistory.aboutMe.confidenceLevel}`;
            }
            
            showBotMessage(summary, [
                "→ Write a new chapter",
                "→ Update quest progress",
                "→ Explore new territories",
                "→ Update what matters to me"
            ]);
        }

        async function submitFeedback() {
            const feedbackInput = document.getElementById('feedbackInput');
            const feedback = feedbackInput.value.trim();
            
            if (feedback) {
                const feedbackContainer = document.getElementById('feedbackContainer');
                
                // Show confirmation in feedback section
                const confirmationDiv = document.createElement('div');
                confirmationDiv.className = 'feedback-confirmation';
                confirmationDiv.innerHTML = `Thank you for sharing your thoughts, ${userHistory.profile.name || 'friend'}! Your feedback helps me become a better guide for everyone's brain health journey. Together, we're creating something truly special. 📖💜`;
                feedbackContainer.appendChild(confirmationDiv);
                
                // Store the actual feedback
                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = 'feedback-item';
                
                const timestamp = new Date().toLocaleString();
                feedbackDiv.innerHTML = `
                    ${feedback}
                    <div class="feedback-timestamp">${timestamp}</div>
                `;
                
                feedbackContainer.appendChild(feedbackDiv);
                feedbackInput.value = '';
                
                feedbackLog.push({
                    feedback: feedback,
                    timestamp: new Date().toISOString(),
                    conversationContext: conversationLog.length
                });
                
                // Save to API if available
                if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                    try {
                        await SofiaAPI.submitFeedback(feedback, conversationLog.length);
                    } catch (error) {
                        console.error('Failed to submit feedback to API:', error);
                        // Save to offline queue
                        const offlineQueue = JSON.parse(localStorage.getItem('sofia_offline_queue') || '[]');
                        offlineQueue.push({ 
                            type: 'feedback', 
                            data: { text: feedback, context: conversationLog.length }, 
                            timestamp: new Date().toISOString() 
                        });
                        localStorage.setItem('sofia_offline_queue', JSON.stringify(offlineQueue));
                    }
                }
                
                // Remove confirmation after a few seconds
                setTimeout(() => {
                    confirmationDiv.style.animation = 'fadeIn 0.5s ease-in reverse';
                    setTimeout(() => {
                        feedbackContainer.removeChild(confirmationDiv);
                    }, 500);
                }, 5000);
            }
        }

        function scrollToBottom() {
            const chatContainer = document.getElementById('chatContainer');
            if (chatContainer) {
                setTimeout(() => {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }, 100);
            }
        }

        // Handle Enter key for sending messages
        document.getElementById('userInput').addEventListener('keypress', function(e) {
            try {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            } catch (error) {
                console.error('Error handling Enter key:', error);
            }
        });

        // Download memory summary in narrative format
        function downloadMemorySummary() {
            const userName = userHistory.profile.name || 'Brave Adventurer';
            const date = new Date().toLocaleDateString();
            
            let summary = `📖 The Brain Health Saga of ${userName}\n`;
            summary += `Chronicled on: ${date}\n`;
            summary += `Adventures completed: ${userHistory.profile.totalSessions}\n\n`;
            
            // Add About Me section
            if (userHistory.aboutMe && userHistory.aboutMe.profileCompleteness > 0) {
                summary += `═══ WHAT MATTERS MOST TO ME ═══\n\n`;
                
                if (userHistory.aboutMe.bestLifeElements.length > 0) {
                    summary += `My Best Life Includes:\n`;
                    userHistory.aboutMe.bestLifeElements.forEach(element => {
                        summary += `• ${element.element}\n`;
                    });
                    summary += '\n';
                }
                
                if (userHistory.aboutMe.concerns.length > 0) {
                    summary += `My Concerns:\n`;
                    userHistory.aboutMe.concerns.forEach(concern => {
                        summary += `• ${concern.concern}\n`;
                    });
                    summary += '\n';
                }
                
                if (userHistory.aboutMe.confidenceLevel) {
                    summary += `My Confidence Level: ${userHistory.aboutMe.confidenceLevel}\n\n`;
                }
            }
            
            summary += `═══ YOUR STORY CHAPTERS ═══\n\n`;
            if (userHistory.storyChapters.length > 0) {
                userHistory.storyChapters.forEach((chapter, index) => {
                    summary += `Chapter ${index + 1}: ${chapter.title}\n`;
                    summary += `━━━━━━━━━━━━━━━━━━━━━━━━\n`;
                    summary += `${chapter.moment}\n`;
                    if (chapter.choices) summary += `\nChoices Made: ${chapter.choices}\n`;
                    if (chapter.learning) summary += `Wisdom Gained: ${chapter.learning}\n`;
                    summary += `Emotional Journey: ${chapter.moodArc.join(' → ')}\n`;
                    if (chapter.linkedBestLifeElements && chapter.linkedBestLifeElements.length > 0) {
                        summary += `Connected to: ${chapter.linkedBestLifeElements.join(', ')}\n`;
                    }
                    summary += `Date: ${new Date(chapter.timestamp).toLocaleDateString()}\n\n`;
                });
            } else {
                summary += 'Your story chapters are yet to be written...\n\n';
            }
            
            summary += `═══ ACTIVE QUESTS ═══\n\n`;
            const activeGoals = userHistory.goals.filter(g => g.status === 'active');
            if (activeGoals.length > 0) {
                activeGoals.forEach((goal, index) => {
                    summary += `Quest ${index + 1}: ${goal.goal}\n`;
                    summary += `   Confidence Level: ${goal.confidence}/10\n`;
                    summary += `   Begun on: ${new Date(goal.setDate).toLocaleDateString()}\n`;
                    if (goal.linkedBestLifeElements && goal.linkedBestLifeElements.length > 0) {
                        summary += `   Supporting: ${goal.linkedBestLifeElements.join(', ')}\n`;
                    }
                    if (goal.userNote) summary += `   Your notes: ${goal.userNote}\n`;
                    summary += '\n';
                });
            } else {
                summary += 'No active quests at this time.\n\n';
            }
            
            summary += `═══ CHALLENGES FACED ═══\n\n`;
            if (userHistory.concerns.length > 0) {
                userHistory.concerns.forEach((concern, index) => {
                    summary += `${index + 1}. ${concern.concern}\n`;
                    if (concern.context) summary += `   Context: ${concern.context}\n`;
                    summary += '\n';
                });
            } else {
                summary += 'No challenges recorded yet.\n\n';
            }
            
            summary += `═══ VALUES THAT GUIDE YOU ═══\n\n`;
            if (userHistory.values.length > 0) {
                userHistory.values.forEach(value => {
                    summary += `• ${value.value} (${value.importance} importance)\n`;
                });
            } else {
                summary += 'Your guiding values await discovery.\n';
            }
            
            summary += `\n═══ YOUR NEXT CHAPTER ═══\n\n`;
            summary += 'The story continues with every choice you make.\n';
            summary += 'What adventure will you write next?\n';
            
            summary += '\n━━━━━━━━━━━━━━━━━━━━━━━━\n';
            summary += 'Created by Sofia, your Brain Health Story Companion\n';
            summary += 'May your journey be filled with discovery and growth.\n';
            
            // Create and download file
            const blob = new Blob([summary], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `brain-health-saga-${userName.toLowerCase().replace(/\s/g, '-')}-${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            
            showBotMessage(`I've created a chronicle of your brain health saga! Your story awaits in your downloads folder. 📖✨`);
        }

        // Function to download complete user history
        function downloadUserHistory() {
            const fullData = {
                userHistory: userHistory,
                conversationLogs: conversationLog,
                feedbackLog: feedbackLog,
                safetyData: safetyData,
                exportDate: new Date().toISOString(),
                storyMetadata: {
                    totalChapters: userHistory.storyChapters ? userHistory.storyChapters.length : 0,
                    totalStoryMoments: userHistory.storyMoments ? userHistory.storyMoments.length : 0,
                    preferredStyle: userHistory.visualStyle || 'journey'
                },
                aboutMeMetadata: {
                    profileComplete: isAboutMeComplete,
                    completeness: userHistory.aboutMe ? userHistory.aboutMe.profileCompleteness : 0,
                    lastUpdated: userHistory.aboutMe ? userHistory.aboutMe.lastUpdated : null
                }
            };
            
            const dataStr = JSON.stringify(fullData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `sofia-story-data-${userHistory.profile.name || 'user'}-${new Date().toISOString()}.json`;
            link.click();
        }

        // Clear all user data
        function clearAllData() {
            const confirmClear = confirm(
                `Are you sure you want to erase your entire story?\n\n` +
                `This will permanently delete:\n` +
                `• Your About Me profile\n` +
                `• All your story chapters\n` +
                `• All quests and progress\n` +
                `• All concerns and values\n` +
                `• Your complete journey history\n\n` +
                `This action cannot be undone!`
            );
            
            if (!confirmClear) return;
            
            const doubleConfirm = confirm(
                `This is your final choice.\n\n` +
                `Type "DELETE" in the next prompt to permanently erase your story.`
            );
            
            if (doubleConfirm) {
                const userInput = prompt('Type "DELETE" to confirm:');
                if (userInput === 'DELETE') {
                    // Clear localStorage
                    localStorage.removeItem('sofiaUserHistory');
                    
                    // Reset all data structures
                    userHistory = createDefaultUserHistory();
                    
                    // Reset safety data
                    safetyData = {
                        triggers: [],
                        interventions: [],
                        contentMisalignments: [],
                        sessionRiskProfile: {
                            overallRiskLevel: "low",
                            dominantConcerns: [],
                            escalationPattern: false,
                            requiresFollowUp: false
                        }
                    };
                    
                    // Reset About Me tracking
                    selectedBestLifeElements = [];
                    selectedConcerns = [];
                    isAboutMeComplete = false;
                    
                    // Update display
                    updateMemoryDisplay();
                    
                    // Reload page to start fresh
                    alert('Your story has been erased. A new adventure begins now.');
                    window.location.reload();
                } else {
                    alert('Story preservation confirmed. Your journey continues.');
                }
            }
        }

        // Auto-save every 30 seconds
        setInterval(() => {
            saveUserHistory();
            console.log('Story auto-saved');
        }, 30000);

        // Save session duration on page unload
        window.addEventListener('beforeunload', function() {
            if (currentSessionIndex >= 0) {
                const sessionStart = new Date(userHistory.sessions[currentSessionIndex].date);
                const duration = Math.floor((new Date() - sessionStart) / 60000); // minutes
                userHistory.sessions[currentSessionIndex].duration = duration;
                saveUserHistory();
            }
        });
        
        // Helper function for API integration (if api-client.js is not loaded)
        if (typeof loadUserHistoryFromAPI === 'undefined') {
            window.loadUserHistoryFromAPI = async function() {
                // Stub function - real implementation in api-client.js
                return null;
            };
        }
    </script>
    <!-- Configuration - Update this file with your Render app URL -->
    <script src="js/config.js"></script>
    <!-- API Integration - Load this file for full backend functionality -->
    <script src="js/api-client.js"></script>
    <!-- Optional: PDF.js for PDF document support -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script> -->
</body>
</html>
