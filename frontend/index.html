<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sofia - Your Brain Health Story Companion</title>
    <link rel="icon" type="image/svg+xml" href="static/favicon.svg">
    <!-- Sofia Brain Health Story Companion
    
    This application can run in two modes:
    1. Standalone (localStorage only) - Works without any backend
    2. Full Backend (API + PostgreSQL) - Load js/api-client.js for full functionality
    
    For backend integration, ensure api-client.js is available and configure API_BASE_URL
    
    Optional Features:
    - PDF Document Upload: Uncomment the PDF.js script tag at bottom to enable PDF parsing
    - API Integration: Loads from js/api-client.js for database persistence
    -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .container {
            display: flex;
            min-height: calc(100vh - 40px);
            max-width: 1600px;
            margin: 0 auto;
            gap: 20px;
            padding: 20px;
        }

        .chat-section, .feedback-section, .memory-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 400px;
            max-height: calc(100vh - 60px);
        }

        .chat-section {
            flex: 2;
            position: relative;
        }

        .feedback-section {
            flex: 1;
        }

        .memory-section {
            flex: 1.2;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Visual Style Selector */
        .style-selector {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
        }

        .style-selector button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .style-selector button:hover {
            background: rgba(255, 255, 255, 0.9);
            color: #000;
        }

        .style-menu {
            position: absolute;
            top: 40px;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 10px;
            display: none;
            width: 200px;
        }

        .style-menu.active {
            display: block;
        }

        .style-option {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            color: #000;
            margin-bottom: 4px;
            transition: background 0.2s;
        }

        .style-option:hover {
            background: #f0f4f8;
        }

        .style-option.active {
            background: #667eea;
            color: #000;
        }

        /* About Me Profile Display */
        .about-me-summary {
            background: #e8f0fe;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .about-me-summary h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .about-me-item {
            background: white;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 6px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .about-me-item.best-life {
            border-left: 3px solid #51cf66;
        }

        .about-me-item.concern {
            border-left: 3px solid #ff6b6b;
        }

        .about-me-item.next-step {
            border-left: 3px solid #339af0;
        }

        .confidence-badge {
            background: #ffd43b;
            color: #000;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        /* Story Progress Visualization */
        .story-progress {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            display: none;
        }

        .story-progress.active {
            display: block;
        }

        .progress-journey {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .journey-node {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin: 0 5px;
            transition: all 0.3s;
        }

        .journey-node.completed {
            background: #51cf66;
            color: white;
        }

        .journey-node.current {
            background: #667eea;
            color: white;
            animation: pulse 2s infinite;
        }

        .journey-line {
            height: 2px;
            width: 40px;
            background: #e0e0e0;
        }

        .journey-line.completed {
            background: #51cf66;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Progress Garden Theme */
        .progress-garden {
            text-align: center;
            padding: 10px;
        }

        .garden-plant {
            font-size: 40px;
            transition: all 0.5s;
        }

        .garden-plant.seed { content: "üå±"; }
        .garden-plant.sprout { font-size: 50px; }
        .garden-plant.growing { font-size: 60px; }
        .garden-plant.blooming { font-size: 70px; }

        /* Progress Constellation Theme */
        .progress-constellation {
            position: relative;
            height: 100px;
            background: #1a1a2e;
            border-radius: 8px;
            overflow: hidden;
        }

        .star {
            position: absolute;
            color: #fff;
            font-size: 16px;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .chat-container, .feedback-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bot-message {
            background: #e8f0fe;
            padding: 15px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            max-width: 80%;
        }

        .bot-message.story-moment {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        .bot-message.about-me {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .user-message {
            background: #f0f4f8;
            padding: 15px;
            border-radius: 12px;
            border-left: 4px solid #764ba2;
            max-width: 80%;
            margin-left: auto;
            text-align: right;
        }

        .narrative-choice {
            background: #f8f9fa;
            border: 2px solid #667eea;
            padding: 12px 20px;
            margin: 8px 4px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            display: block;
            width: calc(100% - 8px);
            color: #000 !important;
        }

        .narrative-choice:hover {
            background: #667eea;
            color: #000 !important;
            transform: translateX(5px);
        }

        .narrative-choice::before {
            content: "‚Üí ";
            font-weight: bold;
            margin-right: 8px;
        }

        .about-me-choice {
            background: #e8f0fe;
            border: 2px solid #667eea;
            padding: 10px 16px;
            margin: 6px 4px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            display: inline-block;
            color: #000 !important;
        }

        .about-me-choice:hover {
            background: #667eea;
            color: #000 !important;
        }

        .about-me-choice.selected {
            background: #667eea;
            color: #000 !important;
        }

        /* Story Moment Indicator */
        .story-moment-indicator {
            display: inline-flex;
            align-items: center;
            background: #ffc107;
            color: #856404;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-bottom: 8px;
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }

        .story-moment-indicator::before {
            content: "üåü ";
            margin-right: 4px;
        }

        .about-me-indicator {
            display: inline-flex;
            align-items: center;
            background: #28a745;
            color: #000;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .about-me-indicator::before {
            content: "üíö ";
            margin-right: 4px;
        }

        /* Chapter Creation Modal */
        .chapter-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1050;
            overflow-y: auto;
        }

        .chapter-modal.active {
            display: flex;
        }

        .chapter-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .chapter-content h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .chapter-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .chapter-input:focus {
            border-color: #667eea;
            outline: none;
        }

        .about-me-connection {
            background: #e8f0fe;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .about-me-connection h4 {
            color: #667eea;
            margin-bottom: 8px;
        }

        .mood-arc {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .mood-node {
            font-size: 30px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .mood-node:hover {
            transform: scale(1.2);
        }

        .mood-node.selected {
            transform: scale(1.3);
            filter: brightness(1.2);
        }

        .input-section {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        input[type="text"], textarea {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Style for all buttons to ensure black text */
        button {
            padding: 12px 24px;
            background: #667eea;
            color: #000 !important;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        button:hover {
            background: #5a67d8;
            color: #000;
        }

        .feedback-header {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .feedback-header h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 5px;
        }

        .feedback-header p {
            font-size: 14px;
            color: #666;
        }

        .feedback-item {
            background: #f8f9fa;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
            font-size: 14px;
        }

        .feedback-timestamp {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .feedback-confirmation {
            background: #d4edda;
            border-left: 3px solid #28a745;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            font-size: 14px;
            animation: fadeIn 0.3s ease-in;
        }

        .goal-card {
            background: #fff3cd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }

        .goal-card h3 {
            color: #856404;
            margin-bottom: 5px;
        }

        .option-button {
            background: #e8f0fe;
            color: #000 !important;
            padding: 10px 20px;
            margin: 5px;
            border: 2px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option-button:hover {
            background: #667eea;
            color: #000 !important;
        }

        .typing-indicator {
            display: none;
            padding: 15px;
            background: #e8f0fe;
            border-radius: 12px;
            width: fit-content;
            margin-bottom: 15px;
        }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        .user-history {
            background: #e8f0fe;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            font-size: 12px;
            display: none;
        }

        .progress-indicator {
            background: #d4edda;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .safety-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #e8f0fe;
            padding: 10px 15px;
            border-radius: 20px;
        }

        /* Enhanced Continue button styling */
        button[id^="continue-"] {
            background: #764ba2 !important;
            color: white !important;
            border: 2px solid #764ba2 !important;
            box-shadow: 0 2px 5px rgba(118, 75, 162, 0.3) !important;
            font-weight: bold !important;
            font-size: 16px !important;
            padding: 14px 30px !important;
            transition: all 0.3s !important;
        }

        button[id^="continue-"]:hover {
            background: #5a3a8a !important;
            border-color: #5a3a8a !important;
            box-shadow: 0 4px 8px rgba(118, 75, 162, 0.4) !important;
            transform: translateY(-1px);
        }

        .document-upload-button {
            font-size: 12px;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 999;
        }

        .safety-indicator::before {
            content: 'üõ°Ô∏è';
            font-size: 16px;
        }

        .safety-alert {
            background: #fee;
            color: #c33;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .memory-header {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .memory-header h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 5px;
        }

        .memory-header p {
            font-size: 14px;
            color: #666;
        }

        .memory-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .memory-item {
            background: #f0f4f8;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
            position: relative;
            animation: fadeIn 0.3s ease-in;
        }

        .memory-item.concern {
            border-left-color: #ff6b6b;
        }

        .memory-item.goal {
            border-left-color: #51cf66;
        }

        .memory-item.value {
            border-left-color: #339af0;
        }

        .memory-item.education {
            border-left-color: #f59f00;
        }

        .memory-item.chapter {
            border-left-color: #9775fa;
            background: #f3f0ff;
        }

        .memory-item.about-me {
            border-left-color: #28a745;
            background: #e7f5e7;
        }

        .memory-type {
            font-size: 11px;
            text-transform: uppercase;
            color: #666;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .memory-content {
            font-size: 14px;
            color: #333;
            margin-bottom: 5px;
        }

        .memory-meta {
            font-size: 12px;
            color: #999;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .memory-actions {
            display: flex;
            gap: 10px;
        }

        .memory-action-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .memory-action-btn:hover {
            background: #e8f0fe;
            color: #000;
        }

        .memory-action-btn.delete {
            color: #ff6b6b;
        }

        .memory-action-btn.delete:hover {
            background: #fee;
        }

        .memory-edit-form {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            display: none;
        }

        .memory-edit-form.active {
            display: block;
        }

        .memory-edit-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .memory-edit-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .memory-edit-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            color: #000;
        }

        .memory-edit-btn.save {
            background: #667eea;
            color: #000;
        }

        .memory-edit-btn.cancel {
            background: #e0e0e0;
            color: #666;
        }

        .memory-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .memory-filter-btn {
            padding: 6px 12px;
            border: 1px solid #e0e0e0;
            background: white;
            color: #000;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .memory-filter-btn.active {
            background: #667eea;
            color: #000;
            border-color: #667eea;
        }

        .memory-filter-btn:hover {
            border-color: #667eea;
        }

        .memory-summary {
            background: #e8f0fe;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
            line-height: 1.6;
        }

        .memory-summary-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .memory-item.new-item {
            animation: highlight 2s ease-in-out;
        }

        @keyframes highlight {
            0% {
                background-color: #ffd43b;
                transform: scale(1.02);
            }
            50% {
                background-color: #ffe066;
            }
            100% {
                background-color: #f0f4f8;
                transform: scale(1);
            }
        }

        .memory-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #667eea;
            color: #000;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            animation: slideIn 0.3s ease-out;
            z-index: 1100;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Document Review Styles */
        .variable-review-item {
            background: #f0f4f8;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .variable-review-item.selected {
            border-color: #51cf66;
            background: #e7f5e7;
        }

        .variable-review-item.conflict {
            border-color: #ffc107;
            background: #fff3cd;
        }

        .variable-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .variable-name {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .variable-type {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
        }

        .variable-value {
            color: #555;
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            font-size: 13px;
        }

        .variable-existing {
            background: #fee;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            font-size: 12px;
        }

        .variable-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .extraction-status {
            background: #e8f0fe;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        /* Responsive design */
        @media (min-width: 1201px) {
            .chat-section, .feedback-section, .memory-section {
                max-height: calc(100vh - 60px);
            }
        }

        @media (max-width: 1400px) {
            .container {
                flex-wrap: wrap;
                min-height: auto;
            }
            
            .chat-section {
                width: 100%;
                max-height: 700px;
                order: 1;
            }
            
            .memory-section {
                width: calc(60% - 10px);
                max-height: 600px;
                order: 2;
            }
            
            .feedback-section {
                width: calc(40% - 10px);
                max-height: 600px;
                order: 3;
            }
        }

        @media (max-width: 1200px) {
            body {
                overflow-y: auto;
            }
            
            .container {
                flex-direction: column;
                min-height: auto;
                max-width: 100%;
            }
            
            .chat-section, .memory-section, .feedback-section {
                width: 100%;
                max-height: 600px;
                margin-bottom: 20px;
                order: unset;
            }
            
            .chat-section {
                max-height: 700px;
            }
        }

        @media (max-width: 768px) {
            body {
                overflow-y: auto;
            }
            
            .container {
                padding: 10px;
                gap: 10px;
            }
            
            .memory-filters {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .memory-filter-btn {
                padding: 4px 10px;
                font-size: 11px;
                margin: 2px;
            }
            
            .memory-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .safety-indicator {
                bottom: 10px;
                right: 10px;
                font-size: 11px;
                padding: 8px 12px;
            }
            
            .memory-notification {
                top: 10px;
                right: 10px;
                left: 10px;
                font-size: 13px;
                padding: 10px 16px;
            }
            
            .chat-section, .memory-section, .feedback-section {
                max-height: 500px;
                margin-bottom: 15px;
            }
            
            .chat-section {
                max-height: 600px;
            }
            
            /* Adjust upload button position on mobile */
            div[style*="position: fixed; bottom: 70px"] {
                bottom: 120px !important;
                right: 10px !important;
            }
            
            div[style*="position: fixed; bottom: 70px"] button {
                padding: 8px 16px !important;
                font-size: 14px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="chat-section">
            <div class="header">
                <h1>üß† Sofia - Your Brain Health Story Companion</h1>
                <p>Creating your personal brain health adventure</p>
                <div class="style-selector">
                    <button onclick="toggleStyleMenu()">üé® Story Style</button>
                    <div class="style-menu" id="styleMenu">
                        <div class="style-option active" onclick="setVisualStyle('journey')">üó∫Ô∏è Journey Map</div>
                        <div class="style-option" onclick="setVisualStyle('garden')">üå± Growing Garden</div>
                        <div class="style-option" onclick="setVisualStyle('constellation')">‚≠ê Star Builder</div>
                        <div class="style-option" onclick="setVisualStyle('simple')">üìä Simple Progress</div>
                    </div>
                </div>
            </div>
            <div class="story-progress" id="storyProgress">
                <!-- Progress visualization will be inserted here -->
            </div>
            <div class="chat-container" id="chatContainer">
                <div class="typing-indicator" id="typingIndicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            <div class="input-section">
                <div class="input-instruction" style="font-size: 12px; color: #666; margin-bottom: 8px; text-align: center; font-style: italic;">
                    Feel free to select a response above or enter a response or question in the box below and press Send
                </div>
                <div class="input-group">
                    <input type="text" id="userInput" placeholder="Type your message here..." />
                    <button onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>

        <div class="memory-section">
            <div class="memory-header">
                <h2>üìñ Your Story Journal</h2>
                <p>Your brain health journey, captured in chapters</p>
                <p style="font-size: 11px; color: #888; margin-top: 5px;">‚úèÔ∏è Edit to refine your story | üóëÔ∏è Delete unwanted memories | üìë Create chapters</p>
            </div>
            <div class="memory-container">
                <!-- About Me Summary Section -->
                <div class="about-me-summary" id="aboutMeSummary" style="display: none;">
                    <h3>üíö What Matters Most to You</h3>
                    <div id="aboutMeContent"></div>
                </div>
                
                <div class="memory-summary" id="memorySummary">
                    <div class="memory-summary-stat">
                        <span>Active Goals:</span>
                        <strong id="activeGoalsCount">0</strong>
                    </div>
                    <div class="memory-summary-stat">
                        <span>Story Chapters:</span>
                        <strong id="chaptersCount">0</strong>
                    </div>
                    <div class="memory-summary-stat">
                        <span>Topics Explored:</span>
                        <strong id="topicsCount">0</strong>
                    </div>
                    <div class="memory-summary-stat">
                        <span>About Me - Living My Best Life:</span>
                        <strong id="bestLifeCount">0</strong>
                    </div>
                    <div class="memory-summary-stat">
                        <span>About Me - Key Concerns:</span>
                        <strong id="concernsCount">0</strong>
                    </div>
                </div>
                <div class="memory-filters">
                    <button class="memory-filter-btn active" onclick="filterMemory('all')">All</button>
                    <button class="memory-filter-btn" onclick="filterMemory('about-me')">About Me</button>
                    <button class="memory-filter-btn" onclick="filterMemory('chapter')">Chapters</button>
                    <button class="memory-filter-btn" onclick="filterMemory('goal')">Goals</button>
                    <button class="memory-filter-btn" onclick="filterMemory('concern')">Concerns</button>
                    <button class="memory-filter-btn" onclick="filterMemory('value')">Values</button>
                    <button class="memory-filter-btn" onclick="filterMemory('education')">Learning</button>
                </div>
                <div id="memoryList"></div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                    <button class="memory-action-btn" onclick="createStoryCompilation()" style="margin-right: 10px;">üìö Create Story</button>
                    <button class="memory-action-btn" onclick="downloadMemorySummary()" style="margin-right: 10px;">üìÑ Export Summary</button>
                    <button class="memory-action-btn" onclick="downloadUserHistory()" style="margin-right: 10px;">üì• Export All Data</button>
                    <button class="memory-action-btn delete" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                </div>
            </div>
        </div>

        <div class="feedback-section">
            <div class="feedback-header">
                <h2>üí≠ Share Your Thoughts</h2>
                <p>Help us improve your story experience</p>
            </div>
            <div class="feedback-container" id="feedbackContainer"></div>
            <div class="input-section">
                <textarea id="feedbackInput" placeholder="How was this conversation? Any suggestions?" rows="3"></textarea>
                <button onclick="submitFeedback()" style="margin-top: 10px; width: 100%;">Submit Feedback</button>
            </div>
        </div>
    </div>
    
    <div class="safety-indicator" id="safetyIndicator">
        Your conversation is monitored for safety
    </div>

    <!-- Document Upload Button -->
    <div style="position: fixed; bottom: 70px; right: 20px; z-index: 999;">
        <button onclick="openDocumentUpload()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 25px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 18px;">üìÑ</span>
            <span>Upload Document</span>
        </button>
        <input type="file" id="documentUpload" accept=".txt,.pdf,.doc,.docx,.json,.csv" style="display: none;" onchange="handleDocumentUpload(event)">
    </div>

    <!-- Document Review Modal -->
    <div class="chapter-modal" id="documentReviewModal">
        <div class="chapter-content" style="max-width: 800px; max-height: 90vh;">
            <h2>üìÑ Review Extracted Information</h2>
            <p style="font-size: 14px; color: #666; margin-bottom: 20px;">
                I've extracted the following information from your document. Please review and approve what you'd like to add to your profile.
            </p>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                <button onclick="selectAllExtracted()" style="background: #51cf66; padding: 8px 16px; font-size: 14px;">
                    ‚úÖ Select All
                </button>
                <button onclick="deselectAllExtracted()" style="background: #ff6b6b; padding: 8px 16px; font-size: 14px;">
                    ‚ùå Deselect All
                </button>
            </div>
            
            <div id="extractedVariablesList" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                <!-- Extracted variables will be shown here -->
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="closeDocumentReview()">Cancel</button>
                <button onclick="applySelectedVariables()" style="background: #51cf66; color: #000;">
                    Apply Selected to Profile
                </button>
            </div>
        </div>
    </div>

    <!-- Chapter Creation Modal -->
    <div class="chapter-modal" id="chapterModal">
        <div class="chapter-content">
            <h2>Create Your Chapter</h2>
            
            <div class="about-me-connection" id="chapterAboutMeConnection" style="display: none;">
                <h4>This chapter connects to what matters most:</h4>
                <div id="chapterAboutMeLinks"></div>
            </div>
            
            <input type="text" class="chapter-input" id="chapterTitle" placeholder="Chapter Title...">
            <textarea class="chapter-input" id="chapterMoment" placeholder="Describe the key moment..." rows="3"></textarea>
            
            <p style="margin-top: 15px; font-size: 14px; color: #666;">Your emotional journey:</p>
            <div class="mood-arc">
                <div class="mood-node" onclick="selectMood(0, 'üòî')">üòî</div>
                <div class="mood-node" onclick="selectMood(1, 'üòê')">üòê</div>
                <div class="mood-node" onclick="selectMood(2, 'üòä')">üòä</div>
                <div class="mood-node" onclick="selectMood(3, 'üòÑ')">üòÑ</div>
                <div class="mood-node" onclick="selectMood(4, 'üåü')">üåü</div>
            </div>
            
            <textarea class="chapter-input" id="chapterChoices" placeholder="What choices led to this moment?" rows="3"></textarea>
            <textarea class="chapter-input" id="chapterLearning" placeholder="What did you learn?" rows="3"></textarea>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="closeChapterModal()">Cancel</button>
                <button onclick="saveChapter()" style="background: #51cf66; color: #000;">Save Chapter</button>
            </div>
        </div>
    </div>

    <script>
        // Sofia - Cognitive Care Companion Configuration with About Me Care Model
        const companionConfig = {
            identity: {
                name: "Sofia",
                role: "Brain Health Story Companion",
                mission: "Guide you in creating your personal brain health transformation story centered on what matters most to you",
                approach: "Narrative-focused, empowering, using second-person perspective, About Me-centered"
            },
            targetAudience: "Adults aged 55 and older",
            aboutMeFramework: {
                bestLifeElements: [
                    "Spend time with people I care about",
                    "Live on my own / be independent",
                    "Take care of my daily needs",
                    "Exercise or play games regularly",
                    "Participate in favorite hobbies",
                    "Spend time outdoors or travel",
                    "Work, volunteer, or help others",
                    "Spend time with pets",
                    "Have mental stimulation everyday"
                ],
                concernCategories: [
                    "Getting help with daily tasks",
                    "My ability to live on my own",
                    "My safety",
                    "My finances",
                    "My anxiety",
                    "Losing interest in hobbies",
                    "My diet",
                    "Being lost or disoriented",
                    "My sleep",
                    "Alcohol or tobacco use",
                    "My balance, falling",
                    "My hearing or vision",
                    "Being alone",
                    "Being a burden",
                    "Quality of care I receive"
                ],
                confidenceLevels: ["Very confident", "Somewhat confident", "Not very confident"]
            },
            narrativeFramework: {
                core: "SAFEST BRAINS",
                topics: {
                    S: "Sleep optimization narratives",
                    A: "Activity and exercise stories",
                    F: "Food and nutrition choices",
                    E: "Education through interactive learning",
                    S2: "Social connection chapters",
                    T: "Tobacco/substance avoidance paths"
                }
            },
            storyElements: {
                momentRecognition: true,
                chapterCreation: true,
                visualJournal: true,
                progressMetaphors: ["journey", "garden", "constellation", "simple"]
            }
        };

        // Remove markdown formatting from bot messages
        function cleanBotMessage(message) {
            // Remove ** markdown bold formatting
            return message.replace(/\*\*/g, '');
        }

        // Helper function to categorize brain health questions
        function detectBrainHealthTopic(message) {
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('memory') || lowerMessage.includes('forget')) {
                return "memory and recall";
            } else if (lowerMessage.includes('exercise') || lowerMessage.includes('physical')) {
                return "physical activity and brain health";
            } else if (lowerMessage.includes('food') || lowerMessage.includes('diet') || lowerMessage.includes('eat')) {
                return "nutrition and brain health";
            } else if (lowerMessage.includes('sleep') || lowerMessage.includes('tired')) {
                return "sleep and brain recovery";
            } else if (lowerMessage.includes('stress') || lowerMessage.includes('worry') || lowerMessage.includes('anxiety')) {
                return "stress and emotional wellbeing";
            } else if (lowerMessage.includes('social') || lowerMessage.includes('lonely') || lowerMessage.includes('friends')) {
                return "social connections";
            } else {
                return "brain health";
            }
        }

        // Sofia's Conversation Principles - Foundation for Responsive Interactions
        const conversationPrinciples = {
            // 1. ALWAYS respond to what the user actually selected/said
            respondFirst: (userChoice) => {
                return `You've chosen to ${userChoice}. Let's explore this together.\n\n`;
            },
            
            // 2. Ask clarifying questions before assuming direction
            clarifyIntent: () => {
                return "Help me understand what you'd like to focus on with this. ";
            },
            
            // 3. Offer options but don't force them
            offerWithoutForcing: (options) => {
                return "You might want to " + options.join(", or ") + ". Or perhaps something else entirely?";
            },
            
            // 4. Keep existing context as background, not foreground
            contextAsBackground: (context) => {
                return `\n\n(For reference: ${context})`;
            },
            
            // 5. End with invitation for their thoughts
            inviteResponse: () => {
                const invitations = [
                    "What are your thoughts?",
                    "What feels right to you?",
                    "Tell me what you're thinking.",
                    "What would you like to explore?",
                    "Share what's on your mind."
                ];
                return invitations[Math.floor(Math.random() * invitations.length)];
            }
        };

        // Universal response function that always acknowledges user input
        function createResponsiveReply(userMessage, context = {}) {
            let response = "";
            
            // ALWAYS acknowledge what they said first
            if (userMessage.length > 20) {
                response += `I hear you saying: "${userMessage.substring(0, 100)}..."\n\n`;
            }
            
            // Add context if relevant, but don't force it
            if (context.existingGoal && !context.hideGoal) {
                response += `(Just for context, you're working on: "${context.existingGoal}")\n\n`;
            }
            
            // Ask open-ended follow-up
            response += context.followUp || "Tell me more about what this means for you.";
            
            return response;
        }

        // ============= TOKEN-EFFICIENT DOCUMENT PROCESSOR CLASS =============
        class TokenEfficientDocumentProcessor {
            constructor() {
                this.chunkSize = 500; // characters per chunk
                this.overlapSize = 50; // overlap between chunks
            }
            
            async processDocument(text, filename) {
                // 1. Create document summary WITHOUT LLM
                const summary = this.createLocalSummary(text);
                
                // 2. Extract key information locally
                const extracted = {
                    medications: this.extractMedications(text),
                    conditions: this.extractConditions(text),
                    dates: this.extractDates(text),
                    keyPhrases: this.extractKeyPhrases(text),
                    documentType: this.classifyDocument(text)
                };
                
                // 3. Create semantic chunks for Q&A
                const chunks = this.createSemanticChunks(text);
                
                // 4. Store processed data (NO LLM CALLS YET)
                return {
                    id: 'doc_' + Date.now(),
                    filename: filename,
                    summary: summary, // 100-200 words max
                    extracted: extracted,
                    chunks: chunks, // For targeted Q&A
                    fullTextHash: this.hashText(text), // For verification
                    requiresLLM: false // Flag for when LLM needed
                };
            }
            
            createLocalSummary(text) {
                const sentences = text.match(/[^.!?]+[.!?]+/g) || [];
                const firstSentence = sentences[0] || '';
                
                const importantSentences = sentences.filter(s => 
                    /diagnosis|prescribed|recommend|result|finding/i.test(s)
                ).slice(0, 3);
                
                const summary = [firstSentence, ...importantSentences]
                    .join(' ')
                    .substring(0, 500);
                    
                return summary;
            }
            
            extractMedications(text) {
                const medPattern = /\b(?:mg|mcg|ml|tablet|capsule|daily|twice|three times)\b/gi;
                const lines = text.split('\n');
                const medications = [];
                
                lines.forEach(line => {
                    if (medPattern.test(line) && line.length < 100) {
                        medications.push(line.trim());
                    }
                });
                
                return [...new Set(medications)]; // Remove duplicates
            }
            
            extractConditions(text) {
                const conditions = [
                    'diabetes', 'hypertension', 'high blood pressure', 'dementia',
                    'alzheimer', 'memory loss', 'cognitive decline', 'depression',
                    'anxiety', 'arthritis', 'heart disease', 'copd', 'asthma'
                ];
                
                const found = [];
                const lowerText = text.toLowerCase();
                conditions.forEach(condition => {
                    if (lowerText.includes(condition)) {
                        found.push(condition);
                    }
                });
                
                return [...new Set(found)];
            }
            
            extractDates(text) {
                const datePattern = /\b\d{1,2}[/-]\d{1,2}[/-]\d{2,4}\b/g;
                return text.match(datePattern) || [];
            }
            
            extractKeyPhrases(text) {
                // Simple key phrase extraction
                const phrases = [];
                const importantWords = ['diagnosis', 'treatment', 'medication', 'appointment', 
                                       'recommendation', 'follow-up', 'results', 'findings'];
                
                const sentences = text.split(/[.!?]+/);
                sentences.forEach(sentence => {
                    const lower = sentence.toLowerCase();
                    importantWords.forEach(word => {
                        if (lower.includes(word)) {
                            phrases.push(sentence.trim().substring(0, 100));
                        }
                    });
                });
                
                return phrases.slice(0, 5); // Limit to 5 key phrases
            }
            
            classifyDocument(text) {
                const lowerText = text.toLowerCase();
                
                if (lowerText.includes('lab result') || lowerText.includes('test result')) {
                    return 'lab_results';
                } else if (lowerText.includes('prescription') || this.extractMedications(text).length > 2) {
                    return 'prescription';
                } else if (lowerText.includes('discharge') || lowerText.includes('summary')) {
                    return 'medical_summary';
                } else if (lowerText.includes('assessment') || lowerText.includes('evaluation')) {
                    return 'medical_assessment';
                } else if (lowerText.includes('invoice') || lowerText.includes('bill')) {
                    return 'billing';
                }
                
                return 'general_medical';
            }
            
            createSemanticChunks(text) {
                const chunks = [];
                const sections = this.splitIntoSections(text);
                
                sections.forEach(section => {
                    const sectionChunks = this.chunkText(section.content);
                    sectionChunks.forEach((chunk, index) => {
                        chunks.push({
                            id: `${section.type}_${index}`,
                            type: section.type,
                            content: chunk,
                            keywords: this.extractKeywords(chunk),
                            charCount: chunk.length
                        });
                    });
                });
                
                return chunks;
            }
            
            splitIntoSections(text) {
                const sections = [];
                const patterns = {
                    medications: /medications?|prescriptions?|drugs?/i,
                    diagnosis: /diagnosis|findings?|impressions?/i,
                    history: /history|background|past medical/i,
                    labs: /lab|results?|values?|tests?/i,
                    instructions: /instructions?|follow-up|return|call/i
                };
                
                let currentSection = { type: 'general', content: '' };
                const lines = text.split('\n');
                
                lines.forEach(line => {
                    let sectionFound = false;
                    for (const [type, pattern] of Object.entries(patterns)) {
                        if (pattern.test(line)) {
                            if (currentSection.content) {
                                sections.push(currentSection);
                            }
                            currentSection = { type, content: line + '\n' };
                            sectionFound = true;
                            break;
                        }
                    }
                    if (!sectionFound) {
                        currentSection.content += line + '\n';
                    }
                });
                
                if (currentSection.content) {
                    sections.push(currentSection);
                }
                
                return sections;
            }
            
            chunkText(text) {
                const chunks = [];
                let start = 0;
                
                while (start < text.length) {
                    let end = start + this.chunkSize;
                    
                    // Try to break at sentence boundary
                    if (end < text.length) {
                        const nextPeriod = text.indexOf('.', end - 50);
                        if (nextPeriod > 0 && nextPeriod < end + 50) {
                            end = nextPeriod + 1;
                        }
                    }
                    
                    chunks.push(text.substring(start, end));
                    start = end - this.overlapSize;
                }
                
                return chunks;
            }
            
            extractKeywords(text) {
                // Simple keyword extraction
                const words = text.toLowerCase().split(/\W+/);
                const stopWords = ['the', 'is', 'at', 'which', 'on', 'a', 'an', 'and', 'or', 'but'];
                return words
                    .filter(w => w.length > 3 && !stopWords.includes(w))
                    .slice(0, 10);
            }
            
            hashText(text) {
                // Simple hash for verification
                let hash = 0;
                for (let i = 0; i < text.length; i++) {
                    const char = text.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString(16);
            }
        }

        // Test function for document processor
        function testDocumentProcessor() {
            try {
                console.log('üß™ Testing document processor...');
                const processor = new TokenEfficientDocumentProcessor();
                console.log('‚úÖ Class instantiated successfully');
                console.log('üìä Chunk size:', processor.chunkSize);
                console.log('üìä Overlap size:', processor.overlapSize);
                
                // Test with sample text
                const sampleText = "Patient diagnosed with diabetes. Prescribed Metformin 500mg twice daily.";
                console.log('üìù Sample text:', sampleText);
                
                processor.processDocument(sampleText, "test.txt").then(result => {
                    console.log('‚úÖ Document processed successfully:', result);
                    
                    // Test Q&A system with the processed document
                    console.log('üß™ Testing Q&A system...');
                    const qa = new TokenEfficientQA(result);
                    console.log('‚úÖ Q&A system initialized');
                    
                    // Test a question
                    qa.answerQuestion("What medications are mentioned?").then(answer => {
                        console.log('‚úÖ Q&A test successful:', answer);
                    }).catch(error => {
                        console.error('‚ùå Q&A test failed:', error);
                    });
                    
                }).catch(error => {
                    console.error('‚ùå Processing failed:', error);
                });
                
            } catch (error) {
                console.error('‚ùå Test failed:', error);
            }
        }

        // Test function for file reading capabilities
        function testFileReading() {
            try {
                console.log('üß™ Testing file reading functions...');
                
                // Test if functions are available
                console.log('üìÑ readTextFile available:', typeof readTextFile === 'function');
                console.log('üìÑ readPDFFile available:', typeof readPDFFile === 'function');
                console.log('üìÑ readWordFile available:', typeof readWordFile === 'function');
                console.log('üìÑ loadPDFJS available:', typeof loadPDFJS === 'function');
                console.log('üìÑ loadMammoth available:', typeof loadMammoth === 'function');
                
                // Test PDF.js loader
                console.log('üß™ Testing PDF.js loader...');
                loadPDFJS().then(() => {
                    console.log('‚úÖ PDF.js loaded successfully');
                    console.log('üìä pdfjsLib available:', typeof pdfjsLib !== 'undefined');
                }).catch(error => {
                    console.error('‚ùå PDF.js loading failed:', error);
                });
                
                // Test Mammoth loader
                console.log('üß™ Testing Mammoth loader...');
                loadMammoth().then(() => {
                    console.log('‚úÖ Mammoth loaded successfully');
                    console.log('üìä mammoth available:', typeof mammoth !== 'undefined');
                }).catch(error => {
                    console.error('‚ùå Mammoth loading failed:', error);
                });
                
            } catch (error) {
                console.error('‚ùå File reading test failed:', error);
            }
        }

        // Test function for document upload handler
        function testDocumentUpload() {
            try {
                console.log('üß™ Testing document upload handler...');
                
                // Test if functions are available
                console.log('üìÑ handleDocumentUpload available:', typeof handleDocumentUpload === 'function');
                console.log('üìÑ handleProcessedDocument available:', typeof handleProcessedDocument === 'function');
                console.log('üìÑ documentProcessor available:', typeof documentProcessor !== 'undefined');
                
                // Test document processor instance
                if (documentProcessor) {
                    console.log('‚úÖ Document processor instance available');
                    console.log('üìä Chunk size:', documentProcessor.chunkSize);
                } else {
                    console.error('‚ùå Document processor not available');
                }
                
                // Test with sample text (simulate document processing)
                const sampleText = "Patient diagnosed with hypertension. Prescribed Lisinopril 10mg daily.";
                console.log('üìù Sample medical text:', sampleText);
                
                documentProcessor.processDocument(sampleText, "test_medical.txt").then(result => {
                    console.log('‚úÖ Sample document processed successfully:', result);
                    
                    // Test the processed document handler
                    handleProcessedDocument(result);
                    console.log('‚úÖ Document handler test completed');
                    
                }).catch(error => {
                    console.error('‚ùå Sample processing failed:', error);
                });
                
            } catch (error) {
                console.error('‚ùå Document upload test failed:', error);
            }
        }

        // Simple test function that should definitely work
        function simpleTest() {
            console.log('üß™ Simple test function working!');
            console.log('Available functions:');
            console.log('- testDocumentProcessor:', typeof testDocumentProcessor);
            console.log('- testFileReading:', typeof testFileReading);
            console.log('- testDocumentUpload:', typeof testDocumentUpload);
            console.log('- handleDocumentUpload:', typeof handleDocumentUpload);
        }

        // Test function for complete document Q&A system
        function testDocumentQA() {
            try {
                console.log('üß™ Testing complete document Q&A system...');
                
                // Test if Q&A handlers are available
                console.log('üìÑ handleDocumentReviewResponses available:', typeof handleDocumentReviewResponses === 'function');
                console.log('üìÑ handleDocumentQA available:', typeof handleDocumentQA === 'function');
                console.log('üìÑ handleDocumentQuestion available:', typeof handleDocumentQuestion === 'function');
                console.log('üìÑ generateSmartFollowUps available:', typeof generateSmartFollowUps === 'function');
                
                // Test with sample document
                const sampleText = "Patient diagnosed with diabetes and hypertension. Prescribed Metformin 500mg twice daily and Lisinopril 10mg daily.";
                console.log('üìù Sample medical text:', sampleText);
                
                documentProcessor.processDocument(sampleText, "test_qa.txt").then(result => {
                    console.log('‚úÖ Sample document processed for Q&A test:', result);
                    
                    // Test Q&A system
                    currentDocumentQA = new TokenEfficientQA(result);
                    userHistory.currentDocument = result;
                    
                    console.log('‚úÖ Q&A system initialized with document');
                    
                    // Test a question
                    currentDocumentQA.answerQuestion("What medications are mentioned?").then(answer => {
                        console.log('‚úÖ Q&A test successful:', answer);
                        console.log('üéØ Document Q&A system is fully functional!');
                    }).catch(error => {
                        console.error('‚ùå Q&A test failed:', error);
                    });
                    
                }).catch(error => {
                    console.error('‚ùå Sample processing failed:', error);
                });
                
            } catch (error) {
                console.error('‚ùå Document Q&A test failed:', error);
            }
        }

        // Test function for PDF.js loading specifically
        function testPDFJS() {
            try {
                console.log('üß™ Testing PDF.js loading...');
                
                // Test if loadPDFJS function is available
                console.log('üìÑ loadPDFJS available:', typeof loadPDFJS === 'function');
                
                // Test PDF.js loading
                console.log('üß™ Attempting to load PDF.js...');
                loadPDFJS().then(() => {
                    console.log('‚úÖ PDF.js loaded successfully!');
                    console.log('üìä pdfjsLib available:', typeof pdfjsLib !== 'undefined');
                    
                    if (typeof pdfjsLib !== 'undefined') {
                        console.log('üìä PDF.js version:', pdfjsLib.version);
                        console.log('üéØ PDF reading is now available!');
                    }
                }).catch(error => {
                    console.error('‚ùå PDF.js loading failed:', error);
                });
                
            } catch (error) {
                console.error('‚ùå PDF.js test failed:', error);
            }
        }

        // Test function for Intent Recognition System
        function testIntentRecognition() {
            try {
                console.log('üß™ Testing Intent Recognition System...');
                
                // Test if functions are available
                console.log('üìÑ detectUserIntent available:', typeof detectUserIntent === 'function');
                console.log('üìÑ detectTopicDivergence available:', typeof detectTopicDivergence === 'function');
                console.log('üìÑ generateNaturalTopicSwitch available:', typeof generateNaturalTopicSwitch === 'function');
                
                // Test with the specific examples you mentioned
                const testMessages = [
                    "I'm feeling really anxious about my upcoming doctor's appointment",
                    "Work stress is really affecting my sleep",
                    "I'm worried about my health",
                    "My relationship with my daughter has been challenging lately",
                    "I'm having trouble sleeping"
                ];
                
                console.log('üß™ Testing specific situation detection...');
                testMessages.forEach((message, index) => {
                    console.log(`\nüìù Test ${index + 1}: "${message}"`);
                    const intent = detectUserIntent(message, 'about_me_best_life');
                    console.log('üéØ Intent result:', intent);
                    
                    if (intent.shouldSwitch) {
                        const response = generateNaturalTopicSwitch(intent);
                        console.log('üí¨ Generated response:');
                        console.log('   Message:', response.message);
                        console.log('   Options:', response.options);
                    }
                });
                
                console.log('\n‚úÖ Intent Recognition System test completed!');
                
            } catch (error) {
                console.error('‚ùå Intent Recognition test failed:', error);
            }
        }



        // ============= TOKEN-EFFICIENT Q&A CLASS =============
        class TokenEfficientQA {
            constructor(document) {
                this.document = document;
                this.maxContextTokens = 500;
            }
            
            async answerQuestion(question) {
                // 1. Try to answer without LLM first
                const localAnswer = this.tryLocalAnswer(question);
                if (localAnswer.confidence > 0.8) {
                    return localAnswer.answer;
                }
                
                // 2. Find relevant chunks only
                const relevantChunks = this.findRelevantChunks(question);
                
                // 3. If no relevant chunks, check if question needs clarification
                if (relevantChunks.length === 0) {
                    return this.handleNoRelevantContent(question);
                }
                
                // 4. For now, return structured answer from chunks (no LLM)
                return this.createStructuredAnswer(relevantChunks, question);
            }
            
            tryLocalAnswer(question) {
                const q = question.toLowerCase();
                
                // Medication questions
                if (q.includes('medication') || q.includes('medicine') || q.includes('prescription')) {
                    if (this.document.extracted.medications.length > 0) {
                        return {
                            answer: `Based on your document, these medications are mentioned:\n\n${
                                this.document.extracted.medications.map(m => `‚Ä¢ ${m}`).join('\n')
                            }\n\nIs there something specific about these medications you'd like to know?`,
                            confidence: 0.9
                        };
                    } else {
                        return {
                            answer: "I don't see any specific medications mentioned in this document.",
                            confidence: 0.9
                        };
                    }
                }
                
                // Date questions
                if (q.includes('when') || q.includes('date') || q.includes('appointment')) {
                    if (this.document.extracted.dates.length > 0) {
                        return {
                            answer: `The document contains these dates:\n\n${
                                this.document.extracted.dates.map(d => `‚Ä¢ ${d}`).join('\n')
                            }\n\nDo any of these relate to what you're looking for?`,
                            confidence: 0.9
                        };
                    }
                }
                
                // Condition questions
                if (q.includes('condition') || q.includes('diagnosis') || q.includes('problem')) {
                    if (this.document.extracted.conditions.length > 0) {
                        return {
                            answer: `The document mentions these conditions:\n\n${
                                this.document.extracted.conditions.map(c => `‚Ä¢ ${c}`).join('\n')
                            }\n\nWould you like to know more about any of these?`,
                            confidence: 0.85
                        };
                    }
                }
                
                // Document type questions
                if (q.includes('what kind') || q.includes('type of document') || q.includes('what is this')) {
                    return {
                        answer: `This appears to be a ${this.document.extracted.documentType.replace('_', ' ')} document.`,
                        confidence: 0.85
                    };
                }
                
                return { answer: null, confidence: 0 };
            }
            
            findRelevantChunks(question) {
                const keywords = this.extractQueryKeywords(question);
                const scored = [];
                
                this.document.chunks.forEach(chunk => {
                    let score = 0;
                    
                    // Keyword matching
                    keywords.forEach(keyword => {
                        if (chunk.content.toLowerCase().includes(keyword)) {
                            score += 2;
                        }
                        if (chunk.keywords.includes(keyword)) {
                            score += 1;
                        }
                    });
                    
                    // Type matching
                    if (this.questionMatchesType(question, chunk.type)) {
                        score += 3;
                    }
                    
                    if (score > 0) {
                        scored.push({ chunk, score });
                    }
                });
                
                // Return top 3 chunks
                return scored
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 3)
                    .map(s => s.chunk);
            }
            
            extractQueryKeywords(question) {
                const stopWords = ['what', 'when', 'where', 'how', 'is', 'are', 'the', 'a', 'an'];
                return question.toLowerCase()
                    .split(/\W+/)
                    .filter(w => w.length > 2 && !stopWords.includes(w));
            }
            
            questionMatchesType(question, chunkType) {
                const q = question.toLowerCase();
                const typeMatches = {
                    medications: ['medication', 'medicine', 'drug', 'prescription'],
                    diagnosis: ['diagnosis', 'condition', 'problem'],
                    labs: ['lab', 'test', 'result', 'value'],
                    instructions: ['instruction', 'follow', 'next', 'appointment']
                };
                
                return typeMatches[chunkType]?.some(word => q.includes(word)) || false;
            }
            
            createStructuredAnswer(chunks, question) {
                let answer = "Based on your document:\n\n";
                
                chunks.forEach((chunk, index) => {
                    // Extract most relevant sentences
                    const sentences = chunk.content.split(/[.!?]+/);
                    const relevantSentences = sentences.filter(s => {
                        const sLower = s.toLowerCase();
                        return this.extractQueryKeywords(question).some(k => sLower.includes(k));
                    }).slice(0, 2);
                    
                    if (relevantSentences.length > 0) {
                        answer += `${relevantSentences.join('. ').trim()}.\n\n`;
                    }
                });
                
                answer += "Is there something specific you'd like me to clarify?";
                return answer;
            }
            
            handleNoRelevantContent(question) {
                return `I couldn't find specific information about "${question}" in the document. ` +
                       `\n\nThe document contains information about:\n` +
                       `‚Ä¢ ${this.document.extracted.documentType.replace('_', ' ')}\n` +
                       (this.document.extracted.medications.length > 0 ? `‚Ä¢ Medications\n` : '') +
                       (this.document.extracted.conditions.length > 0 ? `‚Ä¢ Medical conditions\n` : '') +
                       (this.document.extracted.dates.length > 0 ? `‚Ä¢ Important dates\n` : '') +
                       `\nWhat would you like to know about?`;
            }
        }

        // ============= FILE READING FUNCTIONS =============
        
        // Text file reader
        async function readTextFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        // PDF file reader - Simple and reliable
        async function readPDFFile(file) {
            try {
                // Simple check for PDF.js
                if (typeof pdfjsLib === 'undefined') {
                    console.log('üìÑ PDF.js not available, loading...');
                    await loadPDFJS();
                }
                
                // Verify PDF.js is available
                if (typeof pdfjsLib === 'undefined') {
                    throw new Error('PDF.js failed to load');
                }
                
                console.log('‚úÖ PDF.js available, processing PDF...');
                
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        try {
                            const pdfData = new Uint8Array(e.target.result);
                            const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                            let fullText = '';
                            
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const textContent = await page.getTextContent();
                                const pageText = textContent.items
                                    .map(item => item.str)
                                    .join(' ');
                                fullText += pageText + '\n\n';
                            }
                            
                            if (!fullText.trim()) {
                                reject(new Error('PDF appears to be image-based. Try saving as a text file.'));
                                return;
                            }
                            
                            resolve(fullText);
                        } catch (error) {
                            reject(new Error(`PDF processing failed: ${error.message}`));
                        }
                    };
                    reader.onerror = () => reject(new Error('Could not read file'));
                    reader.readAsArrayBuffer(file);
                });
                
            } catch (error) {
                console.error('PDF.js error:', error);
                throw new Error('PDF reading is not available. Please use a text file (.txt) or copy and paste the content.');
            }
        }

        // Word document reader
        async function readWordFile(file) {
            if (typeof mammoth === 'undefined') {
                await loadMammoth();
            }
            
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const arrayBuffer = e.target.result;
                        const result = await mammoth.extractRawText({ arrayBuffer });
                        resolve(result.value);
                    } catch (error) {
                        reject(new Error('Could not read Word document. Try saving as PDF or text.'));
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Dynamic script loaders - Simple and reliable
        async function loadPDFJS() {
            return new Promise((resolve, reject) => {
                if (typeof pdfjsLib !== 'undefined') {
                    resolve();
                    return;
                }
                
                console.log('üìÑ Loading PDF.js...');
                
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
                
                script.onload = () => {
                    console.log('‚úÖ PDF.js loaded successfully');
                    
                    // Configure worker
                    if (typeof pdfjsLib !== 'undefined') {
                        pdfjsLib.GlobalWorkerOptions.workerSrc = 
                            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                        resolve();
                    } else {
                        reject(new Error('PDF.js failed to initialize'));
                    }
                };
                
                script.onerror = () => {
                    reject(new Error('Failed to load PDF.js'));
                };
                
                document.head.appendChild(script);
            });
        }

        async function loadMammoth() {
            return new Promise((resolve, reject) => {
                if (typeof mammoth !== 'undefined') {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js';
                script.onload = resolve;
                script.onerror = () => reject(new Error('Failed to load Mammoth.js'));
                document.head.appendChild(script);
            });
        }

        // ============= DOCUMENT UPLOAD HANDLER =============
        
        // Global variables for document processing
        const documentProcessor = new TokenEfficientDocumentProcessor();
        let currentDocumentQA = null;

        // Enhanced document upload handler
        async function handleDocumentUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            documentProcessing = true;
            showBotMessage("üìÑ I'm reading your document. This may take a moment...");
            
            try {
                // Extract text based on file type
                let extractedText = "";
                let extractionMethod = "";
                
                if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                    extractedText = await readTextFile(file);
                    extractionMethod = 'text';
                } else if (file.type === 'application/pdf' || file.name.endsWith('.pdf')) {
                    try {
                        extractedText = await readPDFFile(file);
                        extractionMethod = 'pdf';
                    } catch (pdfError) {
                        console.error('PDF reading failed:', pdfError);
                        // Offer text conversion fallback
                        showBotMessage(
                            `I couldn't read your PDF file. This often happens when:\n` +
                            `‚Ä¢ The PDF contains only scanned images\n` +
                            `‚Ä¢ PDF.js library couldn't load from CDN\n` +
                            `‚Ä¢ Network restrictions are blocking external libraries\n\n` +
                            `Would you like to:\n` +
                            `‚Ä¢ Try uploading again\n` +
                            `‚Ä¢ Convert your PDF to text and paste it here\n` +
                            `‚Ä¢ Use a different file format\n` +
                            `‚Ä¢ Tell me what the document contains`,
                            [
                                "‚Üí Try uploading again",
                                "‚Üí I'll paste the text instead",
                                "‚Üí Use different file format",
                                "‚Üí Tell me about the document"
                            ]
                        );
                        currentPhase = "document_upload_fallback";
                        documentProcessing = false;
                        event.target.value = '';
                        return;
                    }
                } else if (file.type.includes('wordprocessingml') || file.name.endsWith('.docx')) {
                    extractedText = await readWordFile(file);
                    extractionMethod = 'docx';
                } else {
                    throw new Error(`File type not supported. Please use TXT, PDF, or Word documents.`);
                }
                
                if (!extractedText || extractedText.trim().length < 10) {
                    throw new Error('Could not extract readable text from document');
                }
                
                // Process document locally with token efficiency
                const processedDoc = await documentProcessor.processDocument(extractedText, file.name);
                
                // Store document reference
                userHistory.uploadedDocuments = userHistory.uploadedDocuments || [];
                userHistory.uploadedDocuments.push({
                    id: processedDoc.id,
                    filename: file.name,
                    uploadDate: new Date().toISOString(),
                    documentType: processedDoc.extracted.documentType,
                    hasMedialInfo: processedDoc.extracted.medications.length > 0 || 
                                   processedDoc.extracted.conditions.length > 0
                });
                
                // Store for Q&A
                userHistory.currentDocument = processedDoc;
                currentDocumentQA = new TokenEfficientQA(processedDoc);
                
                // Save to localStorage for persistence
                localStorage.setItem(`doc_${processedDoc.id}`, JSON.stringify(processedDoc));
                saveUserHistory();
                
                // Handle response based on content
                handleProcessedDocument(processedDoc);
                
            } catch (error) {
                console.error('Document processing error:', error);
                showBotMessage(
                    `I had trouble reading your document: ${error.message}\n\n` +
                    `Would you like to:`,
                    [
                        "‚Üí Try uploading again",
                        "‚Üí Type or paste the content instead",
                        "‚Üí Tell me what the document is about"
                    ]
                );
            } finally {
                documentProcessing = false;
                event.target.value = ''; // Reset file input
            }
        }

        // Handle processed document
        function handleProcessedDocument(processedDoc) {
            currentPhase = "document_review";
            
            let message = `‚úÖ I've successfully processed your document: "${processedDoc.filename}"\n\n`;
            
            // Show what was found
            message += `Here's what I found:\n`;
            message += `‚Ä¢ Document type: ${processedDoc.extracted.documentType.replace('_', ' ')}\n`;
            
            if (processedDoc.extracted.medications.length > 0) {
                message += `‚Ä¢ ${processedDoc.extracted.medications.length} medication${processedDoc.extracted.medications.length > 1 ? 's' : ''}\n`;
            }
            if (processedDoc.extracted.conditions.length > 0) {
                message += `‚Ä¢ ${processedDoc.extracted.conditions.length} medical condition${processedDoc.extracted.medications.length > 1 ? 's' : ''}\n`;
            }
            if (processedDoc.extracted.dates.length > 0) {
                message += `‚Ä¢ ${processedDoc.extracted.dates.length} important date${processedDoc.extracted.dates.length > 1 ? 's' : ''}\n`;
            }
            
            message += `\nI'm ready to answer questions about this document. `;
            
            if (processedDoc.hasMedialInfo || 
                processedDoc.extracted.medications.length > 0 || 
                processedDoc.extracted.conditions.length > 0) {
                message += `\n\nBefore we begin - is this medical information about you? This helps me provide better support.`;
                
                showBotMessage(message, [
                    "‚Üí Yes, this is my medical information",
                    "‚Üí No, this is someone else's information",
                    "‚Üí I'd rather not say - just help me understand it"
                ]);
            } else {
                message += `What would you like to know?`;
                showBotMessage(message);
                currentPhase = "document_qa";
            }
        }

        // ============= Q&A CONVERSATION HANDLERS =============
        
        // Add these handlers to the processUserMessage function
        // Document review responses
        function handleDocumentReviewResponses(message) {
            const lowerMessage = message.toLowerCase();
            
            if (currentPhase === "document_review") {
                if (lowerMessage.includes('yes') && lowerMessage.includes('my medical')) {
                    const doc = userHistory.currentDocument;
                    
                    showBotMessage(
                        `Thank you for trusting me with your medical information. ` +
                        `I'll keep this information private and use it to better support you.\n\n` +
                        `Would you like me to:`,
                        [
                            "‚Üí Add medications to your profile",
                            "‚Üí Note health conditions mentioned",
                            "‚Üí Save important dates",
                            "‚Üí Just answer questions about it",
                            "‚Üí All of the above"
                        ]
                    );
                    
                    currentPhase = "document_profile_integration";
                    return true;
                }
                
                if (lowerMessage.includes('no') || lowerMessage.includes('someone else')) {
                    showBotMessage(
                        `I understand. I'll help you understand this document without adding anything to your personal profile.\n\n` +
                        `What would you like to know about the document?`
                    );
                    currentPhase = "document_qa";
                    return true;
                }
                
                if (lowerMessage.includes('rather not say')) {
                    showBotMessage(
                        `No problem at all. Your privacy is important to me.\n\n` +
                        `Let's focus on understanding the document. What questions do you have?`
                    );
                    currentPhase = "document_qa";
                    return true;
                }
            }
            
            return false;
        }

        // Document Q&A phase
        function handleDocumentQA(message) {
            if (currentPhase === "document_qa" && currentDocumentQA) {
                // Use the token-efficient Q&A
                handleDocumentQuestion(message);
                return true;
            }
            return false;
        }

        // Document upload fallback handler
        function handleDocumentUploadFallback(message) {
            const lowerMessage = message.toLowerCase();
            
            if (currentPhase === "document_upload_fallback") {
                if (lowerMessage.includes('try uploading again')) {
                    showBotMessage("üìÑ Please try uploading your PDF again. Sometimes the library just needs another attempt to load properly.");
                    currentPhase = "main_conversation";
                    return true;
                }
                
                if (lowerMessage.includes('paste the text')) {
                    showBotMessage(
                        "üìù Perfect! Please paste the text content from your document below. I'll process it just like an uploaded file.\n\n" +
                        "You can copy and paste from:\n" +
                        "‚Ä¢ PDF text content\n" +
                        "‚Ä¢ Word document text\n" +
                        "‚Ä¢ Any other text-based document"
                    );
                    currentPhase = "text_paste";
                    return true;
                }
                
                if (lowerMessage.includes('different file format')) {
                    showBotMessage(
                        "üìÑ Great idea! Try uploading one of these formats instead:\n\n" +
                        "‚Ä¢ **Text files (.txt)** - Most reliable\n" +
                        "‚Ä¢ **Word documents (.docx)** - Good for formatted text\n" +
                        "‚Ä¢ **Rich text (.rtf)** - Preserves some formatting\n\n" +
                        "You can usually save/export your PDF as one of these formats from most applications."
                    );
                    currentPhase = "main_conversation";
                    return true;
                }
                
                if (lowerMessage.includes('tell me about')) {
                    showBotMessage(
                        "üìã That's a smart approach! Tell me what your document contains and I can help you understand it.\n\n" +
                        "For example:\n" +
                        "‚Ä¢ What type of document is it? (lab results, prescription, etc.)\n" +
                        "‚Ä¢ What information are you looking for?\n" +
                        "‚Ä¢ What questions do you have about it?"
                    );
                    currentPhase = "document_description";
                    return true;
                }
            }
            
            return false;
        }

        // Token-efficient document Q&A handler
        async function handleDocumentQuestion(question) {
            if (!currentDocumentQA) {
                showBotMessage("I don't have a document loaded. Would you like to upload one?");
                return;
            }
            
            showTypingIndicator();
            
            try {
                // This uses the token-efficient approach
                const answer = await currentDocumentQA.answerQuestion(question);
                
                hideTypingIndicator();
                showBotMessage(answer);
                
                // Suggest follow-up questions based on extracted data
                const followUps = generateSmartFollowUps(question);
                if (followUps.length > 0) {
                    setTimeout(() => {
                        showBotMessage(
                            "Would you like to know about:",
                            followUps
                        );
                    }, 1000);
                }
                
            } catch (error) {
                hideTypingIndicator();
                showBotMessage(
                    "I had trouble finding that information. Could you try asking in a different way?"
                );
            }
        }

        // Generate follow-up questions without using tokens
        function generateSmartFollowUps(lastQuestion) {
            const doc = userHistory.currentDocument;
            if (!doc) return [];
            
            const followUps = [];
            
            // Based on what's in the document
            if (doc.extracted.medications.length > 0 && !lastQuestion.includes('medication')) {
                followUps.push("‚Üí Tell me about the medications");
            }
            if (doc.extracted.dates.length > 0 && !lastQuestion.includes('date')) {
                followUps.push("‚Üí What are the important dates?");
            }
            if (doc.extracted.conditions.length > 0 && !lastQuestion.includes('condition')) {
                followUps.push("‚Üí Explain the conditions mentioned");
            }
            
            return followUps.slice(0, 3); // Limit to 3 suggestions
        }

        // Text paste handler for when PDF upload fails
        async function handleTextPaste(message) {
            if (currentPhase === "text_paste") {
                if (message.trim().length < 10) {
                    showBotMessage("That text seems too short to be a document. Please paste the full content or let me know if you need help.");
                    return true;
                }
                
                showBotMessage("üìù Processing your pasted text...");
                
                try {
                    // Process the pasted text as if it were a document
                    const processedDoc = await documentProcessor.processDocument(message, "pasted_text.txt");
                    
                    // Store document reference
                    userHistory.uploadedDocuments = userHistory.uploadedDocuments || [];
                    userHistory.uploadedDocuments.push({
                        id: processedDoc.id,
                        filename: "pasted_text.txt",
                        uploadDate: new Date().toISOString(),
                        documentType: processedDoc.extracted.documentType,
                        hasMedialInfo: processedDoc.extracted.medications.length > 0 || processedDoc.extracted.conditions.length > 0
                    });
                    
                    // Store for Q&A
                    userHistory.currentDocument = processedDoc;
                    currentDocumentQA = new TokenEfficientQA(processedDoc);
                    
                    // Save to localStorage for persistence
                    localStorage.setItem(`doc_${processedDoc.id}`, JSON.stringify(processedDoc));
                    saveUserHistory();
                    
                    // Handle response based on content
                    handleProcessedDocument(processedDoc);
                    
                } catch (error) {
                    console.error('Text paste processing error:', error);
                    showBotMessage("I had trouble processing that text. Could you try pasting it again or break it into smaller sections?");
                }
                
                return true;
            }
            
            return false;
        }

        // Sofia's Response Patterns - Styling Guide for Consistent Interactions
        const sofiaResponsePatterns = {
            // Core response templates
            exploration: {
                pattern: (topic, choiceName, curiosityPrompt, examples, personalConnection) => {
                    let response = `${choiceName} - ${topic.enthusiasm}!\n\n`;
                    
                    if (personalConnection) {
                        response += `${personalConnection}\n\n`;
                    }
                    
                    response += `${curiosityPrompt}\n\n`;
                    
                    if (examples && examples.length > 0) {
                        examples.forEach(example => {
                            response += `‚Ä¢ ${example}\n`;
                        });
                        response += `\n`;
                    }
                    
                    response += topic.inviteSharing;
                    
                    return response;
                }
            },
            
            // Topic-specific content
            topics: {
                walking: {
                    enthusiasm: "Walking is one of the most powerful gifts you can give your brain",
                    curiosityPrompts: [
                        "Tell me, what draws you to walking?",
                        "What does walking mean to you?",
                        "I'm curious - what appeals to you about walking?"
                    ],
                    examples: [
                        "The freedom of movement and fresh air",
                        "A desire to explore your neighborhood",
                        "Something your doctor recommended",
                        "A way to clear your mind",
                        "Or something else entirely"
                    ],
                    inviteSharing: "Share what walking means to you, and we can shape an adventure that fits your life perfectly.",
                    personalConnections: {
                        exercise: "It connects beautifully to your value of staying active!",
                        independence: "Walking supports your desire to maintain independence.",
                        outdoors: "Perfect for someone who loves spending time outdoors!",
                        social: "Walking can be a wonderful social activity too."
                    }
                },
                
                nutrition: {
                    enthusiasm: "What we eat truly feeds our brain",
                    curiosityPrompts: [
                        "What interests you about nutrition?",
                        "What brought you to think about food and brain health?",
                        "Tell me what healthy eating means to you"
                    ],
                    examples: [
                        "Finding brain-healthy foods you'll actually enjoy",
                        "Making simple swaps in meals you already love",
                        "Understanding which foods boost memory",
                        "Managing eating with health conditions",
                        "Learning about the gut-brain connection"
                    ],
                    inviteSharing: "Share your thoughts about food and eating, and we'll create an approach that fits your tastes and lifestyle.",
                    personalConnections: {
                        independence: "Preparing your own healthy meals supports your independence.",
                        family: "Sharing healthy meals can be a wonderful family activity.",
                        health: "Good nutrition supports all your health goals."
                    }
                },
                
                sleep: {
                    enthusiasm: "Sleep is when your brain heals and consolidates memories",
                    curiosityPrompts: [
                        "What's your relationship with sleep like?",
                        "Tell me about your sleep patterns",
                        "What would better sleep mean for you?"
                    ],
                    examples: [
                        "Creating a calming bedtime routine",
                        "Dealing with middle-of-the-night wakings",
                        "Managing worries that keep you awake",
                        "Finding the right sleep schedule",
                        "Making your bedroom more sleep-friendly"
                    ],
                    inviteSharing: "Tell me about your sleep, and let's work together to help your brain get the rest it needs.",
                    personalConnections: {
                        energy: "Better sleep means more energy for what you love.",
                        memory: "Good sleep is crucial for memory consolidation.",
                        mood: "Quality sleep supports emotional wellbeing."
                    }
                },
                
                socialConnection: {
                    enthusiasm: "Our connections with others are powerful brain medicine",
                    curiosityPrompts: [
                        "What kind of social connections are you thinking about?",
                        "Tell me about your social life",
                        "What would meaningful connection look like for you?"
                    ],
                    examples: [
                        "Reconnecting with old friends",
                        "Making new connections with shared interests",
                        "Deepening family relationships",
                        "Finding community groups or clubs",
                        "Balancing alone time with social time"
                    ],
                    inviteSharing: "Share what connection means to you, and we'll explore ways to nurture your social brain health.",
                    personalConnections: {
                        family: "Your value of family time is wonderful for brain health!",
                        independence: "You can maintain independence while building connections.",
                        activities: "Shared activities can deepen relationships."
                    }
                },
                
                memory: {
                    enthusiasm: "Our memory is like a garden we can nurture and grow",
                    curiosityPrompts: [
                        "What aspects of memory are on your mind?",
                        "Tell me about your memory experiences",
                        "What would better memory mean for your daily life?"
                    ],
                    examples: [
                        "Remembering names and faces better",
                        "Finding things you've misplaced",
                        "Keeping track of appointments",
                        "Learning new skills or hobbies",
                        "Preserving precious memories"
                    ],
                    inviteSharing: "Share your thoughts about memory, and we'll explore ways to keep your mind sharp.",
                    personalConnections: {
                        independence: "A sharp memory supports your independence.",
                        learning: "Memory is the foundation of all learning.",
                        social: "Remembering details about others deepens relationships."
                    }
                }
            },
            
            // Goal guidance patterns
            goalProgression: {
                visioning: (topic) => 
                    `Let's think about this together. If you could imagine your ideal ${topic} routine, what would it look like?`,
                
                makingConcrete: (activity) => 
                    `Now, here's a thought - what if we turned this vision into something you could actually start this week? Nothing overwhelming, just a small, enjoyable step.`,
                
                confirmation: (goal) => 
                    `I love it! So your adventure could be: "${goal}"\n\nThis feels like a wonderful starting point - achievable, enjoyable, and perfect for your brain health.`
            },
            
            // Curiosity phrases to vary responses
            curiosityStarters: [
                "I'm curious - ",
                "Tell me - ",
                "I'd love to know - ",
                "Help me understand - ",
                "I wonder - ",
                "What if I asked - "
            ],
            
            // Encouragement patterns
            encouragement: {
                mild: "That's a great choice!",
                moderate: "I love this choice!",
                strong: "What a wonderful decision!",
                personalized: (value) => `This beautifully supports your value of ${value}!`
            }
        };

        // Helper function to get personalized connection
        function getPersonalConnection(topic, userHistory) {
            if (!userHistory.aboutMe || !userHistory.aboutMe.bestLifeElements) return null;
            
            const topicConnections = sofiaResponsePatterns.topics[topic]?.personalConnections;
            if (!topicConnections) return null;
            
            // Find matching connection
            for (const element of userHistory.aboutMe.bestLifeElements) {
                const elementLower = element.element.toLowerCase();
                for (const [key, connection] of Object.entries(topicConnections)) {
                    if (elementLower.includes(key)) {
                        return connection;
                    }
                }
            }
            
            return null;
        }

        // Generate response using patterns
        function generateExplorationResponse(topicKey, choiceName) {
            const topic = sofiaResponsePatterns.topics[topicKey];
            if (!topic) return null;
            
            // Get random curiosity prompt
            const curiosityPrompt = topic.curiosityPrompts[
                Math.floor(Math.random() * topic.curiosityPrompts.length)
            ];
            
            // Get personal connection
            const personalConnection = getPersonalConnection(topicKey, userHistory);
            
            // Generate response
            return sofiaResponsePatterns.exploration.pattern(
                topic,
                choiceName,
                curiosityPrompt,
                topic.examples,
                personalConnection
            );
        }

        // Story Moment Recognition Patterns
        const storyMomentPatterns = {
            emotionalTransitions: [
                /i used to .* but now/i,
                /something changed when/i,
                /i realized that/i,
                /for the first time/i,
                /different than before/i,
                /surprising myself/i
            ],
            decisionPoints: [
                /i had to choose/i,
                /i decided to/i,
                /i'm considering/i,
                /instead of .* i/i,
                /i chose/i,
                /i picked/i
            ],
            breakthroughs: [
                /i never thought i could/i,
                /it finally clicked/i,
                /breakthrough/i,
                /aha moment/i,
                /everything changed/i,
                /i discovered/i
            ],
            victories: [
                /i actually did it/i,
                /i succeeded/i,
                /proud of myself/i,
                /i managed to/i,
                /accomplishment/i,
                /achieved/i
            ]
        };

        // Current visual style
        let currentVisualStyle = 'journey';
        let storyMoments = [];
        let userChapters = [];
        let currentMoodArc = [];

        // About Me tracking
        let selectedBestLifeElements = [];
        let selectedConcerns = [];
        let isAboutMeComplete = false;

        // Human-in-the-Loop Safety Monitoring Configuration (kept from original)
        const safetyMonitoring = {
            // Emergency keywords requiring immediate intervention
            emergencyKeywords: [
                "suicide", "kill myself", "end my life", "hurt myself", "harm myself",
                "emergency", "chest pain", "can't breathe", "cant breathe", "bleeding",
                "collapsed", "unconscious", "seizure", "stroke", "heart attack",
                "help me", "dying", "911", "999", "ambulance"
            ],
            
            // Emotional distress indicators
            distressKeywords: [
                "hopeless", "helpless", "overwhelmed", "desperate", "miserable",
                "unbearable", "terrible", "can't cope", "cant cope", "give up",
                "too much", "lost", "alone", "lonely", "abandoned", "scared",
                "frightened", "terrified", "worthless", "burden"
            ],
            
            // Frustration indicators
            frustrationKeywords: [
                "frustrated", "annoying", "useless", "stupid", "waste of time",
                "not helpful", "doesn't work", "doesnt work", "doesn't understand",
                "doesnt understand", "not understanding", "pointless", "going in circles",
                "talking to a wall", "not getting anywhere", "ridiculous", "tired of this",
                "fed up", "unhelpful", "confused", "this isn't working", "this isnt working",
                "can't help", "cant help", "stop", "quit", "end this"
            ],
            
            // Repetition indicators
            repetitionIndicators: [
                "i already said", "i told you", "as i said", "like i said",
                "i mentioned", "i just told you", "again", "repeating myself",
                "said earlier", "keep saying", "once more", "one more time"
            ],
            
            // Inclusion/bias concerns
            inclusionKeywords: [
                "racist", "sexist", "discrimination", "biased", "unfair",
                "prejudice", "stereotype", "offensive", "inappropriate",
                "disrespectful", "insensitive"
            ],
            
            // Clinician contact info (would be loaded from secure config in production)
            clinicianInfo: {
                name: "Dr. Sarah Thompson",
                id: "clinician_001",
                email: "sarah.thompson@healthsystem.org",
                phone: "555-0123",
                preferredContact: "dashboard"
            }
        };

        // Safety monitoring data structure
        let safetyData = {
            triggers: [],
            interventions: [],
            contentMisalignments: [],
            sessionRiskProfile: {
                overallRiskLevel: "low",
                dominantConcerns: [],
                escalationPattern: false,
                requiresFollowUp: false
            }
        };

        // Function to create default user history structure
        function createDefaultUserHistory() {
            return {
                // Basic Profile
                profile: {
                    name: "",
                    age: "",
                    registrationDate: new Date().toISOString(),
                    lastVisit: null,
                    totalSessions: 0
                },

                // About Me Profile (NEW)
                aboutMe: {
                    bestLifeElements: [],
                    concerns: [],
                    confidenceLevel: "",
                    confidenceTimestamp: null,
                    userDefinedNextSteps: [],
                    profileCompleteness: 0,
                    lastUpdated: null,
                    updateFrequency: "monthly"
                },

                // Story Elements
                storyChapters: [],
                storyMoments: [],
                visualStyle: "journey",

                // Original tracking elements
                concerns: [],  
                values: [],    
                whatMattersMost: [],  
                goals: [],     
                educationTopics: [],  
                actionPlans: [],  
                
                // Social Context
                socialContext: {
                    livingArrangement: "",
                    supportSystem: [],
                    socialActivities: []
                },
                
                // Health & Lifestyle
                healthFactors: {
                    physicalActivity: "",
                    sleepQuality: "",
                    dietQuality: "",
                    medicalConditions: [],
                    medications: []
                },
                
                // Cognitive Status
                cognitiveStatus: {
                    selfReportedChanges: [],
                    strengths: [],
                    challenges: []
                },
                
                // Emotional State Tracking
                emotionalStates: [],  
                
                // Session Summaries
                sessions: []  
            };
        }

        // Initialize with default structure
        let userHistory = createDefaultUserHistory();

        // Visual style functions
        function toggleStyleMenu() {
            const menu = document.getElementById('styleMenu');
            menu.classList.toggle('active');
        }

        function setVisualStyle(style) {
            currentVisualStyle = style;
            userHistory.visualStyle = style;
            saveUserHistory();
            
            // Update menu
            document.querySelectorAll('.style-option').forEach(option => {
                option.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Hide menu
            document.getElementById('styleMenu').classList.remove('active');
            
            // Update progress display
            updateProgressVisualization();
            
            showBotMessage(`You've chosen the ${getStyleName(style)} style for your journey. I love it!`);
        }

        function getStyleName(style) {
            const names = {
                'journey': 'Journey Map',
                'garden': 'Growing Garden',
                'constellation': 'Star Builder',
                'simple': 'Simple Progress'
            };
            return names[style] || style;
        }

        function updateProgressVisualization() {
            const progressDiv = document.getElementById('storyProgress');
            progressDiv.classList.add('active');
            
            switch(currentVisualStyle) {
                case 'journey':
                    progressDiv.innerHTML = createJourneyVisualization();
                    break;
                case 'garden':
                    progressDiv.innerHTML = createGardenVisualization();
                    break;
                case 'constellation':
                    progressDiv.innerHTML = createConstellationVisualization();
                    break;
                case 'simple':
                    progressDiv.innerHTML = createSimpleVisualization();
                    break;
            }
        }

        function createJourneyVisualization() {
            const totalGoals = userHistory.goals.length;
            const completedGoals = userHistory.goals.filter(g => g.status === 'completed').length;
            const chapters = userHistory.storyChapters.length;
            
            let html = '<div class="progress-journey">';
            html += '<div class="journey-node completed">üè†</div>';
            html += '<div class="journey-line completed"></div>';
            
            for (let i = 0; i < 3; i++) {
                if (i < chapters) {
                    html += '<div class="journey-node completed">üìñ</div>';
                } else if (i === chapters) {
                    html += '<div class="journey-node current">‚ú®</div>';
                } else {
                    html += '<div class="journey-node">?</div>';
                }
                
                if (i < 2) {
                    html += `<div class="journey-line ${i < chapters ? 'completed' : ''}"></div>`;
                }
            }
            
            html += '<div class="journey-line"></div>';
            html += '<div class="journey-node">üèÜ</div>';
            html += '</div>';
            
            return html;
        }

        function createGardenVisualization() {
            const growth = Math.min(userHistory.goals.length + userHistory.storyChapters.length, 4);
            const stages = ['üå±', 'üåø', 'üå≥', 'üå∏'];
            
            return `
                <div class="progress-garden">
                    <div class="garden-plant" style="font-size: ${40 + (growth * 10)}px;">
                        ${stages[growth] || stages[0]}
                    </div>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        Your story is ${growth === 0 ? 'just beginning' : growth === 4 ? 'blooming beautifully' : 'growing stronger'}
                    </p>
                </div>
            `;
        }

        function createConstellationVisualization() {
            let html = '<div class="progress-constellation">';
            const achievements = userHistory.goals.filter(g => g.status === 'completed').length + 
                              userHistory.storyChapters.length;
            
            for (let i = 0; i < achievements; i++) {
                const left = Math.random() * 80 + 10;
                const top = Math.random() * 80 + 10;
                html += `<div class="star" style="left: ${left}%; top: ${top}%;">‚≠ê</div>`;
            }
            
            html += '</div>';
            return html;
        }

        function createSimpleVisualization() {
            const activeGoals = userHistory.goals.filter(g => g.status === 'active').length;
            const completedGoals = userHistory.goals.filter(g => g.status === 'completed').length;
            const chapters = userHistory.storyChapters.length;
            
            return `
                <div style="padding: 10px; text-align: center;">
                    <span style="margin: 0 10px;">üìñ ${chapters} Chapters</span>
                    <span style="margin: 0 10px;">üéØ ${activeGoals} Active Goals</span>
                    <span style="margin: 0 10px;">‚úÖ ${completedGoals} Completed</span>
                </div>
            `;
        }

        // About Me functions
        function updateAboutMeSummary() {
            const summary = document.getElementById('aboutMeSummary');
            const content = document.getElementById('aboutMeContent');
            
            if (!userHistory.aboutMe || 
                (userHistory.aboutMe.bestLifeElements.length === 0 && 
                 userHistory.aboutMe.concerns.length === 0)) {
                summary.style.display = 'none';
                return;
            }
            
            summary.style.display = 'block';
            content.innerHTML = '';
            
            // Best Life Elements
            if (userHistory.aboutMe.bestLifeElements.length > 0) {
                userHistory.aboutMe.bestLifeElements.forEach(element => {
                    const div = document.createElement('div');
                    div.className = 'about-me-item best-life';
                    div.innerHTML = `<span>üåü</span> ${element.element}`;
                    content.appendChild(div);
                });
            }
            
            // Concerns
            if (userHistory.aboutMe.concerns.length > 0) {
                userHistory.aboutMe.concerns.forEach(concern => {
                    const div = document.createElement('div');
                    div.className = 'about-me-item concern';
                    div.innerHTML = `<span>ü§î</span> ${concern.concern}`;
                    content.appendChild(div);
                });
            }
            
            // Confidence Level
            if (userHistory.aboutMe.confidenceLevel) {
                const div = document.createElement('div');
                div.style.marginTop = '10px';
                div.innerHTML = `<span class="confidence-badge">${userHistory.aboutMe.confidenceLevel}</span>`;
                content.appendChild(div);
            }
        }

        // Story moment detection
        function detectStoryMoment(message) {
            const lowerMessage = message.toLowerCase();
            
            for (const [type, patterns] of Object.entries(storyMomentPatterns)) {
                for (const pattern of patterns) {
                    if (pattern.test(message)) {
                        return {
                            type: type,
                            content: message,
                            timestamp: new Date().toISOString(),
                            pattern: pattern.toString()
                        };
                    }
                }
            }
            return null;
        }

        // Chapter creation functions
        function openChapterModal(moment) {
            document.getElementById('chapterModal').classList.add('active');
            if (moment) {
                document.getElementById('chapterMoment').value = moment.content;
            }
            
            // Show About Me connections
            showChapterAboutMeConnections();
            
            currentMoodArc = [];
        }

        function showChapterAboutMeConnections() {
            const connectionDiv = document.getElementById('chapterAboutMeConnection');
            const linksDiv = document.getElementById('chapterAboutMeLinks');
            
            if (userHistory.aboutMe && userHistory.aboutMe.bestLifeElements.length > 0) {
                connectionDiv.style.display = 'block';
                linksDiv.innerHTML = '';
                
                userHistory.aboutMe.bestLifeElements.slice(0, 3).forEach(element => {
                    const span = document.createElement('span');
                    span.style.cssText = 'display: inline-block; background: #e8f0fe; padding: 4px 8px; margin: 2px; border-radius: 4px; font-size: 12px;';
                    span.textContent = element.element;
                    linksDiv.appendChild(span);
                });
            } else {
                connectionDiv.style.display = 'none';
            }
        }

        function closeChapterModal() {
            document.getElementById('chapterModal').classList.remove('active');
            document.getElementById('chapterTitle').value = '';
            document.getElementById('chapterMoment').value = '';
            document.getElementById('chapterChoices').value = '';
            document.getElementById('chapterLearning').value = '';
            currentMoodArc = [];
            document.querySelectorAll('.mood-node').forEach(node => node.classList.remove('selected'));
        }

        function selectMood(index, mood) {
            currentMoodArc[index] = mood;
            document.querySelectorAll('.mood-node').forEach((node, i) => {
                if (i === index) {
                    node.classList.add('selected');
                } else {
                    node.classList.remove('selected');
                }
            });
        }

        function saveChapter() {
            const title = document.getElementById('chapterTitle').value.trim();
            const moment = document.getElementById('chapterMoment').value.trim();
            const choices = document.getElementById('chapterChoices').value.trim();
            const learning = document.getElementById('chapterLearning').value.trim();
            
            if (!title || !moment) {
                alert('Please provide at least a title and key moment for your chapter.');
                return;
            }
            
            const chapter = {
                title: title,
                moment: moment,
                moodArc: currentMoodArc.length > 0 ? currentMoodArc : ['üòê'],
                choices: choices,
                learning: learning,
                timestamp: new Date().toISOString(),
                linkedBestLifeElements: userHistory.aboutMe.bestLifeElements.map(e => e.element)
            };
            
            userHistory.storyChapters.push(chapter);
            saveUserHistory();
            updateMemoryDisplay(true);
            
            // About Me-aware response
            let response = `Beautiful! You've created a new chapter: "${title}". `;
            if (userHistory.aboutMe.bestLifeElements.length > 0) {
                response += `This moment connects to what matters most to you - ${userHistory.aboutMe.bestLifeElements[0].element}. `;
            }
            response += `Your story continues to unfold. üìñ‚ú®`;
            
            showBotMessage(response);
            
            closeChapterModal();
        }

        // Create story compilation
        function createStoryCompilation() {
            if (userHistory.storyChapters.length === 0) {
                showBotMessage("You haven't created any chapters yet. As we continue our conversations, I'll help you capture meaningful moments to build your story.");
                return;
            }
            
            let story = `üìö Your Brain Health Story\n\n`;
            story += `By ${userHistory.profile.name || 'A Brave Storyteller'}\n\n`;
            
            // Add About Me section
            if (userHistory.aboutMe && userHistory.aboutMe.bestLifeElements.length > 0) {
                story += `What Matters Most to Me:\n`;
                userHistory.aboutMe.bestLifeElements.forEach(element => {
                    story += `‚Ä¢ ${element.element}\n`;
                });
                story += `\n`;
            }
            
            userHistory.storyChapters.forEach((chapter, index) => {
                story += `Chapter ${index + 1}: ${chapter.title}\n`;
                story += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
                story += `${chapter.moment}\n\n`;
                
                if (chapter.choices) {
                    story += `Choices Made: ${chapter.choices}\n\n`;
                }
                
                if (chapter.learning) {
                    story += `What I Learned: ${chapter.learning}\n\n`;
                }
                
                story += `Mood Journey: ${chapter.moodArc.join(' ‚Üí ')}\n\n\n`;
            });
            
            // Create and download
            const blob = new Blob([story], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `my-brain-health-story-${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            
            showBotMessage("I've compiled your chapters into a complete story! Check your downloads folder to read your brain health journey. üìñ");
        }

        // Enhanced load user history with migration
        function loadUserHistory() {
            const saved = localStorage.getItem('sofiaUserHistory');
            if (saved) {
                try {
                    const loadedHistory = JSON.parse(saved);
                    
                    // Create a new default structure
                    const defaultHistory = createDefaultUserHistory();
                    
                    // Merge loaded data with default structure to ensure all properties exist
                    userHistory = mergeDeep(defaultHistory, loadedHistory);
                    
                    // Ensure critical arrays exist
                    if (!Array.isArray(userHistory.storyChapters)) userHistory.storyChapters = [];
                    if (!Array.isArray(userHistory.storyMoments)) userHistory.storyMoments = [];
                    if (!Array.isArray(userHistory.concerns)) userHistory.concerns = [];
                    if (!Array.isArray(userHistory.goals)) userHistory.goals = [];
                    if (!Array.isArray(userHistory.values)) userHistory.values = [];
                    if (!Array.isArray(userHistory.educationTopics)) userHistory.educationTopics = [];
                    if (!Array.isArray(userHistory.actionPlans)) userHistory.actionPlans = [];
                    if (!Array.isArray(userHistory.emotionalStates)) userHistory.emotionalStates = [];
                    if (!Array.isArray(userHistory.sessions)) userHistory.sessions = [];
                    if (!Array.isArray(userHistory.whatMattersMost)) userHistory.whatMattersMost = [];
                    
                    // Ensure About Me structure exists
                    if (!userHistory.aboutMe) {
                        userHistory.aboutMe = defaultHistory.aboutMe;
                    } else {
                        if (!Array.isArray(userHistory.aboutMe.bestLifeElements)) userHistory.aboutMe.bestLifeElements = [];
                        if (!Array.isArray(userHistory.aboutMe.concerns)) userHistory.aboutMe.concerns = [];
                        if (!Array.isArray(userHistory.aboutMe.userDefinedNextSteps)) userHistory.aboutMe.userDefinedNextSteps = [];
                    }
                    
                    // Load safety data if it exists
                    if (loadedHistory.safetyData) {
                        safetyData = loadedHistory.safetyData;
                    }
                    
                    // Set visual style if saved
                    if (loadedHistory.visualStyle) {
                        currentVisualStyle = loadedHistory.visualStyle;
                    }
                    
                    // Check if About Me is complete
                    isAboutMeComplete = userHistory.aboutMe.profileCompleteness > 0;
                    
                    console.log('User history loaded and migrated successfully');
                    return true;
                } catch (error) {
                    console.error('Error loading user history:', error);
                    // If there's an error, start fresh
                    userHistory = createDefaultUserHistory();
                    return false;
                }
            }
            return false;
        }

        // Deep merge function to handle nested objects
        function mergeDeep(target, source) {
            const output = Object.assign({}, target);
            if (isObject(target) && isObject(source)) {
                Object.keys(source).forEach(key => {
                    if (isObject(source[key])) {
                        if (!(key in target))
                            Object.assign(output, { [key]: source[key] });
                        else
                            output[key] = mergeDeep(target[key], source[key]);
                    } else {
                        Object.assign(output, { [key]: source[key] });
                    }
                });
            }
            return output;
        }

        function isObject(item) {
            return item && typeof item === 'object' && !Array.isArray(item);
        }

        // Save user history to localStorage
        async function saveUserHistory() {
            // Save to localStorage as backup
            localStorage.setItem('sofiaUserHistory', JSON.stringify(userHistory));
            
            // If API is available, sync specific changes
            if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                try {
                    // Update session if in progress
                    if (currentSessionId && typeof SofiaAPI !== 'undefined') {
                        const currentSession = userHistory.sessions[userHistory.sessions.length - 1];
                        if (currentSession) {
                            await SofiaAPI.updateSession(
                                currentSession.duration,
                                currentSession.mainTopics,
                                conversationLog
                            );
                        }
                    }
                } catch (error) {
                    console.error('Failed to sync with API:', error);
                }
            }
        }

        // About Me logging functions
        async function logBestLifeElement(element, priority = 1) {
            const previousElements = userHistory.aboutMe.bestLifeElements.map(e => e.element).join(', ');
            
            userHistory.aboutMe.bestLifeElements.push({
                element: element,
                priority: priority,
                timestamp: new Date().toISOString(),
                notes: ""
            });
            userHistory.aboutMe.lastUpdated = new Date().toISOString();
            updateAboutMeCompleteness();
            saveUserHistory();
            
            // Track in backend if available
            if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                try {
                    await SofiaAPI.trackProfileChange({
                        variableName: 'bestLifeElements',
                        variableValue: element,
                        previousValue: previousElements || null,
                        source: documentProcessing ? 'document' : 'conversation',
                        sourceDetails: {
                            priority: priority,
                            timestamp: new Date().toISOString()
                        }
                    });
                    
                    // Also update About Me via API
                    await SofiaAPI.updateAboutMe({
                        bestLifeElements: userHistory.aboutMe.bestLifeElements,
                        concerns: userHistory.aboutMe.concerns,
                        confidenceLevel: userHistory.aboutMe.confidenceLevel,
                        userDefinedNextSteps: userHistory.aboutMe.userDefinedNextSteps
                    });
                } catch (error) {
                    console.error('Failed to track best life element in backend:', error);
                }
            }
        }

        async function logAboutMeConcern(concern, severity = 'moderate') {
            const previousConcerns = userHistory.aboutMe.concerns.map(c => c.concern).join(', ');
            
            userHistory.aboutMe.concerns.push({
                concern: concern,
                severity: severity,
                timestamp: new Date().toISOString(),
                linkedToBestLife: [],
                notes: ""
            });
            userHistory.aboutMe.lastUpdated = new Date().toISOString();
            updateAboutMeCompleteness();
            saveUserHistory();
            
            // Track in backend if available
            if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                try {
                    await SofiaAPI.trackProfileChange({
                        variableName: 'aboutMeConcerns',
                        variableValue: concern,
                        previousValue: previousConcerns || null,
                        source: documentProcessing ? 'document' : 'conversation',
                        sourceDetails: {
                            severity: severity,
                            timestamp: new Date().toISOString()
                        }
                    });
                    
                    // Also update About Me via API
                    await SofiaAPI.updateAboutMe({
                        bestLifeElements: userHistory.aboutMe.bestLifeElements,
                        concerns: userHistory.aboutMe.concerns,
                        confidenceLevel: userHistory.aboutMe.confidenceLevel,
                        userDefinedNextSteps: userHistory.aboutMe.userDefinedNextSteps
                    });
                } catch (error) {
                    console.error('Failed to track About Me concern in backend:', error);
                }
            }
        }

        // Smart About Me update - only ask when needed
        function shouldUpdateAboutMe() {
            if (!userHistory.aboutMe) return true;
            
            // Check if it's been over 30 days since last update
            const lastUpdate = userHistory.aboutMe.lastUpdated;
            if (lastUpdate) {
                const daysSinceUpdate = Math.floor((new Date() - new Date(lastUpdate)) / (1000 * 60 * 60 * 24));
                if (daysSinceUpdate > 30) {
                    return true;
                }
            }
            
            // Check if user has achieved multiple goals (life circumstances may have changed)
            const completedGoals = userHistory.goals.filter(g => g.status === 'completed').length;
            if (completedGoals > 3 && !userHistory.aboutMe.recentlyReviewed) {
                return true;
            }
            
            return false;
        }

        // Function to handle periodic About Me reviews
        function promptAboutMeReview() {
            showBotMessage(
                `It's been a while since we reviewed what matters most to you. Life changes, and so might your priorities.

Would you like to update what brings meaning to your life?`,
                [
                    "‚Üí Yes, let's review my priorities",
                    "‚Üí No, they're still the same",
                    "‚Üí Remind me next month"
                ]
            );
            currentPhase = "about_me_review";
        }

        // Function to check understanding after doctor info discussion
        function checkMedicalUnderstanding() {
            showBotMessage(
                `Before we move on, I want to make sure you feel clear about everything we've discussed.

On a scale of 1-10, how confident do you feel about understanding the medical information now?

(1 = Still very confused, 10 = Completely clear)

Remember, it's perfectly okay if you're not at a 10 - medical information can be complex, and we can keep working through it together.`
            );
            currentPhase = "medical_understanding_check";
        }

        // Detect potential conflicts between user input and About Me profile
        function detectAboutMeConflict(userMessage) {
            const lowerMessage = userMessage.toLowerCase();
            
            // Check if user mentions something that conflicts with their values
            if (userHistory.aboutMe && userHistory.aboutMe.bestLifeElements.length > 0) {
                // Example: User values independence but talks about needing constant help
                const valuesIndependence = userHistory.aboutMe.bestLifeElements.some(e => 
                    e.element.toLowerCase().includes('independent') || 
                    e.element.toLowerCase().includes('on my own')
                );
                
                if (valuesIndependence && 
                    (lowerMessage.includes("can't do anything") || 
                     lowerMessage.includes("need help with everything") ||
                     lowerMessage.includes("completely dependent"))) {
                    
                    return {
                        hasConflict: true,
                        type: 'independence',
                        message: `I notice this seems different from your value of independence. Has something changed, or would you like to talk about finding a balance?`
                    };
                }
            }
            
            return { hasConflict: false };
        }

        function updateAboutMeCompleteness() {
            let completeness = 0;
            if (userHistory.aboutMe.bestLifeElements.length > 0) completeness += 40;
            if (userHistory.aboutMe.concerns.length > 0) completeness += 40;
            if (userHistory.aboutMe.confidenceLevel) completeness += 20;
            userHistory.aboutMe.profileCompleteness = completeness;
        }

        // Enhanced logging functions with story elements
        async function logConcern(concern, severity = 'moderate', context = '') {
            // Get previous concerns for history tracking
            const previousConcerns = userHistory.concerns.map(c => c.concern).join(', ');
            
            userHistory.concerns.push({
                concern: concern,
                timestamp: new Date().toISOString(),
                severity: severity,
                context: context
            });
            saveUserHistory();
            
            // Track in backend if available
            if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                try {
                    await SofiaAPI.trackProfileChange({
                        variableName: 'concerns',
                        variableValue: concern,
                        previousValue: previousConcerns || null,
                        source: context.includes('document') ? 'document' : 'conversation',
                        sourceDetails: {
                            severity: severity,
                            context: context,
                            timestamp: new Date().toISOString()
                        }
                    });
                } catch (error) {
                    console.error('Failed to track concern in backend:', error);
                }
            }
        }

        async function logValue(value, importance = 'high') {
            const previousValues = userHistory.values.map(v => v.value).join(', ');
            
            userHistory.values.push({
                value: value,
                timestamp: new Date().toISOString(),
                importance: importance
            });
            saveUserHistory();
            
            // Track in backend if available
            if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                try {
                    await SofiaAPI.trackProfileChange({
                        variableName: 'values',
                        variableValue: value,
                        previousValue: previousValues || null,
                        source: 'conversation',
                        sourceDetails: {
                            importance: importance,
                            timestamp: new Date().toISOString()
                        }
                    });
                } catch (error) {
                    console.error('Failed to track value in backend:', error);
                }
            }
        }

        function logWhatMattersMost(matter) {
            userHistory.whatMattersMost.push({
                matter: matter,
                timestamp: new Date().toISOString()
            });
            saveUserHistory();
        }

        async function logGoal(goal, confidence = 7, linkedBestLifeElements = []) {
            const previousGoals = userHistory.goals.filter(g => g.status === 'active').map(g => g.goal).join(', ');
            
            userHistory.goals.push({
                goal: goal,
                setDate: new Date().toISOString(),
                confidence: confidence,
                status: 'active',
                progress: [],
                linkedBestLifeElements: linkedBestLifeElements
            });
            saveUserHistory();
            
            // Track in backend if available
            if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                try {
                    // Create goal via API
                    await SofiaAPI.createGoal({
                        goal: goal,
                        confidence: confidence,
                        linkedBestLifeElements: linkedBestLifeElements
                    });
                    
                    // Track as profile change
                    await SofiaAPI.trackProfileChange({
                        variableName: 'goals',
                        variableValue: goal,
                        previousValue: previousGoals || null,
                        source: 'conversation',
                        sourceDetails: {
                            confidence: confidence,
                            linkedElements: linkedBestLifeElements,
                            timestamp: new Date().toISOString()
                        }
                    });
                } catch (error) {
                    console.error('Failed to track goal in backend:', error);
                }
            }
        }

        function updateGoalProgress(goalIndex, progress, notes = '') {
            if (userHistory.goals[goalIndex]) {
                userHistory.goals[goalIndex].progress.push({
                    date: new Date().toISOString(),
                    progress: progress,
                    notes: notes
                });
                saveUserHistory();
            }
        }

        async function logEducationTopic(topic, engagement = 'moderate') {
            const previousTopics = userHistory.educationTopics.map(t => t.topic).join(', ');
            
            userHistory.educationTopics.push({
                topic: topic,
                timestamp: new Date().toISOString(),
                engagement: engagement
            });
            saveUserHistory();
            
            // Track in backend if available
            if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                try {
                    await SofiaAPI.trackProfileChange({
                        variableName: 'educationTopics',
                        variableValue: topic,
                        previousValue: previousTopics || null,
                        source: 'conversation',
                        sourceDetails: {
                            engagement: engagement,
                            timestamp: new Date().toISOString()
                        }
                    });
                } catch (error) {
                    console.error('Failed to track education topic in backend:', error);
                }
            }
        }

        function logActionPlan(action) {
            userHistory.actionPlans.push({
                action: action,
                timestamp: new Date().toISOString(),
                completed: false
            });
            saveUserHistory();
        }

        function logEmotionalState(state, trigger = '') {
            userHistory.emotionalStates.push({
                state: state,
                timestamp: new Date().toISOString(),
                trigger: trigger
            });
            saveUserHistory();
        }

        function logStoryMoment(moment) {
            userHistory.storyMoments.push(moment);
            saveUserHistory();
        }

        function startNewSession() {
            userHistory.profile.totalSessions++;
            userHistory.profile.lastVisit = new Date().toISOString();
            const sessionIndex = userHistory.sessions.length;
            userHistory.sessions.push({
                date: new Date().toISOString(),
                duration: 0,
                mainTopics: [],
                goalsSet: [],
                mood: 'neutral',
                notes: []
            });
            saveUserHistory();
            return sessionIndex;
        }

        function updateCurrentSession(updates) {
            const currentSession = userHistory.sessions[userHistory.sessions.length - 1];
            if (currentSession) {
                Object.assign(currentSession, updates);
                saveUserHistory();
            }
        }

        // Safety monitoring functions (kept from original)
        function analyzeSafetyTriggers(message) {
            const lowerMessage = message.toLowerCase();
            const detectedTriggers = [];
            
            // Check for emergency keywords
            safetyMonitoring.emergencyKeywords.forEach(keyword => {
                if (lowerMessage.includes(keyword)) {
                    detectedTriggers.push({
                        type: 'emergency',
                        severity: 'critical',
                        keyword: keyword,
                        context: extractContext(message, keyword),
                        timestamp: new Date().toISOString()
                    });
                }
            });
            
            // Check for distress keywords
            safetyMonitoring.distressKeywords.forEach(keyword => {
                if (lowerMessage.includes(keyword)) {
                    detectedTriggers.push({
                        type: 'distress',
                        severity: 'high',
                        keyword: keyword,
                        context: extractContext(message, keyword),
                        timestamp: new Date().toISOString()
                    });
                }
            });
            
            // Check for frustration
            safetyMonitoring.frustrationKeywords.forEach(keyword => {
                if (lowerMessage.includes(keyword)) {
                    detectedTriggers.push({
                        type: 'frustration',
                        severity: 'moderate',
                        keyword: keyword,
                        context: extractContext(message, keyword),
                        timestamp: new Date().toISOString()
                    });
                }
            });
            
            // Check for repetition
            safetyMonitoring.repetitionIndicators.forEach(phrase => {
                if (lowerMessage.includes(phrase)) {
                    detectedTriggers.push({
                        type: 'repetition',
                        severity: 'moderate',
                        keyword: phrase,
                        context: message,
                        timestamp: new Date().toISOString()
                    });
                }
            });
            
            // Check for inclusion concerns
            safetyMonitoring.inclusionKeywords.forEach(keyword => {
                if (lowerMessage.includes(keyword)) {
                    detectedTriggers.push({
                        type: 'inclusion',
                        severity: 'high',
                        keyword: keyword,
                        context: extractContext(message, keyword),
                        timestamp: new Date().toISOString()
                    });
                }
            });
            
            return detectedTriggers;
        }

        function extractContext(text, keyword, windowSize = 50) {
            const lowerText = text.toLowerCase();
            const keywordIndex = lowerText.indexOf(keyword.toLowerCase());
            if (keywordIndex === -1) return text;
            
            const start = Math.max(0, keywordIndex - windowSize);
            const end = Math.min(text.length, keywordIndex + keyword.length + windowSize);
            
            return '...' + text.slice(start, end) + '...';
        }

        async function handleSafetyTrigger(triggers) {
            if (triggers.length === 0) return null;
            
            // Log all triggers
            safetyData.triggers.push(...triggers);
            
            // Determine highest severity
            const severityOrder = ['critical', 'high', 'moderate', 'low'];
            const highestSeverity = triggers.reduce((max, trigger) => {
                const maxIndex = severityOrder.indexOf(max);
                const triggerIndex = severityOrder.indexOf(trigger.severity);
                return triggerIndex < maxIndex ? trigger.severity : max;
            }, 'low');
            
            // Update session risk profile
            safetyData.sessionRiskProfile.overallRiskLevel = highestSeverity;
            safetyData.sessionRiskProfile.dominantConcerns = [...new Set(triggers.map(t => t.type))];
            
            // Create intervention record
            const intervention = {
                timestamp: new Date().toISOString(),
                triggers: triggers,
                urgency: highestSeverity === 'critical' ? 'immediate' : highestSeverity === 'high' ? 'urgent' : 'standard',
                clinicianNotified: highestSeverity === 'critical' || highestSeverity === 'high',
                sessionId: currentSessionIndex
            };
            
            safetyData.interventions.push(intervention);
            
            // Send to API if available and severity is high/critical
            if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated() && 
                (highestSeverity === 'critical' || highestSeverity === 'high')) {
                try {
                    // Get the most severe trigger
                    const mostSevereTrigger = triggers.find(t => t.severity === highestSeverity);
                    await SofiaAPI.createSafetyEvent({
                        triggerType: mostSevereTrigger.type,
                        severity: highestSeverity,
                        keywords: triggers.map(t => t.keyword),
                        context: triggers.map(t => t.context).join(' | ')
                    });
                } catch (error) {
                    console.error('Failed to create safety event in API:', error);
                    // Save to offline queue
                    const offlineQueue = JSON.parse(localStorage.getItem('sofia_offline_queue') || '[]');
                    offlineQueue.push({ 
                        type: 'safetyEvent', 
                        data: {
                            triggerType: triggers[0].type,
                            severity: highestSeverity,
                            keywords: triggers.map(t => t.keyword),
                            context: triggers.map(t => t.context).join(' | ')
                        }, 
                        timestamp: new Date().toISOString() 
                    });
                    localStorage.setItem('sofia_offline_queue', JSON.stringify(offlineQueue));
                }
            }
            
            // Log to user history
            logEmotionalState(highestSeverity + '_safety_trigger', triggers.map(t => t.keyword).join(', '));
            
            // Simulate clinician alert (in production, this would send actual notifications)
            if (intervention.clinicianNotified) {
                console.error(`CLINICIAN ALERT: ${highestSeverity.toUpperCase()} safety trigger detected for ${userHistory.profile.name || 'User'}`);
                console.error('Triggers:', triggers);
                console.error('Recent conversation:', conversationLog.slice(-5));
            }
            
            // Return appropriate response based on trigger type
            return generateSafetyResponse(triggers, highestSeverity);
        }

        function generateSafetyResponse(triggers, severity) {
            const triggerTypes = triggers.map(t => t.type);
            const userName = userHistory.profile.name || 'friend';
            
            if (severity === 'critical') {
                if (triggerTypes.includes('emergency')) {
                    return `${userName}, this sounds like a medical emergency. Please call 911 immediately or have someone take you to the nearest emergency room. 

I've alerted ${safetyMonitoring.clinicianInfo.name} who will follow up with you as soon as possible. 

Your safety is my top priority. If you're experiencing chest pain, difficulty breathing, or any other severe symptoms, please don't wait - get help right now.`;
                }
            }
            
            if (triggerTypes.includes('distress')) {
                return `${userName}, I can see you're going through a really difficult time right now. Your feelings are valid, and you don't have to face this alone.

I've asked ${safetyMonitoring.clinicianInfo.name} to reach out to you right away. They're trained to provide the kind of support that can really help.

In the meantime, please remember:
‚Ä¢ You are valued and important
‚Ä¢ These intense feelings will pass
‚Ä¢ Help is available and it's okay to reach out

If you need immediate support, you can call the crisis helpline at 988. Would you like me to share some breathing exercises that might help you feel a bit calmer right now?`;
            }
            
            if (triggerTypes.includes('frustration') || triggerTypes.includes('repetition')) {
                return `${userName}, I understand this is frustrating, and I apologize if I haven't been as helpful as you need. 

Let me try a different approach. I've also made a note for ${safetyMonitoring.clinicianInfo.name} to follow up with you to ensure you get the support you deserve.

Could you tell me in your own words what would be most helpful for you right now? I'm here to listen and support you.`;
            }
            
            if (triggerTypes.includes('inclusion')) {
                return `${userName}, I sincerely apologize if anything I've said has come across as biased or insensitive. That's never my intention, and I take your concern very seriously.

I've immediately flagged this conversation for ${safetyMonitoring.clinicianInfo.name} to review. They will follow up with you to address your concerns properly and ensure you receive respectful, inclusive support.

Your feedback helps me improve. Thank you for speaking up about this.`;
            }
            
            // Default safety response
            return `${userName}, I want to make sure you're getting the support you need. I've asked ${safetyMonitoring.clinicianInfo.name} to follow up with you about our conversation. They'll be in touch soon to provide additional help.`;
        }

        function checkContentAlignment(message) {
            // In production, this would check against evidence-based content
            const concerningStatements = [
                /cure/i,
                /guarantee/i,
                /medical advice/i,
                /stop taking/i,
                /don't need.*doctor/i,
                /replace.*medication/i
            ];
            
            let misalignments = [];
            concerningStatements.forEach(pattern => {
                if (pattern.test(message)) {
                    misalignments.push({
                        pattern: pattern.toString(),
                        context: message,
                        timestamp: new Date().toISOString()
                    });
                }
            });
            
            if (misalignments.length > 0) {
                safetyData.contentMisalignments.push(...misalignments);
                console.warn('Content alignment concerns detected:', misalignments);
            }
            
            return misalignments.length === 0;
        }

        // Update safety indicator UI
        function updateSafetyIndicator(riskLevel) {
            const indicator = document.getElementById('safetyIndicator');
            if (!indicator) return;
            
            if (riskLevel === 'critical' || riskLevel === 'high') {
                indicator.classList.add('safety-alert');
                indicator.textContent = 'Clinician has been notified';
            } else {
                indicator.classList.remove('safety-alert');
                indicator.textContent = 'Your conversation is monitored for safety';
            }
        }

        // Update session risk assessment
        function updateSessionRiskAssessment() {
            const recentTriggers = safetyData.triggers.filter(t => {
                const triggerTime = new Date(t.timestamp);
                const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
                return triggerTime > fiveMinutesAgo;
            });
            
            // Check for escalation pattern
            if (recentTriggers.length >= 3) {
                safetyData.sessionRiskProfile.escalationPattern = true;
                safetyData.sessionRiskProfile.requiresFollowUp = true;
            }
            
            // Update UI indicator
            updateSafetyIndicator(safetyData.sessionRiskProfile.overallRiskLevel);
            
            // Save safety data with user history
            userHistory.safetyData = safetyData;
            saveUserHistory();
        }

        // Memory display variables
        let currentMemoryFilter = 'all';
        let memoryDisplayList = [];

        // Update memory display
        function updateMemoryDisplay(highlightLatest = false) {
            const memoryList = document.getElementById('memoryList');
            if (!memoryList) return;
            
            memoryList.innerHTML = '';
            
            // Update About Me summary
            updateAboutMeSummary();
            
            // Collect all memory items
            memoryDisplayList = [];
            
            // Add About Me items (NEW)
            if (userHistory.aboutMe) {
                // Add best life elements as a single item
                if (userHistory.aboutMe.bestLifeElements.length > 0) {
                    memoryDisplayList.push({
                        type: 'about-me',
                        subtype: 'best-life',
                        content: `My Best Life: ${userHistory.aboutMe.bestLifeElements.map(e => e.element).join(', ')}`,
                        metadata: `${userHistory.aboutMe.bestLifeElements.length} elements`,
                        timestamp: userHistory.aboutMe.lastUpdated || new Date().toISOString(),
                        index: 0
                    });
                }
                
                // Add concerns as a single item
                if (userHistory.aboutMe.concerns.length > 0) {
                    memoryDisplayList.push({
                        type: 'about-me',
                        subtype: 'concerns',
                        content: `My Concerns: ${userHistory.aboutMe.concerns.map(c => c.concern).join(', ')}`,
                        metadata: `Confidence: ${userHistory.aboutMe.confidenceLevel || 'Not set'}`,
                        timestamp: userHistory.aboutMe.lastUpdated || new Date().toISOString(),
                        index: 1
                    });
                }
            }
            
            // Add story chapters
            if (userHistory.storyChapters && userHistory.storyChapters.length > 0) {
                userHistory.storyChapters.forEach((chapter, index) => {
                    memoryDisplayList.push({
                        type: 'chapter',
                        content: chapter.title,
                        metadata: `Mood: ${chapter.moodArc.join(' ‚Üí ')}`,
                        timestamp: chapter.timestamp,
                        index: index,
                        fullChapter: chapter
                    });
                });
            }
            
            // Add concerns
            if (userHistory.concerns && userHistory.concerns.length > 0) {
                userHistory.concerns.forEach((concern, index) => {
                    memoryDisplayList.push({
                        type: 'concern',
                        content: concern.concern,
                        metadata: `Severity: ${concern.severity}`,
                        timestamp: concern.timestamp,
                        index: index,
                        context: concern.context
                    });
                });
            }
            
            // Add goals
            if (userHistory.goals && userHistory.goals.length > 0) {
                userHistory.goals.forEach((goal, index) => {
                    let metadata = `Confidence: ${goal.confidence}/10 | Status: ${goal.status}`;
                    if (goal.linkedBestLifeElements && goal.linkedBestLifeElements.length > 0) {
                        metadata += ` | Supports: ${goal.linkedBestLifeElements[0]}`;
                    }
                    memoryDisplayList.push({
                        type: 'goal',
                        content: goal.goal,
                        metadata: metadata,
                        timestamp: goal.setDate,
                        index: index,
                        progress: goal.progress
                    });
                });
            }
            
            // Add values
            if (userHistory.values && userHistory.values.length > 0) {
                userHistory.values.forEach((value, index) => {
                    memoryDisplayList.push({
                        type: 'value',
                        content: value.value,
                        metadata: `Importance: ${value.importance}`,
                        timestamp: value.timestamp,
                        index: index
                    });
                });
            }
            
            // Add education topics
            if (userHistory.educationTopics && userHistory.educationTopics.length > 0) {
                userHistory.educationTopics.forEach((topic, index) => {
                    memoryDisplayList.push({
                        type: 'education',
                        content: topic.topic.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                        metadata: `Engagement: ${topic.engagement}`,
                        timestamp: topic.timestamp,
                        index: index
                    });
                });
            }
            
            // Sort by timestamp (most recent first)
            memoryDisplayList.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Filter based on current filter
            const filteredList = currentMemoryFilter === 'all' 
                ? memoryDisplayList 
                : memoryDisplayList.filter(item => item.type === currentMemoryFilter);
            
            // Display items or empty state
            if (filteredList.length === 0) {
                memoryList.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üìù</div>
                        <div style="font-size: 14px;">
                            ${currentMemoryFilter === 'all' 
                                ? "No memories recorded yet. Let's start our conversation!" 
                                : `No ${currentMemoryFilter}s recorded yet.`}
                        </div>
                    </div>
                `;
            } else {
                filteredList.forEach((item, index) => {
                    const memoryItem = createMemoryItemElement(item);
                    if (highlightLatest && index === 0) {
                        memoryItem.classList.add('new-item');
                    }
                    memoryList.appendChild(memoryItem);
                });
                
                // Scroll to top if highlighting latest
                if (highlightLatest) {
                    const memoryContainer = memoryList.parentElement;
                    memoryContainer.scrollTop = 0;
                }
            }
            
            // Update summary
            updateMemorySummary();
        }

        // Create memory item element
        function createMemoryItemElement(item) {
            const div = document.createElement('div');
            div.className = `memory-item ${item.type}`;
            div.id = `memory-${item.type}-${item.index}`;
            
            const typeLabel = item.type === 'about-me' ? 'About Me' : item.type.charAt(0).toUpperCase() + item.type.slice(1);
            const timeAgo = getTimeAgo(item.timestamp);
            
            // Check if item has a user note or was edited
            let userNote = '';
            let lastEdited = null;
            let itemArray = [];
            
            switch(item.type) {
                case 'chapter':
                    itemArray = userHistory.storyChapters;
                    break;
                case 'concern':
                    itemArray = userHistory.concerns;
                    break;
                case 'goal':
                    itemArray = userHistory.goals;
                    break;
                case 'value':
                    itemArray = userHistory.values;
                    break;
                case 'education':
                    itemArray = userHistory.educationTopics;
                    break;
            }
            
            if (itemArray[item.index]) {
                userNote = itemArray[item.index].userNote || '';
                lastEdited = itemArray[item.index].lastEdited;
            }
            
            // Special handling for About Me items
            if (item.type === 'about-me') {
                div.innerHTML = `
                    <div class="memory-type">üíö ${typeLabel}${lastEdited ? ' <span style="font-size: 10px; color: #999;">(edited)</span>' : ''}</div>
                    <div class="memory-content">${item.content}</div>
                    <div class="memory-meta">
                        <span>${item.metadata} ‚Ä¢ ${timeAgo}</span>
                        <div class="memory-actions">
                            <button class="memory-action-btn" onclick="openAboutMeEditor()">Edit</button>
                        </div>
                    </div>
                `;
            }
            // Special handling for chapters
            else if (item.type === 'chapter') {
                div.innerHTML = `
                    <div class="memory-type">üìñ ${typeLabel}${lastEdited ? ' <span style="font-size: 10px; color: #999;">(edited)</span>' : ''}</div>
                    <div class="memory-content" style="font-weight: bold;">${item.content}</div>
                    <div style="font-size: 12px; color: #666; margin-top: 4px;">${item.fullChapter.moment.substring(0, 100)}...</div>
                    <div class="memory-meta">
                        <span>${item.metadata} ‚Ä¢ ${timeAgo}</span>
                        <div class="memory-actions">
                            <button class="memory-action-btn" onclick="viewChapter(${item.index})">View</button>
                            <button class="memory-action-btn delete" onclick="deleteMemoryItem('${item.type}', ${item.index})">Delete</button>
                        </div>
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <div class="memory-type">${typeLabel}${lastEdited ? ' <span style="font-size: 10px; color: #999;">(edited)</span>' : ''}</div>
                    <div class="memory-content">${item.content}</div>
                    ${userNote ? `<div style="font-size: 12px; color: #666; margin-top: 4px; font-style: italic;">Note: ${userNote}</div>` : ''}
                    <div class="memory-meta">
                        <span>${item.metadata} ‚Ä¢ ${timeAgo}${lastEdited ? ` ‚Ä¢ Edited ${getTimeAgo(lastEdited)}` : ''}</span>
                        <div class="memory-actions">
                            <button class="memory-action-btn" onclick="editMemoryItem('${item.type}', ${item.index})">Edit</button>
                            <button class="memory-action-btn delete" onclick="deleteMemoryItem('${item.type}', ${item.index})">Delete</button>
                        </div>
                    </div>
                    <div class="memory-edit-form" id="edit-${item.type}-${item.index}">
                        <input type="text" class="memory-edit-input" id="edit-input-${item.type}-${item.index}" value="${item.content}">
                        <textarea class="memory-edit-input" id="edit-note-${item.type}-${item.index}" placeholder="Add a note or correction (optional)" rows="2">${userNote}</textarea>
                        <div class="memory-edit-actions">
                            <button class="memory-edit-btn cancel" onclick="cancelEdit('${item.type}', ${item.index})">Cancel</button>
                            <button class="memory-edit-btn save" onclick="saveEdit('${item.type}', ${item.index})">Save</button>
                        </div>
                    </div>
                `;
            }
            
            return div;
        }

        // Open About Me editor
        function openAboutMeEditor() {
            currentPhase = "about_me_edit";
            showBotMessage(
                `Let's update what matters most to you. This helps me provide better support aligned with your values and concerns.

Would you like to:`,
                [
                    "‚Üí Update what makes life meaningful",
                    "‚Üí Review your concerns",
                    "‚Üí Change your confidence level",
                    "‚Üí Add new priorities"
                ]
            );
        }

        // View chapter function
        function viewChapter(index) {
            const chapter = userHistory.storyChapters[index];
            if (!chapter) return;
            
            let chapterView = `üìñ <strong>${chapter.title}</strong>\n\n${chapter.moment}`;
            
            if (chapter.choices) {
                chapterView += `\n\n<em>Choices Made:</em> ${chapter.choices}`;
            }
            
            if (chapter.learning) {
                chapterView += `\n\n<em>What You Learned:</em> ${chapter.learning}`;
            }
            
            chapterView += `\n\n<em>Your Journey:</em> ${chapter.moodArc.join(' ‚Üí ')}`;
            
            if (chapter.linkedBestLifeElements && chapter.linkedBestLifeElements.length > 0) {
                chapterView += `\n\n<em>Connected to:</em> ${chapter.linkedBestLifeElements.join(', ')}`;
            }
            
            showBotMessage(chapterView);
        }

        // Get time ago string
        function getTimeAgo(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const seconds = Math.floor((now - then) / 1000);
            
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} min ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
            return `${Math.floor(seconds / 86400)} days ago`;
        }

        // Edit memory item
        function editMemoryItem(type, index) {
            const editForm = document.getElementById(`edit-${type}-${index}`);
            if (editForm) {
                editForm.classList.add('active');
            }
        }

        // Cancel edit
        function cancelEdit(type, index) {
            const editForm = document.getElementById(`edit-${type}-${index}`);
            if (editForm) {
                editForm.classList.remove('active');
                updateMemoryDisplay();
            }
        }

        // Save edit
        async function saveEdit(type, index) {
            const input = document.getElementById(`edit-input-${type}-${index}`);
            const noteInput = document.getElementById(`edit-note-${type}-${index}`);
            if (!input) return;
            
            const newValue = input.value.trim();
            const note = noteInput ? noteInput.value.trim() : '';
            if (!newValue) return;
            
            const editTimestamp = new Date().toISOString();
            let previousValue = null;
            
            // Update the appropriate array and track in backend
            switch(type) {
                case 'concern':
                    if (userHistory.concerns[index]) {
                        previousValue = userHistory.concerns[index].concern;
                        userHistory.concerns[index].concern = newValue;
                        if (note) userHistory.concerns[index].userNote = note;
                        userHistory.concerns[index].lastEdited = editTimestamp;
                        
                        // Track in backend
                        if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                            try {
                                await SofiaAPI.trackProfileChange({
                                    variableName: 'concern_edit',
                                    variableValue: newValue,
                                    previousValue: previousValue,
                                    source: 'manual_edit',
                                    sourceDetails: {
                                        editNote: note,
                                        editTimestamp: editTimestamp,
                                        itemIndex: index
                                    }
                                });
                            } catch (error) {
                                console.error('Failed to track concern edit:', error);
                            }
                        }
                        
                        showBotMessage(`I've updated your concern to: "${newValue}". ${note ? 'I\'ve also noted: "' + note + '"' : ''} Thank you for refining your story!`);
                    }
                    break;
                case 'goal':
                    if (userHistory.goals[index]) {
                        previousValue = userHistory.goals[index].goal;
                        userHistory.goals[index].goal = newValue;
                        if (note) userHistory.goals[index].userNote = note;
                        userHistory.goals[index].lastEdited = editTimestamp;
                        
                        // Track in backend
                        if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                            try {
                                await SofiaAPI.trackProfileChange({
                                    variableName: 'goal_edit',
                                    variableValue: newValue,
                                    previousValue: previousValue,
                                    source: 'manual_edit',
                                    sourceDetails: {
                                        editNote: note,
                                        editTimestamp: editTimestamp,
                                        itemIndex: index
                                    }
                                });
                            } catch (error) {
                                console.error('Failed to track goal edit:', error);
                            }
                        }
                        
                        showBotMessage(`I've updated your goal to: "${newValue}". ${note ? 'I\'ve noted: "' + note + '"' : ''} Your story continues to evolve!`);
                    }
                    break;
                case 'value':
                    if (userHistory.values[index]) {
                        previousValue = userHistory.values[index].value;
                        userHistory.values[index].value = newValue;
                        if (note) userHistory.values[index].userNote = note;
                        userHistory.values[index].lastEdited = editTimestamp;
                        
                        // Track in backend
                        if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                            try {
                                await SofiaAPI.trackProfileChange({
                                    variableName: 'value_edit',
                                    variableValue: newValue,
                                    previousValue: previousValue,
                                    source: 'manual_edit',
                                    sourceDetails: {
                                        editNote: note,
                                        editTimestamp: editTimestamp,
                                        itemIndex: index
                                    }
                                });
                            } catch (error) {
                                console.error('Failed to track value edit:', error);
                            }
                        }
                        
                        showBotMessage(`I've updated what matters to you: "${newValue}". ${note ? 'I understand: "' + note + '"' : ''} These values guide your journey!`);
                    }
                    break;
                case 'education':
                    if (userHistory.educationTopics[index]) {
                        previousValue = userHistory.educationTopics[index].topic;
                        userHistory.educationTopics[index].topic = newValue.toLowerCase().replace(/ /g, '_');
                        if (note) userHistory.educationTopics[index].userNote = note;
                        userHistory.educationTopics[index].lastEdited = editTimestamp;
                        
                        // Track in backend
                        if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                            try {
                                await SofiaAPI.trackProfileChange({
                                    variableName: 'education_topic_edit',
                                    variableValue: newValue,
                                    previousValue: previousValue,
                                    source: 'manual_edit',
                                    sourceDetails: {
                                        editNote: note,
                                        editTimestamp: editTimestamp,
                                        itemIndex: index
                                    }
                                });
                            } catch (error) {
                                console.error('Failed to track education topic edit:', error);
                            }
                        }
                        
                        showBotMessage(`I've updated the topic we explored: "${newValue}". ${note ? 'Your note: "' + note + '"' : ''}`);
                    }
                    break;
            }
            
            logActionPlan(`User edited ${type}: "${newValue}"`);
            
            saveUserHistory();
            updateMemoryDisplay();
            cancelEdit(type, index);
        }

        // Delete memory item
        function deleteMemoryItem(type, index) {
            const confirmDelete = confirm(`Are you sure you want to delete this ${type}?`);
            if (!confirmDelete) return;
            
            // Remove from the appropriate array
            switch(type) {
                case 'chapter':
                    userHistory.storyChapters.splice(index, 1);
                    showBotMessage("I've removed that chapter from your story. You can always create new chapters as your journey continues.");
                    break;
                case 'concern':
                    userHistory.concerns.splice(index, 1);
                    showBotMessage("I've removed that concern from your story. Your narrative continues to evolve.");
                    break;
                case 'goal':
                    userHistory.goals.splice(index, 1);
                    showBotMessage("I've removed that goal. New paths await in your story!");
                    break;
                case 'value':
                    userHistory.values.splice(index, 1);
                    showBotMessage("I've removed that from what matters to you in your story.");
                    break;
                case 'education':
                    userHistory.educationTopics.splice(index, 1);
                    showBotMessage("I've removed that topic from your learning journey.");
                    break;
            }
            
            saveUserHistory();
            updateMemoryDisplay();
        }

        // Filter memory display
        function filterMemory(filter) {
            currentMemoryFilter = filter;
            
            // Update button states
            document.querySelectorAll('.memory-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateMemoryDisplay();
        }

        // Update memory summary
        function updateMemorySummary() {
            const activeGoals = userHistory.goals ? userHistory.goals.filter(g => g.status === 'active').length : 0;
            const chapters = userHistory.storyChapters ? userHistory.storyChapters.length : 0;
            const topics = userHistory.educationTopics ? userHistory.educationTopics.length : 0;
            
            // NEW: Count About Me elements
            const bestLifeCount = userHistory.aboutMe && userHistory.aboutMe.bestLifeElements ? 
                userHistory.aboutMe.bestLifeElements.length : 0;
            const concernsCount = userHistory.aboutMe && userHistory.aboutMe.concerns ? 
                userHistory.aboutMe.concerns.length : 0;
            
            document.getElementById('activeGoalsCount').textContent = activeGoals;
            document.getElementById('chaptersCount').textContent = chapters;
            document.getElementById('topicsCount').textContent = topics;
            
            // NEW: Update About Me counts
            document.getElementById('bestLifeCount').textContent = bestLifeCount;
            document.getElementById('concernsCount').textContent = concernsCount;
        }

        // Show memory notification
        function showMemoryNotification(type, content) {
            const notification = document.createElement('div');
            notification.className = 'memory-notification';
            
            const typeLabel = type.charAt(0).toUpperCase() + type.slice(1);
            notification.innerHTML = `üìù Remembered ${typeLabel}: "${content}"`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Enhanced logging functions with real-time display and notifications
        const originalLogConcern = logConcern;
        logConcern = function(concern, severity = 'moderate', context = '') {
            originalLogConcern(concern, severity, context);
            updateMemoryDisplay(true);
            showMemoryNotification('concern', concern);
        };

        const originalLogGoal = logGoal;
        logGoal = function(goal, confidence = 7, linkedBestLifeElements = []) {
            const index = originalLogGoal(goal, confidence, linkedBestLifeElements);
            updateMemoryDisplay(true);
            showMemoryNotification('goal', goal);
            return index;
        };

        const originalLogValue = logValue;
        logValue = function(value, importance = 'high') {
            originalLogValue(value, importance);
            updateMemoryDisplay(true);
            showMemoryNotification('value', value);
        };

        const originalLogEducationTopic = logEducationTopic;
        logEducationTopic = function(topic, engagement = 'moderate') {
            originalLogEducationTopic(topic, engagement);
            updateMemoryDisplay(true);
            const displayTopic = topic.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            showMemoryNotification('education', displayTopic);
        };

        let conversationLog = [];
        let feedbackLog = [];
        let currentPhase = "initialization";
        let currentSessionIndex = -1;
        let isReturningUser = false;
        let optionButtonCounter = 0; // Counter for unique button IDs

        // Document upload variables
        let extractedVariables = [];
        let documentProcessing = false;

        // Profile variable mappings for intelligent extraction
        const profileVariableMappings = {
            // Personal Information
            name: ['name', 'full name', 'patient name', 'client name', 'first name', 'last name'],
            age: ['age', 'date of birth', 'dob', 'birth date', 'years old'],
            
            // Health Conditions
            medicalConditions: ['diagnosis', 'medical conditions', 'health conditions', 'conditions', 'diagnosed with', 'medical history'],
            medications: ['medications', 'prescriptions', 'drugs', 'medicine', 'taking', 'prescribed'],
            
            // Cognitive Concerns
            memoryConcerns: ['memory', 'forgetfulness', 'forgetting', 'memory loss', 'cognitive concerns', 'memory problems'],
            cognitiveStrengths: ['strengths', 'abilities', 'good at', 'capable of', 'independent in'],
            
            // Daily Living
            livingArrangement: ['living', 'residence', 'home', 'lives with', 'living arrangement', 'housing'],
            dailyActivities: ['activities', 'daily routine', 'hobbies', 'interests', 'enjoys', 'participates in'],
            
            // Social
            familySupport: ['family', 'relatives', 'children', 'spouse', 'partner', 'support system'],
            socialActivities: ['social', 'friends', 'groups', 'clubs', 'community', 'social activities'],
            
            // Goals and Values
            personalGoals: ['goals', 'wants to', 'hopes to', 'wishes', 'objectives', 'aims'],
            values: ['values', 'important to', 'matters most', 'priorities', 'believes in'],
            
            // Physical Health
            physicalActivity: ['exercise', 'physical activity', 'walking', 'movement', 'fitness'],
            dietNutrition: ['diet', 'nutrition', 'eating', 'meals', 'food preferences'],
            sleepPatterns: ['sleep', 'sleeping', 'insomnia', 'rest', 'bedtime'],
            
            // Safety Concerns
            safetyConcerns: ['safety', 'falls', 'balance', 'risks', 'concerns about', 'worried about'],
            
            // About Me Specific
            bestLifeElements: ['best life', 'meaningful', 'joy', 'fulfillment', 'happiness', 'quality of life'],
            concerns: ['concerns', 'worries', 'anxious about', 'afraid of', 'challenges']
        };

        // Document upload functions
        function openDocumentUpload() {
            document.getElementById('documentUpload').click();
        }

        async function handleDocumentUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            documentProcessing = true;
            showBotMessage("üìÑ I'm reading your document and extracting relevant information. This may take a moment...");
            
            try {
                const content = await readFileContent(file);
                const extracted = await extractProfileVariables(content, file.type);
                
                // Track upload if API is available
                let uploadId = null;
                if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                    try {
                        const uploadResult = await SofiaAPI.trackDocumentUpload({
                            filename: file.name,
                            fileType: file.type,
                            fileSize: file.size,
                            extractedCount: extracted.length,
                            metadata: {
                                processedAt: new Date().toISOString(),
                                extractionMethod: 'client-side'
                            }
                        });
                        uploadId = uploadResult.id;
                    } catch (error) {
                        console.error('Failed to track document upload:', error);
                    }
                }
                
                if (extracted.length > 0) {
                    extractedVariables = extracted;
                    extractedVariables.uploadId = uploadId; // Store for later update
                    showDocumentReview();
                } else {
                    showBotMessage("I couldn't find any relevant profile information in this document. Could you try a different document or tell me what information you'd like to add to your profile?");
                }
            } catch (error) {
                console.error('Document processing error:', error);
                showBotMessage("I had trouble reading your document. Please try again with a different file format (text, PDF, or Word documents work best).");
            } finally {
                documentProcessing = false;
                // Reset file input
                event.target.value = '';
            }
        }

        async function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    const content = e.target.result;
                    
                    if (file.type === 'application/pdf') {
                        // For PDF files, check if PDF.js is available
                        if (typeof pdfjsLib !== 'undefined') {
                            try {
                                const pdf = await pdfjsLib.getDocument({ data: content }).promise;
                                let fullText = '';
                                
                                for (let i = 1; i <= pdf.numPages; i++) {
                                    const page = await pdf.getPage(i);
                                    const textContent = await page.getTextContent();
                                    const pageText = textContent.items.map(item => item.str).join(' ');
                                    fullText += pageText + '\n';
                                }
                                
                                resolve(fullText);
                            } catch (error) {
                                reject(new Error('Could not parse PDF. Please try a text file instead.'));
                            }
                        } else {
                            reject(new Error('PDF reading is not available. Please use a text file (.txt) or copy and paste the content.'));
                        }
                    } else if (file.type.includes('json')) {
                        try {
                            const jsonData = JSON.parse(content);
                            // Convert JSON to readable text format
                            let textContent = '';
                            
                            function extractText(obj, prefix = '') {
                                for (const [key, value] of Object.entries(obj)) {
                                    if (typeof value === 'object' && value !== null) {
                                        extractText(value, key + ': ');
                                    } else {
                                        textContent += `${prefix}${key}: ${value}\n`;
                                    }
                                }
                            }
                            
                            extractText(jsonData);
                            resolve(textContent);
                        } catch (e) {
                            reject(new Error('Invalid JSON file'));
                        }
                    } else if (file.type.includes('csv')) {
                        // Basic CSV parsing
                        const lines = content.split('\n');
                        let textContent = '';
                        
                        if (lines.length > 0) {
                            const headers = lines[0].split(',').map(h => h.trim());
                            
                            for (let i = 1; i < lines.length; i++) {
                                const values = lines[i].split(',').map(v => v.trim());
                                if (values.length === headers.length) {
                                    headers.forEach((header, index) => {
                                        if (values[index]) {
                                            textContent += `${header}: ${values[index]}\n`;
                                        }
                                    });
                                    textContent += '\n';
                                }
                            }
                        }
                        resolve(textContent);
                    } else {
                        // Text files and others
                        resolve(content);
                    }
                };
                
                reader.onerror = reject;
                
                if (file.type === 'application/pdf') {
                    reader.readAsArrayBuffer(file);
                } else {
                    reader.readAsText(file);
                }
            });
        }

        async function extractProfileVariables(content, fileType) {
            const extracted = [];
            const lines = content.split(/\n+/);
            const processedValues = new Set(); // Avoid duplicates
            
            // Smart extraction based on patterns
            for (const [variable, keywords] of Object.entries(profileVariableMappings)) {
                for (const keyword of keywords) {
                    const regex = new RegExp(`${keyword}[:\\s]*([^\\n\\r.;]+)`, 'gi');
                    const matches = content.matchAll(regex);
                    
                    for (const match of matches) {
                        const value = match[1].trim();
                        if (value && value.length > 2 && value.length < 500) {
                            const key = `${variable}_${value}`;
                            if (!processedValues.has(key)) {
                                processedValues.add(key);
                                
                                // Check for existing value
                                const existing = getExistingValue(variable);
                                
                                extracted.push({
                                    variable: variable,
                                    displayName: formatVariableName(variable),
                                    value: value,
                                    type: getVariableType(variable),
                                    source: keyword,
                                    existing: existing,
                                    hasConflict: existing && existing !== value,
                                    selected: true
                                });
                            }
                        }
                    }
                }
            }
            
            // Also look for structured data patterns
            // Look for "About Me" style lists
            const bulletPoints = content.match(/[‚Ä¢\-\*]\s*([^\n]+)/g);
            if (bulletPoints) {
                bulletPoints.forEach(point => {
                    const cleaned = point.replace(/[‚Ä¢\-\*]\s*/, '').trim();
                    // Check if this matches any About Me categories
                    if (cleaned.length > 5 && cleaned.length < 200) {
                        const category = categorizeAboutMeItem(cleaned);
                        if (category) {
                            extracted.push({
                                variable: category,
                                displayName: formatVariableName(category),
                                value: cleaned,
                                type: 'about_me',
                                source: 'bullet point',
                                existing: null,
                                hasConflict: false,
                                selected: true
                            });
                        }
                    }
                });
            }
            
            return extracted;
        }

        function categorizeAboutMeItem(text) {
            const lowerText = text.toLowerCase();
            
            // Check for best life elements
            const bestLifeKeywords = ['enjoy', 'love', 'important', 'meaningful', 'value', 'matter'];
            if (bestLifeKeywords.some(keyword => lowerText.includes(keyword))) {
                return 'bestLifeElements';
            }
            
            // Check for concerns
            const concernKeywords = ['worry', 'concern', 'anxious', 'afraid', 'challenge', 'difficult'];
            if (concernKeywords.some(keyword => lowerText.includes(keyword))) {
                return 'concerns';
            }
            
            // Check for goals
            const goalKeywords = ['want to', 'hope to', 'goal', 'plan to', 'would like'];
            if (goalKeywords.some(keyword => lowerText.includes(keyword))) {
                return 'personalGoals';
            }
            
            return null;
        }

        function getExistingValue(variable) {
            // Check various places in userHistory for existing values
            switch(variable) {
                case 'name':
                    return userHistory.profile.name;
                case 'age':
                    return userHistory.profile.age;
                case 'bestLifeElements':
                    return userHistory.aboutMe.bestLifeElements.map(e => e.element).join(', ');
                case 'concerns':
                    return userHistory.aboutMe.concerns.map(c => c.concern).join(', ');
                case 'personalGoals':
                    return userHistory.goals.filter(g => g.status === 'active').map(g => g.goal).join(', ');
                case 'values':
                    return userHistory.values.map(v => v.value).join(', ');
                case 'livingArrangement':
                    return userHistory.socialContext?.livingArrangement;
                case 'medicalConditions':
                    return userHistory.healthFactors?.medicalConditions?.join(', ');
                case 'medications':
                    return userHistory.healthFactors?.medications?.join(', ');
                default:
                    return null;
            }
        }

        function getVariableType(variable) {
            const types = {
                name: 'personal',
                age: 'personal',
                medicalConditions: 'health',
                medications: 'health',
                memoryConcerns: 'cognitive',
                cognitiveStrengths: 'cognitive',
                livingArrangement: 'social',
                dailyActivities: 'lifestyle',
                familySupport: 'social',
                socialActivities: 'social',
                personalGoals: 'goals',
                values: 'values',
                physicalActivity: 'health',
                dietNutrition: 'health',
                sleepPatterns: 'health',
                safetyConcerns: 'safety',
                bestLifeElements: 'about_me',
                concerns: 'about_me'
            };
            return types[variable] || 'other';
        }

        function formatVariableName(variable) {
            return variable
                .replace(/([A-Z])/g, ' $1')
                .replace(/^./, str => str.toUpperCase())
                .trim();
        }

        function showDocumentReview() {
            const modal = document.getElementById('documentReviewModal');
            const list = document.getElementById('extractedVariablesList');
            
            list.innerHTML = '';
            
            // Group by type
            const grouped = extractedVariables.reduce((acc, item) => {
                if (!acc[item.type]) acc[item.type] = [];
                acc[item.type].push(item);
                return acc;
            }, {});
            
            // Show extraction summary
            const summary = document.createElement('div');
            summary.className = 'extraction-status';
            summary.innerHTML = `Found ${extractedVariables.length} pieces of information across ${Object.keys(grouped).length} categories`;
            list.appendChild(summary);
            
            // Display each group
            Object.entries(grouped).forEach(([type, items]) => {
                const typeHeader = document.createElement('h4');
                typeHeader.style.cssText = 'margin: 15px 0 10px 0; color: #667eea; text-transform: capitalize;';
                typeHeader.textContent = type.replace('_', ' ') + ' Information';
                list.appendChild(typeHeader);
                
                items.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = `variable-review-item ${item.selected ? 'selected' : ''} ${item.hasConflict ? 'conflict' : ''}`;
                    div.id = `extracted-${index}`;
                    
                    div.innerHTML = `
                        <div class="variable-header">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" class="variable-checkbox" 
                                       id="check-${index}" 
                                       ${item.selected ? 'checked' : ''} 
                                       onchange="toggleExtractedVariable(${index})">
                                <label for="check-${index}" class="variable-name">${item.displayName}</label>
                            </div>
                            <span class="variable-type">${item.type}</span>
                        </div>
                        <div class="variable-value">${item.value}</div>
                        ${item.hasConflict ? `
                            <div class="variable-existing">
                                ‚ö†Ô∏è Current value: "${item.existing}"<br>
                                <small>Selecting this will update with a timestamp</small>
                            </div>
                        ` : ''}
                        <div style="font-size: 11px; color: #999; margin-top: 5px;">
                            Source: ${item.source}
                        </div>
                    `;
                    
                    list.appendChild(div);
                });
            });
            
            modal.classList.add('active');
        }

        function toggleExtractedVariable(index) {
            extractedVariables[index].selected = !extractedVariables[index].selected;
            const element = document.getElementById(`extracted-${index}`);
            if (extractedVariables[index].selected) {
                element.classList.add('selected');
            } else {
                element.classList.remove('selected');
            }
        }

        function selectAllExtracted() {
            extractedVariables.forEach((item, index) => {
                item.selected = true;
                document.getElementById(`check-${index}`).checked = true;
                document.getElementById(`extracted-${index}`).classList.add('selected');
            });
        }

        function deselectAllExtracted() {
            extractedVariables.forEach((item, index) => {
                item.selected = false;
                document.getElementById(`check-${index}`).checked = false;
                document.getElementById(`extracted-${index}`).classList.remove('selected');
            });
        }

        function closeDocumentReview() {
            document.getElementById('documentReviewModal').classList.remove('active');
            extractedVariables = [];
        }

        async function applySelectedVariables() {
            const selected = extractedVariables.filter(item => item.selected);
            if (selected.length === 0) {
                alert('Please select at least one item to add to your profile.');
                return;
            }
            
            let updatedCount = 0;
            let addedCount = 0;
            
            // Apply each selected variable
            for (const item of selected) {
                const timestamp = new Date().toISOString();
                
                // Track profile change if API is available
                if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                    try {
                        await SofiaAPI.trackProfileChange({
                            variableName: item.variable,
                            variableValue: item.value,
                            previousValue: item.existing || null,
                            source: 'document',
                            sourceDetails: {
                                extractionKeyword: item.source,
                                hasConflict: item.hasConflict,
                                uploadId: extractedVariables.uploadId
                            }
                        });
                    } catch (error) {
                        console.error('Failed to track profile change:', error);
                    }
                }
                
                switch(item.variable) {
                    case 'name':
                        if (!userHistory.profile.name || item.hasConflict) {
                            userHistory.profile.name = item.value;
                            userHistory.profile.nameHistory = userHistory.profile.nameHistory || [];
                            userHistory.profile.nameHistory.push({ value: item.value, timestamp });
                        }
                        break;
                        
                    case 'age':
                        if (!userHistory.profile.age || item.hasConflict) {
                            userHistory.profile.age = item.value;
                            userHistory.profile.ageHistory = userHistory.profile.ageHistory || [];
                            userHistory.profile.ageHistory.push({ value: item.value, timestamp });
                        }
                        break;
                        
                    case 'bestLifeElements':
                        logBestLifeElement(item.value);
                        break;
                        
                    case 'concerns':
                        logAboutMeConcern(item.value);
                        break;
                        
                    case 'personalGoals':
                        logGoal(item.value);
                        break;
                        
                    case 'values':
                        logValue(item.value);
                        break;
                        
                    case 'memoryConcerns':
                        logConcern(item.value, 'moderate', 'from uploaded document');
                        break;
                        
                    case 'medicalConditions':
                        if (!userHistory.healthFactors.medicalConditions) {
                            userHistory.healthFactors.medicalConditions = [];
                        }
                        userHistory.healthFactors.medicalConditions.push({
                            condition: item.value,
                            timestamp: timestamp,
                            source: 'document'
                        });
                        break;
                        
                    case 'medications':
                        if (!userHistory.healthFactors.medications) {
                            userHistory.healthFactors.medications = [];
                        }
                        userHistory.healthFactors.medications.push({
                            medication: item.value,
                            timestamp: timestamp,
                            source: 'document'
                        });
                        break;
                        
                    case 'livingArrangement':
                        userHistory.socialContext.livingArrangement = item.value;
                        userHistory.socialContext.livingArrangementHistory = userHistory.socialContext.livingArrangementHistory || [];
                        userHistory.socialContext.livingArrangementHistory.push({ value: item.value, timestamp });
                        break;
                        
                    case 'physicalActivity':
                        userHistory.healthFactors.physicalActivity = item.value;
                        logEducationTopic('physical_activity_mentioned');
                        break;
                        
                    case 'sleepPatterns':
                        userHistory.healthFactors.sleepQuality = item.value;
                        logEducationTopic('sleep_patterns_mentioned');
                        break;
                        
                    default:
                        // Store in a general extracted data section
                        if (!userHistory.extractedData) {
                            userHistory.extractedData = {};
                        }
                        if (!userHistory.extractedData[item.variable]) {
                            userHistory.extractedData[item.variable] = [];
                        }
                        userHistory.extractedData[item.variable].push({
                            value: item.value,
                            timestamp: timestamp,
                            source: 'document'
                        });
                }
                
                if (item.hasConflict) {
                    updatedCount++;
                } else {
                    addedCount++;
                }
            }
            
            // Save updates
            saveUserHistory();
            updateMemoryDisplay(true);
            
            // Update document upload status if API is available
            if (extractedVariables.uploadId && typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                try {
                    await SofiaAPI.updateDocumentUpload(extractedVariables.uploadId, selected.length);
                } catch (error) {
                    console.error('Failed to update document status:', error);
                }
            }
            
            closeDocumentReview();
            
            // Show summary to user
            let summaryMessage = `‚ú® I've successfully updated your profile!\n\n`;
            if (addedCount > 0) {
                summaryMessage += `üìå Added ${addedCount} new piece${addedCount > 1 ? 's' : ''} of information\n`;
            }
            if (updatedCount > 0) {
                summaryMessage += `üîÑ Updated ${updatedCount} existing value${updatedCount > 1 ? 's' : ''} with timestamps\n`;
            }
            
            summaryMessage += `\nYour profile is now richer and more complete. `;
            
            // Add personalized follow-up based on what was extracted
            if (selected.some(item => item.type === 'about_me')) {
                summaryMessage += `I see what matters most to you. Would you like to explore how we can support these priorities?`;
                currentPhase = "document_followup";
            } else if (selected.some(item => item.type === 'health')) {
                summaryMessage += `I've noted your health information. Would you like to discuss strategies for brain health that work with your current situation?`;
                currentPhase = "health_followup";
            } else {
                summaryMessage += `This gives me a better understanding of your journey. What would you like to explore next?`;
            }
            
            showBotMessage(summaryMessage, [
                "‚Üí Show me my updated profile",
                "‚Üí Continue our conversation",
                "‚Üí Set a new goal based on this",
                "‚Üí Create a chapter about this"
            ]);
        }

        // Add handler for document-based follow-ups
        function handleDocumentFollowup(message) {
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('show') && lowerMessage.includes('profile')) {
                showProfileSummary();
            } else if (lowerMessage.includes('continue')) {
                showBotMessage(
                    "Let's continue your story. What aspect of your brain health journey would you like to explore?",
                    [
                        "‚Üí The Path of Movement",
                        "‚Üí The Garden of Rest",
                        "‚Üí The Circle of Connection",
                        "‚Üí The Temple of Learning"
                    ]
                );
                currentPhase = "chapter_creation";
            } else if (lowerMessage.includes('goal')) {
                currentPhase = "goal_setting_from_document";
                showBotMessage(
                    "Based on what I learned from your document, here are some meaningful goals we could work on together:",
                    generateGoalSuggestionsFromDocument()
                );
            } else if (lowerMessage.includes('chapter')) {
                openChapterModal();
            }
        }

        function generateGoalSuggestionsFromDocument() {
            const suggestions = [];
            
            // Look at what was extracted to suggest relevant goals
            if (userHistory.healthFactors.physicalActivity) {
                suggestions.push("‚Üí Maintain or increase daily physical activity");
            }
            if (userHistory.healthFactors.sleepQuality) {
                suggestions.push("‚Üí Improve sleep quality and consistency");
            }
            if (userHistory.aboutMe.bestLifeElements.length > 0) {
                suggestions.push(`‚Üí Dedicate more time to ${userHistory.aboutMe.bestLifeElements[0].element.toLowerCase()}`);
            }
            if (userHistory.concerns.length > 0) {
                suggestions.push("‚Üí Address my top concern with a specific action plan");
            }
            
            // Default suggestion
            if (suggestions.length === 0) {
                suggestions.push("‚Üí Create a personalized brain health routine");
            }
            
            return suggestions;
        }

        function showProfileSummary() {
            let summary = `üìä Your Complete Profile Summary\n\n`;
            
            // Personal Information
            summary += `**Personal Information**\n`;
            summary += `Name: ${userHistory.profile.name || 'Not set'}\n`;
            summary += `Age: ${userHistory.profile.age || 'Not set'}\n\n`;
            
            // About Me
            if (userHistory.aboutMe.bestLifeElements.length > 0) {
                summary += `**What Makes Life Meaningful**\n`;
                userHistory.aboutMe.bestLifeElements.forEach(element => {
                    summary += `‚Ä¢ ${element.element}\n`;
                });
                summary += '\n';
            }
            
            if (userHistory.aboutMe.concerns.length > 0) {
                summary += `**Current Concerns**\n`;
                userHistory.aboutMe.concerns.forEach(concern => {
                    summary += `‚Ä¢ ${concern.concern}\n`;
                });
                summary += '\n';
            }
            
            // Health Information
            if (userHistory.healthFactors.medicalConditions && userHistory.healthFactors.medicalConditions.length > 0) {
                summary += `**Health Conditions**\n`;
                userHistory.healthFactors.medicalConditions.forEach(condition => {
                    summary += `‚Ä¢ ${condition.condition || condition}\n`;
                });
                summary += '\n';
            }
            
            // Goals
            const activeGoals = userHistory.goals.filter(g => g.status === 'active');
            if (activeGoals.length > 0) {
                summary += `**Active Goals**\n`;
                activeGoals.forEach(goal => {
                    summary += `‚Ä¢ ${goal.goal}\n`;
                });
                summary += '\n';
            }
            
            // Story Progress
            summary += `**Your Story Progress**\n`;
            summary += `Chapters Written: ${userHistory.storyChapters.length}\n`;
            summary += `Topics Explored: ${userHistory.educationTopics.length}\n`;
            summary += `Values Identified: ${userHistory.values.length}\n`;
            
            showBotMessage(summary);
        }

        // Initialize the chat with profile awareness
        window.onload = async function() {
            // Load API client if available
            if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                try {
                    // Load user data from API
                    const apiData = await loadUserHistoryFromAPI();
                    if (apiData) {
                        userHistory = apiData;
                        isReturningUser = true;
                        isAboutMeComplete = userHistory.aboutMe.profileCompleteness > 0;
                    }
                    
                    // Create new session in API
                    const session = await SofiaAPI.createSession();
                    currentSessionId = session.id;
                } catch (error) {
                    console.error('API initialization failed, falling back to localStorage:', error);
                    isReturningUser = loadUserHistory();
                    currentSessionIndex = startNewSession();
                }
            } else {
                // Fallback to localStorage if API not available
                isReturningUser = loadUserHistory();
                currentSessionIndex = startNewSession();
            }
            
            // Initialize memory display
            updateMemoryDisplay();
            
            // Update progress visualization if returning user
            if (isReturningUser && userHistory.storyChapters && userHistory.storyChapters.length > 0) {
                updateProgressVisualization();
            }

            setTimeout(async () => {
                if (isReturningUser && userHistory.profile.name) {
                    // Check if About Me profile has actual data (not just initialized)
                    const hasCompleteBestLife = userHistory.aboutMe?.bestLifeElements?.length > 0;
                    const hasCompleteConcerns = userHistory.aboutMe?.concerns?.length > 0;
                    const hasConfidenceLevel = userHistory.aboutMe?.confidenceLevel;
                    
                    // Calculate actual completeness
                    const actualCompleteness = (hasCompleteBestLife ? 40 : 0) + 
                                             (hasCompleteConcerns ? 40 : 0) + 
                                             (hasConfidenceLevel ? 20 : 0);
                    
                    if (actualCompleteness === 0) {
                        // First time or incomplete About Me
                        showBotMessage(
                            `Welcome back, ${userHistory.profile.name}! I notice we haven't explored what matters most to you yet.

This helps me provide support that's truly aligned with your values and concerns. It will only take a few moments.

Shall we explore what makes life meaningful for you?`,
                            [
                                "‚Üí Yes, let's explore what matters to me",
                                "‚Üí Skip for now and continue my story"
                            ]
                        );
                        currentPhase = "about_me_prompt";
                    } else {
                        // Returning user with complete About Me - personalized greeting
                        const daysSinceLastVisit = Math.floor((new Date() - new Date(userHistory.profile.lastVisit)) / (1000 * 60 * 60 * 24));
                        let greeting = `Welcome back to your story, ${userHistory.profile.name}! `;

                        if (daysSinceLastVisit === 0) {
                            greeting += "Continuing where we left off... ";
                        } else if (daysSinceLastVisit === 1) {
                            greeting += "It's been a day since your last chapter. ";
                        } else {
                            greeting += `It's been ${daysSinceLastVisit} days since we last connected. `;
                        }

                        // Reference their existing About Me priorities
                        greeting += `\n\nI remember that ${userHistory.aboutMe.bestLifeElements[0].element.toLowerCase()} is important to you`;
                        if (userHistory.aboutMe.concerns.length > 0) {
                            greeting += `, and you're working on managing ${userHistory.aboutMe.concerns[0].concern.toLowerCase()}.`;
                        } else {
                            greeting += '.';
                        }

                        // Check for active goals or chapters
                        const activeGoals = userHistory.goals.filter(g => g.status === 'active');
                        if (activeGoals.length > 0) {
                            greeting += `\n\nYour current quest: "${activeGoals[0].goal}"`;
                            currentPhase = "goal_checkin";
                        } else if (userHistory.storyChapters.length > 0) {
                            const lastChapter = userHistory.storyChapters[userHistory.storyChapters.length - 1];
                            greeting += `\n\nYour last chapter, "${lastChapter.title}," was a powerful moment in your journey.`;
                        }

                        greeting += "\n\nWhat would you like to focus on today?";

                        showBotMessage(greeting, [
                            "‚Üí Continue working to define my goals or life chapters",
                            "‚Üí Begin working to define my goals or a new chapter",
                            "‚Üí Reflect on my journey, document my progress, or update my health numbers",
                            "‚Üí Learn about brain health",
                            "‚Üí Prepare for a visit with my doctor",
                            "‚Üí Discuss what my doctor told me or the information they gave me",
                            "‚Üí Update what matters to me",
                            "‚Üí Something else - enter what you would like to do in the message box below"
                        ]);
                        
                        currentPhase = "main_conversation";
                    }
                } else {
                    // New user - narrative introduction
                    showBotMessage(
                        `Welcome, brave soul. I'm Sofia, your guide in the adventure of brain health.

You stand at the beginning of an extraordinary journey - one where you are both the author and the hero. But before we begin crafting your story, I'd love to understand what makes life meaningful for you.

To start, may I know your name?`
                    );
                    currentPhase = "introduction";
                }
            }, 1000);
        };

        function showTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = 'block';
            document.getElementById('chatContainer').appendChild(indicator);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = 'none';
        }

        function showBotMessage(message, options = [], isStoryMoment = false, isAboutMe = false) {
            showTypingIndicator();
            
            // Clean the message of markdown formatting
            message = cleanBotMessage(message);
            
            setTimeout(() => {
                hideTypingIndicator();
                const chatContainer = document.getElementById('chatContainer');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                
                let messageHTML = '';
                
                // Add special indicators
                if (isStoryMoment) {
                    messageHTML += '<div class="story-moment-indicator">Story Moment Detected</div>';
                }
                if (isAboutMe) {
                    messageHTML += '<div class="about-me-indicator">About Me Discovery</div>';
                }
                
                messageHTML += `<div class="bot-message ${isStoryMoment ? 'story-moment' : ''} ${isAboutMe ? 'about-me' : ''}">${message.replace(/\n/g, '<br>')}</div>`;
                
                if (options.length > 0) {
                    messageHTML += '<div style="margin-top: 10px;">';
                    const buttonIds = [];
                    options.forEach((option, index) => {
                        // Create a unique ID for each option
                        const optionId = `option-${optionButtonCounter++}-${index}`;
                        buttonIds.push({id: optionId, option: option});
                        if (option.startsWith('‚Üí')) {
                            messageHTML += `<button class="narrative-choice" id="${optionId}">${option}</button>`;
                        } else {
                            messageHTML += `<button class="option-button" id="${optionId}">${option}</button>`;
                        }
                    });
                    messageHTML += '</div>';
                    
                    messageDiv.innerHTML = messageHTML;
                    chatContainer.appendChild(messageDiv);
                    
                    // Add click handlers after elements are in DOM
                    buttonIds.forEach(({id, option}) => {
                        const button = document.getElementById(id);
                        if (button) {
                            button.addEventListener('click', function() {
                                const optionText = option.startsWith('‚Üí') ? option.substring(2).trim() : option;
                                handleOptionClick(optionText);
                            });
                        }
                    });
                } else {
                    messageDiv.innerHTML = messageHTML;
                    chatContainer.appendChild(messageDiv);
                }
                
                scrollToBottom();
                
                conversationLog.push({
                    type: 'bot',
                    message: message,
                    timestamp: new Date().toISOString()
                });
            }, 1500);
        }

        function showAboutMeOptions(optionsList, type) {
            const chatContainer = document.getElementById('chatContainer');
            const optionsDiv = document.createElement('div');
            optionsDiv.style.marginTop = '10px';
            optionsDiv.innerHTML = '<div style="margin-bottom: 10px; font-size: 14px; color: #666;">Select all that apply and click the Continue button:</div>';
            
            const buttonIds = [];
            optionsList.forEach((option, index) => {
                const buttonId = `about-me-${optionButtonCounter++}-${index}`;
                buttonIds.push({id: buttonId, option: option});
                const button = document.createElement('button');
                button.id = buttonId;
                button.className = 'about-me-choice';
                button.textContent = option;
                optionsDiv.appendChild(button);
            });
            
            // Add continue button
            const continueBtn = document.createElement('button');
            continueBtn.style.marginTop = '15px';
            continueBtn.style.background = '#764ba2'; // Different purple shade
            continueBtn.style.border = '2px solid #764ba2';
            continueBtn.style.boxShadow = '0 2px 5px rgba(118, 75, 162, 0.3)';
            continueBtn.style.fontWeight = 'bold';
            continueBtn.style.fontSize = '16px';
            continueBtn.textContent = 'Continue ‚Üí';
            continueBtn.id = `continue-${optionButtonCounter++}`;
            optionsDiv.appendChild(continueBtn);
            
            chatContainer.appendChild(optionsDiv);
            
            // Add event listeners after DOM insertion
            buttonIds.forEach(({id, option}) => {
                const button = document.getElementById(id);
                if (button) {
                    button.addEventListener('click', function() {
                        toggleAboutMeSelection(this, option, type);
                    });
                }
            });
            
            // Add continue button listener
            continueBtn.addEventListener('click', function() {
                processAboutMeSelections(type);
            });
            
            scrollToBottom();
        }

        function toggleAboutMeSelection(button, option, type) {
            try {
                button.classList.toggle('selected');
                
                if (type === 'best-life') {
                    if (button.classList.contains('selected')) {
                        selectedBestLifeElements.push(option);
                    } else {
                        selectedBestLifeElements = selectedBestLifeElements.filter(e => e !== option);
                    }
                } else if (type === 'concerns') {
                    if (button.classList.contains('selected')) {
                        selectedConcerns.push(option);
                    } else {
                        selectedConcerns = selectedConcerns.filter(c => c !== option);
                    }
                }
            } catch (error) {
                console.error('Error toggling selection:', error);
            }
        }

        function processAboutMeSelections(type) {
            try {
                if (type === 'best-life') {
                    // Save best life elements
                    selectedBestLifeElements.forEach((element, index) => {
                        logBestLifeElement(element, index + 1);
                    });
                    
                    // Move to concerns phase
                    currentPhase = "about_me_concerns";
                    showBotMessage(
                        `Thank you for sharing what brings meaning to your life. These are beautiful priorities.

Now, let's talk about what might get in the way. What concerns you most when you think about living your best life?`,
                        [],
                        false,
                        true
                    );
                    
                    setTimeout(() => {
                        showAboutMeOptions(companionConfig.aboutMeFramework.concernCategories, 'concerns');
                    }, 2000);
                } else if (type === 'concerns') {
                    // Save concerns
                    selectedConcerns.forEach(concern => {
                        logAboutMeConcern(concern);
                    });
                    
                    // Move to confidence assessment
                    currentPhase = "about_me_confidence";
                    showBotMessage(
                        `I understand these concerns. They're valid and shared by many others.

Given what we've discussed, how confident are you that you can address these concerns?`,
                        companionConfig.aboutMeFramework.confidenceLevels,
                        false,
                        true
                    );
                }
            } catch (error) {
                console.error('Error processing selections:', error);
                showBotMessage("I apologize, but I encountered an error. Let's try a different approach. Can you tell me in your own words what matters most to you?");
            }
        }

        function showUserMessage(message) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `<div class="user-message">${message}</div>`;
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
            
            conversationLog.push({
                type: 'user',
                message: message,
                timestamp: new Date().toISOString()
            });
        }

        function sendMessage() {
            try {
                const input = document.getElementById('userInput');
                const message = input.value.trim();
                
                if (message) {
                    showUserMessage(message);
                    input.value = '';
                    processUserMessage(message);
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('There was an error sending your message. Please try again.');
            }
        }

        function handleOptionClick(option) {
            try {
                showUserMessage(option);
                processUserMessage(option);
            } catch (error) {
                console.error('Error handling option click:', error);
                showBotMessage("I apologize, but I encountered an error. Please try typing your response instead.");
            }
        }

        function analyzeMessageForLogging(message) {
            const lowerMessage = message.toLowerCase();
            
            // Detect and log concerns
            const concernKeywords = ['worry', 'concern', 'afraid', 'scared', 'anxious', 'forget', 'memory', 'lost', 'confused'];
            concernKeywords.forEach(keyword => {
                if (lowerMessage.includes(keyword)) {
                    logEmotionalState('concerned', keyword);
                }
            });

            // Detect and log values
            const valueKeywords = {
                'family': 'family connections',
                'independent': 'independence',
                'active': 'staying active',
                'friend': 'friendships',
                'learn': 'lifelong learning'
            };
            
            Object.entries(valueKeywords).forEach(([keyword, value]) => {
                if (lowerMessage.includes(keyword)) {
                    logValue(value);
                }
            });
        }

        // ============= CORE INTENT RECOGNITION SYSTEM =============
        
        // Detect when users want to discuss new topics naturally
        function detectUserIntent(message, currentPhase) {
            const lowerMessage = message.toLowerCase();
            
            // Store conversation context for potential return
            if (!window.conversationMemory) {
                window.conversationMemory = {
                    previousTopic: null,
                    previousPhase: null,
                    previousOptions: null,
                    userProgress: {},
                    canReturn: true
                };
            }
            
            // First, check if this is a main menu option selection
            if (message.startsWith('‚Üí')) {
                console.log('üéØ Detected main menu option selection:', message);
                const mainMenuOption = handleMainMenuOption(message);
                if (mainMenuOption) {
                    // Preserve current conversation context
                    window.conversationMemory.previousTopic = currentPhase;
                    window.conversationMemory.previousPhase = currentPhase;
                    window.conversationMemory.previousOptions = getCurrentOptions();
                    window.conversationMemory.userProgress = getUserProgress();
                    
                    return {
                        shouldSwitch: true,
                        newTopic: mainMenuOption.newTopic,
                        newPhase: mainMenuOption.newPhase,
                        confidence: mainMenuOption.confidence,
                        reason: mainMenuOption.reason,
                        userInput: mainMenuOption.userInput
                    };
                }
            }
            
            // Check for topic divergence from current conversation
            const topicDivergence = detectTopicDivergence(lowerMessage, currentPhase);
            
            if (topicDivergence.shouldSwitch) {
                // Preserve current conversation context
                window.conversationMemory.previousTopic = currentPhase;
                window.conversationMemory.previousPhase = currentPhase;
                window.conversationMemory.previousOptions = getCurrentOptions();
                window.conversationMemory.userProgress = getUserProgress();
                
                return {
                    shouldSwitch: true,
                    newTopic: topicDivergence.newTopic,
                    newPhase: topicDivergence.newPhase,
                    confidence: topicDivergence.confidence,
                    reason: topicDivergence.reason,
                    userInput: topicDivergence.userInput
                };
            }
            
            return { shouldSwitch: false };
        }
        
        // Intelligent option selection handler for all main menu topics
        function handleMainMenuOption(optionText) {
            const cleanOption = optionText.replace(/^‚Üí\s+/, '').toLowerCase();
            console.log('üéØ Processing main menu option:', cleanOption);
            
            // Brain health specific options
            if (cleanOption.includes('brain health basics') || cleanOption.includes('basics') || cleanOption.includes('fundamentals')) {
                return {
                    shouldSwitch: true,
                    newTopic: 'brain_health_basics',
                    newPhase: 'natural_brain_health_basics',
                    confidence: 0.98,
                    reason: 'user_selected_brain_health_basics',
                    userInput: cleanOption
                };
            }
            
            if (cleanOption.includes('memory') || cleanOption.includes('cognitive') || cleanOption.includes('brain function')) {
                return {
                    shouldSwitch: true,
                    newTopic: 'memory_cognitive_learning',
                    newPhase: 'natural_memory_cognitive_learning',
                    confidence: 0.98,
                    reason: 'user_selected_memory_topic',
                    userInput: cleanOption
                };
            }
            
            if (cleanOption.includes('lifestyle') || cleanOption.includes('habits') || cleanOption.includes('practices')) {
                return {
                    shouldSwitch: true,
                    newTopic: 'brain_lifestyle_habits',
                    newPhase: 'natural_brain_lifestyle_habits',
                    confidence: 0.98,
                    reason: 'user_selected_lifestyle_topic',
                    userInput: cleanOption
                };
            }
            
            if (cleanOption.includes('concerns') || cleanOption.includes('worries') || cleanOption.includes('issues')) {
                return {
                    shouldSwitch: true,
                    newTopic: 'brain_health_concerns',
                    newPhase: 'natural_brain_health_concerns',
                    confidence: 0.98,
                    reason: 'user_selected_concerns_topic',
                    userInput: cleanOption
                };
            }
            
            // Main menu options
            if (cleanOption.includes('continue working') || cleanOption.includes('goals') || cleanOption.includes('life chapters')) {
                return {
                    shouldSwitch: true,
                    newTopic: 'continue_goals_chapters',
                    newPhase: 'natural_continue_goals_chapters',
                    confidence: 0.98,
                    reason: 'user_selected_continue_goals',
                    userInput: cleanOption
                };
            }
            
            if (cleanOption.includes('begin working') || cleanOption.includes('new chapter')) {
                return {
                    shouldSwitch: true,
                    newTopic: 'begin_new_goals_chapters',
                    newPhase: 'natural_begin_new_goals_chapters',
                    confidence: 0.98,
                    reason: 'user_selected_begin_new',
                    userInput: cleanOption
                };
            }
            
            if (cleanOption.includes('reflect on my journey') || cleanOption.includes('document my progress') || cleanOption.includes('update my health numbers')) {
                return {
                    shouldSwitch: true,
                    newTopic: 'reflection_progress_health',
                    newPhase: 'natural_reflection_progress_health',
                    confidence: 0.98,
                    reason: 'user_selected_reflection',
                    userInput: cleanOption
                };
            }
            
            if (cleanOption.includes('prepare for a visit') || cleanOption.includes('doctor visit')) {
                return {
                    shouldSwitch: true,
                    newTopic: 'doctor_visit_preparation',
                    newPhase: 'natural_doctor_visit_preparation',
                    confidence: 0.98,
                    reason: 'user_selected_doctor_prep',
                    userInput: cleanOption
                };
            }
            
            if (cleanOption.includes('discuss what my doctor told me') || cleanOption.includes('doctor information')) {
                return {
                    shouldSwitch: true,
                    newTopic: 'discuss_doctor_info',
                    newPhase: 'natural_discuss_doctor_info',
                    confidence: 0.98,
                    reason: 'user_selected_doctor_discussion',
                    userInput: cleanOption
                };
            }
            
            if (cleanOption.includes('update what matters to me') || cleanOption.includes('update my priorities')) {
                return {
                    shouldSwitch: true,
                    newTopic: 'update_priorities',
                    newPhase: 'natural_update_priorities',
                    confidence: 0.98,
                    reason: 'user_selected_update_priorities',
                    userInput: cleanOption
                };
            }
            
            if (cleanOption.includes('something else') || cleanOption.includes('enter what you would like to do')) {
                return {
                    shouldSwitch: true,
                    newTopic: 'something_else',
                    newPhase: 'natural_something_else',
                    confidence: 0.98,
                    reason: 'user_selected_something_else',
                    userInput: cleanOption
                };
            }
            
            return null;
        }
        
        // Detect when user input diverges from offered options
        function detectTopicDivergence(userInput, currentPhase) {
            const lowerInput = userInput.toLowerCase();
            
            // More sophisticated pattern matching for specific situations
            const situationPatterns = [
                // Doctor appointment anxiety
                {
                    pattern: /(?:feeling|am|i'm)\s+(?:really\s+)?(?:anxious|nervous|worried|stressed)\s+(?:about\s+)?(?:my\s+)?(?:upcoming\s+)?(?:doctor|medical|appointment)/i,
                    topic: 'doctor_appointment_anxiety',
                    confidence: 0.95,
                    reason: 'specific_health_concern'
                },
                // Work stress affecting sleep
                {
                    pattern: /(?:work|job)\s+(?:stress|pressure|anxiety)\s+(?:is\s+)?(?:really\s+)?(?:affecting|impacting|hurting)\s+(?:my\s+)?(?:sleep|rest|health)/i,
                    topic: 'work_stress_sleep',
                    confidence: 0.95,
                    reason: 'work_life_balance_issue'
                },
                // Document upload requests
                {
                    pattern: /(?:want\s+to\s+)?(?:upload|share|show)\s+(?:a\s+)?(?:document|paper|report)\s+(?:my\s+)?(?:clinician|doctor|provider|therapist)\s+(?:gave\s+)?(?:to\s+)?(?:me)/i,
                    topic: 'document_upload_request',
                    confidence: 0.95,
                    reason: 'document_upload_need'
                },
                // Discuss specific documents from provider
                {
                    pattern: /(?:want\s+to\s+)?(?:discuss|talk\s+about|go\s+over)\s+(?:the\s+)?(?:last|recent|latest)\s+(?:document|paper|report|information)\s+(?:my\s+)?(?:provider|doctor|clinician|therapist)\s+(?:gave\s+)?(?:to\s+)?(?:me)/i,
                    topic: 'discuss_provider_document',
                    confidence: 0.95,
                    reason: 'user_wants_to_discuss_specific_document'
                },
                // General document discussion requests
                {
                    pattern: /(?:want\s+to\s+)?(?:discuss|talk\s+about|go\s+over)\s+(?:a\s+)?(?:document|paper|report|medical\s+information)/i,
                    topic: 'discuss_documents_general',
                    confidence: 0.95,
                    reason: 'user_wants_to_discuss_documents'
                },
                // Health concerns and questions
                {
                    pattern: /(?:want\s+to\s+)?(?:discuss|talk\s+about|ask\s+about)\s+(?:my\s+)?(?:health|symptoms|condition|concerns)/i,
                    topic: 'health_concerns_discussion',
                    confidence: 0.95,
                    reason: 'user_wants_to_discuss_health'
                },
                // Sleep and rest issues
                {
                    pattern: /(?:want\s+to\s+)?(?:discuss|talk\s+about|get\s+help\s+with)\s+(?:my\s+)?(?:sleep|rest|insomnia|tiredness|fatigue)/i,
                    topic: 'sleep_rest_help',
                    confidence: 0.95,
                    reason: 'user_wants_sleep_help'
                },
                // Stress and anxiety
                {
                    pattern: /(?:want\s+to\s+)?(?:discuss|talk\s+about|get\s+help\s+with)\s+(?:my\s+)?(?:stress|anxiety|worries|concerns|pressure)/i,
                    topic: 'stress_anxiety_help',
                    confidence: 0.95,
                    reason: 'user_wants_stress_help'
                },
                // Memory and cognitive concerns
                {
                    pattern: /(?:want\s+to\s+)?(?:discuss|talk\s+about|get\s+help\s+with)\s+(?:my\s+)?(?:memory|thinking|cognitive|brain\s+function|forgetfulness)/i,
                    topic: 'memory_cognitive_help',
                    confidence: 0.95,
                    reason: 'user_wants_memory_help'
                },
                // Relationship and social concerns
                {
                    pattern: /(?:want\s+to\s+)?(?:discuss|talk\s+about|get\s+help\s+with)\s+(?:my\s+)?(?:relationships?|social|family|friends|connections)/i,
                    topic: 'relationship_social_help',
                    confidence: 0.95,
                    reason: 'user_wants_relationship_help'
                },
                // Learn about brain health
                {
                    pattern: /(?:learn|find\s+out|understand|know\s+more)\s+(?:about\s+)?(?:brain\s+)?(?:health|wellness|function)/i,
                    topic: 'brain_health_learning',
                    confidence: 0.95,
                    reason: 'educational_interest'
                },
                // Brain health basics (from answer options)
                {
                    pattern: /(?:tell\s+me\s+about\s+)?(?:brain\s+)?(?:health\s+)?(?:basics|fundamentals|essentials)/i,
                    topic: 'brain_health_basics',
                    confidence: 0.95,
                    reason: 'educational_interest'
                },
                // Memory and cognitive function
                {
                    pattern: /(?:learn\s+about\s+)?(?:memory|cognitive|brain\s+function|thinking|mental\s+processes)/i,
                    topic: 'memory_cognitive_learning',
                    confidence: 0.95,
                    reason: 'educational_interest'
                },
                // Brain-healthy lifestyle habits
                {
                    pattern: /(?:explore\s+)?(?:brain\s+)?(?:healthy\s+)?(?:lifestyle|habits|practices|behaviors)/i,
                    topic: 'brain_lifestyle_habits',
                    confidence: 0.95,
                    reason: 'educational_interest'
                },
                // Specific brain health concerns
                {
                    pattern: /(?:discuss\s+)?(?:specific\s+)?(?:brain\s+)?(?:health\s+)?(?:concerns|worries|issues|problems)/i,
                    topic: 'brain_health_concerns',
                    confidence: 0.95,
                    reason: 'health_concern'
                },
                // Main menu option patterns (comprehensive coverage)
                {
                    pattern: /(?:continue\s+working\s+to\s+)?(?:define\s+)?(?:my\s+)?(?:goals?\s+or\s+)?(?:life\s+)?(?:chapters?)/i,
                    topic: 'continue_goals_chapters',
                    confidence: 0.95,
                    reason: 'user_wants_to_continue_goals'
                },
                {
                    pattern: /(?:begin\s+working\s+to\s+)?(?:define\s+)?(?:my\s+)?(?:goals?\s+or\s+)?(?:a\s+new\s+)?(?:chapter)/i,
                    topic: 'begin_new_goals_chapters',
                    confidence: 0.95,
                    reason: 'user_wants_to_begin_new'
                },
                {
                    pattern: /(?:reflect\s+on\s+my\s+journey|document\s+my\s+progress|update\s+my\s+health\s+numbers)/i,
                    topic: 'reflection_progress_health',
                    confidence: 0.95,
                    reason: 'user_wants_to_reflect'
                },
                {
                    pattern: /(?:prepare\s+for\s+a\s+visit\s+with\s+my\s+doctor|prepare\s+for\s+doctor\s+visit)/i,
                    topic: 'doctor_visit_preparation',
                    confidence: 0.95,
                    reason: 'user_wants_doctor_prep'
                },
                {
                    pattern: /(?:discuss\s+what\s+my\s+doctor\s+told\s+me|discuss\s+doctor\s+information|information\s+they\s+gave\s+me)/i,
                    topic: 'discuss_doctor_info',
                    confidence: 0.95,
                    reason: 'user_wants_to_discuss_doctor'
                },
                {
                    pattern: /(?:update\s+what\s+matters\s+to\s+me|update\s+my\s+priorities)/i,
                    topic: 'update_priorities',
                    confidence: 0.95,
                    reason: 'user_wants_to_update_priorities'
                },
                {
                    pattern: /(?:something\s+else|enter\s+what\s+you\s+would\s+like\s+to\s+do)/i,
                    topic: 'something_else',
                    confidence: 0.95,
                    reason: 'user_wants_something_else'
                },
                // Option selection patterns (when users click on provided options)
                {
                    pattern: /^‚Üí\s+(.+)$/i,
                    topic: 'option_selection',
                    confidence: 0.98,
                    reason: 'user_selected_option',
                    extractContent: true // Flag to extract the actual content
                },
                // General anxiety about health
                {
                    pattern: /(?:feeling|am|i'm)\s+(?:anxious|worried|concerned|stressed)\s+(?:about\s+)?(?:my\s+)?(?:health|medical|condition)/i,
                    topic: 'health_anxiety',
                    confidence: 0.9,
                    reason: 'health_concern'
                },
                // Family relationship challenges
                {
                    pattern: /(?:my\s+)?(?:relationship|connection)\s+(?:with\s+)?(?:my\s+)?(?:family|child|parent|spouse|partner)\s+(?:has\s+)?(?:been\s+)?(?:challenging|difficult|strained)/i,
                    topic: 'family_relationship_challenge',
                    confidence: 0.9,
                    reason: 'family_concern'
                },
                // Sleep problems
                {
                    pattern: /(?:having|experiencing|dealing\s+with)\s+(?:trouble|problems|difficulty)\s+(?:sleeping|resting|falling\s+asleep)/i,
                    topic: 'sleep_problems',
                    confidence: 0.9,
                    reason: 'sleep_concern'
                },
                // Work stress
                {
                    pattern: /(?:work|job)\s+(?:stress|pressure|anxiety|overwhelm)/i,
                    topic: 'work_stress',
                    confidence: 0.85,
                    reason: 'work_concern'
                },
                // Emotional challenges
                {
                    pattern: /(?:feeling|am|i'm)\s+(?:sad|depressed|lonely|overwhelmed|stressed|anxious)/i,
                    topic: 'emotional_challenge',
                    confidence: 0.85,
                    reason: 'emotional_concern'
                }
            ];
            
            // Check for specific situation patterns first
            console.log('üîç Checking specific situation patterns...');
            for (const situation of situationPatterns) {
                console.log('üîç Testing pattern:', situation.pattern, 'against input:', userInput);
                if (situation.pattern.test(userInput)) {
                    console.log('‚úÖ Pattern matched! Topic:', situation.topic, 'Confidence:', situation.confidence);
                    
                    // If this is an option selection, extract the actual content
                    let processedInput = userInput;
                    if (situation.extractContent && situation.pattern.test(userInput)) {
                        const match = userInput.match(situation.pattern);
                        if (match && match[1]) {
                            processedInput = match[1].trim();
                            console.log('üîç Extracted content from option:', processedInput);
                        }
                    }
                    
                    return {
                        shouldSwitch: true,
                        newTopic: situation.topic,
                        newPhase: `natural_${situation.topic}`,
                        confidence: situation.confidence,
                        reason: situation.reason,
                        userInput: processedInput // Pass the processed input for context
                    };
                }
            }
            console.log('‚ùå No specific situation patterns matched');
            
            // Fallback to general topic detection for less specific cases
            const generalTopicIndicators = {
                health: ['health', 'medical', 'doctor', 'appointment', 'symptoms', 'pain', 'medication', 'treatment'],
                documents: ['document', 'paper', 'report', 'results', 'lab', 'test', 'prescription', 'medical record'],
                family: ['family', 'child', 'parent', 'spouse', 'partner', 'relationship', 'marriage'],
                work: ['work', 'job', 'career', 'boss', 'colleague', 'meeting', 'project', 'stress'],
                emotions: ['emotion', 'sad', 'happy', 'angry', 'anxious', 'depressed', 'worried'],
                daily_life: ['daily', 'routine', 'schedule', 'time', 'busy', 'tired', 'energy', 'sleep'],
                goals: ['goal', 'plan', 'future', 'dream', 'aspiration', 'ambition', 'achievement'],
                challenges: ['problem', 'challenge', 'difficulty', 'struggle', 'obstacle', 'barrier', 'issue']
            };
            
            // Check if user input contains general topic indicators
            for (const [topic, keywords] of Object.entries(generalTopicIndicators)) {
                const hasTopicKeywords = keywords.some(keyword => lowerInput.includes(keyword));
                const isRelevantToCurrentPhase = isTopicRelevantToPhase(topic, currentPhase);
                
                if (hasTopicKeywords && !isRelevantToCurrentPhase) {
                    return {
                        shouldSwitch: true,
                        newTopic: topic,
                        newPhase: `natural_${topic}`,
                        confidence: 0.7,
                        reason: 'general_topic_indicator',
                        userInput: userInput
                    };
                }
            }
            
            return { shouldSwitch: false };
        }
        
        // Check if a topic is relevant to the current conversation phase
        function isTopicRelevantToPhase(topic, currentPhase) {
            const phaseTopicMapping = {
                'about_me_best_life': ['goals', 'daily_life', 'emotions'],
                'about_me_concerns': ['challenges', 'emotions', 'health'],
                'goal_definition': ['goals', 'work', 'daily_life'],
                'sleep_quest': ['health', 'daily_life', 'emotions'],
                'connection_quest': ['family', 'relationships', 'social'],
                'document_qa': ['documents', 'health', 'medical'],
                'natural_conversation': ['all'] // Allow any topic in natural conversation
            };
            
            const relevantTopics = phaseTopicMapping[currentPhase] || [];
            return relevantTopics.includes('all') || relevantTopics.includes(topic);
        }
        
        // Calculate confidence score for topic detection
        function calculateConfidence(userInput, keywords) {
            const matchedKeywords = keywords.filter(keyword => userInput.includes(keyword));
            const baseConfidence = matchedKeywords.length / keywords.length;
            
            // Boost confidence for longer, more specific inputs
            const lengthBonus = Math.min(userInput.length / 100, 0.3);
            
            return Math.min(baseConfidence + lengthBonus, 1.0);
        }
        
        // Extract topic from explicit change phrases
        function extractTopicFromPhrase(userInput, changePhrase) {
            const afterPhrase = userInput.substring(userInput.indexOf(changePhrase) + changePhrase.length);
            const words = afterPhrase.trim().split(/\s+/);
            
            // Look for topic keywords in the words after the change phrase
            const topicKeywords = [
                'health', 'family', 'work', 'emotions', 'goals', 'challenges',
                'documents', 'medical', 'relationships', 'daily', 'sleep', 'stress'
            ];
            
            for (const word of words) {
                if (topicKeywords.includes(word)) {
                    return word;
                }
            }
            
            // If no specific topic found, return the first few words as a general topic
            return words.slice(0, 3).join('_');
        }
        
        // Get current conversation options for context preservation
        function getCurrentOptions() {
            // This would need to be implemented based on how options are currently displayed
            // For now, return a placeholder
            return ['current_option_1', 'current_option_2'];
        }
        
        // Get user progress in current conversation
        function getUserProgress() {
            // This would capture the user's progress in the current conversation
            return {
                phase: currentPhase,
                timestamp: new Date().toISOString(),
                messageCount: (window.messageCount || 0)
            };
        }
        
        // Generate natural responses for topic switches
        function generateNaturalTopicSwitch(intentRecognition) {
            const { newTopic, confidence, reason, userInput } = intentRecognition;
            
            // High confidence topic switches get immediate engagement
            if (confidence > 0.7) {
                return generateHighConfidenceResponse(newTopic, userInput);
            }
            
            // Medium confidence gets gentle confirmation
            if (confidence > 0.4) {
                return generateMediumConfidenceResponse(newTopic);
            }
            
            // Low confidence gets clarification
            return generateLowConfidenceResponse(newTopic);
        }
        
        // Generate empathetic, specific responses based on actual user input
        function generateHighConfidenceResponse(topic, userInput) {
            // Specific situation-based responses that show Sofia actually listened
            const specificResponses = {
                doctor_appointment_anxiety: {
                    message: `Of course! Speaking with a doctor can be nerve-wracking, especially when you're feeling anxious about it. I'm here to help you feel more prepared and confident.`,
                    options: [
                        "‚Üí Practice answering questions your doctor might ask",
                        "‚Üí Discuss how to communicate your health concerns clearly",
                        "‚Üí Explore relaxation techniques for appointment day",
                        "‚Üí Talk about what's specifically making you anxious"
                    ]
                },
                work_stress_sleep: {
                    message: `I hear you - work stress can really take a toll on your sleep, and that creates a cycle that affects everything else. Let's work on breaking that pattern.`,
                    options: [
                        "‚Üí Learn stress management techniques for work",
                        "‚Üí Develop better sleep habits and routines",
                        "‚Üí Explore work-life balance strategies",
                        "‚Üí Talk about what's causing the work stress"
                    ]
                },
                health_anxiety: {
                    message: `Health anxiety can be really overwhelming, and it's completely normal to feel this way. You don't have to face these worries alone.`,
                    options: [
                        "‚Üí Talk about your specific health concerns",
                        "‚Üí Learn anxiety management techniques",
                        "‚Üí Discuss when to seek medical help",
                        "‚Üí Explore ways to feel more in control"
                    ]
                },
                family_relationship_challenge: {
                    message: `Family relationships can be so complex and challenging. It sounds like you're going through a difficult time, and I want to help you navigate this.`,
                    options: [
                        "‚Üí Talk about the specific challenges you're facing",
                        "‚Üí Explore communication strategies",
                        "‚Üí Discuss setting healthy boundaries",
                        "‚Üí Work on understanding different perspectives"
                    ]
                },
                sleep_problems: {
                    message: `Sleep problems can affect every aspect of your life, and they're often connected to stress or other concerns. Let's work on getting you the rest you need.`,
                    options: [
                        "‚Üí Create a better bedtime routine",
                        "‚Üí Learn relaxation techniques for sleep",
                        "‚Üí Discuss what might be keeping you awake",
                        "‚Üí Explore sleep hygiene improvements"
                    ]
                },
                work_stress: {
                    message: `Work stress is such a common challenge, and it can really impact your well-being. You deserve to feel supported in managing this.`,
                    options: [
                        "‚Üí Identify specific sources of work stress",
                        "‚Üí Learn stress management techniques",
                        "‚Üí Discuss work-life balance strategies",
                        "‚Üí Explore ways to feel more in control at work"
                    ]
                },
                emotional_challenge: {
                    message: `I hear that you're going through a difficult time emotionally. Your feelings are valid, and you don't have to navigate this alone.`,
                    options: [
                        "‚Üí Talk about what's causing these feelings",
                        "‚Üí Learn emotional regulation techniques",
                        "‚Üí Discuss when to seek professional help",
                        "‚Üí Explore self-care strategies"
                    ]
                },
                document_upload_request: {
                    message: `Let's do it! Feel free to upload a document using the button in the bottom right hand corner of the page. I'll study the document and let you know when I am ready for your questions.`,
                    options: [
                        "‚Üí I've uploaded the document",
                        "‚Üí I need help with the upload process",
                        "‚Üí Tell me more about how this works",
                        "‚Üí I changed my mind - let's discuss something else"
                    ]
                },
                discuss_provider_document: {
                    message: `I'd be happy to help you discuss that document from your provider! Sometimes medical information can be confusing, and it's completely normal to want to go over it together.`,
                    options: [
                        "‚Üí Upload the document so I can help explain it",
                        "‚Üí Tell me what the document said",
                        "‚Üí Ask specific questions about the content",
                        "‚Üí Discuss how you're feeling about the information"
                    ]
                },
                discuss_documents_general: {
                    message: `Absolutely! Documents and medical information can be overwhelming, and I'm here to help you understand them. What would be most helpful for you?`,
                    options: [
                        "‚Üí Upload a document for me to review",
                        "‚Üí Ask questions about medical terms",
                        "‚Üí Discuss what you learned from a document",
                        "‚Üí Get help organizing medical information"
                    ]
                },
                brain_health_learning: {
                    message: `Wonderful! Learning about brain health is such an important part of taking care of yourself. I'd love to share some insights and help you understand how your brain works.`,
                    options: [
                        "‚Üí Tell me about brain health basics",
                        "‚Üí Learn about memory and cognitive function",
                        "‚Üí Explore brain-healthy lifestyle habits",
                        "‚Üí Discuss specific brain health concerns"
                    ]
                },
                brain_health_basics: {
                    message: `Great choice! Let me share the fundamentals of brain health with you. Your brain is like a supercomputer that needs the right fuel, rest, and stimulation to work at its best.`,
                    options: [
                        "‚Üí Tell me about brain nutrition and fuel",
                        "‚Üí Learn about brain exercise and stimulation",
                        "‚Üí Explore how sleep affects brain function",
                        "‚Üí Understand brain aging and maintenance"
                    ]
                },
                memory_cognitive_learning: {
                    message: `Excellent! Memory and cognitive function are fascinating aspects of brain health. Your brain has incredible plasticity - meaning it can change and improve throughout your life.`,
                    options: [
                        "‚Üí Learn how memory works and changes",
                        "‚Üí Explore cognitive exercises and games",
                        "‚Üí Understand factors that affect thinking",
                        "‚Üí Discover ways to boost mental sharpness"
                    ]
                },
                brain_lifestyle_habits: {
                    message: `Perfect! Lifestyle habits have a huge impact on your brain health. Small daily choices can make a big difference in how your brain functions and how you feel.`,
                    options: [
                        "‚Üí Learn about brain-healthy nutrition",
                        "‚Üí Explore physical activity for brain health",
                        "‚Üí Understand stress management for cognition",
                        "‚Üí Discover social connection benefits"
                    ]
                },
                brain_health_concerns: {
                    message: `I'm here to help you with any specific brain health concerns you have. It's completely normal to have questions or worries, and talking about them can help.`,
                    options: [
                        "‚Üí Discuss memory changes you've noticed",
                        "‚Üí Talk about concentration or focus issues",
                        "‚Üí Explore mood or emotional changes",
                        "‚Üí Address other brain health worries"
                    ]
                },
                option_selection: {
                    message: `I see you've selected an option. Let me help you with that specific topic.`,
                    options: [
                        "‚Üí Continue with this topic",
                        "‚Üí Choose a different option",
                        "‚Üí Ask me something else"
                    ]
                },
                continue_goals_chapters: {
                    message: `Perfect! Let's continue working on your goals and life chapters. This is where your story really takes shape.`,
                    options: [
                        "‚Üí Review my current goals",
                        "‚Üí Work on a specific goal",
                        "‚Üí Create a new life chapter",
                        "‚Üí See my progress so far"
                    ]
                },
                begin_new_goals_chapters: {
                    message: `Excellent! Starting something new is always exciting. Let's create something meaningful that aligns with what matters most to you.`,
                    options: [
                        "‚Üí Set a new health goal",
                        "‚Üí Create a personal development goal",
                        "‚Üí Start a new life chapter",
                        "‚Üí Explore what kind of goal I need"
                    ]
                },
                reflection_progress_health: {
                    message: `Reflection is such a powerful tool for growth. Taking time to look back and document your journey helps you see how far you've come and what's working well.`,
                    options: [
                        "‚Üí Review my overall journey",
                        "‚Üí Document recent progress",
                        "‚Üí Update my health numbers",
                        "‚Üí See patterns in my story"
                    ]
                },
                doctor_visit_preparation: {
                    message: `I'd love to help you feel prepared and confident for your doctor's visit! Being prepared can make such a difference in how you feel and how well your doctor can help you.`,
                    options: [
                        "‚Üí Think through questions your doctor might ask",
                        "‚Üí Create a list of questions I want to ask",
                        "‚Üí Build an 'About Me Card' for my doctor",
                        "‚Üí Practice communicating my concerns"
                    ]
                },
                discuss_doctor_info: {
                    message: `Sometimes medical information can feel overwhelming, and it's perfectly normal to need time to process what you learned. I'm here to help you understand and work through it all.`,
                    options: [
                        "‚Üí Talk through what my doctor explained",
                        "‚Üí Upload medical documents for help",
                        "‚Üí Define medical terms I don't understand",
                        "‚Üí Process how I'm feeling about it"
                    ]
                },
                update_priorities: {
                    message: `Life changes, and so do our priorities. It's completely normal to want to update what matters most to you. This helps me provide support that's truly aligned with your current values and circumstances.`,
                    options: [
                        "‚Üí Add new things that bring me joy",
                        "‚Üí Remove something that no longer matters",
                        "‚Üí Update my concerns",
                        "‚Üí Change my confidence level"
                    ]
                },
                something_else: {
                    message: `Of course! I'm here to support whatever is on your mind today. Whether it's a specific concern, a question about brain health, or anything else that matters to you - I'm listening with full attention.`,
                    options: [
                        "‚Üí Share a specific concern",
                        "‚Üí Ask a brain health question",
                        "‚Üí Talk about something personal",
                        "‚Üí Just chat and connect"
                    ]
                },
                health_concerns_discussion: {
                    message: `I'm here to help you with your health concerns. Your health is so important, and it's completely normal to have questions or worries. What specific health topic would you like to discuss?`,
                    options: [
                        "‚Üí Talk about specific symptoms",
                        "‚Üí Discuss recent health changes",
                        "‚Üí Ask about medications or treatments",
                        "‚Üí Get help understanding medical information"
                    ]
                },
                sleep_rest_help: {
                    message: `Sleep and rest are fundamental to your brain health and overall well-being. I'd love to help you work on getting better sleep and feeling more rested. What aspect of sleep would you like to focus on?`,
                    options: [
                        "‚Üí Create a better bedtime routine",
                        "‚Üí Learn relaxation techniques",
                        "‚Üí Discuss what's keeping me awake",
                        "‚Üí Explore sleep hygiene improvements"
                    ]
                },
                stress_anxiety_help: {
                    message: `Stress and anxiety can really impact your quality of life, and you don't have to face them alone. I'm here to help you develop strategies to manage these challenges. What would be most helpful?`,
                    options: [
                        "‚Üí Learn stress management techniques",
                        "‚Üí Talk about what's causing my stress",
                        "‚Üí Practice anxiety reduction methods",
                        "‚Üí Develop coping strategies"
                    ]
                },
                memory_cognitive_help: {
                    message: `Memory and cognitive function are such important aspects of brain health. I'd love to help you understand what's happening and work on strategies to support your thinking and memory. What would you like to explore?`,
                    options: [
                        "‚Üí Learn about memory changes",
                        "‚Üí Practice cognitive exercises",
                        "‚Üí Discuss factors affecting my thinking",
                        "‚Üí Explore brain health strategies"
                    ]
                },
                relationship_social_help: {
                    message: `Relationships and social connections are vital for your brain health and emotional well-being. I'm here to help you navigate these important aspects of your life. What relationship topic would you like to discuss?`,
                    options: [
                        "‚Üí Work on communication skills",
                        "‚Üí Navigate family challenges",
                        "‚Üí Build new friendships",
                        "‚Üí Strengthen existing relationships"
                    ]
                }
            };
            
            // Check for specific situation responses first
            if (specificResponses[topic]) {
                return specificResponses[topic];
            }
            
            // Fallback to general topic responses with more empathy
            const generalResponses = {
                health: {
                    message: "Your health is so important, and I want to make sure you feel supported in taking care of yourself. What specific health concern would you like to discuss?",
                    options: [
                        "‚Üí Tell me about your symptoms or concerns",
                        "‚Üí Discuss your doctor's visit or appointment",
                        "‚Üí Talk about medications or treatments",
                        "‚Üí Explore general wellness strategies"
                    ]
                },
                documents: {
                    message: "Medical documents can be confusing and overwhelming. I'd be happy to help you understand what you're working with. What kind of document are you dealing with?",
                    options: [
                        "‚Üí Lab results or test reports",
                        "‚Üí Doctor's notes or prescriptions",
                        "‚Üí Medical bills or insurance documents",
                        "‚Üí Other medical paperwork"
                    ]
                },
                family: {
                    message: "Family relationships are so important and can be both rewarding and challenging. I'd love to help you work through whatever you're experiencing. What would you like to discuss?",
                    options: [
                        "‚Üí Relationship challenges or conflicts",
                        "‚Üí Family health concerns",
                        "‚Üí Communication or boundary issues",
                        "‚Üí Family celebrations or milestones"
                    ]
                },
                work: {
                    message: "Work can be such a big part of our lives, and when it's stressful, it affects everything else. Let's work on finding ways to make it more manageable. What work-related topic would you like to explore?",
                    options: [
                        "‚Üí Work stress or pressure management",
                        "‚Üí Career goals or changes",
                        "‚Üí Work-life balance strategies",
                        "‚Üí Colleague or workplace relationships"
                    ]
                },
                emotions: {
                    message: "Your emotional well-being matters so much, and I'm here to listen and support you through whatever you're feeling. What's on your mind?",
                    options: [
                        "‚Üí Recent emotional challenges or struggles",
                        "‚Üí Mood changes or patterns you've noticed",
                        "‚Üí Stress or anxiety you're experiencing",
                        "‚Üí Positive emotions you'd like to celebrate"
                    ]
                },
                daily_life: {
                    message: "Daily life has so many moving parts, and it's completely normal to feel overwhelmed sometimes. Let's work on making your routine work better for you. What aspect would you like to focus on?",
                    options: [
                        "‚Üí Time management challenges",
                        "‚Üí Daily stress or overwhelm",
                        "‚Üí Routine improvements or habits",
                        "‚Üí Daily achievements or wins to celebrate"
                    ]
                },
                goals: {
                    message: "Goals give us direction and purpose, and working toward them can be both exciting and challenging. I'd love to help you clarify and work on what matters most to you. What goal or aspiration would you like to explore?",
                    options: [
                        "‚Üí Health and wellness goals",
                        "‚Üí Personal development goals",
                        "‚Üí Relationship or connection goals",
                        "‚Üí Career or life goals"
                    ]
                },
                challenges: {
                    message: "Challenges are part of growth, and you don't have to face them alone. I'm here to help you work through whatever obstacles you're encountering. What challenge are you working through?",
                    options: [
                        "‚Üí Health-related challenges",
                        "‚Üí Relationship difficulties",
                        "‚Üí Work or career obstacles",
                        "‚Üí Personal development challenges"
                    ]
                }
            };
            
            return generalResponses[topic] || generateGenericResponse(topic);
        }
        
        // Generate medium confidence responses for potential topic switches
        function generateMediumConfidenceResponse(topic) {
            return {
                message: `I think you might want to discuss ${topic.replace('_', ' ')}. Is that right? I'd be happy to help with that topic.`,
                options: [
                    `‚Üí Yes, let's talk about ${topic.replace('_', ' ')}`,
                    "‚Üí Actually, I want to continue our current conversation",
                    "‚Üí I want to discuss something else entirely"
                ]
            };
        }
        
        // Generate low confidence responses for unclear topic switches
        function generateLowConfidenceResponse(topic) {
            return {
                message: "I want to make sure I understand what you'd like to discuss. Could you tell me a bit more about what's on your mind?",
                options: [
                    "‚Üí I want to discuss something specific",
                    "‚Üí I want to continue our current conversation",
                    "‚Üí I'm not sure what I want to discuss"
                ]
            };
        }
        
        // Generate generic response for unrecognized topics
        function generateGenericResponse(topic) {
            return {
                message: `I'd be happy to help you with ${topic.replace('_', ' ')}! What would you like to discuss about this topic?`,
                options: [
                    "‚Üí Tell me more about this",
                    "‚Üí I have specific questions",
                    "‚Üí Let's explore this together"
                ]
            };
        }

        async function processUserMessage(message) {
            const lowerMessage = message.toLowerCase();
            
            // SAFETY CHECK FIRST
            const safetyTriggers = analyzeSafetyTriggers(message);
            if (safetyTriggers.length > 0) {
                const safetyResponse = handleSafetyTrigger(safetyTriggers);
                if (safetyResponse) {
                    showBotMessage(safetyResponse);
                    updateSessionRiskAssessment();
                    return;
                }
            }

            // CORE INTENT RECOGNITION - Detect when users want to discuss new topics
            console.log('üîç Intent recognition check for message:', message);
            const intentRecognition = detectUserIntent(message, currentPhase);
            console.log('üéØ Intent recognition result:', intentRecognition);
            
            if (intentRecognition.shouldSwitch) {
                console.log('üéØ Intent recognition: User wants to discuss new topic:', intentRecognition.newTopic);
                console.log('üéØ Confidence level:', intentRecognition.confidence);
                console.log('üéØ Reason:', intentRecognition.reason);
                
                const naturalResponse = generateNaturalTopicSwitch(intentRecognition);
                console.log('üí¨ Generated response:', naturalResponse);
                
                if (naturalResponse) {
                    showBotMessage(naturalResponse.message, naturalResponse.options);
                    currentPhase = intentRecognition.newPhase || "natural_conversation";
                    return;
                }
            }

            // DOCUMENT HANDLING - Check for document-related phases first
            if (handleDocumentReviewResponses(message)) {
                return;
            }
            
            if (handleDocumentQA(message)) {
                return;
            }
            
            // STORY MOMENT DETECTION
            const storyMoment = detectStoryMoment(message);
            if (storyMoment) {
                logStoryMoment(storyMoment);
                
                // Connect story moment to About Me if profile is complete
                let aboutMeConnection = "";
                if (userHistory.aboutMe.bestLifeElements.length > 0) {
                    aboutMeConnection = `\n\nThis moment connects to what matters most to you - ${userHistory.aboutMe.bestLifeElements[0].element}.`;
                }
                
                showBotMessage(
                    `You've discovered something important about your journey - a moment worth capturing in your story.${aboutMeConnection}

This ${storyMoment.type === 'breakthroughs' ? 'breakthrough' : 
      storyMoment.type === 'victories' ? 'victory' : 
      storyMoment.type === 'emotionalTransitions' ? 'transformation' : 
      'decision'} could become a powerful chapter.

Would you like to:`,
                    [
                        "‚Üí Explore what made this moment possible",
                        "‚Üí Capture this as a new chapter",
                        "‚Üí Continue building on this momentum"
                    ],
                    true
                );
                
                if (message.includes('capture') || message.includes('chapter')) {
                    openChapterModal(storyMoment);
                }
                return;
            }
            
            // Always analyze message for logging
            analyzeMessageForLogging(message);
            
            // Update session risk assessment periodically
            updateSessionRiskAssessment();
            
            // Document upload follow-up handling
            if (currentPhase === "document_followup" || currentPhase === "health_followup") {
                handleDocumentFollowup(message);
                return;
            }
            
            // About Me prompt responses
            if (currentPhase === "about_me_prompt") {
                if (lowerMessage.includes('yes') || lowerMessage.includes('explore')) {
                    // Only show if we don't have data
                    if (!userHistory.aboutMe.bestLifeElements || userHistory.aboutMe.bestLifeElements.length === 0) {
                        currentPhase = "about_me_best_life";
                        showBotMessage(
                            `Wonderful! Let's explore what makes life meaningful for you.

When you think about living your best life, what brings you the most joy and fulfillment? I'll share some common themes, and you can select all that resonate with you.`,
                            [],
                            false,
                            true
                        );
                        
                        setTimeout(() => {
                            showAboutMeOptions(companionConfig.aboutMeFramework.bestLifeElements, 'best-life');
                        }, 2000);
                    } else {
                        // We already have this data, skip to concerns or next step
                        if (!userHistory.aboutMe.concerns || userHistory.aboutMe.concerns.length === 0) {
                            currentPhase = "about_me_concerns";
                            showBotMessage(
                                `I already know what brings meaning to your life. Now let's talk about what might get in the way.

What concerns you most when you think about living your best life?`,
                                [],
                                false,
                                true
                            );
                            
                            setTimeout(() => {
                                showAboutMeOptions(companionConfig.aboutMeFramework.concernCategories, 'concerns');
                            }, 2000);
                        } else {
                            // We have all data, go to main conversation
                            currentPhase = "main_conversation";
                            showBotMessage(
                                `I already have a complete understanding of what matters to you. Let's continue your brain health journey!

What would you like to explore today?`,
                                [
                                    "‚Üí The Path of Movement (Physical activity)",
                                    "‚Üí The Garden of Rest (Sleep improvement)",
                                    "‚Üí The Circle of Connection (Social engagement)",
                                    "‚Üí The Temple of Learning (Mental stimulation)"
                                ]
                            );
                        }
                    }
                    return;
                } else if (lowerMessage.includes('skip')) {
                    currentPhase = "main_conversation";
                    showBotMessage(
                        `That's fine, we can explore this another time. Let's continue with your brain health journey.

What would you like to focus on today?`,
                        [
                            "‚Üí Begin a new chapter",
                            "‚Üí Set a health goal",
                            "‚Üí Learn about brain health"
                        ]
                    );
                    return;
                }
            }
            
            // About Me confidence response
            if (currentPhase === "about_me_confidence") {
                userHistory.aboutMe.confidenceLevel = message;
                userHistory.aboutMe.confidenceTimestamp = new Date().toISOString();
                updateAboutMeCompleteness();
                saveUserHistory();
                
                isAboutMeComplete = true;
                currentPhase = "about_me_next_steps";
                
                let confidenceResponse = "";
                if (message.includes("Very confident")) {
                    confidenceResponse = "Your confidence is inspiring! With that strength, you're ready to tackle these challenges.";
                } else if (message.includes("Somewhat confident")) {
                    confidenceResponse = "That's a good starting point. We'll work together to build your confidence as we go.";
                } else {
                    confidenceResponse = "I understand. It's okay to feel uncertain. We'll take small steps together to build your confidence.";
                }
                
                showBotMessage(
                    `${confidenceResponse}

Now, thinking about everything we've discussed - what you value most and the concerns you face - what do you think would be a good first step toward living your best life?

This could be something small and manageable, or a bigger goal you're ready to pursue.`,
                    [],
                    false,
                    true
                );
                return;
            }
            
            // About Me next steps
            if (currentPhase === "about_me_next_steps") {
                userHistory.aboutMe.userDefinedNextSteps.push({
                    step: message,
                    timestamp: new Date().toISOString(),
                    status: "planned",
                    linkedConcerns: selectedConcerns
                });
                saveUserHistory();
                updateMemoryDisplay(true);
                
                currentPhase = "story_beginning";
                
                // Create first goal linked to About Me
                const linkedElements = userHistory.aboutMe.bestLifeElements.map(e => e.element);
                logGoal(message, 7, linkedElements);
                
                showBotMessage(
                    `Perfect! "${message}" is a wonderful first step that directly supports what matters most to you.

This goal connects to your desire to ${linkedElements[0].toLowerCase()}, which makes it even more meaningful.

Now that I understand what's important to you, let's begin crafting your brain health story. Every journey needs its first chapter.

What would you like to explore first?`,
                    [
                        "‚Üí The Path of Movement (Physical activity)",
                        "‚Üí The Garden of Rest (Sleep improvement)",
                        "‚Üí The Circle of Connection (Social engagement)",
                        "‚Üí The Temple of Learning (Mental stimulation)",
                        "‚Üí The Valley of Calm (Stress management)"
                    ]
                );
                return;
            }
            
            // Update what matters to me
            if (lowerMessage.includes('update what matters')) {
                currentPhase = "about_me_update";
                
                // Show current values
                let currentStatus = `Here's what I currently know about what matters to you:\n\n`;
                
                if (userHistory.aboutMe.bestLifeElements.length > 0) {
                    currentStatus += `**What brings you joy:**\n`;
                    userHistory.aboutMe.bestLifeElements.forEach(element => {
                        currentStatus += `‚Ä¢ ${element.element}\n`;
                    });
                }
                
                if (userHistory.aboutMe.concerns.length > 0) {
                    currentStatus += `\n**Your concerns:**\n`;
                    userHistory.aboutMe.concerns.forEach(concern => {
                        currentStatus += `‚Ä¢ ${concern.concern}\n`;
                    });
                }
                
                currentStatus += `\n**Confidence level:** ${userHistory.aboutMe.confidenceLevel || 'Not set'}`;
                
                showBotMessage(
                    currentStatus + `\n\nWhat would you like to update?`,
                    [
                        "‚Üí Add new things that bring me joy",
                        "‚Üí Remove something that no longer matters",
                        "‚Üí Update my concerns",
                        "‚Üí Change my confidence level",
                        "‚Üí Keep everything as is"
                    ]
                );
                return;
            }
            
            // Continue my current quest / Continue working to define my goals or life chapters
            if (lowerMessage.includes('continue my current quest') || 
                lowerMessage.includes('current quest') ||
                lowerMessage.includes('continue working to define my goals') || 
                lowerMessage.includes('goals or life chapters')) {
                
                // FIRST: Acknowledge what they selected
                let response = conversationPrinciples.respondFirst('continue working on defining your goals or life chapters');
                
                // SECOND: Check their current context
                const activeGoals = userHistory.goals.filter(g => g.status === 'active');
                const hasChapters = userHistory.storyChapters.length > 0;
                
                // THIRD: Ask what they want to do
                if (activeGoals.length > 0) {
                    response += `I see you're currently working on: "${activeGoals[0].goal}"\n\n`;
                    response += `Would you like to:\n`;
                    response += `‚Ä¢ Continue developing this goal\n`;
                    response += `‚Ä¢ Set a new goal alongside this one\n`;
                    response += `‚Ä¢ Transform this learning journey into a life chapter\n`;
                    response += `‚Ä¢ Or something else?\n\n`;
                    response += `Tell me what feels right for you today.`;
                } else {
                    response += `This is a perfect time to define what matters to you.\n\n`;
                    response += `Are you thinking about:\n`;
                    response += `‚Ä¢ Setting a new goal for your journey\n`;
                    response += `‚Ä¢ Creating a chapter about a meaningful experience\n`;
                    response += `‚Ä¢ Both - capturing where you've been and where you're going\n\n`;
                    response += `What's calling to you?`;
                }
                
                showBotMessage(response);
                currentPhase = "goal_chapter_clarification";
                return;
            }
            
            // Begin working to define my goals or a new chapter (was "Begin a new chapter")
            if (lowerMessage.includes('begin working to define my goals') || 
                lowerMessage.includes('goals or a new chapter')) {
                
                // FIRST: Acknowledge what they selected
                let response = conversationPrinciples.respondFirst('begin working on defining new goals or life chapters');
                
                // SECOND: Ask what they want to focus on
                response += `Every journey needs both direction and story. I'd love to understand what's calling to you right now.\n\n`;
                
                response += `Are you thinking about:\n`;
                response += `‚Ä¢ Setting a new goal to guide your path forward\n`;
                response += `‚Ä¢ Creating a story chapter to capture a meaningful moment\n`;
                response += `‚Ä¢ Both - setting a goal and telling its story\n`;
                response += `‚Ä¢ Or something else entirely?\n\n`;
                
                response += conversationPrinciples.inviteResponse();
                
                showBotMessage(response);
                currentPhase = "chapter_or_goal_choice";
                return;
            }
            
            // Reflect on my journey, document my progress, or update my health numbers
            if (lowerMessage.includes('reflect on my journey') || 
                lowerMessage.includes('document my progress') ||
                lowerMessage.includes('update my health numbers')) {
                
                // FIRST: Acknowledge what they selected
                let response = conversationPrinciples.respondFirst('reflect on your journey and document your progress');
                
                // SECOND: Ask what aspect of reflection interests them
                response += `Reflection is a powerful tool for growth. I'd love to understand what aspect of your journey you'd like to explore.\n\n`;
                
                response += `Are you thinking about:\n`;
                response += `‚Ä¢ Reviewing your overall journey and progress\n`;
                response += `‚Ä¢ Documenting recent experiences or breakthroughs\n`;
                response += `‚Ä¢ Updating your health numbers or measurements\n`;
                response += `‚Ä¢ Seeing patterns in your story over time\n`;
                response += `‚Ä¢ Celebrating specific achievements\n`;
                response += `‚Ä¢ Or something else that feels important?\n\n`;
                
                response += conversationPrinciples.inviteResponse();
                
                showBotMessage(response);
                currentPhase = "reflection_choice";
                return;
            }
            
            // Handle their clarification about goals/chapters
            if (currentPhase === "goal_chapter_clarification") {
                // Listen to what they actually said
                if (lowerMessage.includes('continue developing') || lowerMessage.includes('this goal')) {
                    // They want to work on existing goal
                    const activeGoal = userHistory.goals.find(g => g.status === 'active');
                    
                    showBotMessage(
                        `Let's explore your goal: "${activeGoal.goal}"\n\n` +
                        `Tell me - what's been happening with this? Have you:\n` +
                        `‚Ä¢ Made some progress you'd like to share?\n` +
                        `‚Ä¢ Encountered challenges?\n` +
                        `‚Ä¢ Discovered something new about what you want?\n` +
                        `‚Ä¢ Or is there another aspect you'd like to discuss?\n\n` +
                        `I'm here to listen and help however you need.`
                    );
                    currentPhase = "goal_exploration_open";
                    
                } else if (lowerMessage.includes('new goal')) {
                    showBotMessage(
                        `Setting a new goal - wonderful! Goals give our journey direction and meaning.\n\n` +
                        `What area of your life is calling for attention right now? It could be:\n` +
                        `‚Ä¢ Something specific you want to achieve\n` +
                        `‚Ä¢ A habit you want to build\n` +
                        `‚Ä¢ A fear you want to address\n` +
                        `‚Ä¢ Or any change you want to make\n\n` +
                        `Share what's on your mind, and we'll shape it together.`
                    );
                    currentPhase = "new_goal_exploration";
                    
                } else if (lowerMessage.includes('chapter') || lowerMessage.includes('meaningful experience')) {
                    showBotMessage(
                        `Creating a life chapter - what a beautiful way to honor your experiences.\n\n` +
                        `Chapters can capture:\n` +
                        `‚Ä¢ A recent breakthrough or realization\n` +
                        `‚Ä¢ A challenge you've overcome\n` +
                        `‚Ä¢ A moment that changed your perspective\n` +
                        `‚Ä¢ Or any experience that feels significant\n\n` +
                        `What story is asking to be told?`
                    );
                    currentPhase = "chapter_exploration_open";
                    
                } else {
                    // They said something unexpected - RESPOND TO IT
                    showBotMessage(
                        `I want to make sure I understand what you'd like to focus on. You mentioned: "${message}"\n\n` +
                        `Tell me more about what this means to you. I'm here to support whatever direction feels right for your journey.`
                    );
                    currentPhase = "open_exploration";
                }
                return;
            }

            // Name collection phase
            if (!userHistory.profile.name && currentPhase === "introduction") {
                userHistory.profile.name = message;
                
                // Don't save yet - wait for age
                currentPhase = "age_inquiry";
                showBotMessage(
                    `${message} - a name that will echo through the chapters of your brain health saga.

Every hero's journey begins with understanding where they stand. To craft your personalized adventure, may I know your age? This helps me tailor your story's challenges and triumphs.`
                );
                return;
            }
            
            // Age collection phase
            if (!userHistory.profile.age && currentPhase === "age_inquiry") {
                userHistory.profile.age = message;
                
                // Authenticate with API if available
                if (typeof SofiaAPI !== 'undefined') {
                    try {
                        const authResult = await SofiaAPI.authenticate(userHistory.profile.name, userHistory.profile.age);
                        // API will return existing user data if returning user
                        if (authResult.user.total_sessions > 0) {
                            // Load full profile from API
                            const apiData = await loadUserHistoryFromAPI();
                            if (apiData) {
                                userHistory = apiData;
                                isReturningUser = true;
                                isAboutMeComplete = userHistory.aboutMe.profileCompleteness > 0;
                            }
                        }
                        // Create new session
                        const session = await SofiaAPI.createSession();
                        currentSessionId = session.id;
                    } catch (error) {
                        console.error('API authentication failed:', error);
                        // Continue with localStorage fallback
                    }
                }
                
                saveUserHistory();
                currentPhase = "about_me_prompt";
                updateCurrentSession({ mainTopics: ['introduction', 'about_me_setup'] });
                
                showBotMessage(
                    `At ${userHistory.profile.age}, you stand at a powerful point in your story - where wisdom meets opportunity, where experience guides new adventures.

Before we begin your brain health journey, I'd love to understand what makes life meaningful for you. This helps me provide support that's truly aligned with your values.

Shall we explore what matters most to you?`,
                    [
                        "‚Üí Yes, let's explore what matters to me",
                        "‚Üí Skip for now and start my journey"
                    ]
                );
                return;
            }
            
            // Prepare for a visit with my doctor
            if (lowerMessage.includes('prepare for a visit') || 
                lowerMessage.includes('visit with my doctor')) {
                currentPhase = "doctor_visit_type";
                
                showBotMessage(
                    `I'd be happy to help you prepare for your doctor's visit, ${userHistory.profile.name}. 

First, so I can provide the most helpful guidance, could you tell me:

What type of doctor are you seeing?`,
                    [
                        "‚Üí Primary care doctor",
                        "‚Üí Neurologist",
                        "‚Üí Cardiologist", 
                        "‚Üí Mental health provider",
                        "‚Üí Specialist (other)",
                        "‚Üí Not sure of the type"
                    ]
                );
                return;
            }

            // Discuss what my doctor told me
            if (lowerMessage.includes('discuss what my doctor told me') || 
                lowerMessage.includes('information they gave me')) {
                currentPhase = "doctor_info_discussion";
                
                showBotMessage(
                    `I'm here to help you understand and process what you learned from your doctor, ${userHistory.profile.name}.

Sometimes medical information can feel overwhelming, and it's perfectly normal to need time to digest it all.

Would you like to:
- Talk through what your doctor explained
- Upload a document or notes for me to help explain
- Discuss specific medical terms or concepts
- Process how you're feeling about what you learned

What would be most helpful for you right now?`,
                    [
                        "‚Üí Explain what they told me",
                        "‚Üí Upload medical documents",
                        "‚Üí Define medical terms",
                        "‚Üí Process my feelings about it"
                    ]
                );
                return;
            }

            // Something else
            if (lowerMessage.includes('something else')) {
                currentPhase = "open_ended";
                
                showBotMessage(
                    `Of course! I'm here to support whatever is on your mind today.

Please share what you'd like to explore or discuss. Whether it's a specific concern, a question about brain health, or anything else that matters to you - I'm listening with full attention.

What would you like to focus on?`
                );
                return;
            }

            // Learn about brain health
            if (lowerMessage.includes('learn about brain health') || 
                lowerMessage.includes('brain health education')) {
                currentPhase = "brain_health_learning";
                
                showBotMessage(
                    `I'm so glad you want to learn more about brain health, ${userHistory.profile.name}! Knowledge truly is power when it comes to taking care of our amazing brains.

Everyone's learning journey is unique, and I want to make sure we explore what's most meaningful for you.

Help me understand - what brings you to want to learn about brain health today?`,
                    [
                        "‚Üí I have specific questions or concerns",
                        "‚Üí I want to create a personalized learning plan",
                        "‚Üí Someone suggested I learn more about it",
                        "‚Üí I have documents or information to understand",
                        "‚Üí I'm curious about keeping my brain healthy as I age"
                    ]
                );
                return;
            }

            // Handle brain health learning choices
            if (currentPhase === "brain_health_learning") {
                if (lowerMessage.includes('specific questions') || lowerMessage.includes('concerns')) {
                    showBotMessage(
                        `I'm here to help answer your questions! No question is too small or too big.

What would you like to know about? You can ask me anything - from how the brain works, to practical tips for daily life, to understanding changes you might be experiencing.

What's on your mind?`
                    );
                    currentPhase = "brain_health_q_and_a";
                    return;
                }
                
                if (lowerMessage.includes('learning plan') || lowerMessage.includes('personalized learning')) {
                    let learningMessage = `Let's create a learning plan that fits your life and interests! `;
                    
                    // Personalize based on About Me data
                    if (userHistory.aboutMe.bestLifeElements.length > 0) {
                        learningMessage += `Since ${userHistory.aboutMe.bestLifeElements[0].element.toLowerCase()} is important to you, we can focus on brain health topics that support this.\n\n`;
                    }
                    
                    learningMessage += `A good learning plan covers different areas. Which of these interest you most? (We'll explore them one at a time):`;
                    
                    showBotMessage(learningMessage, [
                        "‚Üí Memory and thinking skills",
                        "‚Üí Physical health and the brain",
                        "‚Üí Emotional wellbeing",
                        "‚Üí Social connections and brain health",
                        "‚Üí Nutrition for the brain",
                        "‚Üí Sleep and brain recovery"
                    ]);
                    currentPhase = "learning_plan_topics";
                    return;
                }
                
                if (lowerMessage.includes('someone suggested') || lowerMessage.includes('suggested i learn')) {
                    let supportiveResponse = `It's wonderful that someone cares about your brain health! Sometimes others notice things we might miss, or they might have learned something they want to share with you.\n\n`;
                    
                    if (userHistory.aboutMe.concerns.length > 0) {
                        supportiveResponse += `I see that you've mentioned concerns about ${userHistory.aboutMe.concerns[0].concern.toLowerCase()}. Could this be related to why they suggested learning more?\n\n`;
                    }
                    
                    supportiveResponse += `Would you like to share what prompted their suggestion? This can help me tailor our learning to what matters most to you.`;
                    
                    showBotMessage(supportiveResponse);
                    currentPhase = "brain_health_prompted_learning";
                    return;
                }
                
                if (lowerMessage.includes('documents') || lowerMessage.includes('information to understand')) {
                    showBotMessage(
                        `I'd be happy to help you understand any brain health information you have!

You can upload documents using the üìÑ button at the bottom right of your screen. I can help explain:

- Medical reports or test results
- Articles about brain health
- Information from your doctor
- Research or news you've found
- Educational materials

Once you upload something, I'll break it down into clear, understandable pieces and answer any questions you have about it.

What kind of information would you like help understanding?`
                    );
                    currentPhase = "brain_health_document_review";
                    return;
                }
                
                if (lowerMessage.includes('curious') || lowerMessage.includes('keeping my brain healthy')) {
                    showBotMessage(
                        `Your curiosity is one of the best things for your brain! Being proactive about brain health is like tending a garden - the care you give it today helps it flourish tomorrow.

Let's start with what interests you most about brain health:

- How your daily habits affect your brain
- Simple changes that make a big difference  
- Understanding how the brain ages
- Fun facts about your amazing brain
- Practical tips you can use right away

What sounds most interesting to you?`,
                        [
                            "‚Üí Daily habits that help my brain",
                            "‚Üí Simple changes I can make",
                            "‚Üí How aging affects the brain",
                            "‚Üí Amazing brain facts",
                            "‚Üí Practical tips for today"
                        ]
                    );
                    currentPhase = "brain_health_exploration";
                    return;
                }
            }

            // Handle open-ended brain health questions
            if (currentPhase === "brain_health_q_and_a") {
                // Store the question for context
                logEducationTopic(`brain_health_question: ${message}`);
                
                // Provide personalized response based on question type
                let response = `That's a great question about ${detectBrainHealthTopic(message)}!\n\n`;
                
                // Add personalized context if available
                if (userHistory.aboutMe.bestLifeElements.length > 0) {
                    response += `Let me explain this in a way that connects to what matters to you...\n\n`;
                }
                
                // For now, acknowledge and offer to explore
                response += `This is an important topic. Would you like me to:`;
                
                showBotMessage(response, [
                    "‚Üí Give you a simple explanation",
                    "‚Üí Share practical tips you can use",
                    "‚Üí Explain the science behind it",
                    "‚Üí Connect it to your daily life"
                ]);
                
                currentPhase = "brain_health_answer_type";
                return;
            }

            // Path selections (narrative branches)
            if (currentPhase === "story_beginning" || currentPhase === "chapter_creation") {
                if (lowerMessage.includes('movement') || lowerMessage.includes('path of movement')) {
                    // Link to About Me
                    let connectionMessage = "";
                    if (userHistory.aboutMe.bestLifeElements.some(e => e.element.includes('Exercise'))) {
                        connectionMessage = "Perfect! This directly supports your goal of exercising regularly. ";
                    }
                    
                    currentPhase = "movement_quest";
                    showBotMessage(
                        `${connectionMessage}You choose the Path of Movement, where every step strengthens both body and mind.

Movement is medicine, ${userHistory.profile.name}. Each activity you do sends healing signals throughout your brain.

What aspect of movement speaks to you right now?`,
                        [
                            "‚Üí Daily Walking Adventures",
                            "‚Üí Gentle Strength Building",
                            "‚Üí Balance and Flexibility",
                            "‚Üí Joyful Movement (Dancing, Playing)"
                        ]
                    );
                    return;
                }
                
                if (lowerMessage.includes('rest') || lowerMessage.includes('garden of rest') || lowerMessage.includes('sleep improvement')) {
                    // Link to About Me
                    let connectionMessage = "";
                    if (userHistory.aboutMe.concerns.some(c => c.concern.includes('sleep'))) {
                        connectionMessage = "Wise choice! This addresses your concern about sleep. ";
                    }
                    
                    currentPhase = "sleep_quest";
                    logEducationTopic("sleep_improvement");
                    
                    // Use pattern system for sleep exploration
                    const sleepResponse = generateExplorationResponse('sleep', 'The Garden of Rest');
                    const fullResponse = connectionMessage + sleepResponse;
                    
                    showBotMessage(fullResponse, [
                        "‚Üí Creating a bedtime ritual",
                        "‚Üí Dealing with sleep disruptions",
                        "‚Üí Making my bedroom a sanctuary",
                        "‚Üí Managing worries at night"
                    ]);
                    return;
                }
                
                if (lowerMessage.includes('connection') || lowerMessage.includes('circle of connection')) {
                    // Link to About Me
                    let connectionMessage = "";
                    if (userHistory.aboutMe.bestLifeElements.some(e => e.element.includes('people I care about'))) {
                        connectionMessage = "Wonderful choice! This aligns perfectly with your value of spending time with people you care about. ";
                    }
                    
                    currentPhase = "connection_quest";
                    
                    // Use pattern system for social connection exploration
                    const socialResponse = generateExplorationResponse('socialConnection', 'The Circle of Connection');
                    const fullResponse = connectionMessage + socialResponse;
                    
                    showBotMessage(fullResponse, [
                        "‚Üí Reconnect with old friends",
                        "‚Üí Deepen family bonds",
                        "‚Üí Join a community group",
                        "‚Üí Share your wisdom with others"
                    ]);
                    return;
                }
            }

            // Movement Path Handlers using the pattern system
            if (currentPhase === "movement_quest") {
                if (lowerMessage.includes('daily walking') || lowerMessage.includes('walking adventures')) {
                    currentPhase = "walking_exploration";
                    
                    const response = generateExplorationResponse('walking', 'Daily walking adventures');
                    showBotMessage(response);
                    return;
                }
                
                if (lowerMessage.includes('gentle strength') || lowerMessage.includes('strength building')) {
                    currentPhase = "strength_exploration";
                    
                    showBotMessage(
                        `Gentle strength building - wise choice! Building strength isn't about lifting heavy weights; it's about maintaining the power to do what you love.

What interests you about strength building? Maybe you want to:

- Feel more confident carrying groceries
- Get up from chairs more easily  
- Feel stronger in your daily activities
- Prevent falls and stay steady
- Or perhaps you have a specific goal in mind?

Tell me what strength means to you, and we'll create a plan that feels right.`
                    );
                    return;
                }
                
                if (lowerMessage.includes('balance') || lowerMessage.includes('flexibility')) {
                    currentPhase = "balance_exploration";
                    
                    showBotMessage(
                        `Balance and flexibility - the foundation of confident movement! These skills help us navigate life with grace and security.

I'm curious - what brought you to choose this? Are you:

- Wanting to feel more steady on your feet?
- Hoping to maintain your independence?
- Interested in activities like yoga or tai chi?
- Looking to prevent falls?
- Or is there another reason?

Share what balance means in your life, and we'll explore ways to strengthen it.`
                    );
                    return;
                }
                
                if (lowerMessage.includes('joyful movement') || lowerMessage.includes('dancing')) {
                    currentPhase = "joyful_movement_exploration";
                    
                    showBotMessage(
                        `Joyful movement and dancing - how wonderful! When movement brings joy, it doesn't feel like exercise - it feels like celebration.

What kind of joyful movement calls to you?

- Dancing to your favorite music at home
- Playing with grandchildren or pets
- Gardening or outdoor activities
- Swimming or water activities
- Something else that makes you smile?

Tell me what brings you joy when you move, and let's turn that into your brain health adventure!`
                    );
                    return;
                }
            }

            // Additional Path Handlers using the pattern system
            if (currentPhase === "learning_quest") {
                if (lowerMessage.includes('memory') || lowerMessage.includes('thinking skills')) {
                    currentPhase = "memory_exploration";
                    
                    const response = generateExplorationResponse('memory', 'Memory and thinking skills');
                    showBotMessage(response);
                    return;
                }
                
                if (lowerMessage.includes('hobbies') || lowerMessage.includes('new skills')) {
                    currentPhase = "skill_learning_exploration";
                    
                    showBotMessage(
                        `Learning new skills and hobbies - what an exciting choice! Every new thing you learn creates new neural pathways in your brain.

What kind of learning interests you? Maybe you want to:

- Pick up a musical instrument
- Learn a new language
- Master a craft or art form
- Explore technology or digital skills
- Or something else that calls to you?

Tell me what you'd like to learn, and we'll create a plan that fits your interests and lifestyle.`
                    );
                    return;
                }
                
                if (lowerMessage.includes('brain training') || lowerMessage.includes('exercises')) {
                    currentPhase = "brain_training_exploration";
                    
                    showBotMessage(
                        `Brain training exercises - excellent choice! These are like workouts for your mind, designed to strengthen specific cognitive skills.

What aspects of brain training appeal to you? We could explore:

- Memory games and puzzles
- Attention and focus exercises
- Problem-solving challenges
- Speed and processing activities
- Or a combination that feels right for you?

Share what interests you about brain training, and we'll find activities that are both fun and beneficial.`
                    );
                    return;
                }
                
                if (lowerMessage.includes('reading') || lowerMessage.includes('knowledge building')) {
                    currentPhase = "reading_exploration";
                    
                    showBotMessage(
                        `Reading and knowledge building - what a wonderful way to feed your mind! Reading is one of the most powerful brain exercises.

What kind of reading interests you? Maybe you want to:

- Explore new genres or authors
- Read about topics that fascinate you
- Join a book club or reading group
- Listen to audiobooks while doing other activities
- Or discover new ways to enjoy stories and information?

Tell me about your reading interests, and we'll create a plan that makes learning enjoyable and meaningful.`
                    );
                    return;
                }
            }

            if (currentPhase === "calm_quest") {
                if (lowerMessage.includes('breathing') || lowerMessage.includes('relaxation techniques')) {
                    currentPhase = "breathing_exploration";
                    
                    showBotMessage(
                        `Breathing and relaxation techniques - wise choice! These are some of the most powerful tools for finding calm in any moment.

What draws you to breathing and relaxation? Maybe you want to:

- Learn simple breathing exercises you can do anywhere
- Find techniques for managing daily stress
- Create peaceful moments throughout your day
- Develop a relaxation practice that fits your life
- Or discover what works best for you?

Share what you're looking for, and we'll explore techniques that bring you the calm you deserve.`
                    );
                    return;
                }
                
                if (lowerMessage.includes('daily stressors') || lowerMessage.includes('managing stress')) {
                    currentPhase = "stress_management_exploration";
                    
                    showBotMessage(
                        `Managing daily stressors - this is so important for brain health! When we manage stress well, our brain can function at its best.

What aspects of stress management interest you? We could explore:

- Identifying your stress triggers
- Creating stress-free zones in your day
- Learning to say no to overwhelming commitments
- Finding activities that naturally reduce stress
- Or developing your own stress management toolkit?

Tell me about your stress patterns, and we'll work together to create strategies that fit your life.`
                    );
                    return;
                }
                
                if (lowerMessage.includes('peaceful moments') || lowerMessage.includes('creating calm')) {
                    currentPhase = "peaceful_moments_exploration";
                    
                    showBotMessage(
                        `Creating peaceful moments - what a beautiful intention! These moments are like mini-vacations for your brain.

What kind of peaceful moments would you like to create? Maybe you want to:

- Start your day with a calm morning routine
- Find quiet time during busy days
- Create a peaceful evening ritual
- Designate special places for calm in your home
- Or discover what brings you peace naturally?

Share what peace means to you, and we'll explore ways to weave more calm into your daily life.`
                    );
                    return;
                }
                
                if (lowerMessage.includes('balance') || lowerMessage.includes('busy times')) {
                    currentPhase = "balance_exploration";
                    
                    showBotMessage(
                        `Finding balance in busy times - this is such an important skill! Life can be hectic, but we can learn to navigate it with more calm.

What aspects of finding balance interest you? We could explore:

- Setting healthy boundaries with your time
- Learning to prioritize what truly matters
- Creating buffer time between activities
- Finding ways to recharge during busy periods
- Or developing your own balance strategies?

Tell me about your busy times and what balance would look like for you, and we'll create approaches that help you stay centered.`
                    );
                    return;
                }
            }

            // Handle walking exploration responses
            if (currentPhase === "walking_exploration") {
                // Store their motivation
                logValue(`Walking motivation: ${message}`, 'high');
                
                let response = `I hear you - ${message.toLowerCase()}. That's a beautiful reason to walk.\n\n`;
                
                // Guide toward goal setting naturally
                response += `Let's think about this together. If you could imagine your ideal walking routine, what would it look like?\n\n`;
                
                response += `For example:\n`;
                response += `‚Ä¢ A morning stroll to start your day with energy\n`;
                response += `‚Ä¢ An evening walk to unwind and reflect\n`;
                response += `‚Ä¢ Weekend adventures exploring new places\n`;
                response += `‚Ä¢ Short walks throughout the day to stay active\n\n`;
                
                response += `There's no right or wrong answer - just what feels good to you. What appeals to you most?`;
                
                showBotMessage(response);
                currentPhase = "walking_routine_visioning";
                return;
            }

            // Handle walking routine visioning
            if (currentPhase === "walking_routine_visioning") {
                // Natural progression to goal setting
                let goalGuidance = `That sounds lovely! `;
                
                // Parse their response for specifics
                const morningMention = lowerMessage.includes('morning');
                const eveningMention = lowerMessage.includes('evening');
                const dailyMention = lowerMessage.includes('daily') || lowerMessage.includes('every day');
                
                if (morningMention) {
                    goalGuidance += `A morning walk can set such a positive tone for the whole day. `;
                } else if (eveningMention) {
                    goalGuidance += `Evening walks are perfect for processing the day and finding peace. `;
                }
                
                goalGuidance += `\n\nNow, here's a thought - what if we turned this vision into something you could actually start this week? Nothing overwhelming, just a small, enjoyable step.\n\n`;
                
                goalGuidance += `What feels doable for you?\n`;
                goalGuidance += `‚Ä¢ A 5-minute walk around your home or yard\n`;
                goalGuidance += `‚Ä¢ A 10-minute stroll to the corner and back\n`;
                goalGuidance += `‚Ä¢ A 15-minute adventure in your neighborhood\n`;
                goalGuidance += `‚Ä¢ Or your own idea - any movement counts!\n\n`;
                
                goalGuidance += `Remember, the best walking plan is one you'll actually enjoy doing.`;
                
                showBotMessage(goalGuidance);
                currentPhase = "walking_goal_formation";
                return;
            }

            // Handle natural goal formation
            if (currentPhase === "walking_goal_formation") {
                // They've described what they want to do - help them make it a goal
                let goalSuggestion = "";
                
                // Extract key elements from their response
                if (lowerMessage.includes('5') || lowerMessage.includes('five')) {
                    goalSuggestion = "Take a 5-minute walk";
                } else if (lowerMessage.includes('10') || lowerMessage.includes('ten')) {
                    goalSuggestion = "Take a 10-minute walk";
                } else if (lowerMessage.includes('15') || lowerMessage.includes('fifteen')) {
                    goalSuggestion = "Take a 15-minute walk";
                } else {
                    // Use their own words
                    goalSuggestion = message;
                }
                
                // Add frequency if not mentioned
                if (!lowerMessage.includes('day') && !lowerMessage.includes('week')) {
                    goalSuggestion += " three times this week";
                }
                
                showBotMessage(
                    `I love it! So your walking adventure could be: "${goalSuggestion}"

This feels like a wonderful starting point - achievable, enjoyable, and perfect for your brain health.

How does this feel to you? We can adjust it to make it just right, or if you're ready, we can make this your quest!`,
                    [
                        "‚Üí Yes, this feels perfect!",
                        "‚Üí Let's adjust it a bit",
                        "‚Üí I want to think about it more",
                        "‚Üí Tell me how walking helps my brain"
                    ]
                );
                
                // Store the suggested goal temporarily
                userHistory.suggestedGoal = goalSuggestion;
                currentPhase = "goal_confirmation";
                return;
            }

            // Handle "Other" option
            if (lowerMessage.includes('other') && lowerMessage.includes('enter what you')) {
                currentPhase = "custom_input";
                
                showBotMessage(
                    `Perfect! I'm here to support whatever is on your mind.

Please share what you'd like to explore or discuss. Whether it's a specific concern, a question about brain health, or anything else that matters to you - I'm listening with full attention.

What would you like to focus on?`
                );
                return;
            }

            // Begin a new chapter
            if (lowerMessage.includes('begin a new chapter') || lowerMessage.includes('new chapter')) {
                currentPhase = "chapter_creation";
                
                let chapterPrompt = `A new chapter awaits. Every story needs its turning points - moments where the hero chooses a new direction.`;
                
                // Add About Me context
                if (userHistory.aboutMe.bestLifeElements.length > 0) {
                    const topElements = userHistory.aboutMe.bestLifeElements.slice(0, 2).map(e => e.element);
                    chapterPrompt += `\n\nConsidering what matters most to you - ${topElements.join(' and ')} - what calls to you in this moment?`;
                    chapterPrompt += `\n\nWould you like to learn what you can do or define a plan for any of the options below?`;
                } else {
                    chapterPrompt += `\n\nWhat calls to you in this moment of your journey?`;
                }
                
                showBotMessage(chapterPrompt, [
                    "‚Üí The Path of Movement (Physical activity)",
                    "‚Üí The Garden of Rest (Sleep improvement)",
                    "‚Üí The Circle of Connection (Social engagement)",
                    "‚Üí The Temple of Learning (Mental stimulation)",
                    "‚Üí The Valley of Calm (Stress management)",
                    "‚Üí Other - enter what you'd like to do in the message box below"
                ]);
                return;
            }

            // Handle reflection choice clarification
            if (currentPhase === "reflection_choice") {
                if (lowerMessage.includes('overall journey') || lowerMessage.includes('overall progress')) {
                    showBotMessage(
                        `Reviewing your overall journey - what a wonderful way to see how far you've come!\n\n` +
                        `I'd love to help you reflect on your progress. What aspect of your journey would you like to explore?\n\n` +
                        `‚Ä¢ How your goals have evolved over time\n` +
                        `‚Ä¢ The patterns in your story chapters\n` +
                        `‚Ä¢ Changes in your health and wellbeing\n` +
                        `‚Ä¢ Growth in what matters most to you\n` +
                        `‚Ä¢ Or something else that feels important?\n\n` +
                        `Tell me what you'd like to focus on.`
                    );
                    currentPhase = "journey_review_exploration";
                    
                } else if (lowerMessage.includes('recent progress') || lowerMessage.includes('document progress')) {
                    showBotMessage(
                        `Documenting recent progress - this is such a powerful practice!\n\n` +
                        `What recent experiences or breakthroughs would you like to capture?\n\n` +
                        `‚Ä¢ A goal you've made progress on\n` +
                        `‚Ä¢ A challenge you've overcome\n` +
                        `‚Ä¢ A new habit you've developed\n` +
                        `‚Ä¢ A realization or insight you've had\n` +
                        `‚Ä¢ Or something else that feels significant?\n\n` +
                        `Share what's been happening, and we'll document it together.`
                    );
                    currentPhase = "progress_documentation";
                    
                } else if (lowerMessage.includes('health numbers') || lowerMessage.includes('measurements')) {
                    showBotMessage(
                        `Updating your health numbers - this helps us track your progress!\n\n` +
                        `What health measurements would you like to update or discuss?\n\n` +
                        `‚Ä¢ Physical measurements (weight, blood pressure, etc.)\n` +
                        `‚Ä¢ Activity levels or exercise progress\n` +
                        `‚Ä¢ Sleep quality or duration\n` +
                        `‚Ä¢ Mood or energy levels\n` +
                        `‚Ä¢ Or other health indicators you're tracking?\n\n` +
                        `Tell me what you'd like to update, and we'll record it together.`
                    );
                    currentPhase = "health_numbers_update";
                    
                } else if (lowerMessage.includes('patterns') || lowerMessage.includes('story over time')) {
                    showBotMessage(
                        `Seeing patterns in your story over time - this is where real insights emerge!\n\n` +
                        `What kind of patterns are you curious about?\n\n` +
                        `‚Ä¢ How your goals and priorities have changed\n` +
                        `‚Ä¢ Cycles in your energy or motivation\n` +
                        `‚Ä¢ Recurring themes in your story chapters\n` +
                        `‚Ä¢ Progress in specific areas over time\n` +
                        `‚Ä¢ Or something else that feels revealing?\n\n` +
                        `Share what patterns you'd like to explore, and we'll discover them together.`
                    );
                    currentPhase = "pattern_exploration";
                    
                } else if (lowerMessage.includes('celebrate') || lowerMessage.includes('achievements')) {
                    showBotMessage(
                        `Celebrating achievements - this is so important for motivation!\n\n` +
                        `What would you like to celebrate today?\n\n` +
                        `‚Ä¢ A goal you've reached\n` +
                        `‚Ä¢ A habit you've maintained\n` +
                        `‚Ä¢ A challenge you've overcome\n` +
                        `‚Ä¢ Progress you've made\n` +
                        `‚Ä¢ Or something else that feels like an achievement?\n\n` +
                        `Tell me what you'd like to celebrate, and let's honor your success together!`
                    );
                    currentPhase = "celebration_exploration";
                    
                } else {
                    // They said something unexpected - RESPOND TO IT
                    showBotMessage(
                        `I want to make sure I understand what aspect of reflection interests you. You mentioned: "${message}"\n\n` +
                        `Tell me more about what this means to you. I'm here to support whatever direction feels right for your reflection.`
                    );
                    currentPhase = "open_reflection_exploration";
                }
                return;
            }

            // Handle doctor type selection
            if (currentPhase === "doctor_visit_type") {
                let doctorType = "";
                
                if (lowerMessage.includes('primary care')) {
                    doctorType = "primary care doctor";
                } else if (lowerMessage.includes('neurologist')) {
                    doctorType = "neurologist";
                } else if (lowerMessage.includes('cardiologist')) {
                    doctorType = "cardiologist";
                } else if (lowerMessage.includes('mental health')) {
                    doctorType = "mental health provider";
                } else if (lowerMessage.includes('specialist') || lowerMessage.includes('other')) {
                    showBotMessage(
                        `Please type the kind of specialist you're seeing (for example: endocrinologist, rheumatologist, etc.):`
                    );
                    currentPhase = "doctor_visit_specialist_type";
                    return;
                } else if (lowerMessage.includes('not sure')) {
                    doctorType = "doctor";
                } else {
                    doctorType = message; // Use what they typed
                }
                
                // Store doctor type for context
                userHistory.currentDoctorVisit = { type: doctorType };
                saveUserHistory();
                
                currentPhase = "doctor_visit_focus";
                
                showBotMessage(
                    `Thank you. Now, is there something specific you'd like help with for your ${doctorType} visit?`,
                    [
                        "‚Üí Questions they might ask me",
                        "‚Üí Questions I should ask them", 
                        "‚Üí Explaining my symptoms clearly",
                        "‚Üí Discussing treatment options",
                        "‚Üí Understanding my test results",
                        "‚Üí General visit preparation"
                    ]
                );
                return;
            }

            // Handle doctor visit focus selection
            if (currentPhase === "doctor_visit_focus") {
                const doctorType = userHistory.currentDoctorVisit?.type || "doctor";
                
                if (lowerMessage.includes('questions they might ask')) {
                    let questionsMessage = `Here are common questions a ${doctorType} might ask:\n\n`;
                    
                    // Customize questions based on doctor type
                    if (doctorType === "neurologist") {
                        questionsMessage += `1. "When did you first notice these symptoms?"\n`;
                        questionsMessage += `2. "Have you noticed any changes in your memory or thinking?"\n`;
                        questionsMessage += `3. "Any headaches, dizziness, or balance issues?"\n`;
                        questionsMessage += `4. "Has anyone in your family had similar issues?"\n`;
                    } else if (doctorType === "primary care doctor") {
                        questionsMessage += `1. "What brings you in today?"\n`;
                        questionsMessage += `2. "How long has this been going on?"\n`;
                        questionsMessage += `3. "How is this affecting your daily life?"\n`;
                        questionsMessage += `4. "What medications are you currently taking?"\n`;
                    } else if (doctorType === "mental health provider") {
                        questionsMessage += `1. "How have you been feeling lately?"\n`;
                        questionsMessage += `2. "What changes have you noticed in your mood or thoughts?"\n`;
                        questionsMessage += `3. "How is your sleep and appetite?"\n`;
                        questionsMessage += `4. "What support do you have at home?"\n`;
                    } else {
                        // Generic questions
                        questionsMessage += `1. "What concerns brought you here today?"\n`;
                        questionsMessage += `2. "When did you first notice these issues?"\n`;
                        questionsMessage += `3. "What makes it better or worse?"\n`;
                        questionsMessage += `4. "How is this impacting your quality of life?"\n`;
                    }
                    
                    if (userHistory.aboutMe.bestLifeElements.length > 0) {
                        questionsMessage += `\nRemember, you can relate your answers to what matters most to you - like ${userHistory.aboutMe.bestLifeElements[0].element.toLowerCase()}.`;
                    }
                    
                    questionsMessage += `\n\nWould you like to practice answering any of these?`;
                    
                    showBotMessage(questionsMessage, [
                        "‚Üí Practice my answers",
                        "‚Üí Create a symptoms timeline",
                        "‚Üí List my current medications",
                        "‚Üí Move on to my questions for them"
                    ]);
                    
                    currentPhase = "doctor_questions_practice";
                    return;
                }
                
                if (lowerMessage.includes('questions i should ask')) {
                    let suggestedQuestions = `Here are important questions to ask your ${doctorType}:\n\n`;
                    
                    // Customize based on doctor type
                    if (doctorType === "neurologist") {
                        suggestedQuestions += `‚Ä¢ What exactly is happening in my brain?\n`;
                        suggestedQuestions += `‚Ä¢ What tests do you recommend and why?\n`;
                        suggestedQuestions += `‚Ä¢ What are the treatment options?\n`;
                        suggestedQuestions += `‚Ä¢ How might this progress over time?\n`;
                    } else {
                        suggestedQuestions += `‚Ä¢ What is causing my symptoms?\n`;
                        suggestedQuestions += `‚Ä¢ What are my treatment options?\n`;
                        suggestedQuestions += `‚Ä¢ What are the risks and benefits?\n`;
                        suggestedQuestions += `‚Ä¢ What happens if we do nothing?\n`;
                    }
                    
                    suggestedQuestions += `\nLet's create your personal list. What's your biggest question or concern?`;
                    
                    showBotMessage(suggestedQuestions);
                    currentPhase = "building_question_list";
                    return;
                }
            }

            // Handle doctor visit preparation confidence response
            if (currentPhase === "doctor_visit_prep" && !isNaN(parseInt(message))) {
                const confidence = parseInt(message);
                logEmotionalState(`doctor_communication_confidence_${confidence}`, 'doctor_visit_prep');
                
                let response = "";
                if (confidence <= 3) {
                    response = `I understand - medical visits can feel intimidating. Many people share this feeling, and it's completely valid.

Let's work together to build your confidence. We'll start with something simple and empowering.`;
                } else if (confidence <= 7) {
                    response = `That's a good foundation to build on. Even experienced advocates sometimes need a little preparation.

Let's strengthen your confidence even more.`;
                } else {
                    response = `Wonderful! Your confidence is inspiring. Let's make sure you have everything you need to make this visit as productive as possible.`;
                }
                
                response += `\n\nWhat would you like to work on first?`;
                
                showBotMessage(response, [
                    "‚Üí Questions my doctor might ask me",
                    "‚Üí Questions I want to ask my doctor",
                    "‚Üí Create my About Me Card",
                    "‚Üí Practice explaining my concerns"
                ]);
                
                currentPhase = "doctor_prep_choice";
                return;
            }

            // Handle doctor prep choices
            if (currentPhase === "doctor_prep_choice") {
                if (lowerMessage.includes('questions my doctor might ask')) {
                    showBotMessage(
                        `Let's think through common questions doctors ask, so you'll feel ready. Here are some typical ones:

**1. "What brings you in today?"**
Think about your main concern in one clear sentence.

**2. "How long has this been going on?"**
Try to remember when you first noticed changes.

**3. "How is this affecting your daily life?"**
${userHistory.aboutMe.bestLifeElements.length > 0 ? 
`This connects to what matters most to you - like ${userHistory.aboutMe.bestLifeElements[0].element.toLowerCase()}.` : 
'Think about specific activities that have become harder.'}

**4. "What medications are you taking?"**
Having a written list helps here.

Would you like to practice answering any of these? Or shall we prepare a different type of question?`,
                        [
                            "‚Üí Practice my main concern",
                            "‚Üí Timeline of changes",
                            "‚Üí Daily life impacts",
                            "‚Üí Prepare medication list"
                        ]
                    );
                    currentPhase = "doctor_questions_practice";
                    return;
                }
                
                if (lowerMessage.includes('questions i want to ask')) {
                    showBotMessage(
                        `Excellent! Having your own questions ready helps you get the most from your visit.

Let me help you build a list. What's your biggest concern or what do you most want to understand?

Some examples to inspire you:
- "What exactly is causing my symptoms?"
- "What are my treatment options?"
- "How might this affect my ability to ${userHistory.aboutMe.bestLifeElements[0]?.element.toLowerCase() || 'do what I love'}?"
- "What should I watch for?"

Share your first question, and we'll build your list together.`
                    );
                    currentPhase = "building_question_list";
                    return;
                }
                
                if (lowerMessage.includes('create my about me card')) {
                    showBotMessage(
                        `Your About Me Card is a powerful tool - it helps your doctor understand not just your symptoms, but who you are and what matters to you.

Based on what you've shared with me, here's a draft:

**ABOUT ME CARD**
**Name:** ${userHistory.profile.name}

**What Living Well Means to Me:**
${userHistory.aboutMe.bestLifeElements.map(e => `‚Ä¢ ${e.element}`).join('\n')}

**My Current Concerns:**
${userHistory.aboutMe.concerns.map(c => `‚Ä¢ ${c.concern}`).join('\n')}

**My Goals:**
${userHistory.goals.filter(g => g.status === 'active').slice(0, 2).map(g => `‚Ä¢ ${g.goal}`).join('\n')}

**Important for My Care Team to Know:**
- My confidence level: ${userHistory.aboutMe.confidenceLevel || 'Working on building confidence'}

Would you like to:`,
                        [
                            "‚Üí Add something important",
                            "‚Üí Remove something",
                            "‚Üí Print/save this card",
                            "‚Üí Create a shorter version"
                        ]
                    );
                    currentPhase = "about_me_card_editing";
                    return;
                }
            }

            // Handle doctor information discussion
            if (currentPhase === "doctor_info_discussion") {
                if (lowerMessage.includes('explain what they told me')) {
                    showBotMessage(
                        `I'm here to help make sense of what your doctor shared. Sometimes it helps to talk it through with someone who can listen without judgment.

Please share what your doctor told you - you can:
- Type it in your own words
- Share specific terms you didn't understand
- Describe the overall message

Take your time. What did they say?`
                    );
                    currentPhase = "doctor_explanation";
                    return;
                }
                
                if (lowerMessage.includes('upload medical documents')) {
                    showBotMessage(
                        `You can upload your medical documents using the upload button (üìÑ) at the bottom right of the screen.

I can help explain:
- Test results
- Treatment plans  
- Medication information
- Medical terminology

Once you upload, I'll help break down the information into clear, understandable pieces.`
                    );
                    currentPhase = "awaiting_medical_upload";
                    return;
                }
            }
            
            // Goal setting with About Me awareness
            if (lowerMessage.includes('accept') && lowerMessage.includes('quest')) {
                currentPhase = "quest_commitment";
                let questGoal = "";
                
                if (conversationLog.slice(-3).some(log => log.message && log.message.includes('Daily Walking'))) {
                    questGoal = "Take a 15-minute walk every day this week";
                }
                
                if (questGoal) {
                    // Link to About Me elements
                    const linkedElements = userHistory.aboutMe.bestLifeElements.map(e => e.element);
                    logGoal(questGoal, 7, linkedElements);
                    
                    showBotMessage(
                        `‚öîÔ∏è Quest Accepted: "${questGoal}"

This quest beautifully supports your value of ${linkedElements[0] || 'living your best life'}. You feel a surge of determination.

On a scale of 1-10, how confident do you feel about completing this quest?
(1 = This seems impossible, 10 = I've got this!)`,
                    );
                    currentPhase = "confidence_check";
                    return;
                }
            }
            
            // Confidence assessment
            if (currentPhase === "confidence_check") {
                const confidence = parseInt(message);
                if (!isNaN(confidence)) {
                    const lastGoalIndex = userHistory.goals.length - 1;
                    userHistory.goals[lastGoalIndex].confidence = confidence;
                    saveUserHistory();
                    
                    if (confidence < 7) {
                        showBotMessage(
                            `A confidence level of ${confidence} shows wisdom - you recognize the challenge ahead.

Every hero faces doubt. What would increase your confidence on this quest?`,
                            [
                                "‚Üí Start with a smaller challenge",
                                "‚Üí Find a quest companion",
                                "‚Üí Learn preparation rituals",
                                "‚Üí Set magical reminders"
                            ]
                        );
                    } else {
                        logActionPlan(`Begin quest: ${userHistory.goals[lastGoalIndex].goal}`);
                        showBotMessage(
                            `Confidence level ${confidence} - the heart of a true hero!

Your quest begins now. What's the very first step you'll take TODAY to start this adventure?

Remember: Even the longest journey begins with a single step.`
                        );
                        currentPhase = "action_planning";
                    }
                }
                return;
            }
            
            // Report progress on quest
            if ((lowerMessage.includes('report progress') || lowerMessage.includes('progress on my quest')) && userHistory.goals.some(g => g.status === 'active')) {
                currentPhase = "progress_report";
                const activeGoal = userHistory.goals.find(g => g.status === 'active');
                
                showBotMessage(
                    `Tell me about your progress with "${activeGoal.goal}".

How has it been going? Every step forward, no matter how small, is part of your heroic journey.

Share your experience - the triumphs, the challenges, or even the days you didn't quite make it. It's all part of your story.`
                );
                return;
            }
            
            // Face a challenge
            if (lowerMessage.includes('face a challenge') || lowerMessage.includes('challenge that') || lowerMessage.includes('emerged')) {
                currentPhase = "challenge_support";
                const activeGoal = userHistory.goals.find(g => g.status === 'active');
                
                showBotMessage(
                    `Every hero faces obstacles. What challenge has emerged on your quest${activeGoal ? ' to "' + activeGoal.goal + '"' : ''}?

Sometimes the dragon we must slay is our own doubt, or the mountain we climb is made of daily habits.

Tell me what you're facing, and together we'll find a way forward.`,
                    [
                        "‚Üí I'm losing motivation",
                        "‚Üí It's harder than I expected",
                        "‚Üí Life got in the way",
                        "‚Üí I need to adjust my approach"
                    ]
                );
                return;
            }
            
            // Seek wisdom
            if (lowerMessage.includes('seek wisdom') || lowerMessage.includes('wisdom for')) {
                currentPhase = "wisdom_sharing";
                const activeGoal = userHistory.goals.find(g => g.status === 'active');
                
                let wisdomTopics = [
                    "‚Üí Tips for staying consistent",
                    "‚Üí How to track progress",
                    "‚Üí Building supportive habits",
                    "‚Üí Celebrating small wins"
                ];
                
                // Customize based on goal type
                if (activeGoal && activeGoal.goal.toLowerCase().includes('walk')) {
                    wisdomTopics = [
                        "‚Üí Best times for walking",
                        "‚Üí Making walks more enjoyable",
                        "‚Üí Walking safely",
                        "‚Üí Tracking your steps"
                    ];
                } else if (activeGoal && activeGoal.goal.toLowerCase().includes('sleep')) {
                    wisdomTopics = [
                        "‚Üí Evening routines that work",
                        "‚Üí Creating a sleep sanctuary",
                        "‚Üí Dealing with sleep disruptions",
                        "‚Üí Tracking sleep quality"
                    ];
                }
                
                showBotMessage(
                    `The ancient scrolls of brain health wisdom are open before you. üìú‚ú®

What knowledge would serve you best on your quest${activeGoal ? ' to "' + activeGoal.goal + '"' : ''}?`,
                    wisdomTopics
                );
                return;
            }
            
            // Adjust quest parameters
            if (lowerMessage.includes('adjust') && (lowerMessage.includes('quest') || lowerMessage.includes('parameters'))) {
                currentPhase = "quest_adjustment";
                const activeGoal = userHistory.goals.find(g => g.status === 'active');
                
                if (activeGoal) {
                    showBotMessage(
                        `Sometimes a quest needs refinement. Your current quest is: "${activeGoal.goal}"

Your original confidence level was ${activeGoal.confidence}/10.

How would you like to adjust this quest?`,
                        [
                            "‚Üí Make it easier to start",
                            "‚Üí Change the frequency",
                            "‚Üí Add a reward system",
                            "‚Üí Find an accountability partner",
                            "‚Üí Complete this quest and start anew"
                        ]
                    );
                } else {
                    showBotMessage("I don't see an active quest to adjust. Would you like to set a new quest?");
                    currentPhase = "chapter_creation";
                }
                return;
            }
            
            // Handle progress report responses
            if (currentPhase === "progress_report") {
                // Log the progress update
                const activeGoalIndex = userHistory.goals.findIndex(g => g.status === 'active');
                if (activeGoalIndex >= 0) {
                    updateGoalProgress(activeGoalIndex, message);
                    
                    // Check for success indicators
                    if (lowerMessage.includes('did it') || lowerMessage.includes('success') || lowerMessage.includes('achieved')) {
                        showBotMessage(
                            `üéâ This is wonderful! You're living your heroic story!

Your progress shows that ${userHistory.aboutMe.bestLifeElements.length > 0 ? userHistory.aboutMe.bestLifeElements[0].element + ' is truly possible' : 'transformation is happening'}.

Would you like to:`,
                            [
                                "‚Üí Celebrate this victory",
                                "‚Üí Set a new challenge",
                                "‚Üí Share what you've learned",
                                "‚Üí Continue with the same quest"
                            ]
                        );
                    } else if (lowerMessage.includes('struggle') || lowerMessage.includes('hard') || lowerMessage.includes('difficult')) {
                        showBotMessage(
                            `I hear you. This path isn't always easy, but your honesty shows strength.

Remember: Heroes aren't defined by never falling, but by always getting back up.

What would help you most right now?`,
                            [
                                "‚Üí Adjust the quest to be more manageable",
                                "‚Üí Find strategies that work better",
                                "‚Üí Take a brief rest and restart",
                                "‚Üí Connect with others on similar journeys"
                            ]
                        );
                    } else {
                        showBotMessage(
                            `Thank you for sharing your progress. Every step of this journey matters.

How do you feel about your progress so far?`,
                            [
                                "‚Üí Proud of what I've done",
                                "‚Üí Ready for more challenge",
                                "‚Üí Need some adjustments",
                                "‚Üí Want to try something different"
                            ]
                        );
                    }
                }
                currentPhase = "quest_reflection";
                return;
            }
            
            // Capture as chapter request
            if (lowerMessage.includes('capture') && lowerMessage.includes('chapter')) {
                openChapterModal();
                return;
            }
            
            // Default response for unhandled inputs during specific phases
            if (currentPhase === "movement_quest" || currentPhase === "sleep_quest" || currentPhase === "connection_quest") {
                // User typed something unexpected during a quest selection
                showBotMessage(
                    `I see you have something specific in mind. Tell me more about what you'd like to explore, or choose from the options above to continue on your chosen path.`
                );
                return;
            }
            
            // If no specific handler matched, provide a contextual response
            if (currentPhase && !['initialization', 'introduction', 'age_inquiry'].includes(currentPhase)) {
                // We're in the middle of something specific
                showBotMessage(
                    `I'm not sure how to respond to that in our current context. Would you like to continue with what we were discussing, or would you prefer to explore something else?`,
                    [
                        "‚Üí Continue our current topic",
                        "‚Üí Start something new",
                        "‚Üí Show me my progress",
                        "‚Üí Update what matters to me"
                    ]
                );
            }
        }

        function showProgressSummary() {
            const activeGoals = userHistory.goals.filter(g => g.status === 'active');
            const completedGoals = userHistory.goals.filter(g => g.status === 'completed');
            const chapters = userHistory.storyChapters.length;
            
            let summary = `üìö The Story So Far...\n\n`;
            summary += `**Protagonist:** ${userHistory.profile.name}\n`;
            summary += `**Chapters Written:** ${chapters}\n`;
            summary += `**Active Quests:** ${activeGoals.length}\n`;
            summary += `**Completed Quests:** ${completedGoals.length}\n\n`;
            
            // Add About Me summary
            if (userHistory.aboutMe.bestLifeElements.length > 0) {
                summary += `**What Matters Most:**\n`;
                userHistory.aboutMe.bestLifeElements.forEach(element => {
                    summary += `‚Ä¢ ${element.element}\n`;
                });
                summary += '\n';
            }
            
            if (chapters > 0) {
                summary += `**Recent Chapter:** "${userHistory.storyChapters[chapters - 1].title}"\n\n`;
            }
            
            if (activeGoals.length > 0) {
                summary += `**Current Quest:**\n`;
                activeGoals.forEach(goal => {
                    summary += `‚öîÔ∏è ${goal.goal} (Confidence: ${goal.confidence}/10)\n`;
                    if (goal.linkedBestLifeElements && goal.linkedBestLifeElements.length > 0) {
                        summary += `   Supporting: ${goal.linkedBestLifeElements[0]}\n`;
                    }
                });
            }
            
            summary += `\n**Your Journey Stats:**\n`;
            summary += `üóìÔ∏è Days on this adventure: ${Math.floor((new Date() - new Date(userHistory.profile.registrationDate)) / (1000 * 60 * 60 * 24))}\n`;
            summary += `üí¨ Conversations shared: ${userHistory.profile.totalSessions}\n`;
            summary += `üìñ Wisdom topics explored: ${userHistory.educationTopics.length}`;
            
            if (userHistory.aboutMe.confidenceLevel) {
                summary += `\nüí™ Confidence Level: ${userHistory.aboutMe.confidenceLevel}`;
            }
            
            showBotMessage(summary, [
                "‚Üí Write a new chapter",
                "‚Üí Update quest progress",
                "‚Üí Explore new territories",
                "‚Üí Update what matters to me"
            ]);
        }

        async function submitFeedback() {
            const feedbackInput = document.getElementById('feedbackInput');
            const feedback = feedbackInput.value.trim();
            
            if (feedback) {
                const feedbackContainer = document.getElementById('feedbackContainer');
                
                // Show confirmation in feedback section
                const confirmationDiv = document.createElement('div');
                confirmationDiv.className = 'feedback-confirmation';
                confirmationDiv.innerHTML = `Thank you for sharing your thoughts, ${userHistory.profile.name || 'friend'}! Your feedback helps me become a better guide for everyone's brain health journey. Together, we're creating something truly special. üìñüíú`;
                feedbackContainer.appendChild(confirmationDiv);
                
                // Store the actual feedback
                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = 'feedback-item';
                
                const timestamp = new Date().toLocaleString();
                feedbackDiv.innerHTML = `
                    ${feedback}
                    <div class="feedback-timestamp">${timestamp}</div>
                `;
                
                feedbackContainer.appendChild(feedbackDiv);
                feedbackInput.value = '';
                
                feedbackLog.push({
                    feedback: feedback,
                    timestamp: new Date().toISOString(),
                    conversationContext: conversationLog.length
                });
                
                // Save to API if available
                if (typeof SofiaAPI !== 'undefined' && SofiaAPI.isAuthenticated()) {
                    try {
                        await SofiaAPI.submitFeedback(feedback, conversationLog.length);
                    } catch (error) {
                        console.error('Failed to submit feedback to API:', error);
                        // Save to offline queue
                        const offlineQueue = JSON.parse(localStorage.getItem('sofia_offline_queue') || '[]');
                        offlineQueue.push({ 
                            type: 'feedback', 
                            data: { text: feedback, context: conversationLog.length }, 
                            timestamp: new Date().toISOString() 
                        });
                        localStorage.setItem('sofia_offline_queue', JSON.stringify(offlineQueue));
                    }
                }
                
                // Remove confirmation after a few seconds
                setTimeout(() => {
                    confirmationDiv.style.animation = 'fadeIn 0.5s ease-in reverse';
                    setTimeout(() => {
                        feedbackContainer.removeChild(confirmationDiv);
                    }, 500);
                }, 5000);
            }
        }

        function scrollToBottom() {
            const chatContainer = document.getElementById('chatContainer');
            if (chatContainer) {
                setTimeout(() => {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }, 100);
            }
        }

        // Handle Enter key for sending messages
        document.getElementById('userInput').addEventListener('keypress', function(e) {
            try {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            } catch (error) {
                console.error('Error handling Enter key:', error);
            }
        });

        // Download memory summary in narrative format
        function downloadMemorySummary() {
            const userName = userHistory.profile.name || 'Brave Adventurer';
            const date = new Date().toLocaleDateString();
            
            let summary = `üìñ The Brain Health Saga of ${userName}\n`;
            summary += `Chronicled on: ${date}\n`;
            summary += `Adventures completed: ${userHistory.profile.totalSessions}\n\n`;
            
            // Add About Me section
            if (userHistory.aboutMe && userHistory.aboutMe.profileCompleteness > 0) {
                summary += `‚ïê‚ïê‚ïê WHAT MATTERS MOST TO ME ‚ïê‚ïê‚ïê\n\n`;
                
                if (userHistory.aboutMe.bestLifeElements.length > 0) {
                    summary += `My Best Life Includes:\n`;
                    userHistory.aboutMe.bestLifeElements.forEach(element => {
                        summary += `‚Ä¢ ${element.element}\n`;
                    });
                    summary += '\n';
                }
                
                if (userHistory.aboutMe.concerns.length > 0) {
                    summary += `My Concerns:\n`;
                    userHistory.aboutMe.concerns.forEach(concern => {
                        summary += `‚Ä¢ ${concern.concern}\n`;
                    });
                    summary += '\n';
                }
                
                if (userHistory.aboutMe.confidenceLevel) {
                    summary += `My Confidence Level: ${userHistory.aboutMe.confidenceLevel}\n\n`;
                }
            }
            
            summary += `‚ïê‚ïê‚ïê YOUR STORY CHAPTERS ‚ïê‚ïê‚ïê\n\n`;
            if (userHistory.storyChapters.length > 0) {
                userHistory.storyChapters.forEach((chapter, index) => {
                    summary += `Chapter ${index + 1}: ${chapter.title}\n`;
                    summary += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                    summary += `${chapter.moment}\n`;
                    if (chapter.choices) summary += `\nChoices Made: ${chapter.choices}\n`;
                    if (chapter.learning) summary += `Wisdom Gained: ${chapter.learning}\n`;
                    summary += `Emotional Journey: ${chapter.moodArc.join(' ‚Üí ')}\n`;
                    if (chapter.linkedBestLifeElements && chapter.linkedBestLifeElements.length > 0) {
                        summary += `Connected to: ${chapter.linkedBestLifeElements.join(', ')}\n`;
                    }
                    summary += `Date: ${new Date(chapter.timestamp).toLocaleDateString()}\n\n`;
                });
            } else {
                summary += 'Your story chapters are yet to be written...\n\n';
            }
            
            summary += `‚ïê‚ïê‚ïê ACTIVE QUESTS ‚ïê‚ïê‚ïê\n\n`;
            const activeGoals = userHistory.goals.filter(g => g.status === 'active');
            if (activeGoals.length > 0) {
                activeGoals.forEach((goal, index) => {
                    summary += `Quest ${index + 1}: ${goal.goal}\n`;
                    summary += `   Confidence Level: ${goal.confidence}/10\n`;
                    summary += `   Begun on: ${new Date(goal.setDate).toLocaleDateString()}\n`;
                    if (goal.linkedBestLifeElements && goal.linkedBestLifeElements.length > 0) {
                        summary += `   Supporting: ${goal.linkedBestLifeElements.join(', ')}\n`;
                    }
                    if (goal.userNote) summary += `   Your notes: ${goal.userNote}\n`;
                    summary += '\n';
                });
            } else {
                summary += 'No active quests at this time.\n\n';
            }
            
            summary += `‚ïê‚ïê‚ïê CHALLENGES FACED ‚ïê‚ïê‚ïê\n\n`;
            if (userHistory.concerns.length > 0) {
                userHistory.concerns.forEach((concern, index) => {
                    summary += `${index + 1}. ${concern.concern}\n`;
                    if (concern.context) summary += `   Context: ${concern.context}\n`;
                    summary += '\n';
                });
            } else {
                summary += 'No challenges recorded yet.\n\n';
            }
            
            summary += `‚ïê‚ïê‚ïê VALUES THAT GUIDE YOU ‚ïê‚ïê‚ïê\n\n`;
            if (userHistory.values.length > 0) {
                userHistory.values.forEach(value => {
                    summary += `‚Ä¢ ${value.value} (${value.importance} importance)\n`;
                });
            } else {
                summary += 'Your guiding values await discovery.\n';
            }
            
            summary += `\n‚ïê‚ïê‚ïê YOUR NEXT CHAPTER ‚ïê‚ïê‚ïê\n\n`;
            summary += 'The story continues with every choice you make.\n';
            summary += 'What adventure will you write next?\n';
            
            summary += '\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
            summary += 'Created by Sofia, your Brain Health Story Companion\n';
            summary += 'May your journey be filled with discovery and growth.\n';
            
            // Create and download file
            const blob = new Blob([summary], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `brain-health-saga-${userName.toLowerCase().replace(/\s/g, '-')}-${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            
            showBotMessage(`I've created a chronicle of your brain health saga! Your story awaits in your downloads folder. üìñ‚ú®`);
        }

        // Function to download complete user history
        function downloadUserHistory() {
            const fullData = {
                userHistory: userHistory,
                conversationLogs: conversationLog,
                feedbackLog: feedbackLog,
                safetyData: safetyData,
                exportDate: new Date().toISOString(),
                storyMetadata: {
                    totalChapters: userHistory.storyChapters ? userHistory.storyChapters.length : 0,
                    totalStoryMoments: userHistory.storyMoments ? userHistory.storyMoments.length : 0,
                    preferredStyle: userHistory.visualStyle || 'journey'
                },
                aboutMeMetadata: {
                    profileComplete: isAboutMeComplete,
                    completeness: userHistory.aboutMe ? userHistory.aboutMe.profileCompleteness : 0,
                    lastUpdated: userHistory.aboutMe ? userHistory.aboutMe.lastUpdated : null
                }
            };
            
            const dataStr = JSON.stringify(fullData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `sofia-story-data-${userHistory.profile.name || 'user'}-${new Date().toISOString()}.json`;
            link.click();
        }

        // Clear all user data
        function clearAllData() {
            const confirmClear = confirm(
                `Are you sure you want to erase your entire story?\n\n` +
                `This will permanently delete:\n` +
                `‚Ä¢ Your About Me profile\n` +
                `‚Ä¢ All your story chapters\n` +
                `‚Ä¢ All quests and progress\n` +
                `‚Ä¢ All concerns and values\n` +
                `‚Ä¢ Your complete journey history\n\n` +
                `This action cannot be undone!`
            );
            
            if (!confirmClear) return;
            
            const doubleConfirm = confirm(
                `This is your final choice.\n\n` +
                `Type "DELETE" in the next prompt to permanently erase your story.`
            );
            
            if (doubleConfirm) {
                const userInput = prompt('Type "DELETE" to confirm:');
                if (userInput === 'DELETE') {
                    // Clear localStorage
                    localStorage.removeItem('sofiaUserHistory');
                    
                    // Reset all data structures
                    userHistory = createDefaultUserHistory();
                    
                    // Reset safety data
                    safetyData = {
                        triggers: [],
                        interventions: [],
                        contentMisalignments: [],
                        sessionRiskProfile: {
                            overallRiskLevel: "low",
                            dominantConcerns: [],
                            escalationPattern: false,
                            requiresFollowUp: false
                        }
                    };
                    
                    // Reset About Me tracking
                    selectedBestLifeElements = [];
                    selectedConcerns = [];
                    isAboutMeComplete = false;
                    
                    // Update display
                    updateMemoryDisplay();
                    
                    // Reload page to start fresh
                    alert('Your story has been erased. A new adventure begins now.');
                    window.location.reload();
                } else {
                    alert('Story preservation confirmed. Your journey continues.');
                }
            }
        }

        // Auto-save every 30 seconds
        setInterval(() => {
            saveUserHistory();
            console.log('Story auto-saved');
        }, 30000);

        // Save session duration on page unload
        window.addEventListener('beforeunload', function() {
            if (currentSessionIndex >= 0) {
                const sessionStart = new Date(userHistory.sessions[currentSessionIndex].date);
                const duration = Math.floor((new Date() - sessionStart) / 60000); // minutes
                userHistory.sessions[currentSessionIndex].duration = duration;
                saveUserHistory();
            }
        });
        
        // Helper function for API integration (if api-client.js is not loaded)
        if (typeof loadUserHistoryFromAPI === 'undefined') {
            window.loadUserHistoryFromAPI = async function() {
                // Stub function - real implementation in api-client.js
                return null;
            };
        }
    </script>
    <!-- Configuration - Update this file with your Render app URL -->
    <script src="js/config.js"></script>
    <!-- API Integration - Load this file for full backend functionality -->
    <script src="js/api-client.js"></script>
    <!-- Optional: PDF.js for PDF document support -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script> -->
</body>
</html>
